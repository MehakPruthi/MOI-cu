---
title: "courts"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rgdal)
source("helpers.R")
```

# Assumptions

- Assumptions due to limited data:
  - Satellite courts lack data because the courthouse hours MAG dataset is not detailed to the level of the court asset MAG dataset, therefore
    - Satellite courts are assumed to service the same set of business lines as the base court in the CD
    - Satellite courts are assumed to have 1 courtroom
  
  - Assume individuals appear at courthouses within their CD of home origin due to limited information on where court demand is coming from
  - Assume that a portion of of individuals are "assigned" and another portion chooses closeset available courtroom due to limited information on the number of trips per individual and where court demand is coming from
    - This split is defaulted to 20/80 for civil, family, small claims and 10/90 for OCJcrim, SCJcrim
  - Four years of back data may not be enough to tease out future trends where hrs/case is increasing and may cause an inflection in forecast years - future extended data set may allow for various demand assessment approaches and/or more accurate rate production from historical data
  
- Processing Assumptions
  - CD 3553 (Greater Sudbury) is within CD 3552 (Sudbury) with the courts located in Greater Sudbury. Therefore, the two CDs are combined and treated as one CD due to limited on information on where individuals attending court are coming from

# User Inputs
```{r}
# Establish rate of business line courthours by population based on historical data. Available historical data is from 2014-2018.
WEIGHT_RATE = tibble("year" = c(2014, 2015, 2016, 2017, 2018),
                       "weight" = c(1, 1, 1, 1, 1)) # For historical data weighting - default is equal weighting

# Model Scenario inputs
MODEL_YEAR <- 2025
BASE_YEAR <- 2018 # Most recent historical data
OP_DAYS <- 249
NEW_COURTROOM_SIZE <- 11500

DECISION_MAKING <- FALSE

if (DECISION_MAKING) {
  U_AVG <- tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                  target.utilization = c(0.8, 0.8, 0.85, 0.85, 0.9, 0.9))
} else {
  U_AVG <- tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                target.utilization = c(1, 1, 1, 1, 1, 1))
}

DISTRIBUTION_PERCENTAGE <- tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                             closest.percentage = c(0.9, 0.9, 0.8, 0.8, 0.8, 0.8), 
                             random.percentage = 1 - closest.percentage)

# Demand-adjustment factor to account for modernization - a factor less than 1 will reduce demand for that business line accordingly 
MODERNIZATION_FACTOR = tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                              mod.factor = c(1, 1, 1, 1, 1, 1))

# Number of cases per court-hour, appearances per case, and one-way trips per appearance
APPEARANCE_FACTOR = tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                           case.factor = c(0.3, 0.3, 0.3, 0.3, 0.3, 0.3),
                           app.factor = c(2, 2, 2, 2, 2, 2),
                           trip.factor = c(2, 2, 2, 2, 2, 2))

# User-placed New Courthouse
new_courthouse <- tibble(
  bid = "B99999",
  courthouse.lat = 43.90032, courthouse.long = -78.85863,
  name = "New Court",
  building.type = "Base Court",
  casetypes.serviced = c("civil,smac,OCJcrim"),
  courtrooms = 4,
  rentable.square.feet = 0,
  new.courthouse = 1)

# Read in cost function parameters from model user: cost per courtroom plus a startup cost applied to all courthouses regardless of size
USER_COST_PER_SQFT <- 200
USER_COST_COURTHOUSE_FLAT <- 20000000 

# Cost Annualiztion
USER_INPUT_INFLATION <- 0.02
CURRENCY_YEAR = 2018 # Units of costs; set to 2018 since cost function from EDU assumed to be set in 2018$
CURRENT_YEAR = 2020 # Current year used to calculate construction timespan; should be parameterized and put up front for user to choose

```


# Import Data

```{r import data}
# Improt TRESO information to define system
treso_shp <- readOGR(dsn ="input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_zone_system <- read.csv("input/treso/treso_zone_system.csv")

# Import TRESO Travel Time Skims to distribute demand to courts
travel_time_skim <- readRDS("cache/treso/treso_travel_time_2016.rds")

# Import prepared TRESO projection population with age groups segmented to enable MAG business line (casetype) breakdown
treso_population <- readRDS("input/mag/treso_population_mag.rds")

# Import courthouse hours dataset recieved from MAG
court_hours <- readRDS("cache/mag/courthouse_hours.rds")

# Import courthouse asset lists that includes satellite & base courts from MAG
courthouse_master <- readRDS("cache/mag/courthouse_master.rds")

# Build utilization table for each business line
utilization_rate <- tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                           base.hours.dy = c(3.5, 2.6, 2.7, 2.7, 2.4, 2.7),
                           inflect.hours.dy = c(4.4, 3.7, 4.3, 4.1, 3.5, 4.0),
                           max.hours.dy = c(4.5, 3.8, 4.4, 4.3, 3.6, 4.1),
                           inflect.hours = c(15000, 9000, 5000, 6000, 5000, 6000),
                           max.hours = c(30000, 18000, 10000, 12000, 10000, 12000)
                           )

saveRDS(utilization_rate, "cache/mag/utilization_rate.rds")
```

## Data Preparation

```{r data preparation}

treso_population_bl_long <- prepare_treso_population(treso_population, treso_zone_system)
saveRDS(treso_population_bl_long, "cache/mag/treso_population_bl_long.rds")

```


```{r combine hours with population}

court_hours_population <- combine_hours_and_population(treso_population_bl_long, court_hours)
saveRDS(court_hours_population, "cache/mag/court_hours_population.rds")

```

# Rate Calculation
## Base Year Rates

The age ranges for business lines are based on background information received as follows:

- OCJCrim: 12 - 49
- SCJCrim: 18 - 49
- OCJFam: 0 - 17
- SCJFam: 0 - 59
- Civil: 20 - 69
- Smac: 20 - 69

```{r population rates for base year 2018}

baseyear_rates <- calculate_baseyear_rates(court_hours_population, WEIGHT_RATE)
saveRDS(baseyear_rates, "cache/mag/baseyear_rates.rds")

```

## Project Cases

```{r project cases by business lines}

future_cases_bl_treso <- calculate_forecast_cases(baseyear_rates, treso_population_bl_long)
saveRDS(future_cases_bl_treso, "cache/mag/future_cases_bl_treso.rds")

```

# Courtrooms (Capacity) Required
-  Calculate courtrooms required using business line specfic utilization characteristics from background data recieved

```{r courtroom required}

forecasted_courtrooms_required <- calculate_courtrooms_required(future_cases_bl_treso, utilization_rate, 
                                                                courthouse_master, OP_DAYS, MODEL_YEAR)
saveRDS(forecasted_courtrooms_required, "output/mag/forecasted_courtrooms_required.rds")

## Calculate an average utilization by CD and model year
cd_utilization <- forecasted_courtrooms_required %>% 
  mutate(utilization = courtrooms.needed / number.of.courtrooms.2018)
```

# Demand Distribution

- All cases are assigned to a single courthouse because the buisness lines do NOT compete with each other
- Upon confirmation, the distribution of demand to competing courthouses can be removed.

```{r demand distribution}

results <- distribute_mag_demand(future_cases_bl_treso, courthouse_master, new_courthouse, treso_shp, travel_time_skim,
                                 MODERNIZATION_FACTOR, APPEARANCE_FACTOR, DISTRIBUTION_PERCENTAGE, U_AVG, USER_COST_PER_SQFT,
                                 USER_COST_COURTHOUSE_FLAT, OP_DAYS, MODEL_YEAR)

courthouse_asset <- results[[1]]
courthours_od <- results[[2]]

saveRDS(courthouse_asset, "output/mag/courthouse_asset.rds")
saveRDS(courthours_od, "output/mag/courthours_od.rds")

```


# Cost Annualization 
- Inflate cost for facility construction based on construction year; calculate total cost over time period of interest
```{r}
annualized_inflated_cost <- construction_cost(USER_INPUT_INFLATION, MODEL_YEAR, CURRENCY_YEAR, CURRENT_YEAR, courthouse_asset)

```

# Old Code: Linear Regression

- Commented out due to being non-essential to current modelling approach, but can be used for further exploration
- Conducted to test whether there are any linear relationships between age groups and certain court hours

```{r explore linear regression}
# library(perturb)

# treso_2016_population <- readRDS("input/mag/treso_2016_population_mag.rds") %>% 
#   left_join(treso_zone_system, by = c("treso_zone" = "treso_id")) %>% 
#   select(treso_zone, age.group, population, cduid, cdname) %>% 
#   mutate(cdname = as.character(cdname)) %>% 
#   group_by(cduid, cdname, age.group) %>% 
#   summarise(population = sum(population)) %>% 
#   ungroup() %>% 
#   spread(key = "age.group", value = "population") %>% 
#   mutate(adult = adult.20s + adult.30s + adult.40s + adult.50s + adult.60s) %>% 
#   mutate(senior = senior.70s + senior.80s) %>% 
#   mutate(majority = adult + senior) %>% 
#   mutate(minor = child + youth + young.adult) %>% 
#   mutate(total = majority + minor)
# 
# court_hours_2016 <- court_hours %>% 
#   filter(year == 2016) %>% 
#   select(-lat, -long, -csduid, -csdname, -area, -region, -courthouse.lat, -courthouse.long) %>% 
#   group_by(cduid, cdname, casetypes) %>%
#   summarise(value = sum(value)) %>% 
#   ungroup() %>% 
#   spread(key = "casetypes", value = "value") %>% 
#   left_join(treso_2016_population, by = c("cduid", "cdname")) %>% 
#   select(-cduid, -cdname) %>% 
#   mutate_if(is.numeric, list(ln = log1p, sqrt = sqrt, log = log10, sq = ~.^2, scale = scale)) 

```

```{r building models - OCJcrim}
# r1 <- resid(lm(young.adult_ln ~ adult.20s_ln, data = court_hours_2016))
# mod <- lm(OCJcrim_sqrt ~ adult.20s_ln + r1, data = court_hours_2016)
# summary(mod)
# 
# plot(mod)
```

```{r building models - SCJcrim}
# r1 <- resid(lm(adult.30s_sqrt ~ adult.20s_sqrt, data = court_hours_2016))
# mod <- lm(SCJcrim_sqrt ~ adult.20s_sqrt + r1, data = court_hours_2016)
# summary(mod)
# plot(mod)
```

```{r building models - OCJfam}
# mod <- lm(OCJfam ~ adult.30s_sqrt + adult.50s_sqrt + child, data = court_hours_2016)
# summary(mod)
# plot(mod)
# 
# # Comment - it was found that to have a high R^2 and proper signs with the `child` term, the only transformation is the non-transformed version.
```

```{r building models - SCJfam}
# mod <- lm(SCJfam ~ youth_sqrt + senior.70s, data = court_hours_2016)
# summary(mod)
# plot(mod)
```

```{r building models - civil}

# mod <- lm(civil_sqrt ~ young.adult_sqrt + adult.20s_sqrt + senior.80s_sqrt, data = court_hours_2016)
# summary(mod)
# print(colldiag(mod))
# plot(mod)
```

```{r building models - smac}
# rMod <- residuals(lm(adult.30s ~ adult.20s, data = court_hours_2016))
# mod <- lm(smac ~ adult.20s_sqrt + rMod, data = court_hours_2016)
# cd <- colldiag(mod)
# cd
# 
# mod <- lm(smac ~ adult.20s_sqrt + adult.30s_sqrt, data = court_hours_2016)
# cd <- colldiag(mod)
# cd
# 
# #plot(mod)

```



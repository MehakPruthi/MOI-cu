---
title: "courts"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(magrittr)
library(stringr)
library(tidyr)
source("helpers.R")
```

#Questions for workshop
  - two cds don't have courts allocated to them. How can we incorporate the demand from those two cds? Currently we aren't
  - we cleaned the court asset list by making some assumptions on the breakdown of courtrooms in base and satellite courts
  - Four years of back data may not be enough to tease out future trends where hrs/case is increasing and may cause an inflection in forecast years
  
#To-Do
  - slider for base, inflection, max, by business line
  - treso regression characteristic breakdown
  - 

# Court-Hours Forecasting

## Import Data
  - Import Court hour data, MOF population data and City/CD cross-walk datasets
  - Clean Data
  - SHOULD THIS BE ADDED TO 'DATA CLEANING' RMD?
```{r data import}

#TRESO 
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("cache/treso_tb.rds")

#TRESO Travel TIme Skims to distribute demand to courts
travel_time_skim_square <- read_csv("input/treso/mf224.csv.gz")
travel_time_skim <- travel_time_skim_square %>%
  melt(id = c("p/q/[val]")) %>%
  rename(orig = "p/q/[val]", dest = variable) %>%
  mutate(orig = as.numeric(orig), dest = as.numeric(levels(dest))[dest]) %>%
  filter(orig %in% treso_shp@data$Treso_ID) %>%
  filter(dest %in% treso_shp@data$Treso_ID)

#updated courthouse hrs dataset (update in date_cleaning.rmd)
crthrs <- readRDS("cache/mag/courthouse_hours.rds")

#updated court asset lists that includes satellite & base courts (update in date_cleaning.rmd)
courthouse_asset <- readRDS("cache/mag/courthouse_master.rds")

#cleaned treso population estimates from 2011-2041
treso_population <- readRDS("input/mag/treso_population_mag.rds")

#to match Treso zones to CDs and courts
treso_zone_system <- read.csv("input/treso/treso_zone_system.csv")

```

## Parameters
  - Create Business Line parameter matrices
  
```{r business line parameter matrices}
casetypes <- c('OCJCrim','SCJCrim','OCJFam','SCJFam','Civil','SmaC' ) ##OCJFam & SCJFam age groups are flipped - Salah Flipped them back
maxmagage <- c(49,49,17,59,69,69)
minmagage <- c(12,18,0,0,20,20)
projperiod <- 10
baseyearmodels <- tibble('Year'=c(-4,-3,-2,-1,0),
                            'Weight_5y'=c(.2,.2,.2,.2,.2),
                            'Weight_cr'=c(0,0,0,0,1),
                            'weight_custom'=c(0,0,0,0,0))
starting_forecast_year <- max(crthrs$year) #update with paul's list

```

## Data Preparation

```{r data preparation}

##input and manipulate treso zone level population data by age groups
treso_population_x <- treso_population %>% 
  left_join(select(treso_zone_system, treso_id, cduid), by = c("treso_zone" = "treso_id")) %>% 
  select(-csduid) %>% 
  rename_at(vars(3:24), funs(substr(.,12,15))) %>% 
  gather(key="year", value = "population", -treso_zone, -age.group, -cduid)

#transform age ranges to business line populations by zone and projection year
treso_population_OCJCrim <- treso_population_x %>% 
  group_by(treso_zone, year) %>% 
  filter(age.group == "12-17" | age.group=="18" | age.group=="19" | age.group =="20-49") %>% 
  mutate(OCJCrim = sum(population))%>% 
  summarise(OCJCrim = first(OCJCrim))

treso_population_SCJCrim <- treso_population_x %>% 
  group_by(treso_zone, year) %>% 
  filter(age.group=="18" | age.group=="19" | age.group =="20-49") %>% 
  mutate(SCJCrim = sum(population))%>% 
  summarise(SCJCrim = first(SCJCrim))

treso_population_OCJFam <- treso_population_x %>% 
  group_by(treso_zone, year) %>% 
  filter(age.group=="0-11" | age.group=="12-17") %>% 
  mutate(OCJFam = sum(population))%>% 
  summarise(OCJFam = first(OCJFam))

treso_population_SCJFam <- treso_population_x %>% 
  group_by(treso_zone, year) %>% 
  filter(age.group=="0-11" | age.group=="12-17" | age.group=="18" | age.group=="19" | age.group =="20-49" | age.group =="50-59") %>% 
  mutate(SCJFam = sum(population))%>% 
  summarise(SCJFam = first(SCJFam))

treso_population_Civil <- treso_population_x %>% 
  group_by(treso_zone, year) %>% 
  filter(age.group =="20-49" | age.group =="50-59"| age.group =="60-69") %>% 
  mutate(Civil = sum(population))%>% 
  summarise(Civil = first(Civil))

treso_population_Smac <- treso_population_x %>% 
  group_by(treso_zone, year) %>% 
  filter(age.group =="20-49" | age.group =="50-59"| age.group =="60-69") %>% 
  mutate(Smac = sum(population)) %>% 
  summarise(Smac = first(Smac))

treso_population_bl <- treso_population_x %>% 
  select(-age.group, - population) %>% 
  group_by(treso_zone, year) %>% 
  full_join(select(treso_population_OCJCrim, OCJCrim, treso_zone, year), by = c("treso_zone", "year")) %>% 
  full_join(select(treso_population_SCJCrim, SCJCrim, treso_zone, year), by = c("treso_zone", "year")) %>%
  full_join(select(treso_population_OCJFam, OCJFam, treso_zone, year), by = c("treso_zone", "year")) %>%
  full_join(select(treso_population_SCJFam, SCJFam, treso_zone, year), by = c("treso_zone", "year")) %>%
  full_join(select(treso_population_Civil, Civil, treso_zone, year), by = c("treso_zone", "year")) %>%
  full_join(select(treso_population_Smac, Smac, treso_zone, year), by = c("treso_zone", "year")) %>% 
  summarise(OCJCrim = first(OCJCrim), SCJCrim = first(SCJCrim), OCJFam = first(OCJFam), SCJFam = first(SCJFam), Civil = first(Civil), Smac = first(Smac)) %>% 
  left_join(select(treso_zone_system, treso_id, cduid), by = c("treso_zone" = "treso_id")) %>% 
  replace(., is.na(.), 0)
  
rm(treso_population_Smac, treso_population_Civil, treso_population_SCJFam, treso_population_OCJFam, treso_population_SCJCrim, treso_population_OCJCrim)

##Calculate population growth rates

treso_population_bl_long <- treso_population_bl %>%
  rename(civil = 'Civil',
         OCJcrim = 'OCJCrim',
         SCJcrim = 'SCJCrim',
         OCJfam = 'OCJFam',
         SCJfam = 'SCJFam',
         smac = 'Smac') %>%
  gather(casetypes,population,OCJcrim:smac) %>%
  arrange(treso_zone, casetypes , year)

saveRDS(treso_population_bl_long, "cache/mag/treso_population_bl_long.rds")

##sum up from the treso population to the cd population of the courts and attach a treso id to each court all to the crthrs2

treso_population_rolled_cd <- treso_population_bl_long %>% 
  group_by(year, cduid,casetypes) %>%
  summarise(population = sum(population))

crthrs2 <- crthrs %>% ##this needs to be updated with the table paul is updating
  left_join(treso_population_rolled_cd, by = c('year', 'casetypes', 'cduid')) %>% 
  mutate_at("year", as.numeric) %>% 
  rename(hours = value, treso_id = treso.id.pos) %>% 
  select(-lat, -long, -csduid, -csdname, - courthouse.lat, - courthouse.long)

```

## Base Year Values

```{r population rates for base year 2018}
modernization_factor = 1

## assign base year model weights to the appropriate year
baseyearmodels_adj <- baseyearmodels %>% 
  mutate(Year = Year + max(crthrs2$year))

##Create starting year part rates, then calculate starting year (most recent data year)hours
crthrs_master <- crthrs2 %>% 
  mutate(pop_rate = hours/population) %>% 
  left_join(baseyearmodels_adj, by = c('year' = 'Year')) %>% 
  mutate(mod1_5y = Weight_5y*pop_rate*modernization_factor,
         mod2_cr = Weight_cr*pop_rate*modernization_factor,
         mod3_cust = weight_custom*pop_rate*modernization_factor) %>% 
  group_by(cduid, casetypes) %>% 
  mutate(mod1_5y)
  

## Calculate the base year part rate by model to be applied to future years
baseyear <- crthrs_master %>% 
  group_by(bid, name, treso_id, cduid, casetypes) %>%
  summarise_at(c('mod1_5y','mod2_cr','mod3_cust'),sum) %>% 
  group_by(cduid, casetypes) %>%  
  summarise(mod1_5y = mean(mod1_5y), mod2_cr = mean(mod2_cr), mod3_cust = mean(mod3_cust)) 
  

saveRDS(baseyear, "cache/mag/baseyear_rates")

```


## Projections

```{r 5-year rates to projection years by business lines}
##develop table that applies the 5-year rate to projection years by business lines - rate calculation method can be changed later on

future_pop_bl <- readRDS("cache/mag/baseyear_rates") %>%
  left_join(treso_population_rolled_cd, by =c("cduid", "casetypes")) %>%
  spread(key = "year", value = "population") %>%
  select(-"2011",-"2012",-"2013", -"2014", -"2015", -"2016", -"2017") %>%
  mutate_at(.funs = funs(.*mod1_5y), .vars = vars(starts_with("20"))) %>%
  select(-mod1_5y,-mod2_cr,-mod3_cust) %>%
  gather(year, crthrs, `2018`:`2041`)

saveRDS(future_pop_bl, "cache/mag/future_pop_pl")



##develop table that applies the 5-year rates to TRESO crthrs projections

treso_pop_by_bl <- readRDS("cache/mag/treso_population_bl_long.rds")

baseyear_temp <- readRDS("cache/mag/baseyear_rates") %>% 
  ungroup() 

treso_population_bl_demand <- treso_pop_by_bl %>%
  select(cduid, everything()) %>% 
  arrange(cduid, treso_zone, casetypes, year) %>% 
  left_join(select(baseyear_temp, cduid, casetypes, mod1_5y), by = c("casetypes", "cduid"))%>% 
  na.omit() %>% #cd 3546 & 3553 don't have courts. Their demand is incorporated in the produced rate of other CDs and are therefore removed
  mutate(crthrs.demand = population*mod1_5y)

saveRDS(treso_population_bl_demand, "output/mag/treso_population_bl_demand.rds")

```


#Distribution

## Court Hours Distribution
```{r}
assessment_year = 2018
temp <- c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac')

##prep complete origin list
treso_demand_origin_temp <- readRDS("output/mag/treso_population_bl_demand.rds") %>% 
  filter(year == assessment_year) %>% 
  select(treso_zone, casetypes, crthrs.demand)

treso_demand_list_temp <- readRDS("output/por_full.rds") %>% 
  arrange(orig) %>% 
  left_join(treso_demand_origin, by = c("orig" = "treso_zone")) %>% 
  expand(orig, temp)

treso_orig <- treso_demand_list_temp %>% 
  left_join(treso_demand_origin, by = c(casetypes, "orig" = "treso_zone")) 
  
  

treso_demand_origin <- readRDS("output/mag/treso_population_bl_demand.rds") %>% 
  filter(year == assessment_year) %>% 
  select(-year, -population, -mod1_5y)
  



```






# Courtroom Conversion

## Set Parameters

```{r set business line hrs/day and hrs per year}
days_yr<-249

##Utilization Factors
casetypes<- c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac' ) #error in hours - flipped by Salah
base_hrs_dy <-c(3.5, 2.6,2.7,2.7,2.4,2.7)
inflect_hrs_dy<-c(4.4,3.7,4.3,4.1,3.5,4.0)
max_hrs_dy<-c(4.5,3.8,4.4,4.3,3.6,4.1)
inflect_hrs<-c(15000, 9000, 5000, 6000, 5000, 6000)
max_hrs<-c(30000,18000,10000,12000,10000,12000)
cur<-data.frame(casetypes,
                base_hrs_dy,inflect_hrs_dy,max_hrs_dy,inflect_hrs,max_hrs,
                stringsAsFactors = FALSE)
saveRDS(cur,"cache/mag/cur.rds")
## There should be a slider for user input changes to max hrs a day to reflect modernization effects
## There should be a slider for higher or lower than forecast hours

```





## Courtrooms Needed

```{r project future courtroom needs}
#project by case

projection_casetype_needs <- readRDS("cache/mag/future_pop_pl") %>% 
  left_join(cur, by = "casetypes") %>% 
  mutate(utilization = 0) %>% 
  mutate(utilization = ifelse(crthrs <= inflect_hrs,
                              base_hrs_dy + (inflect_hrs_dy - base_hrs_dy) / (inflect_hrs - 0 ) * crthrs,
                              utilization)) %>% 
  mutate(utilization = ifelse(crthrs > inflect_hrs & crthrs <= max_hrs,
                              inflect_hrs_dy + (max_hrs_dy - inflect_hrs_dy) * (crthrs - inflect_hrs) / (max_hrs - inflect_hrs),
                              utilization)) %>% 
  mutate(utilization = ifelse(crthrs > max_hrs,
                              max_hrs_dy,
                              utilization)) %>% 
  mutate(courtrooms_needed = round(crthrs / (utilization * 249), digits = 2))
  
total_court_needs <- projection_casetype_needs %>%
  select(-c("base_hrs_dy":"max_hrs")) %>%
  left_join(select(crthrs, name, number_of_courtrooms), by = "name") %>%
  group_by(cduid, bid, name, year, casetypes, courtrooms_needed) %>% 
  summarise(number_of_courtrooms = first(number_of_courtrooms), treso_id = first(treso_id)) %>% 
  group_by(cduid, treso_id, bid, casetypes, year) %>% 
  summarise(courtrooms_needed = sum(courtrooms_needed), number_of_courtrooms = first(number_of_courtrooms))


saveRDS(total_court_needs, "output/mag/total_court_needs.rds")

```


```{r match courtroom needs to current courtroom assets}

##distribute the 2018 number of courtrooms by casetype and courthouse
court_list_demand_final <- total_court_needs %>%
  ungroup() %>% 
  filter(year==2018) %>% 
  group_by(cduid, casetypes) %>% 
  summarise(courtrooms_needed = sum(courtrooms_needed), number_of_courtrooms = first(number_of_courtrooms)) %>% 
  left_join(select(courthouse_asset, treso.id.pos, bid, cduid, name, address, city, building.type, courtrooms), by = "cduid") %>%
  mutate(court_factor = courtrooms/number_of_courtrooms) %>% 
  mutate(courtroom_demand_section = court_factor*courtrooms_needed) %>% 
  select(treso.id.pos, casetypes, courtroom_demand_section)

treso_proportion <- court_list_demand_final %>% 
  group_by(cduid, casetypes) %>% 
  summarise(courtroom_demand_section = sum(courtroom_demand_section))

dest_vector <- court_list_demand_final%>% 
  unite("dest", treso.id.pos:casetypes, remove = TRUE) %>% 
  ungroup() %>% 
  select(-cduid)


  


```


---
title: "courts"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rgdal)
source("helpers.R")
```


# General Assumptions

  - Satellite courts lack data, therefore
    - Satellite courts are assumed to service the same set of business lines as the base court in the CD
    - Satellite courts are assumed to have 1 courtroom
  - Assume individuals appear at courthouses within their CD of home origin
  - Assume that a portion of of individuals are "assigned" and another portion chooses closeset available courtroom
    - This split is defaulted to 20/80 for civil, family, small claims and 10/90 for OCJcrim, SCJcrim
  - Four years of back data may not be enough to tease out future trends where hrs/case is increasing and may cause an inflection in forecast years
  
# To-Do
  - slider for base, inflection, max, by business line
  - treso regression characteristic breakdown

## Import Data

```{r import data}
# TRESO 
treso_shp <- readOGR(dsn ="input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("cache/treso_tb.rds")
treso_zone_system <- read.csv("input/treso/treso_zone_system.csv")

# TRESO Travel TIme Skims to distribute demand to courts
travel_time_skim <- readRDS("output/treso_travel_time.rds")

# TRESO projection population with MAG related segmentations
treso_population <- readRDS("input/mag/treso_population_mag.rds")

# Courthouse hours dataset
court_hours <- readRDS("cache/mag/courthouse_hours.rds")

# Courthouse asset lists that includes satellite & base courts
courthouse_asset <- readRDS("cache/mag/courthouse_master.rds")
```

## Data Preparation

```{r data preparation}
# Gather the TRESO Population table into long format
treso_population_spread <- treso_population %>% 
  select(-csduid) %>% 
  rename_at(vars(contains("population")), funs(substr(., 12, 15))) %>% 
  gather(key="year", value = "population", -treso_zone, -age.group)

# Transform age ranges to business line populations by zone and projection year
treso_population_bl <- treso_population_spread %>% 
  mutate(OCJcrim = ifelse(age.group %in% c("12-17", "18", "19", "20-49"), population, 0)) %>% 
  mutate(SCJcrim = ifelse(age.group %in% c("18", "19", "20-49"), population, 0)) %>% 
  mutate(OCJfam = ifelse(age.group %in% c("0-11", "12-17"), population, 0)) %>% 
  mutate(SCJfam = ifelse(age.group %in% c("0-11", "12-17", "18", "19", "20-49", "50-59"), population, 0)) %>% 
  mutate(civil = ifelse(age.group %in% c("20-49", "50-59", "60-69"), population, 0)) %>%
  mutate(smac = ifelse(age.group %in% c("20-49", "50-59", "60-69"), population, 0)) %>%
  group_by(treso_zone, year) %>% 
  summarise_if(is.numeric, sum) %>% 
  left_join(select(treso_zone_system, treso_id, cduid, cdname), by = c("treso_zone" = "treso_id"))

# Output the population by business line as long format
treso_population_bl_long <- treso_population_bl %>%
  gather(casetypes, population, OCJcrim:smac) %>%
  arrange(treso_zone, casetypes , year) %>% 
  ungroup()

saveRDS(treso_population_bl_long, "cache/mag/treso_population_bl_long.rds")

```


```{r combine hours with population}
treso_population_bl_long <- readRDS("cache/mag/treso_population_bl_long.rds")
# Summarize to CD level for population
# Combine with hours 
treso_population_bl_cd <- treso_population_bl_long %>% 
  group_by(year, cduid, cdname, casetypes) %>%
  summarise(population = sum(population)) %>% 
  ungroup()

court_rate <- court_hours %>% 
  left_join(treso_population_bl_cd, by = c('year', 'casetypes', 'cduid', 'cdname')) %>% 
  mutate_at("year", as.numeric) %>% 
  rename(hours = value, treso_id = treso.id.pos) %>% 
  select(-lat, -long, -csduid, -csdname, - courthouse.lat, - courthouse.long)

```

# Rate Calculation
## Base Year Rates
  
```{r business line parameter matrices}

casetypes <- c('OCJCrim','SCJCrim','OCJFam','SCJFam','Civil','SmaC' ) 
maxmagage <- c(49,49,17,59,69,69)
minmagage <- c(12,18,0,0,20,20)
projperiod <- 10
baseyearmodels <- tibble('Year'=c(-4,-3,-2,-1,0),
                            'Weight_5y'=c(.2,.2,.2,.2,.2),
                            'Weight_cr'=c(0,0,0,0,1),
                            'weight_custom'=c(0,0,0,0,0))
```

```{r population rates for base year 2018}
BASE_YEAR <- 2018
WEIGHT_FACTOR <- "five_years"

if (WEIGHT_FACTOR == "five_years") {
  # Equally weight the five past years to calculate population rates
  court_hours_master <- court_rate %>% 
    filter(year >= (BASE_YEAR - 5)) %>%
    group_by(bid, name, cduid, cdname, casetypes, year) %>% 
    summarise(population = sum(population), hours = sum(hours)) %>% 
    mutate(pop.rate = hours / population)
    
} else if (WEIGHT_FACTOR == "recent_year") {
  # Only use the previous year to calculate population rates
  court_hours_master <- court_rate %>% 
    filter(year >= (BASE_YEAR)) %>%
    group_by(bid, name, cduid, cdname, casetypes, year) %>% 
    summarise(population = sum(population), hours = sum(hours)) %>% 
    mutate(pop.rate = hours / population)
}

# Weight the hospitals in the same CD by hours
baseyear_rates <- court_hours_master %>% 
  group_by(bid, name, cduid, cdname, casetypes) %>% 
  summarise(pop.rate = mean(pop.rate),
            hours = sum(hours)) %>% 
  group_by(cduid, cdname, casetypes) %>% 
  summarise(pop.rate = weighted.mean(pop.rate, hours)) %>% 
  replace_na(list(pop.rate = 0))
saveRDS(baseyear_rates, "cache/mag/baseyear_rates.rds")
```

## Projections

```{r 5-year rates to projection years by business lines}
MODERNIZATION_FACTOR = 1

## develop table that applies the 5-year rate to projection years by business lines - rate calculation method can be changed later on

future_pop_bl <- readRDS("cache/mag/baseyear_rates.rds") %>%
  left_join(treso_population_bl_cd, by =c("cduid", "cdname", "casetypes")) %>%
  spread(key = "year", value = "population") %>%
  select(-"2011",-"2012",-"2013", -"2014", -"2015", -"2016", -"2017") %>%
  mutate_at(.funs = funs(.*mod1_5y), .vars = vars(starts_with("20"))) %>%
  select(-mod1_5y,-mod2_cr,-mod3_cust) %>%
  gather(year, court_hours, `2018`:`2041`)

saveRDS(future_pop_bl, "cache/mag/future_pop_pl")



##develop table that applies the 5-year rates to TRESO court_hours projections

treso_pop_by_bl <- readRDS("cache/mag/treso_population_bl_long.rds")

baseyear_temp <- readRDS("cache/mag/baseyear_rates") %>% 
  ungroup() 

treso_population_bl_demand <- treso_pop_by_bl %>%
  select(cduid, everything()) %>% 
  arrange(cduid, treso_zone, casetypes, year) %>% 
  left_join(select(baseyear_temp, cduid, casetypes, mod1_5y), by = c("casetypes", "cduid"))%>% 
  na.omit() %>% #cd 3546 & 3553 don't have courts. Their demand is incorporated in the produced rate of other CDs and are therefore removed
  mutate(court_hours.demand = population*mod1_5y)

saveRDS(treso_population_bl_demand, "output/mag/treso_population_bl_demand.rds")

```


#Distribution

## Court Hours Distribution
```{r}
assessment_year = 2018
temp <- c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac')

##prep complete origin list
treso_demand_origin_temp <- readRDS("output/mag/treso_population_bl_demand.rds") %>% 
  filter(year == assessment_year) %>% 
  select(treso_zone, casetypes, court_hours.demand)

treso_demand_list_temp <- readRDS("output/por_full.rds") %>% 
  arrange(orig) %>% 
  left_join(treso_demand_origin, by = c("orig" = "treso_zone")) %>% 
  expand(orig, temp)

treso_orig <- treso_demand_list_temp %>% 
  left_join(treso_demand_origin, by = c(casetypes, "orig" = "treso_zone")) 
  
  

treso_demand_origin <- readRDS("output/mag/treso_population_bl_demand.rds") %>% 
  filter(year == assessment_year) %>% 
  select(-year, -population, -mod1_5y)
  



```






# Courtroom Conversion

## Set Parameters

```{r set business line hrs/day and hrs per year}
days_yr<-249

##Utilization Factors
casetypes<- c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac' ) #error in hours - flipped by Salah
base_hrs_dy <-c(3.5, 2.6,2.7,2.7,2.4,2.7)
inflect_hrs_dy<-c(4.4,3.7,4.3,4.1,3.5,4.0)
max_hrs_dy<-c(4.5,3.8,4.4,4.3,3.6,4.1)
inflect_hrs<-c(15000, 9000, 5000, 6000, 5000, 6000)
max_hrs<-c(30000,18000,10000,12000,10000,12000)
cur<-data.frame(casetypes,
                base_hrs_dy,inflect_hrs_dy,max_hrs_dy,inflect_hrs,max_hrs,
                stringsAsFactors = FALSE)
saveRDS(cur,"cache/mag/cur.rds")
## There should be a slider for user input changes to max hrs a day to reflect modernization effects
## There should be a slider for higher or lower than forecast hours

```





## Courtrooms Needed

```{r project future courtroom needs}
#project by case

projection_casetype_needs <- readRDS("cache/mag/future_pop_pl") %>% 
  left_join(cur, by = "casetypes") %>% 
  mutate(utilization = 0) %>% 
  mutate(utilization = ifelse(court_hours <= inflect_hrs,
                              base_hrs_dy + (inflect_hrs_dy - base_hrs_dy) / (inflect_hrs - 0 ) * court_hours,
                              utilization)) %>% 
  mutate(utilization = ifelse(court_hours > inflect_hrs & court_hours <= max_hrs,
                              inflect_hrs_dy + (max_hrs_dy - inflect_hrs_dy) * (court_hours - inflect_hrs) / (max_hrs - inflect_hrs),
                              utilization)) %>% 
  mutate(utilization = ifelse(court_hours > max_hrs,
                              max_hrs_dy,
                              utilization)) %>% 
  mutate(courtrooms_needed = round(court_hours / (utilization * 249), digits = 2))
  
total_court_needs <- projection_casetype_needs %>%
  select(-c("base_hrs_dy":"max_hrs")) %>%
  left_join(select(court_hours, name, number_of_courtrooms), by = "name") %>%
  group_by(cduid, bid, name, year, casetypes, courtrooms_needed) %>% 
  summarise(number_of_courtrooms = first(number_of_courtrooms), treso_id = first(treso_id)) %>% 
  group_by(cduid, treso_id, bid, casetypes, year) %>% 
  summarise(courtrooms_needed = sum(courtrooms_needed), number_of_courtrooms = first(number_of_courtrooms))


saveRDS(total_court_needs, "output/mag/total_court_needs.rds")

```


```{r match courtroom needs to current courtroom assets}

##distribute the 2018 number of courtrooms by casetype and courthouse
court_list_demand_final <- total_court_needs %>%
  ungroup() %>% 
  filter(year==2018) %>% 
  group_by(cduid, casetypes) %>% 
  summarise(courtrooms_needed = sum(courtrooms_needed), number_of_courtrooms = first(number_of_courtrooms)) %>% 
  left_join(select(courthouse_asset, treso.id.pos, bid, cduid, name, address, city, building.type, courtrooms), by = "cduid") %>%
  mutate(court_factor = courtrooms/number_of_courtrooms) %>% 
  mutate(courtroom_demand_section = court_factor*courtrooms_needed) %>% 
  select(treso.id.pos, casetypes, courtroom_demand_section)

treso_proportion <- court_list_demand_final %>% 
  group_by(cduid, casetypes) %>% 
  summarise(courtroom_demand_section = sum(courtroom_demand_section))

dest_vector <- court_list_demand_final%>% 
  unite("dest", treso.id.pos:casetypes, remove = TRUE) %>% 
  ungroup() %>% 
  select(-cduid)


  


```

# Linear Regression

- Explore whether there are any linear relationships between age groups and certain court hours

```{r explore linear regression}
library(perturb)

treso_2016_population <- readRDS("input/mag/treso_2016_population_mag.rds") %>% 
  left_join(treso_zone_system, by = c("treso_zone" = "treso_id")) %>% 
  select(treso_zone, age.group, population, cduid, cdname) %>% 
  mutate(cdname = as.character(cdname)) %>% 
  group_by(cduid, cdname, age.group) %>% 
  summarise(population = sum(population)) %>% 
  ungroup() %>% 
  spread(key = "age.group", value = "population") %>% 
  mutate(adult = adult.20s + adult.30s + adult.40s + adult.50s + adult.60s) %>% 
  mutate(senior = senior.70s + senior.80s) %>% 
  mutate(majority = adult + senior) %>% 
  mutate(minor = child + youth + young.adult) %>% 
  mutate(total = majority + minor)

court_hours_2016 <- court_hours %>%
  select(-lat, -long, -csduid, -csdname, -area, -region, -courthouse.lat, -courthouse.long) %>% 
  filter(year == 2016) %>% 
  group_by(cduid, cdname, casetypes) %>%
  summarise(value = sum(value)) %>% 
  ungroup() %>% 
  spread(key = "casetypes", value = "value") %>% 
  left_join(treso_2016_population, by = c("cduid", "cdname")) %>% 
  select(-cduid, -cdname) %>% 
  mutate_if(is.numeric, list(ln = log1p, sqrt = sqrt, log = log10, sq = ~.^2, scale = scale)) 

```

```{r building models - OCJcrim}
r1 <- resid(lm(young.adult_ln ~ adult.20s_ln, data = court_hours_2016))
summary(mod)

plot(mod)
```

```{r building models - SCJcrim}
r1 <- resid(lm(adult.30s_sqrt ~ adult.20s_sqrt, data = court_hours_2016))
mod <- lm(SCJcrim_sqrt ~ adult.20s_sqrt + r1, data = court_hours_2016)
summary(mod)
plot(mod)
```

```{r building models - OCJfam}
mod <- lm(OCJfam ~ adult.30s_sqrt + adult.50s_sqrt + child, data = court_hours_2016)
summary(mod)
plot(mod)

# Comment - it was found that to have a high R^2 and proper signs with the `child` term, the only transformation is the non-transformed version.
```

```{r building models - SCJfam}
mod <- lm(SCJfam ~ youth_sqrt + senior.70s, data = court_hours_2016)
summary(mod)
plot(mod)
```

```{r building models - civil}

mod <- lm(civil_sqrt ~ young.adult_sqrt + adult.20s_sqrt + senior.80s_sqrt, data = court_hours_2016)
summary(mod)
print(colldiag(mod))
plot(mod)
```

```{r building models - smac}
rMod <- residuals(lm(adult.30s ~ adult.20s, data = court_hours_2016))
mod <- lm(smac ~ adult.20s_sqrt + rMod, data = court_hours_2016)
cd <- colldiag(mod)
cd

mod <- lm(smac ~ adult.20s_sqrt + adult.30s_sqrt, data = court_hours_2016)
cd <- colldiag(mod)
cd

#plot(mod)

```
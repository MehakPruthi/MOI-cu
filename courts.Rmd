---
title: "courts"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rgdal)
library(future.apply)
library(data.table)
source("helpers.R")
```


# General Assumptions

  - Satellite courts lack data, therefore
    - Satellite courts are assumed to service the same set of business lines as the base court in the CD
    - Satellite courts are assumed to have 1 courtroom
  - Assume individuals appear at courthouses within their CD of home origin
  - Assume that a portion of of individuals are "assigned" and another portion chooses closeset available courtroom
    - This split is defaulted to 20/80 for civil, family, small claims and 10/90 for OCJcrim, SCJcrim
  - Four years of back data may not be enough to tease out future trends where hrs/case is increasing and may cause an inflection in forecast years
  
# To-Do
  - slider for base, inflection, max, by business line
  - treso regression characteristic breakdown

## Import Data

```{r import data}
# TRESO 
treso_shp <- readOGR(dsn ="input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("cache/treso_tb.rds")
treso_zone_system <- read.csv("input/treso/treso_zone_system.csv")

# TRESO Travel TIme Skims to distribute demand to courts
travel_time_skim <- readRDS("output/treso_travel_time.rds")

# TRESO projection population with MAG related segmentations
treso_population <- readRDS("input/mag/treso_population_mag.rds")

# Courthouse hours dataset
court_hours <- readRDS("cache/mag/courthouse_hours.rds")

# Courthouse asset lists that includes satellite & base courts
courthouse_asset <- readRDS("cache/mag/courthouse_master.rds")
```

## Data Preparation

```{r data preparation}
# Gather the TRESO Population table into long format
treso_population_spread <- treso_population %>% 
  select(-csduid) %>% 
  rename_at(vars(contains("population")), list(~substr(., 12, 15))) %>% 
  gather(key="year", value = "population", -treso_zone, -age.group)

# Transform age ranges to business line populations by zone and projection year
treso_population_bl <- treso_population_spread %>% 
  mutate(OCJcrim = ifelse(age.group %in% c("12-17", "18", "19", "20-49"), population, 0)) %>% 
  mutate(SCJcrim = ifelse(age.group %in% c("18", "19", "20-49"), population, 0)) %>% 
  mutate(OCJfam = ifelse(age.group %in% c("0-11", "12-17"), population, 0)) %>% 
  mutate(SCJfam = ifelse(age.group %in% c("0-11", "12-17", "18", "19", "20-49", "50-59"), population, 0)) %>% 
  mutate(civil = ifelse(age.group %in% c("20-49", "50-59", "60-69"), population, 0)) %>%
  mutate(smac = ifelse(age.group %in% c("20-49", "50-59", "60-69"), population, 0)) %>%
  group_by(treso_zone, year) %>% 
  summarise_if(is.numeric, sum) %>% 
  left_join(select(treso_zone_system, treso_id, cduid, cdname), by = c("treso_zone" = "treso_id"))

# Output the population by business line as long format
treso_population_bl_long <- treso_population_bl %>%
  gather(casetypes, population, OCJcrim:smac) %>%
  arrange(treso_zone, casetypes , year) %>% 
  ungroup()

saveRDS(treso_population_bl_long, "cache/mag/treso_population_bl_long.rds")

```


```{r combine hours with population}
treso_population_bl_long <- readRDS("cache/mag/treso_population_bl_long.rds")
# Summarize to CD level for population
# Combine with hours 
treso_population_bl_cd <- treso_population_bl_long %>% 
  group_by(year, cduid, cdname, casetypes) %>%
  summarise(population = sum(population)) %>% 
  ungroup()

court_hours_population <- court_hours %>% 
  left_join(treso_population_bl_cd, by = c('year', 'casetypes', 'cduid', 'cdname')) %>% 
  mutate_at("year", as.numeric) %>% 
  rename(hours = value, treso_id = treso.id.pos) %>% 
  select(-lat, -long, -csduid, -csdname, - courthouse.lat, - courthouse.long)

# IMPORTANT
# CD 3553 (Greater Sudbury) is within CD 3552 (Sudbury)
# The courts are located in Greater Sudbury, so the two CDs are combined and treated as one CD
sudbury_population_bl_cd <- treso_population_bl_cd %>% 
  mutate_at("year", as.numeric) %>% 
  filter(cduid == 3552) %>% 
  mutate(cduid = 3553) %>% 
  rename(population.sudbury = population) %>% 
  select(year, cduid, casetypes, population.sudbury)
  
court_hours_population <- court_hours_population %>% 
  left_join(sudbury_population_bl_cd, by = c("cduid", "year", "casetypes")) %>% 
  mutate(population = ifelse(is.na(population.sudbury), population, population + population.sudbury))

cat(paste0("Quick check that the population in", "\n",
           "CD 3553 and 3552 is: ", 
           sum(filter(treso_population_bl_cd, year == 2018, cduid %in% c(3552, 3553))$population), "\n",
           "Combined is: ",
           (filter(court_hours_population, year == 2018, cduid == 3553) %>% group_by(bid, cduid) %>% summarise(population = sum(population)))$population[1]))

```

# Rate Calculation
## Base Year Rates
  
```{r business line parameter matrices}
casetypes <- c('OCJCrim','SCJCrim','OCJFam','SCJFam','Civil','SmaC' ) 
maxmagage <- c(49,49,17,59,69,69)
minmagage <- c(12,18,0,0,20,20)
projperiod <- 10
baseyearmodels <- tibble('Year'=c(-4,-3,-2,-1,0),
                            'Weight_5y'=c(.2,.2,.2,.2,.2),
                            'Weight_cr'=c(0,0,0,0,1),
                            'weight_custom'=c(0,0,0,0,0))
```

```{r population rates for base year 2018}
BASE_YEAR <- 2018
WEIGHT_FACTOR <- "recent_year"
WEIGHT_CUSTOM = tibble("year" = c(2018, 2017, 2016, 2015, 2014),
                       "weight" = c(1, 1, 1, 1, 1))


if (WEIGHT_FACTOR == "five_years") {
  # Equally weight the five past years to calculate population rates
  court_rate <- court_hours_population %>% 
    filter(year >= (BASE_YEAR - 5)) %>%
    group_by(bid, name, cduid, cdname, casetypes, year) %>% 
    # Population is duplicated for each bid, so don't sum it up
    summarise(population = first(population), hours = sum(hours)) %>% 
    mutate(pop.rate = hours / population) %>% 
  # Average the years, if there are differences
    group_by(bid, name, cduid, cdname, casetypes) %>% 
    summarise(pop.rate = mean(pop.rate),
              hours = sum(hours))
    
} else if (WEIGHT_FACTOR == "recent_year") {
  # Only use the previous year to calculate population rates
  court_rate <- court_hours_population %>% 
    filter(year >= (BASE_YEAR)) %>%
    group_by(bid, name, cduid, cdname, casetypes, year) %>% 
    summarise(population = sum(population), hours = sum(hours)) %>% 
    mutate(pop.rate = hours / population) %>% 
  # Average the years, if there are differences
    group_by(bid, name, cduid, cdname, casetypes) %>% 
    summarise(pop.rate = mean(pop.rate),
              hours = sum(hours))
  
} else if (WEIGHT_FACTOR == "custom") {
  # Use a custom weighting system
  court_rate <- court_hours_population %>% 
    left_join(WEIGHT_CUSTOM, by = "year") %>% 
    filter(!is.na(weight)) %>%
    group_by(bid, name, cduid, cdname, casetypes, year) %>% 
    summarise(population = sum(population), hours = sum(hours)) %>% 
    mutate(pop.rate = hours / population) %>% 
    # Average the years, if there are differences
    group_by(bid, name, cduid, cdname, casetypes) %>% 
    summarise(pop.rate = weighted.mean(pop.rate, weight),
              hours = sum(hours))
}

baseyear_rates <- court_rate %>% 
  # Add the contribution of the multiple hospitals together
  group_by(cduid, cdname, casetypes) %>% 
  summarise(pop.rate = sum(pop.rate)) %>% 
  replace_na(list(pop.rate = 0)) %>% 
  ungroup()
saveRDS(baseyear_rates, "cache/mag/baseyear_rates.rds")
```

## Projection Cases

```{r project cases by business lines}
MODERNIZATION_FACTOR = 1

future_cases_bl <- readRDS("cache/mag/baseyear_rates.rds") %>%
  left_join(treso_population_bl_cd, by = c("cduid", "cdname", "casetypes")) %>%
  spread(key = "year", value = "population") %>%
  select(-`2011`:-`2017`) %>%
  mutate_at(vars(starts_with("20")), list(~(. * pop.rate))) %>% 
  gather(year, court.hours, `2018`:`2041`)

saveRDS(future_cases_bl, "cache/mag/future_cases_bl.rds")

# Sanity check - this will miss population from Sudbury, so it will be slightly lower than observed
# But in the TRESO level which is what is actually used in modelling - Sudbury will share the rates of
# Greater Sudbury
print("If the 'recent_year' flag is used to calculate the baseyear_rate, then the court hours in 2018 should match")

print(filter(future_cases_bl, year == 2018) %>% group_by(cduid, cdname, casetypes) %>% summarise(court.hours = sum(court.hours)))

print(filter(court_hours_population, year == 2018) %>% group_by(cduid, cdname, casetypes) %>% summarise(court.hours = sum(hours)))

print(paste0("The calculated court hours is: ", (sum(filter(future_cases_bl, year == 2018)$court.hours)),
             " While the historical 2018 court hours is: ", (sum(filter(court_hours_population, year == 2018)$hours))))

# Calculate the cases at TRESO level
future_cases_bl_treso <- readRDS("cache/mag/treso_population_bl_long.rds")
baseyear_rates <- readRDS("cache/mag/baseyear_rates.rds")

# CD 3546 (Haliburton) is missing court hours, CD 3552 (Sudbury) will share rates from CD 3553 (Greater Sudbury)
# The case rates were calculated using the combined population
sudbury_rates <- baseyear_rates %>% 
  filter(cduid == 3553) %>% 
  select(cduid, casetypes, pop.rate) %>% 
  mutate(cduid = 3552) %>% 
  rename(pop.rate.sudbury = pop.rate)

future_cases_bl_treso <- future_cases_bl_treso %>% 
  left_join(baseyear_rates, by = c("cduid", "cdname", "casetypes")) %>% 
  left_join(sudbury_rates, by = c("cduid", "casetypes")) %>% 
  mutate(pop.rate = ifelse(!is.na(pop.rate.sudbury), pop.rate.sudbury, pop.rate)) %>% 
  select(-pop.rate.sudbury) %>% 
  mutate(court.hours = population * pop.rate) %>% 
  # TODO remove drop_na once hours for Haliburton is obtained
  drop_na(court.hours)

# Sanity Check
print(paste0("The calculated court hours is: ", (sum(filter(future_cases_bl_treso, year == 2018)$court.hours)),
             " While the historical 2018 court hours is: ", (sum(filter(court_hours_population, year == 2018)$hours))))

saveRDS(future_cases_bl_treso, "cache/mag/future_cases_bl_treso.rds")
```

# Courtroom Required

```{r courtroom required}
MODEL_YEAR <- 2018
CARETYPE_LIST <- c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac')
OP_DAYS <- 249
NEW_COURTROOM_SIZE <- 11500

# Utilization table for each business line
utilization_rate <- tibble(casetypes = c('OCJcrim','SCJcrim','OCJfam','SCJfam','civil','smac'),
                           base.hours.dy = c(3.5, 2.6, 2.7, 2.7, 2.4, 2.7),
                           inflect.hours.dy = c(4.4, 3.7, 4.3, 4.1, 3.5, 4.0),
                           max.hours.dy = c(4.5, 3.8, 4.4, 4.3, 3.6, 4.1),
                           inflect.hours = c(15000, 9000, 5000, 6000, 5000, 6000),
                           max.hours = c(30000, 18000, 10000, 12000, 10000, 12000)
                           )

saveRDS(utilization_rate, "cache/mag/utilization_rate.rds")

# Calculate future court hours needed
future_needs <- readRDS("cache/mag/future_cases_bl.rds") %>%  
  left_join(utilization_rate, by = "casetypes") %>% 
  mutate(op.utilization = 0) %>% 
  mutate(op.utilization = ifelse(court.hours <= inflect.hours,
                              base.hours.dy + (inflect.hours.dy - base.hours.dy) / (inflect.hours - 0 ) * court.hours,
                              op.utilization)) %>% 
  mutate(op.utilization = ifelse(court.hours > inflect.hours & court.hours <= max.hours,
                              inflect.hours.dy + (max.hours.dy - inflect.hours.dy) * (court.hours - inflect.hours) / (max.hours - inflect.hours),
                              op.utilization)) %>% 
  mutate(op.utilization = ifelse(court.hours > max.hours,
                              max.hours.dy,
                              op.utilization)) %>% 
  mutate(courtrooms.needed = round(court.hours / (op.utilization * OP_DAYS), digits = 2))
  
# Summarise the courthours needed per courthouse
future_courthours_needed <- future_needs %>% 
  group_by(cduid, cdname, year, casetypes) %>%
  summarise(courthours.needed = sum(court.hours))

# Summarise the courtooms needed per courthouse
future_courtrooms_needed <- future_needs %>% 
  group_by(cduid, cdname, year) %>% 
  summarise(courtrooms.needed = sum(courtrooms.needed)) %>% 
  spread(key = year, value = courtrooms.needed) %>% 
  rename_at(vars(starts_with("20")), list(~ utility_rename(.)))

# Summarise courtrooms needed with the existing 2018 courtrooms dataset
courtroom_needed <- courthouse_asset %>%
  filter(year == 2018) %>% 
  group_by(cduid, cdname) %>% 
  summarise(number.of.courtrooms.2018 = sum(courtrooms),
            rentable.square.feet.2018 = sum(rentable.square.feet)) %>% 
  left_join(future_courtrooms_needed, by = c("cduid", "cdname")) %>%   
  mutate(required.square.feet = get(paste0("courtrooms.needed.", MODEL_YEAR)) * NEW_COURTROOM_SIZE) %>% 
  ungroup()

saveRDS(courtroom_needed, "output/mag/courtroom_needed")
  
```

# Demand Distribution

```{r demand distribution}
# Prepare the origin demand vector for selected year
treso_demand_origin <- readRDS("cache/mag/future_cases_bl_treso.rds") %>%
  rename(treso.id.por = treso_zone) %>% 
  filter(year == MODEL_YEAR) %>%
  select(-year, -population, -pop.rate)

# Create a list of courthouses available in each CD
courthouse_available <- courthouse_asset %>%
  group_by(cduid, cdname) %>% 
  summarise(treso.id.pos = paste(treso.id.pos, collapse = ","),
            bid = paste(bid, collapse = ","),
            name = paste(name, collapse = ","),
            building.type = paste(name, collapse = ",")
            )

# Join the list of courthouses available by CD to the origin demand
# Create a NN lookup list for CD with multiple courthouses using TRESO travel time
treso_demand_origin <- left_join(treso_demand_origin, courthouse_available, by = c("cduid", "cdname"))
  
# Apply nearest courthouse by row
nearest_courthouse <- function(row, travel_time_skim) {
  por <- row["treso.id.por"][[1]]
  pos_list <- row["treso.id.pos"][[1]]
  bid_list <- row["bid"][[1]]
  casetypes <- row["casetypes"][[1]]
  
  print(paste0("Origin TRESO Zone: ", por, ". Destination TRESO Zone(s): ", pos_list))
  
  df <- tibble(treso.id.por = por, treso.id.pos = pos_list, bid = bid_list, casetypes = casetypes) %>% 
    # Convert the list of POS to individual rows
    unnest(treso.id.pos = strsplit(treso.id.pos, ","),
           bid = strsplit(bid, ",")) %>% 
    mutate(treso.id.pos = as.numeric(treso.id.pos),
           treso.id.por = as.numeric(treso.id.por)) %>%
    # Merge with TRESO travel times
    # TODO this step is very time consuming
    left_join(travel_time_skim, by = c("treso.id.por", "treso.id.pos")) %>%
    # Identify the closest travel time pair by calculating a travel utility (e^(1/tt))
    mutate(travel.utility = exp(1/value)) %>%
    arrange(desc(travel.utility)) %>%
    mutate(travel.utility.ranking = row_number()) %>%
    # Select the closest courthouse and label it as 1
    # Randomly select another courthouse and label it as 2
    mutate(selected = 0,
           selected = ifelse(travel.utility.ranking == sample(1:max(travel.utility.ranking), 1), 2, selected),
           selected = ifelse(travel.utility.ranking == 1, 1, selected)) %>% 
    filter(selected != 0) %>% 
    group_by(treso.id.por, casetypes) %>%
    summarise(treso.id.pos = paste(treso.id.pos, collapse = ","),
              selected = paste(selected, collapse = ","),
              bid = paste(bid, collapse = ","))


}

# Adjust the max size limit for future()
options(future.globals.maxSize= 891289600)
plan(multiprocess)
result <- future_apply(treso_demand_origin[1:100,], 1, nearest_courthouse, 
                                      travel_time_skim = travel_time_skim)
result_df <- (rbindlist(result))
saveRDS(result_df, "output/mag/distribution_resutls.rds")

treso_demand_origin[1:100,] %>% select(treso.id.por, cduid, cdname, casetypes, court.hours) %>% 
  cbind(select(result_df, treso.id.pos, selected, bid)) %>% 
  unnest(treso.id.pos = strsplit(treso.id.pos, ","),
         selected = strsplit(selected, ","),
         bid = strsplit(bid, ",")) %>% 
  mutate(distribution.percentage = ifelse(selected == 1, 0.8, 0.2)) %>% 
  group_by(treso.id.por, cduid, cdname, casetypes, court.hours) %>% 
  summarise(treso.id.pos = paste(treso.id.pos, collapse = ","),
            bid = paste(bid, collapse = ","),
            distribution = paste(distribution.percentage / sum(distribution.percentage), collapse = ","))
```

# Linear Regression

- Explore whether there are any linear relationships between age groups and certain court hours

```{r explore linear regression}
library(perturb)

treso_2016_population <- readRDS("input/mag/treso_2016_population_mag.rds") %>% 
  left_join(treso_zone_system, by = c("treso_zone" = "treso_id")) %>% 
  select(treso_zone, age.group, population, cduid, cdname) %>% 
  mutate(cdname = as.character(cdname)) %>% 
  group_by(cduid, cdname, age.group) %>% 
  summarise(population = sum(population)) %>% 
  ungroup() %>% 
  spread(key = "age.group", value = "population") %>% 
  mutate(adult = adult.20s + adult.30s + adult.40s + adult.50s + adult.60s) %>% 
  mutate(senior = senior.70s + senior.80s) %>% 
  mutate(majority = adult + senior) %>% 
  mutate(minor = child + youth + young.adult) %>% 
  mutate(total = majority + minor)

court_hours_2016 <- court_hours %>%
  select(-lat, -long, -csduid, -csdname, -area, -region, -courthouse.lat, -courthouse.long) %>% 
  filter(year == 2016) %>% 
  group_by(cduid, cdname, casetypes) %>%
  summarise(value = sum(value)) %>% 
  ungroup() %>% 
  spread(key = "casetypes", value = "value") %>% 
  left_join(treso_2016_population, by = c("cduid", "cdname")) %>% 
  select(-cduid, -cdname) %>% 
  mutate_if(is.numeric, list(ln = log1p, sqrt = sqrt, log = log10, sq = ~.^2, scale = scale)) 

```

```{r building models - OCJcrim}
r1 <- resid(lm(young.adult_ln ~ adult.20s_ln, data = court_hours_2016))
summary(mod)

plot(mod)
```

```{r building models - SCJcrim}
r1 <- resid(lm(adult.30s_sqrt ~ adult.20s_sqrt, data = court_hours_2016))
mod <- lm(SCJcrim_sqrt ~ adult.20s_sqrt + r1, data = court_hours_2016)
summary(mod)
plot(mod)
```

```{r building models - OCJfam}
mod <- lm(OCJfam ~ adult.30s_sqrt + adult.50s_sqrt + child, data = court_hours_2016)
summary(mod)
plot(mod)

# Comment - it was found that to have a high R^2 and proper signs with the `child` term, the only transformation is the non-transformed version.
```

```{r building models - SCJfam}
mod <- lm(SCJfam ~ youth_sqrt + senior.70s, data = court_hours_2016)
summary(mod)
plot(mod)
```

```{r building models - civil}

mod <- lm(civil_sqrt ~ young.adult_sqrt + adult.20s_sqrt + senior.80s_sqrt, data = court_hours_2016)
summary(mod)
print(colldiag(mod))
plot(mod)
```

```{r building models - smac}
rMod <- residuals(lm(adult.30s ~ adult.20s, data = court_hours_2016))
mod <- lm(smac ~ adult.20s_sqrt + rMod, data = court_hours_2016)
cd <- colldiag(mod)
cd

mod <- lm(smac ~ adult.20s_sqrt + adult.30s_sqrt, data = court_hours_2016)
cd <- colldiag(mod)
cd

#plot(mod)

```
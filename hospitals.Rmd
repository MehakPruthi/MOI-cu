---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
source("helpers.R")
```

## To-Do List
[x] Calculate Origin trips by TRESO zone for each caretype
[] Aggregate HBAM Historical caseload to TRESO zone level for Destination trips
[] Balance O-D pairing

## Import Relevant Files
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
```{r}
#CD Caserates
cd_caserates <- readRDS('cache/hospitals/cd_caserates.rds') %>% 
  select(cd,
         caretype,
         agegroup,
         caserate) %>% 
  ungroup(cd) %>% 
  mutate(cd = as.numeric(cd))

#Historical HBAM Data at CD level
HBAMhistorical_cd <- readRDS('cache/hospitals/hbam_cd.rds')

HBAMhistorical_destination <- readRDS('cache/hospitals/HBAMhistorical.rds') %>% 
  filter(year == 2016) %>% 
  select(-year) %>% 
  mutate(caretype = as.character(caretype),
         caretype = replace(caretype, caretype == "ER", "AM"),
         caretype = replace(caretype, caretype == "DS", "AM")) %>% 
  ungroup() %>%
  group_by(siteid,
           caretype,
           agegroup) %>% 
  summarise(totalcases = sum(totalcases))

#TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")

treso_health_slim_tb <- readRDS('cache/hospitals/treso_health_tb.rds') %>% 
  select(treso_zone,
         cdname, 
         cd = cduid,
         pop_ag1 = n_ag1_pop,
         pop_ag2 = n_ag2_pop,
         pop_ag3 = n_ag3_pop,
         pop_ag4 = n_ag4_pop,
         pop_ag5 = n_ag5_pop,
         pop_ag6 = n_ag6_pop,
         pop_ped1 = n_ped1_pop,
         pop_ped2 = n_ped2_pop,
         pop_ped3 = n_ped3_pop)

#Hospital Asset Data
hospitallocations <- readRDS('cache/hospitals/hospitallocations.rds') %>% 
```

## Convert TRESO data to long format
```{r}
treso_health_long <- gather(treso_health_slim_tb, agegroup, population, pop_ag1:pop_ped3) %>% 
  mutate(agegroup = replace(agegroup, agegroup == 'pop_ag1', 1),
         agegroup = replace(agegroup, agegroup == 'pop_ag2', 2),
         agegroup = replace(agegroup, agegroup == 'pop_ag3', 3),
         agegroup = replace(agegroup, agegroup == 'pop_ag4', 4),
         agegroup = replace(agegroup, agegroup == 'pop_ag5', 5),
         agegroup = replace(agegroup, agegroup == 'pop_ag6', 6),
         agegroup = replace(agegroup, agegroup == 'pop_ped1', 'ped1'),
         agegroup = replace(agegroup, agegroup == 'pop_ped2', 'ped2'),
         agegroup = replace(agegroup, agegroup == 'pop_ped3', 'ped3'))

```

## Join CD Caserates to TRESO data for origin caseload/trip calculations:
  - Assuming one case = one trip (may be > 1 for most cases)
```{r}
origin_trips <- left_join(treso_health_long, cd_caserates, by = c('cd', 'agegroup')) %>% 
  mutate(o_trips = (population*caserate))
```

## Link Hospital Site IDs to TRESO Zones for destination caseload/trip calculations:
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Join HBAM historical data to hospital spatial database
  - Identify and quantify unmatched TRESO zones/Site IDs
```{r}
# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- hospitallocations %>%
  ungroup() %>%
  select(name,
         siteid,
         facilityid,
         caretype = type,
         pcode,
         lat,
         long) %>%
  group_by(siteid) %>%
  summarise_all(funs(first)) %>%
  mutate(id = row_number()) %>% 
  drop_na(lat)

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            name = hospital_xy@data$name,
            siteid = hospital_xy@data$siteid,
            caretype = hospital_xy@data$caretype) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             caretype,
             name, 
             siteid) %>% 
      rename(treso.id.pos = Treso_ID) %>% 
      mutate(caretype = as.character(caretype))

# Aggregate Historical HBAM to corresponding TRESO level
destination_trips <- left_join(HBAMhistorical_destination, hospital_overlay, by = c('siteid', 'caretype')) %>% 
  rename('d_trips' = 'totalcases',
         'treso_zone' = 'treso.id.pos')

hospital_id_join <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype' = 'type')) %>% 
  filter(is.na(name)) %>% 
  distinct(siteid)

# Check unmatched Site IDs and TRESO zones: 
unmatched_destination_trips <- destination_trips %>% 
  filter(is.na(treso_zone)) %>% 
  distinct(siteid)

unmatched_destination_trips %>% 
  filter(!grepl("^ped[1-3]", agegroup)) %>% 
  group_by(treso_zone) %>% 
  count()

unmatched_destination_trips %>% 
  filter(!grepl("^ped[1-3]", agegroup)) %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

unmatched_destination_trips %>% 
  filter(!grepl("^ped[1-3]", agegroup)) %>% 
  group_by(caretype) %>% 
  summarise(sum(d_trips))
```


```{r}
hospital_travel_mat <- left_join(origin_trips, destination_trips, by = c('treso_zone', 'agegroup', 'caretype'))
```


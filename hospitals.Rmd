---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
source('helpers.r')
```

## To-Do List
[x] Calculate Origin trips by TRESO zone for each caretype by CD case-rates
[x] Aggregate HBAM Historical caseload to TRESO zone level for Destination trips
[x] Balance O-D pairing
[x] Separate Pediatric (0-17), Adult (18-74) and Senior (75+) age groups
[x] Calculate Origin trips by TRESO zone for each caretype by CSD case-rates
[x] Calculate projections for Origins based on historical CSD caserates
[x] Scale origins to match projected HBAM destinations

## Import Relevant Files
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
  
```{r, include= FALSE, results='hide'}
#Defining hospital parameters for care-types and age bands
caretypes = c("at", "cr", "gr", "mh", "am")
age_cluster = c('ad', 'ped', 'sr')
agegroup_ref <- data.frame(age_cluster = c('ad', 'ad', 'ad', 'ped', 'sr', 'sr'),
                          agegroup = as.factor(c(2,3,4,1,5,6))) %>% 
  arrange(agegroup)

#CIHI Bed Data
CIHIhospitalbeds <- read_csv('input/moh/cap.CIHI_Hospital_Beds.csv')

#Daily Bed Census bed counts
num_beds <- readRDS('cache/moh/num_beds.rds')

#CD Caserates
cd_caserates <- readRDS('cache/moh/cd_caserates.rds')

csd_caserates <- readRDS('cache/moh/csd_caserates.rds') #TRESO zones with 0 population resulted in Inf caserates, causing a mismatch of total cases between Origin and Destination vectors when calcluated at the CSD-level; Inf replaced by 0 in cleaning code
  
caserates_comp <- readRDS('cache/moh/caserates_comp.rds')

# Historical HBAM Master (w/ Asset data)
HBAMhistorical_master <- readRDS('cache/moh/HBAMhistorical_master.rds')

# Projected HBAM Master (w/ Asset data)
HBAMprojected_master <- readRDS('cache/moh/HBAMprojected_master.rds')

#Hospital Asset Data
hospitallocations <- readRDS('cache/moh/hospitallocations.rds')

#TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")

treso_population_moh <- readRDS('input/moh/treso_population_moh.rds')

treso_population_long <- gather(treso_population_moh, 'year', 'population', population.2011:population.2041, -age_group) %>% 
  separate(year, into = c('pop', 'year'), sep = "n.") %>% 
  mutate(year = as.numeric(year)) %>% 
  select(-pop)

treso_health_slim_tb <- readRDS('cache/moh/treso_health_tb.rds') %>% 
  select(treso_zone,
         cdname, 
         cd = cduid,
         csdname,
         csd = csduid,
         pop_ag1 = n_ag1_pop,
         pop_ag2 = n_ag2_pop,
         pop_ag3 = n_ag3_pop,
         pop_ag4 = n_ag4_pop,
         pop_ag5 = n_ag5_pop,
         pop_ag6 = n_ag6_pop)

#Convert TRESO to Long format
treso_health_long <- gather(treso_health_slim_tb, agegroup, population, pop_ag1:pop_ag6) %>%
  mutate(agegroup = replace(agegroup, agegroup == 'pop_ag1', 1),
         agegroup = replace(agegroup, agegroup == 'pop_ag2', 2),
         agegroup = replace(agegroup, agegroup == 'pop_ag3', 3),
         agegroup = replace(agegroup, agegroup == 'pop_ag4', 4),
         agegroup = replace(agegroup, agegroup == 'pop_ag5', 5),
         agegroup = replace(agegroup, agegroup == 'pop_ag6', 6))

#TRESO Travel time and Propensity Matrix
treso_travel_time <- readRDS('output/treso_travel_time.rds') %>% 
  rename('orig' = 'treso.id.por',
         'dest' = 'treso.id.pos')

prop_matrix <- treso_travel_time %>%
  mutate(value = 1/value) %>% #change if something bad happens 
  arrange(orig, dest) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

saveRDS(prop_matrix, file = 'cache/moh/prop_matrix.rds')

origin_full <- readRDS('output/por_full.rds')
dest_full <- readRDS('output/pos_full.rds')

treso_zone_system <- read_csv('input/treso/treso_zone_system.csv')

```

## Link Hospital Site IDs to TRESO Zones:
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Identify and quantify unmatched TRESO zones/Site IDs, if any
  
```{r}
# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- HBAMhistorical_master %>%
  ungroup() %>%
  select(name,
         siteid,
         facilityid,
         caretype,
         pcode,
         lat,
         long) %>%
  group_by(siteid) %>%
  summarise_all(list(first)) %>%
  mutate(id = row_number()) %>% 
  drop_na(lat)

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            hosp_name = hospital_xy@data$name,
            siteid = hospital_xy@data$siteid,
            caretype = hospital_xy@data$caretype) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             caretype,
             hosp_name, 
             siteid) %>% 
      rename(treso_zone = Treso_ID) %>% 
      mutate(caretype = as.character(caretype)) %>% 
      left_join(treso_zone_system, by = c('treso_zone' = 'treso_id'))

saveRDS(hospital_overlay, file = 'cache/moh/hospital_overlay.rds')

# Match Original Historical HBAM Site IDs with Orignal Asset Inventory to quantify mismatched IDs
# hospital_id_join <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype')) %>% 
#   filter(!is.na(name)) %>% 
#   distinct(siteid) 

# Mismatched IDs from Original Asset Inventory and TRESO Overlay (should be empty)
# hospital_mismatch <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype')) %>% 
#   filter(is.na(lat))

# hospital_mismatch_treso <- left_join(HBAMhistorical_destination, hospital_overlay, by = c('siteid', 'caretype')) %>% 
#   filter(is.na(treso_zone))

# rm(hospital_xy, hospital_spdf, treso_shp)
```

## HBAM Age Group Separation
  - Join HBAM historical data to hospital spatial database
  - Filter master dataset for major age groups
```{r}
hospital_overlay <- readRDS(file = "cache/moh/hospital_overlay.rds")

#Update Master HBAM liste to Include TRESO Zones
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, select(hospital_overlay, treso_zone, siteid, caretype, hosp_csduid = csduid, csdname, cdname), by = c('siteid', 'caretype')) %>% 
  left_join(agegroup_ref, by = 'agegroup')

HBAMhistorical_origcsd_cases <- HBAMhistorical_master_tz %>% 
  group_by(year, siteid, age_cluster, caretype) %>% 
  mutate(totalcases = sum(cases),
         csd.mrkt = cases/totalcases) %>% 
  select(year, siteid, hospitalname, caretype, age_cluster, orig_csd, cases, totalcases, csd.mrkt)

#For loop to separate HBAM observations by each age-group cluster
for (a in age_cluster) {
  HBAMhistorical_master_age <- HBAMhistorical_master_tz %>% 
    filter(age_cluster == a) %>% 
    select(year,
           siteid,
           name,
           hosp_csduid,
           caretype,
           agegroup,
           totalcases,
           csd,
           treso_zone)
  
  saveRDS(HBAMhistorical_master_age, file = paste0("cache/moh/HBAMhistorical_master_", a, ".rds"))
}

rm(HBAMhistorical_master_age)

# #Filter out Adult age groups
# HBAMhistorical_master_ad <- HBAMhistorical_master_tz %>% 
#   select(siteid,
#          name,
#          caretype,
#          agegroup,
#          totalcases,
#          csd,
#          treso_zone) %>% 
#   filter(agegroup %in% (2:4))
# 
# #Filter Pediatric Age Groups  
# HBAMhistorical_master_ped <- HBAMhistorical_master_tz %>%
#   select(siteid,
#          name,
#          caretype,
#          agegroup,
#          totalcases,
#          csd,
#          treso_zone) %>%
#   filter(agegroup == 1)
# 
# #Filter Senior Age Groups
# HBAMhistorical_master_sr <- HBAMhistorical_master_tz %>% 
#   select(siteid,
#          name,
#          caretype,
#          agegroup,
#          totalcases,
#          csd,
#          treso_zone) %>% 
#   filter(agegroup %in% (5:6))  
```

```{r}
#Reorganize HBAM Destination data at CSD-level
HBAMhistorical_dest_csd <- HBAMhistorical_master_tz %>%
  select(year,
         siteid,
         facilityid,
         hosp_csduid,
         csdname,
         treso_zone,
         caretype,
         agegroup,
         totalcases,
         orig_csd = csd,
         age_cluster) %>% 
  group_by(year, siteid, agegroup, caretype) %>% 
  mutate(sum.totalcases = sum(totalcases))  %>% 
  group_by(year, siteid,agegroup, caretype, hosp_csduid, orig_csd) %>% 
  mutate(in.csd = if_else(hosp_csduid == orig_csd, sum(totalcases), 0, missing = NULL),
         out.csd = if_else(hosp_csduid != orig_csd, sum(totalcases), 0, missing = NULL),
         perc.in.csd = (in.csd/sum.totalcases)*100,
         perc.out.csd = (out.csd/sum.totalcases)*100) %>% 
  group_by(year, siteid, caretype, age_cluster) %>% 
  summarise(sum.in.csd = sum(in.csd),
            sum.out.csd = sum(out.csd)) %>% 
  mutate(perc.in.csd = sum.in.csd/(sum.in.csd + sum.out.csd),
         perc.out.csd = sum.out.csd/(sum.in.csd + sum.out.csd))
  
  
```

## HBAM Base Care-Type Matricies
```{r}
#For Loop to create HBAM Matrices for each care-type

for (ct in caretypes) {
  for (a in age_cluster) {
    
    hbam_matrix <- HBAMhistorical_master_tz %>%
      filter(caretype == toupper(ct),
             age_cluster == a) %>% 
      group_by(csd, treso_zone) %>% 
      summarise(trips = sum(totalcases)) %>% 
      mutate(trips = trips/365)
    
    saveRDS(hbam_matrix, file = paste0('cache/moh/', ct, "_hbam_matrix_", a,".rds"))
    
  }
  
}

rm(hbam_matrix)

```

## Caseload Calculation
  - Create TRESO destination caseload datasets for both Origin and Destination vectors

```{r}
###CSD caserates needed extra filtering steps as there are TRESO zones w/ 0 population that when aggregated to the CSD level created 'inf' outputs, as opposed to CDs which are larger and have a wider capture area

#Join destination data to joined CSDs for master-list
csd_destinations <- left_join(csd_caserates, HBAMhistorical_master_tz, by = c('csd', 'agegroup', 'caretype')) %>% 
  select(siteid,
         name,
         caretype,
         agegroup,
         age_cluster,
         totalcases,
         treso_zone,
         csd) #sum of csd_destinations is less than original HBAMhistorical_master by 57k cases removed as NAs from CSD mismatch

#Calculate CSD-level cases to be used as origin vector source
csd_origins <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>% 
  mutate(o_trips = (population*caserate))

```

## Origin Caseload Calculation
  - Join CSD Caserates to TRESO data
  - Assuming one case = one trip (may be > 1 for most cases)
  - Calculate Origin vector cases / trips
  - Create totaling outputs

```{r}
#Calculate Origin trips

## Adult Origins
origin_trips_csd_ad <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>% 
  filter(agegroup %in% (2:4)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup() %>% 
  group_by(csd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

## Pediatric Origins
origin_trips_csd_ped <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>%
  filter(agegroup == 1) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup() %>% 
  group_by(csd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

## Senior Origins
origin_trips_csd_sr <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>% 
  filter(agegroup %in% (5:6)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup() %>% 
  group_by(csd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

#Total Case Summarise
calcases_csd_origin_ad <- origin_trips_csd_ad %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

calcases_csd_origin_ped <- origin_trips_csd_ped %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

calcases_csd_origin_sr <- origin_trips_csd_sr %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

sum(calcases_csd_origin_ad, calcases_csd_origin_ped, calcases_csd_origin_sr) #Total of 7,314,475 cases, difference of 57,854 cases from original HBAM due to mismatched CSDs (see mismatched_csd)
```

## CSD-Rate O-D Vectors
```{r}

#Adult
for (ct in caretypes) {
    origin_csd_ad <- origin_trips_csd_ad %>% 
      filter(caretype == toupper(ct)) %>% 
      ungroup() %>% 
      select(-caretype, -csd)
    
    saveRDS(origin_csd_ad, file = paste0("cache/moh/", ct, "_origin_csd_ad.rds"))
    
    destination_csd_ad <- destination_trips_csd_ad %>% 
      filter(caretype == toupper(ct)) %>% 
      select(-caretype)
    
    saveRDS(destination_csd_ad, file = paste0("cache/moh/", ct, "_destination_csd_ad.rds"))
    
    origin_csd_full_ad <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd_ad, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full_ad, file = paste0("cache/moh/", ct, "_origin_csd_full_ad.rds"))
    
    destination_csd_full_ad <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd_ad, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
     saveRDS(destination_csd_full_ad, file = paste0("cache/moh/", ct, "_destination_csd_full_ad.rds"))
}

#Pediatric
for (ct in caretypes) {
    origin_csd_ped <- origin_trips_csd_ped %>% 
      filter(caretype == toupper(ct)) %>% 
      ungroup() %>% 
      select(-caretype, -csd)
    
    saveRDS(origin_csd_ped, file = paste0("cache/moh/", ct, "_origin_csd_ped.rds"))
    
    destination_csd_ped <- destination_trips_csd_ped %>% 
      filter(caretype == toupper(ct)) %>% 
      select(-caretype)
    
    saveRDS(destination_csd_ped, file = paste0("cache/moh/", ct, "_destination_csd_ped.rds"))
    
    origin_csd_full_ped <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd_ped, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full_ped, file = paste0("cache/moh/", ct, "_origin_csd_full_ped.rds"))
    
    destination_csd_full_ped <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd_ped, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
     saveRDS(destination_csd_full_ped, file = paste0("cache/moh/", ct, "_destination_csd_full_ped.rds"))
}

#Senior
for (ct in caretypes) {
    origin_csd_sr <- origin_trips_csd_sr %>% 
      filter(caretype == toupper(ct)) %>% 
      ungroup() %>% 
      select(-caretype, -csd)
    
    saveRDS(origin_csd_sr, file = paste0("cache/moh/", ct, "_origin_csd_sr.rds"))
    
    destination_csd_sr <- destination_trips_csd_sr %>% 
      filter(caretype == toupper(ct)) %>% 
      select(-caretype)
    
    saveRDS(destination_csd_sr, file = paste0("cache/moh/", ct, "_destination_csd_sr.rds"))
    
    origin_csd_full_sr <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd_sr, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full_sr, file = paste0("cache/moh/", ct, "_origin_csd_full_sr.rds"))
    
    destination_csd_full_sr <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd_sr, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
     saveRDS(destination_csd_full_sr, file = paste0("cache/moh/", ct, "_destination_csd_full_sr.rds"))
}

rm(origin_csd_ad, origin_csd_ped, origin_csd_sr, origin_csd_full_ad, origin_csd_full_ped, origin_csd_full_sr)
rm(destination_csd_ad, destination_csd_ped, destination_csd_sr, destination_csd_full_ad, destination_csd_full_ped, destination_csd_full_sr)
```

## Summarize CSD Matrices
  - Create O-D vectors and matrices for each care-type and age-cluster segment
  - Balance matrices and create comparison table for simulated vs observed trips
  - Assume 1 case = 1 trip

```{r}
#Create O-D vectors (where destination trips are taken directly from HBAM Historical and Origin trips are calculated using historical case-rates). Outputs are saved in the cache directory for greater analysis if needed.
for (ct in caretypes) {
  for (a in unique(age_cluster)) {
    
    #Create destination vectors
    destination_csd <- csd_destinations %>%
      rename('d_trips' = 'totalcases') %>% 
      filter(age_cluster == a,
             caretype == toupper(ct)) %>% 
      group_by(treso_zone) %>% 
      summarise(d_trips = (sum(d_trips)/365)) 
    
    saveRDS(destination_csd, file = paste0('cache/moh/', ct, '_destination_csd_', a, '.rds'))
    
    #Create full destination matrix
    destination_csd_full <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
    saveRDS(destination_csd_full, file = paste0('cache/moh/', ct, '_destination_csd_full_', a, '.rds'))
    
    #Create Origin Vector
    origin_csd <- csd_origins %>% 
      filter(age_cluster == a,
             caretype == toupper(ct)) %>% 
      select(-caretype, -csd) %>% 
      group_by(treso_zone) %>% 
      summarise(o_trips = (sum(o_trips)/365))
    
    saveRDS(origin_csd, file = paste0('cache/moh/', ct, '_origin_csd_', a, '.rds'))
    
    #Create full origin matrix
    origin_csd_full <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full, file = paste0('cache/moh/', ct, '_origin_csd_full_', a, '.rds'))
    
    #Create propensity matrix for care-type and age-cluster segment
    prop_matrix_csd <- matrix_balancing_2d(prop_matrix, origin_csd_full, destination_csd_full, 'column', 1000, 0.001)
    saveRDS(prop_matrix_csd, file = paste0('cache/moh/', ct, '_prop_matrix_csd_', a, '.rds'))
    
    #Convert propensity matrix to long-format for ease of analysis
    long_prop_matrix_csd <- prop_matrix_csd %>% 
      melt() %>% 
      rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')
    saveRDS(long_prop_matrix_csd, file = paste0('cache/moh/', ct, '_long_prop_matrix_csd_', a, '.rds'))
    
    #Reaggregate TRESO trip values to CSD and compare to original HBAM dataset
    sim_csd <- left_join(long_prop_matrix_csd, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
      select(-area, -mof_region) %>% 
      filter(!is.na(csduid)) %>% 
      ungroup() %>% 
      group_by(csduid, destination) %>% 
      summarise(trips = sum(trips, na.rm = TRUE))
    
    #Create comparison table for simulated vs observed HBAM cases (requires reading in observed HBAM matrix)
    HBAM_matrix <- readRDS(paste0('cache/moh/', ct, "_hbam_matrix_", a,".rds"))
    
    comp_sim_csd <- full_join(sim_csd, HBAM_matrix, by = c('destination'='treso_zone', 'csduid'='csd'), suffix = c('.csd', '.hbam')) %>% 
      replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
      mutate(diff = abs(trips.csd - trips.hbam),
             perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)
    
    saveRDS(comp_sim_csd, file = paste0('cache/moh/', ct, '_comp_sim_csd_', a, '.rds'))
    
    rm(destination_csd, origin_csd, destination_csd_full, origin_csd_full, prop_matrix_csd, long_prop_matrix_csd, sim_csd, HBAM_matrix, comp_sim_csd)
  }
}

```

### AT Matrices

```{r AT Adult}
# Create Propensity Matrix
at_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, at_origin_csd_full_ad, at_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_csd_ad <- at_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_csd_ad <- left_join(at_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_csd_ad <- at_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_csd_ad <- at_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_csd_ad <- full_join(at_sim_matrix_csd_ad, at_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_ad <- at_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AT Pediatric}
# Create Propensity Matrix
at_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, at_origin_csd_full_ped, at_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_csd_ped <- at_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_csd_ped <- left_join(at_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_csd_ped <- at_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_csd_ped <- at_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_csd_ped <- full_join(at_sim_matrix_csd_ped, at_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_ped <- at_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AT Senior}
# Create Propensity Matrix
at_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, at_origin_csd_full_sr, at_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_csd_sr <- at_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_csd_sr <- left_join(at_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_csd_sr <- at_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_csd_sr <- at_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_csd_sr <- full_join(at_sim_matrix_csd_sr, at_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_sr <- at_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### CR Matrices

```{r CR Adult}
# Create Propensity Matrix
cr_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, cr_origin_csd_full_ad, cr_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_csd_ad <- cr_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_csd_ad <- left_join(cr_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_csd_ad <- cr_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_csd_ad <- cr_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_csd_ad <- full_join(cr_sim_matrix_csd_ad, cr_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
cr_treso_csd_ad <- cr_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r CR Pediatric}
# Create Propensity Matrix
cr_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, cr_origin_csd_full_ped, cr_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_csd_ped <- cr_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_csd_ped <- left_join(cr_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_csd_ped <- cr_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_csd_ped <- cr_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_csd_ped <- full_join(cr_sim_matrix_csd_ped, cr_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
cr_treso_csd_ped <- cr_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r CR Senior}
# Create Propensity Matrix
cr_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, cr_origin_csd_full_sr, cr_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_csd_sr <- cr_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_csd_sr <- left_join(cr_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_csd_sr <- cr_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_csd_sr <- cr_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_csd_sr <- full_join(cr_sim_matrix_csd_sr, cr_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
cr_treso_csd_sr <- cr_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### GR Matrices

```{r GR Adult}
# Create Propensity Matrix
gr_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, gr_origin_csd_full_ad, gr_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_csd_ad <- gr_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_csd_ad <- left_join(gr_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
gr_prop_sum_csd_ad <- gr_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_csd_ad <- gr_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_csd_ad <- full_join(gr_sim_matrix_csd_ad, gr_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
gr_treso_csd_ad <- gr_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r GR Pediatric}
# Create Propensity Matrix
gr_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, gr_origin_csd_full_ped, gr_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_csd_ped <- gr_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_csd_ped <- left_join(gr_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
gr_prop_sum_csd_ped <- gr_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_csd_ped <- gr_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_csd_ped <- full_join(gr_sim_matrix_csd_ped, gr_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
gr_treso_csd_ped <- gr_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r GR Senior}
# Create Propensity Matrix
gr_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, gr_origin_csd_full_sr, gr_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_csd_sr <- gr_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_csd_sr <- left_join(gr_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
gr_prop_sum_csd_sr <- gr_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_csd_sr <- gr_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_csd_sr <- full_join(gr_sim_matrix_csd_sr, gr_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
gr_treso_csd_sr <- gr_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### MH  Matrices

```{r MH Adult}
# Create Propensity Matrix
mh_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, mh_origin_csd_full_ad, mh_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_csd_ad <- mh_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_csd_ad <- left_join(mh_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_csd_ad <- mh_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_csd_ad <- mh_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_csd_ad <- full_join(mh_sim_matrix_csd_ad, mh_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
mh_treso_csd_ad <- mh_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r MH Pediatric}
# Create Propensity Matrix
mh_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, mh_origin_csd_full_ped, mh_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_csd_ped <- mh_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_csd_ped <- left_join(mh_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_csd_ped <- mh_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_csd_ped <- mh_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_csd_ped <- full_join(mh_sim_matrix_csd_ped, mh_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
mh_treso_csd_ped <- mh_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r MH Senior}
# Create Propensity Matrix
mh_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, mh_origin_csd_full_sr, mh_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_csd_sr <- mh_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_csd_sr <- left_join(mh_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_csd_sr <- mh_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_csd_sr <- mh_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_csd_sr <- full_join(mh_sim_matrix_csd_sr, mh_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
mh_treso_csd_sr <- mh_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### AM Matrices

```{r AM Adult}
# Create Propensity Matrix
am_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, am_origin_csd_full_ad, am_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_csd_ad <- am_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_csd_ad <- left_join(am_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_csd_ad <- am_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_csd_ad <- am_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_csd_ad <- full_join(am_sim_matrix_csd_ad, am_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_csd_ad <- am_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AM Pediatric}
# Create Propensity Matrix
am_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, am_origin_csd_full_ped, am_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_csd_ped <- am_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_csd_ped <- left_join(am_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_csd_ped <- am_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_csd_ped <- am_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_csd_ped <- full_join(am_sim_matrix_csd_ped, am_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_csd_ped <- am_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AM Senior}
# Create Propensity Matrix
am_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, am_origin_csd_full_sr, am_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_csd_sr <- am_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_csd_sr <- left_join(am_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_csd_sr <- am_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_csd_sr <- am_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_csd_sr <- full_join(am_sim_matrix_csd_sr, am_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_csd_sr <- am_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

## Forecasting 

### Define forecasting parameters

```{r}
#Forecasting parameters define base year for population calculation and user-selected projection year. This year will also be used in origin forecasting calculations and matrix balancing

#Projection parameters:
base_year <- 2016 #can set it to max(HBAM$year) to help streamline, requires insertion of 'year' in original HBAM code
target_year <- 2022 #user selected projection year

```

### Projected HBAM Age Group Separations

```{r}
#Update Master HBAM liste to Include TRESO Zones
hospital_overlay <- readRDS('cache/moh/hospital_overlay.rds')

HBAMprojected_master_tz <- left_join(HBAMprojected_master, select(hospital_overlay, treso_zone, siteid, caretype), by = c('siteid', 'caretype')) %>% 
  left_join(agegroup_ref, by = c('agegroup'))

#Filter HBAM by age group cluster

for (a in unique(agegroup_ref$age_cluster)) {
  
  HBAMprojected_age <- HBAMprojected_master_tz %>% 
    filter(age_cluster == a) %>% 
    select(year,
         siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         los,
         beddays,
         treso_zone)
  
  saveRDS(HBAMprojected_age, file = paste0("cache/moh/HBAMprojected_", a, ".rds"))
}

rm(HBAMprojected_age)

```

### Origin forecast

```{r}
#Disaggregate CSD case-rates to TRESO zones
treso_caserates <- left_join(caserates_comp, treso_zone_system, by = c('csd' = 'csduid', 'cd' = 'cduid')) %>% 
  select(year,
         treso_zone = treso_id,
         csduid = csd,
         csdname,
         cduid = cd,
         cdname,
         agegroup,
         caretype,
         csd_caserates,
         cd_caserate)

saveRDS(treso_caserates, file = 'cache/moh/treso_caserates.rds')

#Join TRESO case-rates to projection year population allocation for origin cases / trips
proj_origin <- right_join(treso_caserates, proj_year_summary, by = c('treso_id' = 'treso_zone', 'csduid' = 'csduid', 'agegroup' = 'age_group')) %>% 
  left_join(agegroup_ref, by = c('agegroup')) %>% 
  mutate(origin_cases = caserate*proj_year_pop) %>% 
  select(-cdname, - cduid, -area, mof_region)

proj_origin_na <- proj_origin %>% 
  filter(!is.na(proj_year_pop),
         is.na(caserate))

```

### Forecasting Function

```{r AM Adult}

#Recall function (NEEDS TO BE FIXED, ONLY RETURNS LAST OBJECT); could be a loop?
proj_odv_rcall <- function(ct, a) {
  proj_origin <- readRDS(paste0('cache/moh/', ct, '_proj_origin_', a,'.rds'))
  proj_origin_full <- readRDS(paste0('cache/moh/', ct, '_proj_origin_full_', a, '.rds'))
  proj_destination <- readRDS(paste0('cache/moh/', ct, '_proj_destination_', a,'.rds'))
  proj_destination_full <- assign(paste0(ct, '_proj_destination_full_', a), readRDS(paste0('cache/moh/', ct,'_proj_destination_full_', a, '.rds')))
  
  return(proj_origin)
  return(proj_origin_full)
  return(proj_destination)
  return(proj_destination_full)
}

proj_odv_rcall('am','ped')
```

```{r}
#Function developed to calculate the origin and destination cases for each care-type and age-group cluster. Function will return the balanced matrix of total trips / cases but breakdown of cases / trips by age-group cluster will be saved in working directory.

#TODO: ADD OUTSIDE OBJECTS INTO FUNCTION VARIALBES
proj_matrix <- function(ct,proj_cases,HBAM_cases,origin,destination,prop_matrix) {
  
  age_cluster <- c('ad', 'ped', 'sr')
  
  for (a in age_cluster) {
    
    #Origin filter operation by age-group cluster for selected care-type
      ct_origin <- proj_cases %>% 
        filter(age_cluster == a,
               caretype == toupper(ct)) %>% 
        group_by(treso_id) %>% 
        summarise(o_trips = (sum(origin_cases)/365)) %>% #Calculate daily trips 
        replace_na(list(o_trips = 0))
      
    #Apply origin values to TRESO matrix  
      proj_origin_full <- origin %>% 
        left_join(ct_origin, by = c('orig' = 'treso_id')) %>% 
        replace_na(list(o_trips = 0)) %>%
        arrange(orig) %>% 
        column_to_rownames(var = "orig") %>%
        data.matrix()
      
    #Destination filter operation from projected HBAM of selected projection year  
      proj_destination_trips <- HBAM_cases %>% 
        filter(age_cluster == a,
             caretype == toupper(ct),
             year == proj_year) %>% 
        group_by(treso_zone) %>% 
        summarise(d_trips = (sum(totalcases)/365)) #Calculate daily trips
    
    #Apply destination values to TRESO matrix  
      proj_destination_full <- destination %>% 
        left_join(proj_destination_trips, by = c('dest' = 'treso_zone')) %>% 
        replace_na(list(d_trips = 0)) %>%
        arrange(dest) %>% 
        column_to_rownames(var = "dest") %>%
        data.matrix()
    
    #1D matrix balancing operation balancing origins against destinations
     proj_prop_matrix <- matrix_balancing_1d(prop_matrix, proj_destination_full, proj_origin_full, axis = 2, constrained = TRUE)
     
     saveRDS(proj_prop_matrix, file = paste0("cache/moh/", ct, "_proj_prop_matrix_", a, ".rds"))

  }
  
  #Read in caculated matrices for each age-group cluster and sum
  pm_ad <- readRDS(paste0('cache/moh/', ct, '_proj_prop_matrix_ad', '.rds'))
  pm_ped <- readRDS(paste0('cache/moh/', ct, '_proj_prop_matrix_ped', '.rds'))
  pm_sr <- readRDS(paste0('cache/moh/', ct, '_proj_prop_matrix_sr', '.rds'))
  pm_sum <- pm_ad + pm_ped + pm_sr
  
  return(pm_sum)
  
}

#Summarizing function to convert balanced matrix into long-form for ease of analysis and calculation. Summary function includes the O-D calculation and balancing function but returns the long-form table instead of the full matrix
proj_summary <- function(matrix) {
  
  proj_summary_table <- matrix %>%
    melt() %>%
    rename('origin' = 'Var1',
          'destination' = 'Var2',
          'trips' = 'value')
  
  return(proj_summary_table)
}

prop_matrix <- readRDS('cache/moh/prop_matrix.rds')

p1 <- proj_matrix(ct = 'am', proj_origin,HBAMprojected_master_tz, origin_full, dest_full,prop_matrix)
p2 <- proj_summary(p1)

```

## Consolidated Hospital Lookup
  - Reorganize HBAM historical to show unique hospital locations w/ metadata needed for visualization tool
  - Create in wide format w/ sub-naming for care-type and age-cluster 
  hosp | postcode/index | year | ct_age1 | ct_age2 | ...
  ..................................................
                                    Total Cases
```{r}
#Use combine HBAM-TRESO object as basis
hospital_lookup_latlong <- HBAMhistorical_master_tz %>% 
  group_by(name, pcode) %>% 
  summarise(csduid = first(hosp_csduid),
            csdname = first(csdname),
            lat = first(lat),
            long = first(long),
            treso_zone = first(treso_zone)) 

hospital_lookup <- HBAMhistorical_master_tz %>% 
  group_by(year, name, pcode, age_cluster, caretype) %>% 
  summarise(cases = sum(cases)) %>% 
  mutate(cases_at_ad = ifelse(caretype %in% 'AT' & age_cluster %in% 'ad', cases, 0),
         cases_at_ped = ifelse(caretype %in% 'AT' & age_cluster %in% 'ped', cases, 0),
         cases_at_sr = ifelse(caretype %in% 'AT' & age_cluster %in% 'sr', cases, 0),
         cases_cr_ad = ifelse(caretype %in% 'CR' & age_cluster %in% 'ad', cases, 0),
         cases_cr_ped = ifelse(caretype %in% 'CR' & age_cluster %in% 'ped', cases, 0),
         cases_cr_sr = ifelse(caretype %in% 'CR' & age_cluster %in% 'sr', cases, 0),
         cases_gr_ad = ifelse(caretype %in% 'GR' & age_cluster %in% 'ad', cases, 0),
         cases_gr_ped = ifelse(caretype %in% 'GR' & age_cluster %in% 'ped', cases, 0),
         cases_gr_sr = ifelse(caretype %in% 'GR' & age_cluster %in% 'sr', cases, 0),
         cases_mh_ad = ifelse(caretype %in% 'MH' & age_cluster %in% 'ad', cases, 0),
         cases_mh_ped = ifelse(caretype %in% 'MH' & age_cluster %in% 'ped', cases, 0),
         cases_mh_sr = ifelse(caretype %in% 'MH' & age_cluster %in% 'sr', cases, 0),
         cases_am_ad = ifelse(caretype %in% 'AM' & age_cluster %in% 'ad', cases, 0),
         cases_am_ped = ifelse(caretype %in% 'AM' & age_cluster %in% 'ped', cases, 0),
         cases_am_sr = ifelse(caretype %in% 'AM' & age_cluster %in% 'sr', cases, 0)) %>% 
  group_by(year, name, pcode) %>% 
  summarise_at(vars(cases_at_ad:cases_am_sr), sum) %>% 
  left_join(hospital_lookup_latlong, by = c('name', 'pcode'))

#Added check to make sure summarise is correct
hospital_check <- HBAMhistorical_master_tz %>%
  group_by(year, name, pcode, age_cluster, caretype) %>% 
  summarise(totalcases = sum(cases))

#Import bed summaries from Daily Bed Census (DBC); this can be imported above
num_beds_spread <- num_beds %>%
  spread(year, maxstaffedbeds) %>% 
  rename('dbc_beds_2017' = '2017',
         'dbc_beds_2018' = '2018',
         'caretype' = 'type') %>% 
  left_join(select(hospitallocations, siteid, caretype, name, pcode), by = c('siteid', 'caretype'))

#Spread DBC 2017 and 2018 data
dbc_beds_2017 <- num_beds_spread %>% 
  select(-dbc_beds_2018) %>% 
  spread(caretype, dbc_beds_2017) %>% 
  rename(at_beds_2017 = AT,
         cr_beds_2017 = CR,
         gr_beds_2017 = GR,
         mh_beds_2017 = MH) %>% 
  mutate(dbc_total_beds_2017 = sum(c(at_beds_2017, cr_beds_2017, gr_beds_2017, mh_beds_2017), na.rm = TRUE))

dbc_beds_2018 <- num_beds_spread %>% 
  select(-dbc_beds_2017) %>% 
  spread(caretype, dbc_beds_2018) %>% 
  rename(at_beds_2018 = AT,
         cr_beds_2018 = CR,
         gr_beds_2018 = GR,
         mh_beds_2018 = MH) %>% 
  mutate(dbc_total_beds_2018 = sum(c(at_beds_2018, cr_beds_2018, gr_beds_2018, mh_beds_2018), na.rm = TRUE))

#Combine DBC bed data into wide table format by Postal Code
dbc_beds <- full_join(dbc_beds_2017, dbc_beds_2018, by = c('name', 'pcode', 'siteid')) %>%
  group_by(pcode) %>% 
  summarise_at(vars(at_beds_2017:dbc_total_beds_2018), sum, na.rm = TRUE)

#Import CIHI Bed data and structure to wide table format by Postal Code
CIHIhospitalbeds_spread <- CIHIhospitalbeds %>% 
  select(year = Year,
         name = 'Hospital Name',
         hosp_type = 'Type of Hospital',
         cihi_total = Total) %>%  
  mutate(name = toupper(name)) %>% 
  right_join(select(hospital_lookup, year, name, pcode), by = c('name', 'year')) %>% 
  spread(year, cihi_total) %>% 
  rename('cihi_beds_2012' = '2012',
         'cihi_beds_2013' = '2013',
         'cihi_beds_2014' = '2014',
         'cihi_beds_2015' = '2015',
         'cihi_beds_2016' = '2016',)

#Compiled Bed Data between CIHI and DBC
hosp_beds_comp <- left_join(dbc_beds, CIHIhospitalbeds_spread, by = 'pcode') %>% 
  select(pcode, hosp_type, cihi_beds_2012:cihi_beds_2016, at_beds_2017:dbc_total_beds_2018)

#Final Master List only including DBC because of incomplete CIHI Data
hospital_lookup_master <- left_join(hospital_lookup, dbc_beds, by = 'pcode')

saveRDS(hospital_lookup_master, file = 'output/moh/hospital_lookup_master.rds')
```

##Base Scenario Calculation
  - Calculate the market share of cases for each hospital w.r.t population from HBAM for the given year/caretype/age cluster (named segment from now on)
  - Summarize the number of cases by TRESO zones for each segment (HBAM Demand) [origin vector]
  - Apply the case rates to the population at TRESO zones (Caserate Demand) [origin vector]
  - Calculate the difference between HBAM Demand and Caserate Demand, summarize the difference at the CSD level (Latent Demand) [KPI]

```{r}
#Create Origin TRESO caseload by disaggregating CSD case-rates down to the TRESO level

##Disaggregate CSD case-rates to TRESO zones
treso_caserates <- left_join(caserates_comp, treso_zone_system, by = c('orig_csd' = 'csduid', 'orig_cd' = 'cduid')) %>% 
  select(year,
         treso_zone = treso_id,
         orig_csd,
         csdname,
         orig_cd,
         cdname,
         agegroup,
         caretype,
         csd_caserate,
         cd_caserate)

saveRDS(treso_caserates, file = 'cache/moh/treso_caserates.rds')

##Calculate origin caseload by TRESO zone
treso_origin_cases <- left_join(treso_caserates, treso_population_long, by = c('year', 'treso_zone', 'orig_csd' = 'csduid', 'agegroup' = 'age_group')) %>% 
  rename('orig.treso.zone' = 'treso_zone') %>% 
  mutate(orig.cases = csd_caserate*population)

#Create Hospital-TRESO OD table by joining Origin caseload calculations to historical HBAM

hosp2treso_origin_cases <- HBAMhistorical_master_tz %>% 
  filter(year == 2016) %>% 
  select(year,
         siteid,
         name,
         hosp.treso.zone = treso_zone,
         orig_csd,
         agegroup,
         age_cluster,
         caretype) %>% 
  left_join(select(HBAMhistorical_cases, year, siteid, orig_csd, agegroup, caretype, cases, totalcases, csd.mrkt), by = c('year', 'siteid','orig_csd', 'agegroup', 'caretype')) %>% 
  left_join(select(treso_origin_cases, year, agegroup, caretype, orig.treso.zone, orig_csd, population), by = c('year', 'orig_csd', 'agegroup', 'caretype')) 

hosp2treso_caserates <- hosp2treso_origin_cases %>% 
  # filter(siteid == 1030) %>% 
  mutate(population = replace_na(population, 0)) %>% 
  group_by(year, siteid, orig_csd, agegroup, caretype) %>% 
  mutate(treso.pop.perc = population/sum(population)) %>% 
  group_by(year, siteid, agegroup, caretype) %>%
  mutate(treso.mrktshare = treso.pop.perc*csd.mrkt,
         treso.hosp.cases = treso.mrktshare*totalcases,
         treso.hosp.caserate = treso.hosp.cases/population,
         hosp.seg.cases = sum(treso.hosp.cases))


#TODO: CLEAN CODE AND REMOVE USELESS OPERATIONS
#TODO: TRANSITION TO AGE CLUSTERS FROM AGE GROUP: EITHER UPSTREAM AT HBAM OR DOWNSTREAM VIA PROPER SUM FUNCTION


hosp2treso_caserates <- hosp2treso_origin_cases %>% 
  filter(siteid == 1030) %>% 
  mutate(population = replace_na(population, 0)) %>% 
  group_by(year, siteid, orig_csd, age_cluster, caretype) %>% 
  mutate(treso.pop.perc = population/sum(population)) %>% 
  group_by(year, siteid, orig_csd, age_cluster, caretype) %>% #Transition grouping variable from agegroup to age_cluster
  select(-agegroup) %>%
  distinct() %>%
  mutate(treso.pop.perc = sum(treso.pop.perc),
         totalcases = sum(totalcases)) %>%
  group_by(year, siteid, age_cluster, caretype) %>%
  mutate(treso.mrktshare = treso.pop.perc*csd.mrkt,
         treso.hosp.cases = treso.mrktshare*totalcases,
         treso.hosp.caserate = treso.hosp.cases/population,
         hosp.seg.cases = sum(treso.hosp.cases))
  

```

###TODAY'S ATTEMPT
```{r}
#Update Master HBAM liste to Include TRESO Zones (COPIED FROM CHUNKS ABOVE, REMOVE ONCE CODE IS WORKING/CLEANED)
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, select(hospital_overlay, treso_zone, siteid, caretype, hosp_csduid = csduid, csdname, cdname), by = c('siteid', 'caretype')) %>% 
  left_join(agegroup_ref, by = 'agegroup')

HBAMhistorical_origcsd_cases <- HBAMhistorical_master_tz %>% 
  group_by(year, siteid, agegroup, caretype) %>% 
  mutate(totalcases = sum(cases),
         csd.mrkt = cases/totalcases) %>% 
  select(year, siteid, hospitalname, caretype,agegroup, age_cluster, orig_csd, cases, totalcases, csd.mrkt)

treso_caserates <- left_join(caserates_comp, treso_zone_system, by = c('orig_csd' = 'csduid', 'orig_cd' = 'cduid')) %>%
  left_join(agegroup_ref, by = 'agegroup') %>% 
  select(year,
         treso_zone = treso_id,
         orig_csd,
         csdname,
         orig_cd,
         cdname,
         agegroup,
         caretype,
         csd_caserate,
         cd_caserate)

treso_origin_cases <- left_join(treso_caserates, treso_population_long, by = c('year', 'treso_zone', 'orig_csd' = 'csduid', 'agegroup' = 'age_group')) %>% 
  rename('orig.treso.zone' = 'treso_zone',
         'treso.pop' = 'population') %>%
  group_by(year, agegroup, orig_csd,caretype) %>%
  mutate(csd.pop = sum(treso.pop),
         treso.pop.perc = treso.pop/csd.pop,
         treso.caserate = treso.pop.perc*csd_caserate)



```


























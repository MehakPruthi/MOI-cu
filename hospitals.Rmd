---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
```

## To-Do List
[x] Calculate Origin trips by TRESO zone for each caretype by CD case-rates
[x] Aggregate HBAM Historical caseload to TRESO zone level for Destination trips
[x] Balance O-D pairing
[x] Separate Pediatric (0-17), Adult (18-74) and Senior (75+) age groups
[] Calculate Origin trips by TRESO zone for each caretype by CSD case-rates

## Import Relevant Files
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
  
```{r, include= FALSE, results='hide'}
#CD Caserates
cd_caserates <- readRDS('cache/hospitals/cd_caserates.rds') %>% 
  select(cd,
         caretype,
         agegroup,
         caserate) %>% 
  mutate(cd = as.numeric(cd))

csd_caserates <- readRDS('cache/hospitals/csd_caserates.rds') %>% 
  filter(caserate != Inf) %>% #TRESO zones with 0 population resulted in Inf caserates, causing a mismatch of total cases between Origin and Destination vectors when calcluated at the CSD-level (see below)
  select(-totalcases, -population)

# Historical HBAM Master (w/ Asset data)
HBAMhistorical_master <- readRDS('cache/hospitals/HBAMhistorical_master.rds')

# Projected HBAM Master (w/ Asset data)
HBAMprojected_master <- readRDS('cache/hospitals/HBAMprojected_master.rds')

#Hospital Asset Data
hospitallocations <- readRDS('cache/hospitals/hospitallocations.rds')

#TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")

treso_health_slim_tb <- readRDS('cache/hospitals/treso_health_tb.rds') %>% 
  select(treso_zone,
         cdname, 
         cd = cduid,
         csdname,
         csd = csduid,
         pop_ag1 = n_ag1_pop,
         pop_ag2 = n_ag2_pop,
         pop_ag3 = n_ag3_pop,
         pop_ag4 = n_ag4_pop,
         pop_ag5 = n_ag5_pop,
         pop_ag6 = n_ag6_pop)

travel_time_skim_square <- read_csv("input/treso/mf224.csv.gz")

travel_time_skim <- travel_time_skim_square %>%
  melt(id = c("p/q/[val]")) %>%
  rename(orig = "p/q/[val]", dest = variable) %>%
  mutate(orig = as.numeric(orig), dest = as.numeric(levels(dest))[dest])

treso_zone_system <- read_csv('input/treso/treso_zone_system.csv')

rm(travel_time_skim_square)
```

## Convert TRESO data to long format
```{r}
treso_health_long <- gather(treso_health_slim_tb, agegroup, population, pop_ag1:pop_ag6) %>%
  mutate(agegroup = replace(agegroup, agegroup == 'pop_ag1', 1),
         agegroup = replace(agegroup, agegroup == 'pop_ag2', 2),
         agegroup = replace(agegroup, agegroup == 'pop_ag3', 3),
         agegroup = replace(agegroup, agegroup == 'pop_ag4', 4),
         agegroup = replace(agegroup, agegroup == 'pop_ag5', 5),
         agegroup = replace(agegroup, agegroup == 'pop_ag6', 6))
```

## Link Hospital Site IDs to TRESO Zones:
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Identify and quantify unmatched TRESO zones/Site IDs, if any
  
```{r}
# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- HBAMhistorical_master %>%
  ungroup() %>%
  select(name,
         siteid,
         facilityid,
         caretype,
         pcode,
         lat,
         long) %>%
  group_by(siteid) %>%
  summarise_all(funs(first)) %>%
  mutate(id = row_number()) %>% 
  drop_na(lat)

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            name = hospital_xy@data$name,
            siteid = hospital_xy@data$siteid,
            caretype = hospital_xy@data$caretype) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             caretype,
             name, 
             siteid) %>% 
      rename(treso_zone = Treso_ID) %>% 
      mutate(caretype = as.character(caretype))

# Match Original Historical HBAM Site IDs with Orignal Asset Inventory to quantify mismatched IDs
# hospital_id_join <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype')) %>% 
#   filter(!is.na(name)) %>% 
#   distinct(siteid) 

# Mismatched IDs from Original Asset Inventory and TRESO Overlay (should be empty)
# hospital_mismatch <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype')) %>% 
#   filter(is.na(lat))

# hospital_mismatch_treso <- left_join(HBAMhistorical_destination, hospital_overlay, by = c('siteid', 'caretype')) %>% 
#   filter(is.na(treso_zone))

# rm(hospital_xy, hospital_spdf, treso_shp)
```

## HBAM Age Group Separation
  - Join HBAM historical data to hospital spatial database
  - Filter master dataset for major age groups
```{r}
#Update Master HBAM liste to Include TRESO Zones
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, select(hospital_overlay, treso_zone, siteid, caretype), by = c('siteid', 'caretype'))

#Filter out Adult age groups
HBAMhistorical_master_ad <- HBAMhistorical_master_tz %>% 
  select(siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         csd,
         treso_zone) %>% 
  filter(agegroup %in% (2:4))

#Filter Pediatric Age Groups  
HBAMhistorical_master_ped <- HBAMhistorical_master_tz %>%
  select(siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         csd,
         treso_zone) %>%
  filter(agegroup == 1)

#Filter Senior Age Groups
HBAMhistorical_master_sr <- HBAMhistorical_master_tz %>% 
  select(siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         csd,
         treso_zone) %>% 
  filter(agegroup %in% (5:6))  
```

## Destination Caseload Calculation
  - Create TRESO destination caseload datasets
  - Required to create two sets of destination datasets, one for CD caserate applications (that used matched HBAM/TRESO CDs) and one for matched HBAM/TRESO CSDs (some of which  mismatched)

### CD Destination Caseload
```{r}
# Aggregate Historical HBAM to corresponding TRESO level
destination_trips_cd_ad <- HBAMhistorical_master_ad %>%
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

destination_trips_cd_ped <- HBAMhistorical_master_ped %>%
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

destination_trips_cd_sr <- HBAMhistorical_master_sr %>% 
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

#Total Cases Summarise
calcases_destination_cd_ad <- destination_trips_cd_ad %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_destination_cd_ped <- destination_trips_cd_ped %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_destination_cd_sr <- destination_trips_cd_sr %>% 
  ungroup() %>% 
  summarise(sum(d_trips))
```

### CSD Destination Caseload
```{r}
###CSD caserates needed extra filtering steps as there are TRESO zones w/ 0 population that when aggregated to the CSD level created 'inf' outputs, as opposed to CDs which are larger and have a wider capture area

#Join destination data to joined CSDs for master-list
csd_destinations <- left_join(csd_caserates, HBAMhistorical_master_tz, by = c('csd', 'agegroup', 'caretype')) %>% 
  select(siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         treso_zone,
         csd) #sum of csd_destinations is less than original HBAMhistorical_master by 51k cases removed as NAs from CSD mismatch

#Aggregate HBAM to corresponding TRESO level
destination_trips_csd_ad <- csd_destinations %>%
  rename('d_trips' = 'totalcases') %>% 
  filter(agegroup %in% (2:4)) %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

destination_trips_csd_ped <- csd_destinations %>% 
  rename('d_trips' = 'totalcases') %>% 
  filter(agegroup == 1) %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

destination_trips_csd_sr <- csd_destinations %>% 
  rename('d_trips' = 'totalcases') %>% 
  filter(agegroup %in% (5:6)) %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

#Total Cases Summarise
calcases_destination_csd_ad <- destination_trips_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_destination_csd_ped <- destination_trips_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_destination_csd_sr <- destination_trips_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

sum(calcases_destination_csd_ad, calcases_destination_csd_ped, calcases_destination_csd_sr)
```

## HBAM Base Care-Type Matricies

### Adult Care-Type Matricies
```{r}
#Create Care-Type Matrices for Adult Age Groups
at_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'AT') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

cr_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'CR') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

gr_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'GR') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

mh_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'MH') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

am_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'AM') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)
```

### Pediatric Care-Type Matricies
```{r}
#Create Care-Type Matrices for Adult Age Groups
at_hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
  filter(caretype == 'AT') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)
  
cr_hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
  filter(caretype == 'CR') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

gr_hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
  filter(caretype == 'GR') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

mh_hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
  filter(caretype == 'MH') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

am_hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
  filter(caretype == 'AM') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

### Senior HBAM matrices were created in the loops below once the manual stucture for each caretype was established
```

### Historical HBAM Matrices For Loops
```{r}
caretypes = c("at", "cr", "gr", "mh", "am")
age_groups = c("ad", "ped")

#For Loop to create HBAM Matrices for each care-type
for (ct in caretypes) {
  
  hbam_matrix_ad <- HBAMhistorical_master_ad %>%
    filter(caretype == toupper(ct)) %>% 
    group_by(csd, treso_zone) %>% 
    summarise(trips = sum(totalcases)) %>% 
    mutate(trips = trips/365)
  
  saveRDS(hbam_matrix_ad, file = paste0('cache/hospitals/', ct, "_hbam_matrix_ad.rds"))
  
  hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
    filter(caretype == toupper(ct)) %>% 
    group_by(csd, treso_zone) %>% 
    summarise(trips = sum(totalcases)) %>% 
    mutate(trips = trips/365)
  
  saveRDS(hbam_matrix_ped, file = paste0('cache/hospitals/', ct, "_hbam_matrix_ped.rds"))
  
  hbam_matrix_sr <- HBAMhistorical_master_sr %>% 
    filter(caretype == toupper(ct)) %>% 
    group_by(csd, treso_zone) %>% 
    summarise(trips = sum(totalcases)) %>% 
    mutate(trips = trips/365)   
  
  saveRDS(hbam_matrix_sr, file = paste0('cache/hospitals/', ct, "_hbam_matrix_sr.rds"))

}

rm(hbam_matrix_ad, hbam_matrix_ped, HBAMhistorical_master_sr)

```

## Origin Caseload Calculation
  - Join CD Caserates to TRESO data
  - Assuming one case = one trip (may be > 1 for most cases)
  - Calculate Origin vector cases / trips
  - Create totaling outputs
  
### CD Origin Rates Applied
```{r}
#Calculate Origin trips

## Adult Origins
origin_trips_cd_ad <- left_join(treso_health_long, cd_caserates, by = c('cd', 'agegroup')) %>% 
  filter(agegroup %in% (2:4)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup () %>% 
  group_by(cd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))


## Pediatric Origins
origin_trips_cd_ped <- left_join(treso_health_long, cd_caserates, by = c('cd', 'agegroup')) %>%
  filter(agegroup == 1) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup () %>% 
  group_by(cd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))


## Senior Origins
origin_trips_cd_sr <- left_join(treso_health_long, cd_caserates, by = c('cd', 'agegroup')) %>% 
  filter(agegroup %in% (5:6)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup () %>% 
  group_by(cd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

#Total Case Summarise
calcases_cd_origin_ad <- origin_trips_cd_ad %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

calcases_cd_origin_ped <- origin_trips_cd_ped %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

calcases_cd_origin_sr <- origin_trips_cd_sr %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))
```

### CSD Origin Rates Applied
```{r}
#Calculate Origin trips

## Adult Origins
origin_trips_csd_ad <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>% 
  filter(agegroup %in% (2:4)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup() %>% 
  group_by(csd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

## Pediatric Origins
origin_trips_csd_ped <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>%
  filter(agegroup == 1) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup() %>% 
  group_by(csd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

## Senior Origins
origin_trips_csd_sr <- left_join(treso_health_long, csd_caserates, by = c('csd', 'agegroup')) %>% 
  filter(agegroup %in% (5:6)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup() %>% 
  group_by(csd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

#Total Case Summarise
calcases_csd_origin_ad <- origin_trips_csd_ad %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

calcases_csd_origin_ped <- origin_trips_csd_ped %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

calcases_csd_origin_sr <- origin_trips_csd_sr %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

sum(calcases_csd_origin_ad, calcases_csd_origin_ped, calcases_csd_origin_sr) #Total of 7,314,475 cases, difference of 57,854 cases from original HBAM due to mismatched CSDs (see mismatched_csd)
```

## Mapping Hospital points to TRESO zone polygons
```{r, include=FALSE, echo=FALSE, eval=FALSE}
# Convert the SpatialDataframe to normal Dataframe for ggplot()
treso_shp_df <- fortify(treso_shp) %>%
  rename(
    x = long,
    y = lat
  )

hospital_xy_df <- data.frame(hospital_xy) %>%
  rename(
    x = long,
    y = lat
  )

hospital_plot <- ggplot() +
  geom_polygon(data = treso_shp_df, mapping = aes(x = x, y = y, group = group),
               fill = 'grey40', color = 'grey90', alpha = 1, size = 0.1) +
  geom_point(data = hospital_xy_df, mapping = aes(x = x, y = y), color = "red", alpha = 0.1, size = 0.05) +
  labs(x = "", y = "", title = "Hospitals in Ontario") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

ggsave(hospital_plot, file = "output/hospital_plot.png", width = 20, height = 20)

```

## CD Rate O-D Matricies
  - Develop O-D dataframes for each care type: AT, CR, GR, MH, AM (ER + DS)
  - Fill NA values with 0 for TRESO zones with no travel

### AT
```{r}
###Adult
at_origin_cd_ad <- origin_trips_cd_ad %>% 
  filter(caretype == 'AT') %>%
  ungroup() %>% 
  select(-caretype, -cd)

at_destination_cd_ad <- destination_trips_cd_ad %>% 
  filter(caretype == 'AT') %>% 
  select(-caretype)

at_origin_cd_full_ad <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(at_origin_cd_ad, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

at_destination_cd_full_ad <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(at_destination_cd_ad, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

###Pediatric
at_origin_cd_ped <- origin_trips_cd_ped %>% 
  filter(caretype == 'AT') %>%
  ungroup() %>% 
  select(-caretype, -cd)

at_destination_cd_ped <- destination_trips_cd_ped %>% 
  filter(caretype == 'AT') %>% 
  select(-caretype)

at_origin_cd_full_ped <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(at_origin_cd_ped, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

at_destination_cd_full_ped <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(at_destination_cd_ped, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### CR
```{r}
###Adult
cr_origin_cd_ad <- origin_trips_cd_ad %>% 
  filter(caretype == 'CR') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

cr_destination_cd_ad <- destination_trips_cd_ad %>% 
  filter(caretype == 'CR') %>% 
  select(-caretype)

cr_origin_cd_full_ad <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(cr_origin_cd_ad, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

cr_destination_cd_full_ad <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(cr_destination_cd_ad, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

###Pediatric
cr_origin_cd_ped <- origin_trips_cd_ped %>% 
  filter(caretype == 'CR') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

cr_destination_cd_ped <- destination_trips_cd_ped %>% 
  filter(caretype == 'CR') %>% 
  select(-caretype)

cr_origin_cd_full_ped <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(cr_origin_cd_ped, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

cr_destination_cd_full_ped <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(cr_destination_cd_ped, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### GR
```{r}
###Adult
gr_origin_cd_ad <- origin_trips_cd_ad %>% 
  filter(caretype == 'GR') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

gr_destination_cd_ad <- destination_trips_cd_ad %>% 
  filter(caretype == 'GR') %>% 
  select(-caretype)

gr_origin_cd_full_ad <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(gr_origin_cd_ad, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

gr_destination_cd_full_ad <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(gr_destination_cd_ad, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

###Pediatric
gr_origin_cd_ped <- origin_trips_cd_ped %>% 
  filter(caretype == 'GR') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

gr_destination_cd_ped <- destination_trips_cd_ped %>% 
  filter(caretype == 'GR') %>% 
  select(-caretype)

gr_origin_cd_full_ped <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(gr_origin_cd_ped, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

gr_destination_cd_full_ped <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(gr_destination_cd_ped, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### MH
```{r}
###Adult
mh_origin_cd_ad <- origin_trips_cd_ad %>% 
  filter(caretype == 'MH') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

mh_destination_cd_ad <- destination_trips_cd_ad %>% 
  filter(caretype == 'MH') %>% 
  select(-caretype)

mh_origin_cd_full_ad <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(mh_origin_cd_ad, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

mh_destination_cd_full_ad <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(mh_destination_cd_ad, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

###Pediatric
mh_origin_cd_ped <- origin_trips_cd_ped %>% 
  filter(caretype == 'MH') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

mh_destination_cd_ped <- destination_trips_cd_ped %>% 
  filter(caretype == 'MH') %>% 
  select(-caretype)

mh_origin_cd_full_ped <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(mh_origin_cd_ped, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix() 

mh_destination_cd_full_ped <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(mh_destination_cd_ped, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### AM
```{r}
###Adult
am_origin_cd_ad <- origin_trips_cd_ad %>% 
  filter(caretype == 'AM') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

am_destination_cd_ad <- destination_trips_cd_ad %>% 
  filter(caretype == 'AM') %>% 
  select(-caretype)

am_origin_cd_full_ad <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(am_origin_cd_ad, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

am_destination_cd_full_ad <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(am_destination_cd_ad, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

###Pediatric
am_origin_cd_ped <- origin_trips_cd_ped %>% 
  filter(caretype == 'AM') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

am_destination_cd_ped <- destination_trips_cd_ped %>% 
  filter(caretype == 'AM') %>% 
  select(-caretype)

am_origin_cd_full_ped <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(am_origin_cd_ped, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix() 

am_destination_cd_full_ped <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(am_destination_cd_ped, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

## CSD-Rate O-D Matrices
```{r}
##Create OD matrices for CSD rates using loops below once manual structure was established using CD rates as per chunk above

caretypes = c("at", "cr", "gr", "mh", "am")
age_groups = c("ad", "ped")

#Adult
for (ct in caretypes) {
    origin_csd_ad <- origin_trips_csd_ad %>% 
      filter(caretype == toupper(ct)) %>% 
      ungroup() %>% 
      select(-caretype, -csd)
    
    saveRDS(origin_csd_ad, file = paste0("cache/hospitals/", ct, "_origin_csd_ad.rds"))
    
    destination_csd_ad <- destination_trips_csd_ad %>% 
      filter(caretype == toupper(ct)) %>% 
      select(-caretype)
    
    saveRDS(destination_csd_ad, file = paste0("cache/hospitals/", ct, "_destination_csd_ad.rds"))
    
    origin_csd_full_ad <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd_ad, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full_ad, file = paste0("cache/hospitals/", ct, "_origin_csd_full_ad.rds"))
    
    destination_csd_full_ad <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd_ad, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
     saveRDS(destination_csd_full_ad, file = paste0("cache/hospitals/", ct, "_destination_csd_full_ad.rds"))
}

#Pediatric
for (ct in caretypes) {
    origin_csd_ped <- origin_trips_csd_ped %>% 
      filter(caretype == toupper(ct)) %>% 
      ungroup() %>% 
      select(-caretype, -csd)
    
    saveRDS(origin_csd_ped, file = paste0("cache/hospitals/", ct, "_origin_csd_ped.rds"))
    
    destination_csd_ped <- destination_trips_csd_ped %>% 
      filter(caretype == toupper(ct)) %>% 
      select(-caretype)
    
    saveRDS(destination_csd_ped, file = paste0("cache/hospitals/", ct, "_destination_csd_ped.rds"))
    
    origin_csd_full_ped <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd_ped, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full_ped, file = paste0("cache/hospitals/", ct, "_origin_csd_full_ped.rds"))
    
    destination_csd_full_ped <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd_ped, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
     saveRDS(destination_csd_full_ped, file = paste0("cache/hospitals/", ct, "_destination_csd_full_ped.rds"))
}

#Senior
for (ct in caretypes) {
    origin_csd_sr <- origin_trips_csd_sr %>% 
      filter(caretype == toupper(ct)) %>% 
      ungroup() %>% 
      select(-caretype, -csd)
    
    saveRDS(origin_csd_sr, file = paste0("cache/hospitals/", ct, "_origin_csd_sr.rds"))
    
    destination_csd_sr <- destination_trips_csd_sr %>% 
      filter(caretype == toupper(ct)) %>% 
      select(-caretype)
    
    saveRDS(destination_csd_sr, file = paste0("cache/hospitals/", ct, "_destination_csd_sr.rds"))
    
    origin_csd_full_sr <- travel_time_skim %>% 
      distinct(orig) %>% 
      left_join(origin_csd_sr, by = c('orig' = 'treso_zone')) %>% 
      replace_na(list(o_trips = 0)) %>%
      column_to_rownames(var = "orig") %>%
      data.matrix()
    
    saveRDS(origin_csd_full_sr, file = paste0("cache/hospitals/", ct, "_origin_csd_full_sr.rds"))
    
    destination_csd_full_sr <- travel_time_skim %>% 
      distinct(dest) %>% 
      left_join(destination_csd_sr, by = c('dest' = 'treso_zone')) %>% 
      replace_na(list(d_trips = 0)) %>%
      column_to_rownames(var = "dest") %>%
      data.matrix()
    
     saveRDS(destination_csd_full_sr, file = paste0("cache/hospitals/", ct, "_destination_csd_full_sr.rds"))
}

rm(origin_csd_ad, origin_csd_ped, origin_csd_sr, origin_csd_full_ad, origin_csd_full_ped, origin_csd_full_sr)
rm(destination_csd_ad, destination_csd_ped, destination_csd_sr, destination_csd_full_ad, destination_csd_full_ped, destination_csd_full_sr)
```

## Travel Demand Matricies 
  - Develop Propensity Matrix from TRESO travel times skim
  - Create function for matrix balancing
  - Calculate propensity matrix for each care type
  
```{r}
prop_matrix <- travel_time_skim %>%
  mutate(value = replace(value, value == 0, 0.00000001),
         value = 1/value) %>% #change if something bad happens 
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

balance <- function(matrix, tot, axis) {
  if (axis == 1) {
      sum <- rowSums(matrix)
  } else if (axis == 2) {
      sum <- colSums(matrix)
  }
  sc <- tot / sum 
  sc[is.nan(sc)] <- 0
  
  # MARGIN = 1 indicates rows, MARGIN = 2 indicates columns
  matrix2 <- sweep(matrix, MARGIN = axis, sc, `*`)
  return(matrix2)
}

calc_error <- function(matrix, a, b) {
  row_sum <- sum(abs(a - rowSums(matrix)))
  col_sum <- sum(abs(b - colSums(matrix)))
  return(row_sum + col_sum)
}

matrix_balancing <- function(matrix, a, b, max_iterations = 10000, rel_error = 0.0001) {
  error <- 1.0
  i <- 0
  init_error <- calc_error(matrix, a, b)
  matrix2 <- matrix
  
  while (error > rel_error) {
    if (i > max_iterations) {
      print("Matrix balancing did not converge within iteration limit")
      break
    }
    matrix2 <- balance(matrix2, a, 1)
    matrix2 <- balance(matrix2, b, 2)
    error <- calc_error(matrix2, a, b) / init_error
    i <- i + 1
  }
  return(matrix2)
}
```

## Summarize CD Rate Matrices (Origin)
  - Balance O-D pairing matricies for each care-type
  - Calculate difference between original HBAM "cases" and matrix-generated "trips"

### AT Matrices
```{r AT Adult, eval=FALSE}

# Create Propensity Matrix
at_prop_matrix_cd_ad <- matrix_balancing(prop_matrix, at_origin_cd_full_ad, at_destination_cd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_cd_ad <- at_prop_matrix_cd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_cd_ad <- left_join(at_matrix_long_cd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_cd_ad <- at_prop_matrix_cd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_cd_ad <- at_origin_cd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_cd_ad <- full_join(at_sim_matrix_cd_ad, at_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_ad <- at_origin_cd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AT Pediatric, eval=FALSE}
# Create Propensity Matrix
at_prop_matrix_cd_ped <- matrix_balancing(prop_matrix, at_origin_cd_full_ped, at_destination_cd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_cd_ped <- at_prop_matrix_cd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_cd_ped <- left_join(at_matrix_long_cd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_cd_ped <- at_prop_matrix_cd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_cd_ped <- at_origin_cd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_cd_ped <- full_join(at_sim_matrix_cd_ped, at_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_ad <- at_origin_cd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### CR Matrices

```{r CR Adult, eval=FALSE}
# Create Propensity Matrix
cr_prop_matrix_cd_ad <- matrix_balancing(prop_matrix, cr_origin_cd_full_ad, cr_destination_cd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_cd_ad <- cr_prop_matrix_cd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_cd_ad <- left_join(cr_matrix_long_cd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_cd_ad <- cr_prop_matrix_cd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_cd_ad <- cr_origin_cd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_cd_ad <- full_join(cr_sim_matrix_cd_ad, cr_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)
```

```{r CR Pediatrics}
# Create Propensity Matrix
cr_prop_matrix_cd_ped <- matrix_balancing(prop_matrix, cr_origin_cd_full_ped, cr_destination_cd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_cd_ped <- cr_prop_matrix_cd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_cd_ped <- left_join(cr_matrix_long_cd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_cd_ped <- cr_prop_matrix_cd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_cd_ped <- cr_origin_cd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_cd_ped <- full_join(cr_sim_matrix_cd_ped, cr_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0,  trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)
```

### GR Matrices

```{r GR Adult, eval=FALSE}
# Create Propensity Matrix
gr_prop_matrix_cd_ad <- matrix_balancing(prop_matrix, gr_origin_cd_full_ad, gr_destination_cd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_cd_ad <- gr_prop_matrix_cd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_cd_ad <- left_join(gr_matrix_long_cd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)
  
# Summarise and Calculate Comparison
gr_prop_sum_cd_ad <- gr_prop_matrix_cd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_cd_ad <- gr_origin_cd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_cd_ad <- full_join(gr_sim_matrix_cd_ad, gr_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)

```

```{r GR Pediatric, eval=FALSE}
# Create Propensity Matrix
gr_prop_matrix_cd_ped <- matrix_balancing(prop_matrix, gr_origin_cd_full_ped, gr_destination_cd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_cd_ped <- gr_prop_matrix_cd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_cd_ped <- left_join(gr_matrix_long_cd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)
  
# Summarise and Calculate Comparison
gr_prop_sum_cd_ped <- gr_prop_matrix_cd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_cd_ped <- gr_origin_cd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_cd_ped <- full_join(gr_sim_matrix_cd_ped, gr_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)
```

### MH Matrices

```{r MH Adult}
# Create Propensity Matrix
mh_prop_matrix_cd_ad <- matrix_balancing(prop_matrix, mh_origin_cd_full_ad, mh_destination_cd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_cd_ad <- mh_prop_matrix_cd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_cd_ad <- left_join(mh_matrix_long_cd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_cd_ad <- mh_prop_matrix_cd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_cd_ad <- mh_origin_cd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_cd_ad <- full_join(mh_sim_matrix_cd_ad, mh_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)
```

```{r MH Pediatric}
# Create Propensity Matrix
mh_prop_matrix_cd_ped <- matrix_balancing(prop_matrix, mh_origin_cd_full_ped, mh_destination_cd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_cd_ped <- mh_prop_matrix_cd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_cd_ped <- left_join(mh_matrix_long_cd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_cd_ped <- mh_prop_matrix_cd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_cd_ped <- mh_origin_cd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_cd_ped <- full_join(mh_sim_matrix_cd_ped, mh_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)
```

### AM Matrices

```{r AM Adult}
# Create Propensity Matrix
am_prop_matrix_cd_ad <- matrix_balancing(prop_matrix, am_origin_cd_full_ad, am_destination_cd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_cd_ad <- am_prop_matrix_cd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_cd_ad <- left_join(am_matrix_long_cd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_cd_ad <- am_prop_matrix_cd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_cd_ad <- am_origin_cd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_cd_ad <- full_join(am_sim_matrix_cd_ad, am_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_cd_ad <- am_origin_cd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AM Pediatric}
# Create Propensity Matrix
am_prop_matrix_cd_ped <- matrix_balancing(prop_matrix, am_origin_cd_full_ped, am_destination_cd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_cd_ped <- am_prop_matrix_cd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_cd_ped <- left_join(am_matrix_long_cd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_cd_ped <- am_prop_matrix_cd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_cd_ped <- am_origin_cd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_cd_ped <- full_join(am_sim_matrix_cd_ped, am_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_cd_ped <- am_origin_cd_ped %>% #naming should be changed to reflect that it's using CD case rates 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### Balanced Matrices For Loops

#### CD Rate Matricses (NEEDS TO BE FIXED)
  - Apply CD case-rate calculations to propensity matrix and create trip distribution matrix
  - Compare simulated trip distribution matrix with observed HBAM matrix at the CSD level (as per HBAM)
```{r}
#Adult Matrix
for (ct in caretypes) {
  prop_matrix_ad <- matrix_balancing(prop_matrix, origin_full_ad, destination_full_ad, 1000, 0.001)
  
  saveRDS(prop_matrix, file = paste0("cache/hospitals/", ct, "_prop_matrix_ad.rds"))
  
  matrix_long_ad <- prop_matrix_ad %>% 
    melt() %>% 
    rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')
  
  saveRDS(matrix_long_ad, file = paste0("cache/hospitals/", ct, "_prop_matrix_ad.rds"))
  
  csd_matrix_ad <- left_join(matrix_long_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
    select(-area, -mof_region) %>% 
    filter(!is.na(csduid)) %>% 
    ungroup() %>% 
    group_by(csduid, destination) %>% 
    summarise(trips = sum(trips, na.rm = TRUE)) %>% 
    mutate(trips = trips/365)
  
  saveRDS(csd_matrix_ad, file = paste0("cache/hospitals/", ct, "_prop_matrix_ad.rds"))
  
  prop_sum_ad <- prop_matrix_ad %>% 
    colsums() %>% 
    melt() %>% 
    summarise(sum(value))
  
  print(prop_sum_ad)
  
  treso_csd_ad <- origin_ad %>% 
    left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))

  saveRDS(treso_csd_ad, file = paste0("cache/hospitals/", ct, "_prop_matrix_ad.rds"))
  
}

#Pediatric Matrix
for (ct in caretypes) {
  prop_matrix_ped <- matrix_balancing(prop_matrix, origin_full_ped, destination_full_ped, 1000, 0.001)
  
  saveRDS(prop_matrix, file = paste0("cache/hospitals/", ct, "_prop_matrix_ped.rds"))
  
  matrix_long_ped <- prop_matrix_ped %>% 
    melt() %>% 
    rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')
  
  saveRDS(matrix_long_ped, file = paste0("cache/hospitals/", ct, "_prop_matrix_ped.rds"))
  
  csd_matrix_ped <- left_join(matrix_long_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
    select(-area, -mof_region) %>% 
    filter(!is.na(csduid)) %>% 
    ungroup() %>% 
    group_by(csduid, destination) %>% 
    summarise(trips = sum(trips, na.rm = TRUE)) %>% 
    mutate(trips = trips/365)
  
  saveRDS(csd_matrix_ped, file = paste0("cache/hospitals/", ct, "_prop_matrix_ped.rds"))
  
  prop_sum_ped <- prop_matrix_ped %>% 
    colsums() %>% 
    melt() %>% 
    summarise(sum(value))
  
  print(prop_sum_ped)
  
  treso_csd_ped <- origin_ped %>% 
    left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))

  saveRDS(treso_csd_ped, file = paste0("cache/hospitals/", ct, "_prop_matrix_ped.rds"))
}

#Senior Matrix
for (ct in caretypes) {
  prop_matrix_sr <- matrix_balancing(prop_matrix, origin_full_sr, destination_full_sr, 1000, 0.001)
  
  saveRDS(prop_matrix, file = paste0("cache/hospitals/", ct, "_prop_matrix_sr.rds"))
  
  matrix_long_sr <- prop_matrix_sr %>% 
    melt() %>% 
    rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')
  
  saveRDS(matrix_long_sr, file = paste0("cache/hospitals/", ct, "_prop_matrix_sr.rds"))
  
  csd_matrix_sr <- left_join(matrix_long_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
    select(-area, -mof_region) %>% 
    filter(!is.na(csduid)) %>% 
    ungroup() %>% 
    group_by(csduid, destination) %>% 
    summarise(trips = sum(trips, na.rm = TRUE)) %>% 
    mutate(trips = trips/365)
  
  saveRDS(csd_matrix_sr, file = paste0("cache/hospitals/", ct, "_prop_matrix_sr.rds"))
  
  prop_sum_sr <- prop_matrix_sr %>% 
    colsums() %>% 
    melt() %>% 
    summarise(sum(value))
  
  print(prop_sum_sr)
  
  treso_csd_sr <- origin_sr %>% 
    left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))

  saveRDS(treso_csd_sr, file = paste0("cache/hospitals/", ct, "_prop_matrix_sr.rds"))
}
```

## Summarize CSD Matrices (Origin)
  - Apply CSD case-rates

### AT Matrices

```{r AT Adult}
# Create Propensity Matrix
at_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, at_origin_csd_full_ad, at_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_csd_ad <- at_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_csd_ad <- left_join(at_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_csd_ad <- at_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_csd_ad <- at_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_csd_ad <- full_join(at_sim_matrix_csd_ad, at_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_ad <- at_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AT Pediatric}
# Create Propensity Matrix
at_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, at_origin_csd_full_ped, at_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_csd_ped <- at_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_csd_ped <- left_join(at_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_csd_ped <- at_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_csd_ped <- at_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_csd_ped <- full_join(at_sim_matrix_csd_ped, at_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_ped <- at_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AT Senior}
# Create Propensity Matrix
at_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, at_origin_csd_full_sr, at_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long_csd_sr <- at_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_sim_matrix_csd_sr <- left_join(at_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
at_prop_sum_csd_sr <- at_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum_csd_sr <- at_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix_csd_sr <- full_join(at_sim_matrix_csd_sr, at_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
at_treso_csd_sr <- at_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### CR Matrices

```{r CR Adult}
# Create Propensity Matrix
cr_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, cr_origin_csd_full_ad, cr_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_csd_ad <- cr_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_csd_ad <- left_join(cr_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_csd_ad <- cr_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_csd_ad <- cr_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_csd_ad <- full_join(cr_sim_matrix_csd_ad, cr_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
cr_treso_csd_ad <- cr_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r CR Pediatric}
# Create Propensity Matrix
cr_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, cr_origin_csd_full_ped, cr_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_csd_ped <- cr_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_csd_ped <- left_join(cr_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_csd_ped <- cr_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_csd_ped <- cr_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_csd_ped <- full_join(cr_sim_matrix_csd_ped, cr_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
cr_treso_csd_ped <- cr_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r CR Senior}
# Create Propensity Matrix
cr_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, cr_origin_csd_full_sr, cr_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long_csd_sr <- cr_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_sim_matrix_csd_sr <- left_join(cr_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
cr_prop_sum_csd_sr <- cr_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum_csd_sr <- cr_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix_csd_sr <- full_join(cr_sim_matrix_csd_sr, cr_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
cr_treso_csd_sr <- cr_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### GR Matrices

```{r GR Adult}
# Create Propensity Matrix
gr_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, gr_origin_csd_full_ad, gr_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_csd_ad <- gr_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_csd_ad <- left_join(gr_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
gr_prop_sum_csd_ad <- gr_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_csd_ad <- gr_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_csd_ad <- full_join(gr_sim_matrix_csd_ad, gr_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
gr_treso_csd_ad <- gr_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r GR Pediatric}
# Create Propensity Matrix
gr_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, gr_origin_csd_full_ped, gr_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_csd_ped <- gr_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_csd_ped <- left_join(gr_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
gr_prop_sum_csd_ped <- gr_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_csd_ped <- gr_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_csd_ped <- full_join(gr_sim_matrix_csd_ped, gr_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
gr_treso_csd_ped <- gr_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r GR Senior}
# Create Propensity Matrix
gr_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, gr_origin_csd_full_sr, gr_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long_csd_sr <- gr_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_sim_matrix_csd_sr <- left_join(gr_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
gr_prop_sum_csd_sr <- gr_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum_csd_sr <- gr_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix_csd_sr <- full_join(gr_sim_matrix_csd_sr, gr_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
gr_treso_csd_sr <- gr_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### MH  Matrices

```{r MH Adult}
# Create Propensity Matrix
mh_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, mh_origin_csd_full_ad, mh_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_csd_ad <- mh_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_csd_ad <- left_join(mh_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_csd_ad <- mh_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_csd_ad <- mh_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_csd_ad <- full_join(mh_sim_matrix_csd_ad, mh_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
mh_treso_csd_ad <- mh_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r MH Pediatric}
# Create Propensity Matrix
mh_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, mh_origin_csd_full_ped, mh_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_csd_ped <- mh_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_csd_ped <- left_join(mh_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_csd_ped <- mh_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_csd_ped <- mh_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_csd_ped <- full_join(mh_sim_matrix_csd_ped, mh_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
mh_treso_csd_ped <- mh_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r MH Senior}
# Create Propensity Matrix
mh_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, mh_origin_csd_full_sr, mh_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long_csd_sr <- mh_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_sim_matrix_csd_sr <- left_join(mh_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
mh_prop_sum_csd_sr <- mh_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum_csd_sr <- mh_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix_csd_sr <- full_join(mh_sim_matrix_csd_sr, mh_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
mh_treso_csd_sr <- mh_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

### AM Matrices

```{r AM Adult}
# Create Propensity Matrix
am_prop_matrix_csd_ad <- matrix_balancing(prop_matrix, am_origin_csd_full_ad, am_destination_csd_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_csd_ad <- am_prop_matrix_csd_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_csd_ad <- left_join(am_matrix_long_csd_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_csd_ad <- am_prop_matrix_csd_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_csd_ad <- am_origin_csd_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_csd_ad <- full_join(am_sim_matrix_csd_ad, am_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_csd_ad <- am_origin_csd_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AM Pediatric}
# Create Propensity Matrix
am_prop_matrix_csd_ped <- matrix_balancing(prop_matrix, am_origin_csd_full_ped, am_destination_csd_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_csd_ped <- am_prop_matrix_csd_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_csd_ped <- left_join(am_matrix_long_csd_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_csd_ped <- am_prop_matrix_csd_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_csd_ped <- am_origin_csd_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_csd_ped <- full_join(am_sim_matrix_csd_ped, am_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_csd_ped <- am_origin_csd_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

```{r AM Senior}
# Create Propensity Matrix
am_prop_matrix_csd_sr <- matrix_balancing(prop_matrix, am_origin_csd_full_sr, am_destination_csd_full_sr, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_csd_sr <- am_prop_matrix_csd_sr %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_sim_matrix_csd_sr <- left_join(am_matrix_long_csd_sr, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_csd_sr <- am_prop_matrix_csd_sr %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_csd_sr <- am_origin_csd_sr %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_csd_sr <- full_join(am_sim_matrix_csd_sr, am_hbam_matrix_sr, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0, trips.csd = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

#Create TRESO to CSD origin dataset
am_treso_csd_sr <- am_origin_csd_sr %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))
```

## Forecasting 

### Define forecasting parameters

```{r}
base_year <- 2016 #can set it to min(HBAM$year) to help streamline, requires insertion of 'year' in original HBAM code
proj_max_year <- max(HBAMprojected_master$year)
proj_year <- 2025 #user selected projection year
x1 = 2041 - proj_year
x2 = proj_year - 2016
proj_ct_list <- c('AT', 'CR', 'GR', 'MH', 'AM')

age_clusters <- c('ad', 'ad', 'ad', 'ped', 'sr', 'sr')
age_groups <- c(2:4, 1, 5:6)
agegroup_ref <- data.frame(age_clusters,
                          agegroup = as.factor(age_groups))

```

### 1D Matrix Balancing (temp for reference)

```{r}
matrix_balancing_1d <- function(matrix, a, weight, axis=1, constrained=TRUE) {
  
  #' One dimensional balances a matrix
  #' 
  #' One dimensional matrix balancing with optional scaling. If there are known scale weights that needs to be
  #' applied to the propensity matrix, it can be supplied in argument `weight`. The `axis` argument determine which
  #' direction to balance the matrix, 1 indicates rows (origin) and 2 indicates columns (destination). The 
  #' `constrained` flag determines if the weighting vector is used as a hard limit or as a boolean value to 
  #' prevent trips to be sent. 
  #' 
  #' @param matrix The propensity matrix
  #' @param a The totals to balance against
  #' @param weight The weight vector to scale against
  #' @param axis The direction to perform the balance
  #' @param constrianed A flag to determine if the weight is to be used as a constraint or not
  #' @return One dimentionally balanced matrix
  
  # Check if `axis` is 1 or 2
  if (!(axis %in% c(1, 2))) {
    stop("`axis` value is invalid, not one of (1, 2)")
  }
  
  # Check if weight vector is supplied
  if (missing(weight)) {
    print("`weight` was not supplied, 1D balancing done without any destination constraints")
    tot = a
    matrix2 <- balance(matrix, tot, axis)
  } else {
    print("`weight` was supplied, 1D balancing done with destination constraints")
    tot = a
    
    # If constrained, scale the matrix to the values of the weight vector
    # It not constrained, apply a boolean value to the matrix
    if (!(constrained)) {
      print("Weight is used as a boolean control for destination")
      weight = ifelse(weight == 0.0, 0, 1)
    } else {
      print("Weight is used directly")
    }
    
    # If `axis` is 1, balance the matrix against the rows but scale against the columns
    if (axis == 1) {
      sum = colSums(matrix)
      axis_to_scale = 2
    } 
    # If `axis` is 2, balance the matrix against the columns but scale against the rows
    else if (axis == 2) {
      sum = rowSums(matrix)
      axis_to_scale = 1
    }
    
    # Scale the propensity matrix to the weight vector
    matrix_scaled = sweep(matrix, MARGIN = axis_to_scale, weight, `*`)
    # Normalize the propensity matrix to ensure the scaled probailitiy does not exceed 1
    matrix_norm = sweep(matrix_scaled, MARGIN = axis_to_scale, sum, `/`)
    
    # 1D balance against the tot vector on the specified axis
    matrix2 <- balance(matrix_scaled, tot, axis)
  }
  
  return(matrix2)
}
```

### Projected HBAM Age Group Separations

```{r}
#Update Master HBAM liste to Include TRESO Zones
HBAMprojected_master_tz <- left_join(HBAMprojected_master, select(hospital_overlay, treso_zone, siteid, caretype), by = c('siteid', 'caretype')) %>% 
  left_join(agegroup_ref, by = c('agegroup'))

#Filter out Adult age groups
HBAMprojected_master_ad <- HBAMprojected_master_tz %>% 
  select(year,
         siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         los,
         beddays,
         treso_zone) %>% 
  filter(agegroup %in% (2:4))

#Filter Pediatric Age Groups  
HBAMprojected_master_ped <- HBAMprojected_master_tz %>%
  select(year,
         siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         los,
         beddays,
         treso_zone) %>%
  filter(agegroup == 1)

#Filter Senior Age Groups
HBAMprojected_master_sr <- HBAMprojected_master_tz %>% 
  select(year,
         siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         los,
         beddays,
         treso_zone) %>% 
  filter(agegroup %in% (5:6)) 

#For Loop to simplify NEEDS FIXING
for (a in unique(agegroup_ref$age_clusters)) {
  
  HBAMprojected_age <- HBAMprojected_master_tz %>% 
    filter(age_clusters == a) %>% 
    select(year,
         siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         los,
         beddays,
         treso_zone)
  
  saveRDS(HBAMprojected_age, file = paste0("cache/hospitals/HBAMprojected_", a, ".rds"))
}

rm(HBAMprojected_age)
```

### Projected HBAM Destination Vectors

  - Add Year variable in destination matrix
  
```{r}
# Aggregate Historical HBAM to corresponding TRESO level
proj_destination_trips_ad <- HBAMprojected_master_ad %>%
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

proj_destination_trips_ped <- HBAMprojected_master_ped %>%
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

proj_destination_trips_sr <- HBAMprojected_master_sr %>% 
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

for (ct in proj_ct_list) {
  for (a in age_clusters) {
    
    proj_destination_trips <- HBAMprojected_master_tz %>% 
      filter(agegroup == a,
             caretype == ct) %>% 
      group_by(treso_zone) %>% 
      summarise(d_trips = sum(totalcases))
    
    saveRDS(proj_destination_trips, file = paste0("cache/hospitals/", tolower(ct), "_proj_destination_", a,".rds"))
  }
}

rm(proj_destination_trips)

#Total Cases Summarise
calcases_proj_destination_ad <- proj_destination_trips_ad %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_proj_destination_ped <- proj_destination_trips_ped %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_proj_destination_sr <- proj_destination_trips_sr %>% 
  ungroup() %>% 
  summarise(sum(d_trips))
```

### Population Forecasting (TRESO) Setup

```{r}
#Import TRESO files (should be moved up later for consistency)
csd_controls <- read_csv("C:/Users/cane070735/Documents/MOI/Modelling/popsyn-scaling/csd_controls.csv")
hhld_2016 <- read_csv("C:/Users/cane070735/Documents/MOI/Modelling/popsyn-scaling/final_households_2016.csv.gz")
pers_2016 <- read_csv("C:/Users/cane070735/Documents/MOI/Modelling/popsyn-scaling/final_persons_2016.csv.gz")
hhld_2041 <- read_csv("C:/Users/cane070735/Documents/MOI/Modelling/popsyn-scaling/households_2041_p2g.csv.gz")
pers_2041 <- read_csv("C:/Users/cane070735/Documents/MOI/Modelling/popsyn-scaling/persons_2041_p2g.csv.gz") 
treso_zone_system <- read_csv("C:/Users/cane070735/Documents/MOI/Modelling/popsyn-scaling/treso_zone_system.csv")
```

```{r}
#Summarize base year population data
pers_2016_summary <- pers_2016 %>% 
    mutate(age_group = "other",
           age_group = ifelse(age <= 17 & age >= 0, 1, age_group),
           age_group = ifelse(age <= 44 & age >= 18, 2, age_group),
           age_group = ifelse(age <= 64 & age >= 45, 3, age_group),
           age_group = ifelse(age <= 74 & age >= 65, 4, age_group),
           age_group = ifelse(age <= 84 & age >= 75, 5, age_group),
           age_group = ifelse(age >= 85, 6, age_group)) %>%
    group_by(treso_zone, age_group) %>%
    summarise(population = n()) %>% 
    ungroup() %>% 
    left_join(select(treso_zone_system, csduid, treso_id), by = c("treso_zone" = "treso_id"))

#scale treso age groups to match csd_controls for 2016
pers_2016_summary_scaled <- pers_2016_summary %>% 
    group_by(csduid) %>% 
    mutate (total = sum(population)) %>% 
    ungroup() %>% 
    left_join(select(csd_controls, pop_2016, csduid), by = "csduid") %>% 
    mutate(scale_factor = pop_2016/total) %>% 
    mutate(population = population*scale_factor, perc_of_csd_pop_16 = (population/pop_2016)) %>% 
    select(treso_zone, age_group, csduid, population, perc_of_csd_pop_16)
    
#Summarize max forecast (TRESO) year
pers_2041_summary <- pers_2041 %>% 
    mutate(age_group = "other",
           age_group = ifelse(age <= 17 & age >= 0, 1, age_group),
           age_group = ifelse(age <= 44 & age >= 18, 2, age_group),
           age_group = ifelse(age <= 64 & age >= 45, 3, age_group),
           age_group = ifelse(age <= 74 & age >= 65, 4, age_group),
           age_group = ifelse(age <= 84 & age >= 75, 5, age_group),
           age_group = ifelse(age >= 85, 6, age_group)) %>%
    group_by(treso_zone, age_group) %>%
    summarise(population = n()) %>% 
    ungroup() %>% 
    left_join(select(treso_zone_system, csduid, treso_id), by = c("treso_zone" = "treso_id"))

#scale treso age groups to match csd_controls for 2041
pers_2041_summary_scaled <- pers_2041_summary %>% 
    group_by(csduid) %>% 
    mutate (total = sum(population)) %>% 
    ungroup() %>% 
    left_join(select(csd_controls, pop_2041, csduid), by = "csduid") %>% 
    mutate(scale_factor = pop_2041/total) %>% 
    mutate(population = population*scale_factor, perc_of_csd_pop_41 = (population/pop_2041)) %>% 
    select(treso_zone, age_group, csduid, population, perc_of_csd_pop_41)

#get the percent change for proj_year and calculate projected year allocation

proj_year_summary <- select(pers_2041_summary_scaled, treso_zone, age_group, csduid, perc_of_csd_pop_41) %>% 
    left_join(select(pers_2016_summary_scaled, treso_zone, age_group, csduid, perc_of_csd_pop_16), by = c("treso_zone", "age_group", "csduid")) %>% 
    replace(., is.na(.), 0)%>% 
    mutate(proj_year_csd_perc = (((perc_of_csd_pop_41 - perc_of_csd_pop_16)/(proj_max_year-base_year))*x2+perc_of_csd_pop_16)) %>% 
    left_join(select(csd_controls, csduid, paste0("pop_",proj_year)), by = "csduid") %>% 
    mutate(proj_year_pop = proj_year_csd_perc * get(paste0("pop_",proj_year))) %>% 
    select(treso_zone, age_group, csduid, proj_year_pop, proj_year_csd_perc)

#combined dataset for base, max and projected year population w/ percent change
pers_combined <- full_join(pers_2016_summary_scaled, pers_2041_summary_scaled, by = c("treso_zone", "age_group", "csduid"), suffix = c("_2016", "_2041")) %>%  
    left_join(proj_year_summary, by = c("treso_zone", "age_group", "csduid"))
```

### Origin forecast

```{r}
treso_caserates <- left_join(treso_zone_system, csd_caserates, by = c('csduid' = 'csd')) %>% 
  filter(!is.na(caserate))


proj_origin <- left_join(treso_caserates, proj_year_summary, by = c('treso_id' = 'treso_zone', 'csduid' = 'csduid', 'agegroup' = 'age_group')) %>% 
  left_join(agegroup_ref, by = c('agegroup')) %>% 
  mutate(origin_cases = caserate*proj_year_pop) %>% 
  select(-cdname, - cduid, -area, mof_region)

for (ct in proj_ct_list) {
    for (a in age_clusters) {
      
      ct_origin <- proj_origin %>% 
        filter(age_clusters == a,
               caretype == ct) %>% 
        group_by(treso_id) %>% 
        summarise(o_trips = sum(origin_cases)) %>% 
        replace_na(list(o_trips = 0))
      
      saveRDS(ct_origin, file = paste0("cache/hospitals/", tolower(ct), "_proj_origin_", a,".rds"))
    }
}

rm(ct_origin)




```



































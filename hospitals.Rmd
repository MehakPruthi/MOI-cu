---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
```

## To-Do List
[x] Calculate Origin trips by TRESO zone for each caretype
[x] Aggregate HBAM Historical caseload to TRESO zone level for Destination trips
[x] Balance O-D pairing

## Import Relevant Files
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
  
```{r, include= FALSE, results='hide'}
#CD Caserates
cd_caserates <- readRDS('cache/hospitals/cd_caserates.rds') %>% 
  select(cd,
         caretype,
         agegroup,
         caserate) %>% 
  ungroup(cd) %>% 
  mutate(cd = as.numeric(cd),
         caretype = replace(caretype, caretype == "ER", "AM"),
         caretype = replace(caretype, caretype == "DS", "AM"))

# Historical HBAM Master (w/ Asset data)
HBAMhistorical_master <- readRDS('cache/hospitals/HBAMhistorical_master.rds')

#Historical HBAM Data at CD level
HBAMhistorical_cd <- readRDS('cache/hospitals/hbam_cd.rds')

#Historical HBAM Destination data
HBAMhistorical_destination <- HBAMhistorical_master %>% 
  select(siteid,
         caretype,
         agegroup,
         totalcases) %>%
  ungroup() %>% 
  group_by(siteid,
           caretype) %>% 
  summarise(totalcases = sum(totalcases))

#Hospital Asset Data
hospitallocations <- readRDS('cache/hospitals/hospitallocations.rds')

#TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")

treso_health_slim_tb <- readRDS('cache/hospitals/treso_health_tb.rds') %>% 
  select(treso_zone,
         cdname, 
         cd = cduid,
         pop_ag1 = n_ag1_pop,
         pop_ag2 = n_ag2_pop,
         pop_ag3 = n_ag3_pop,
         pop_ag4 = n_ag4_pop,
         pop_ag5 = n_ag5_pop,
         pop_ag6 = n_ag6_pop,
         pop_ped1 = n_ped1_pop,
         pop_ped2 = n_ped2_pop,
         pop_ped3 = n_ped3_pop)

travel_time_skim_square <- read_csv("input/treso/mf224.csv.gz")

travel_time_skim <- travel_time_skim_square %>%
  melt(id = c("p/q/[val]")) %>%
  rename(orig = "p/q/[val]", dest = variable) %>%
  mutate(orig = as.numeric(orig), dest = as.numeric(levels(dest))[dest])

treso_zone_system <- read_csv('input/treso/treso_zone_system.csv')
```

## Convert TRESO data to long format
```{r}
treso_health_long <- gather(treso_health_slim_tb, agegroup, population, pop_ag1:pop_ag6) %>%
  select(-pop_ped1, -pop_ped2, -pop_ped3) %>% 
  mutate(agegroup = replace(agegroup, agegroup == 'pop_ag1', 1),
         agegroup = replace(agegroup, agegroup == 'pop_ag2', 2),
         agegroup = replace(agegroup, agegroup == 'pop_ag3', 3),
         agegroup = replace(agegroup, agegroup == 'pop_ag4', 4),
         agegroup = replace(agegroup, agegroup == 'pop_ag5', 5),
         agegroup = replace(agegroup, agegroup == 'pop_ag6', 6))
```

## Link Hospital Site IDs to TRESO Zones:
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Identify and quantify unmatched TRESO zones/Site IDs, if any
  
```{r}
# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- HBAMhistorical_master %>%
  ungroup() %>%
  select(name,
         siteid,
         facilityid,
         caretype,
         pcode,
         lat,
         long) %>%
  group_by(siteid) %>%
  summarise_all(funs(first)) %>%
  mutate(id = row_number()) %>% 
  drop_na(lat)

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            name = hospital_xy@data$name,
            siteid = hospital_xy@data$siteid,
            caretype = hospital_xy@data$caretype) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             caretype,
             name, 
             siteid) %>% 
      rename(treso_zone = Treso_ID) %>% 
      mutate(caretype = as.character(caretype))

# Match Original Historical HBAM Site IDs with Orignal Asset Inventory to quantify mismatched IDs
hospital_id_join <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype')) %>% 
  filter(!is.na(name)) %>% 
  distinct(siteid) 

# Mismatched IDs from Original Asset Inventory and TRESO Overlay (should be empty)
hospital_mismatch <- left_join(HBAMhistorical_destination, hospitallocations, by = c('siteid', 'caretype')) %>% 
  filter(is.na(lat))

hospital_mismatch_treso <- left_join(HBAMhistorical_destination, hospital_overlay, by = c('siteid', 'caretype')) %>% 
  filter(is.na(treso_zone))
```

## Combine TRESO Zones to HBAM Dataset for destination caseload/trip calculations:
  - Join HBAM historical data to hospital spatial database
  - Filter master dataset for major age groups
  - Summarise to calculate destination caseload/trips
```{r}
#Update Master HBAM liste to Include TRESO Zones
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, select(hospital_overlay, treso_zone, siteid, caretype), by = c('siteid', 'caretype'))

#Filter out Adult age groups from HBAM
HBAMhistorical_master_ad <- HBAMhistorical_master_tz %>% 
  select(siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         csd,
         treso_zone) %>% 
  filter(agegroup %in% (2:6))

#Filter Pediatric Age Groups  
HBAMhistorical_master_ped <- HBAMhistorical_master_tz %>%
  select(siteid,
         name,
         caretype,
         agegroup,
         totalcases,
         csd,
         treso_zone) %>%
  filter(grepl('^ped[1-3]', agegroup) | agegroup == 1)

# Aggregate Historical HBAM to corresponding TRESO level
destination_trips_ad <- HBAMhistorical_master_ad %s>%
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

destination_trips_ped <- HBAMhistorical_master_ped %>%
  rename('d_trips' = 'totalcases') %>% 
  group_by(treso_zone,
           caretype) %>% 
  summarise(d_trips = sum(d_trips))

calcases_cd_destination_ad <- destination_trips_ad %>% 
  ungroup() %>% 
  summarise(sum(d_trips))

calcases_cd_destination_ped <- destination_trips_ped %>% 
  ungroup() %>% 
  summarise(sum(d_trips))
```

## HBAM Base Care-Type Matricies
```{r}
#Create Care-Type Matrices for Adult Age Groups
at_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'AT') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases))

cr_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'CR') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases))

gr_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'GR') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases))

mh_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'MH') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases))

am_hbam_matrix_ad <- HBAMhistorical_master_ad %>% 
  filter(caretype == 'AM') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)
```

```{r}


#Create Care-Type Matrices for Adult Age Groups
am_hbam_matrix_ped <- HBAMhistorical_master_ped %>% 
  filter(caretype == 'AM') %>% 
  group_by(csd, treso_zone) %>% 
  summarise(trips = sum(totalcases)) %>% 
  mutate(trips = trips/365)

```


## Join CD Caserates to TRESO data for origin caseload/trip calculations:
  - Assuming one case = one trip (may be > 1 for most cases)
```{r}
origin_trips_ad <- left_join(treso_health_long, cd_caserates, by = c('cd', 'agegroup')) %>% 
  filter(agegroup %in% (2:6)) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup () %>% 
  group_by(cd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

calcases_cd_origin_ad <- origin_trips_ad %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))

origin_trips_ped <- left_join(treso_health_long, cd_caserates, by = c('cd', 'agegroup')) %>%
  filter(grepl('^ped[1-3]', agegroup) | agegroup == 1) %>% 
  mutate(o_trips = (population*caserate)) %>%
  ungroup () %>% 
  group_by(cd,
           treso_zone, 
           caretype) %>% 
  summarise(o_trips = sum(o_trips))

calcases_cd_origin_ped <- origin_trips_ped %>% 
  ungroup() %>% 
  summarise(trips = sum(o_trips, na.rm=TRUE))
```

## Mapping Hospital points to TRESO zone polygons
```{r, include=FALSE, echo=FALSE, eval=FALSE}
# Convert the SpatialDataframe to normal Dataframe for ggplot()
treso_shp_df <- fortify(treso_shp) %>%
  rename(
    x = long,
    y = lat
  )

hospital_xy_df <- data.frame(hospital_xy) %>%
  rename(
    x = long,
    y = lat
  )

hospital_plot <- ggplot() +
  geom_polygon(data = treso_shp_df, mapping = aes(x = x, y = y, group = group),
               fill = 'grey40', color = 'grey90', alpha = 1, size = 0.1) +
  geom_point(data = hospital_xy_df, mapping = aes(x = x, y = y), color = "red", alpha = 0.1, size = 0.05) +
  labs(x = "", y = "", title = "Hospitals in Ontario") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

ggsave(hospital_plot, file = "output/hospital_plot.png", width = 20, height = 20)

```

## CD Case-Rate Care-Type Matricies
  - Develop O-D dataframes for each care type: AT, CR, GR, MH, AM (ER + DS)
  - Fill NA values with 0 for TRESO zones with no travel

### AT
```{r}
at_cd_origin <- origin_trips %>% 
  filter(caretype == 'AT') %>%
  ungroup() %>% 
  select(-caretype, -cd)

at_cd_destination <- destination_trips %>% 
  filter(caretype == 'AT') %>% 
  select(-caretype)

at_origin_full <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(at_cd_origin, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

at_destination_full <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(at_cd_destination, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### CR
```{r}
cr_origin <- origin_trips %>% 
  filter(caretype == 'CR') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

cr_destination <- destination_trips %>% 
  filter(caretype == 'CR') %>% 
  select(-caretype)

cr_origin_full <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(cr_origin, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

cr_destination_full <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(cr_destination, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### GR
```{r}
gr_origin <- origin_trips %>% 
  filter(caretype == 'GR') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

gr_destination <- destination_trips %>% 
  filter(caretype == 'GR') %>% 
  select(-caretype)

gr_origin_full <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(gr_origin, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

gr_destination_full <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(gr_destination, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### MH
```{r}
mh_origin <- origin_trips %>% 
  filter(caretype == 'MH') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

mh_destination <- destination_trips %>% 
  filter(caretype == 'MH') %>% 
  select(-caretype)

mh_origin_full <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(mh_origin, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

mh_destination_full <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(mh_destination, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

### AM
```{r}
am_origin_ad <- origin_trips_ad %>% 
  filter(caretype == 'AM') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

am_destination_ad <- destination_trips_ad %>% 
  filter(caretype == 'AM') %>% 
  select(-caretype)

am_origin_full_ad <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(am_origin_ad, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

am_destination_full_ad <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(am_destination_ad, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

am_origin_ped <- origin_trips_ped %>% 
  filter(caretype == 'AM') %>% 
  ungroup() %>% 
  select(-caretype, -cd)

am_destination_ped <- destination_trips_ped %>% 
  filter(caretype == 'AM') %>% 
  select(-caretype)

am_origin_full_ped <- travel_time_skim %>% 
  distinct(orig) %>% 
  left_join(am_origin_ped, by = c('orig' = 'treso_zone')) %>% 
  replace_na(list(o_trips = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix() 

am_destination_full_ped <- travel_time_skim %>% 
  distinct(dest) %>% 
  left_join(am_destination_ped, by = c('dest' = 'treso_zone')) %>% 
  replace_na(list(d_trips = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()
```

## Travel Demand Matricies 
  - Develop Propensity Matrix from TRESO travel times skim
  - Create function for matrix balancing
  - Calculate propensity matrix for each care type
  
### TT Propensity Matrix
```{r}
prop_matrix <- travel_time_skim %>%
  mutate(value = replace(value, value == 0, 0.00000001),
         value = 1/value) %>% #change if something bad happens 
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

balance <- function(matrix, tot, axis) {
  if (axis == 1) {
      sum <- rowSums(matrix)
  } else if (axis == 2) {
      sum <- colSums(matrix)
  }
  sc <- tot / sum 
  sc[is.nan(sc)] <- 0
  
  # MARGIN = 1 indicates rows, MARGIN = 2 indicates columns
  matrix2 <- sweep(matrix, MARGIN = axis, sc, `*`)
  return(matrix2)
}

calc_error <- function(matrix, a, b) {
  row_sum <- sum(abs(a - rowSums(matrix)))
  col_sum <- sum(abs(b - colSums(matrix)))
  return(row_sum + col_sum)
}

matrix_balancing <- function(matrix, a, b, max_iterations = 10000, rel_error = 0.0001) {
  error <- 1.0
  i <- 0
  init_error <- calc_error(matrix, a, b)
  matrix2 <- matrix
  
  while (error > rel_error) {
    if (i > max_iterations) {
      print("Matrix balancing did not converge within iteration limit")
      break
    }
    matrix2 <- balance(matrix2, a, 1)
    matrix2 <- balance(matrix2, b, 2)
    error <- calc_error(matrix2, a, b) / init_error
    i <- i + 1
  }
  return(matrix2)
}
```

## Summarize Balanced Matrix to CSD (Origin)
  - Balance O-D pairing matricies for each care-type
  - Calculate difference between original HBAM "cases" and matrix-generated "trips"

### AT Matrix
```{r, eval=FALSE}
# Create Propensity Matrix
at_prop_matrix <- matrix_balancing(prop_matrix, at_origin_full, at_destination_full, 1000, 0.001)

# Convert Prop Matrix to Long Format
at_matrix_long <- at_prop_matrix %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
at_csd_matrix <- left_join(at_matrix_long, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE))

# Summarise and Calculate Comparison
at_prop_sum <- at_prop_matrix %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

at_origin_sum <- at_cd_origin %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

at_cd_caserate_ratio <- at_prop_sum/at_origin_sum

# Calculate Difference between simulated matrix and base HBAM matrix
at_comp_matrix <- left_join(at_csd_matrix, at_hbam_matrix, by = c('destination' = 'treso.id.pos', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0)) %>% 
  mutate(diff = (trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)
  
```

### CR Matrix
```{r, eval=FALSE}
# Create Propensity Matrix
cr_prop_matrix <- matrix_balancing(prop_matrix, cr_origin_full, cr_destination_full, 1000, 0.001)

# Convert Prop Matrix to Long Format
cr_matrix_long <- cr_prop_matrix %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
cr_csd_matrix <- left_join(cr_matrix_long, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE))

# Summarise and Calculate Comparison
cr_prop_sum <- cr_prop_matrix %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

cr_origin_sum <- cr_origin %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

cr_cd_caserate_ratio <- cr_prop_sum/cr_origin_sum

# Calculate Difference between simulated matrix and base HBAM matrix
cr_comp_matrix <- left_join(cr_csd_matrix, cr_hbam_matrix, by = c('destination' = 'treso.id.pos', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0.0000001)) %>% 
  mutate(diff = (trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)
```

### GR Matrix
```{r, eval=FALSE}
# Create Propensity Matrix
gr_prop_matrix <- matrix_balancing(prop_matrix, gr_origin_full, gr_destination_full, 1000, 0.001)

# Convert Prop Matrix to Long Format
gr_matrix_long <- gr_prop_matrix %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
gr_csd_sum <- left_join(gr_matrix_long, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE))

# Summarise and Calculate Comparison
gr_prop_sum <- gr_prop_matrix %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

gr_origin_sum <- gr_origin %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

gr_cd_casertace_ratio <- gr_prop_sum/gr_origin_sum

# Calculate Difference between simulated matrix and base HBAM matrix
gr_comp_matrix <- left_join(gr_csd_matrix, gr_hbam_matrix, by = c('destination' = 'treso.id.pos', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0.0000001)) %>% 
  mutate(diff = (trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)
  
```

### MH Matrix
```{r}
# Create Propensity Matrix
mh_prop_matrix <- matrix_balancing(prop_matrix, mh_origin_full, mh_destination_full, 1000, 0.001)

# Convert Prop Matrix to Long Format
mh_matrix_long <- mh_prop_matrix %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
mh_csd_sum <- left_join(mh_matrix_long, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE))

# Summarise and Calculate Comparison
mh_prop_sum <- mh_prop_matrix %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

mh_origin_sum <- mh_origin %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

mh_cd_caserate_ratio <- mh_prop_sum/mh_origin_sum

# Calculate Difference between simulated matrix and base HBAM matrix
mh_comp_matrix <- left_join(mh_csd_matrix, mh_hbam_matrix, by = c('destination' = 'treso.id.pos', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0.0000001)) %>% 
  mutate(diff = (trips.csd - trips.hbam),
         perc.diff = (trips.csd - trips.hbam)/trips.hbam)
```

### AM Matrix
```{r}
# Create Propensity Matrix
am_prop_matrix_ad <- matrix_balancing(prop_matrix, am_origin_full_ad, am_destination_full_ad, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_ad <- am_prop_matrix_ad %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_csd_matrix_ad <- left_join(am_matrix_long_ad, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_ad <- am_prop_matrix_ad %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_ad <- am_origin_ad %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

am_cd_caserate_ratio <- am_prop_sum_ad/am_origin_sum_ad

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_ad <- left_join(am_csd_matrix_ad, am_hbam_matrix_ad, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)

### PED

# Create Propensity Matrix
am_prop_matrix_ped <- matrix_balancing(prop_matrix, am_origin_full_ped, am_destination_full_ped, 1000, 0.001)

# Convert Prop Matrix to Long Format
am_matrix_long_ped <- am_prop_matrix_ped %>% 
  melt() %>% 
  rename('origin' = 'Var1',
         'destination' = 'Var2',
         'trips' = 'value')

# Aggregate Origin back to CSD
am_csd_matrix_ped <- left_join(am_matrix_long_ped, treso_zone_system, by = c('origin' = 'treso_id')) %>% 
  select(-area, -mof_region) %>% 
  filter(!is.na(csduid)) %>% 
  ungroup() %>% 
  group_by(csduid, destination) %>% 
  summarise(trips = sum(trips, na.rm = TRUE)) %>% 
  mutate(trips = trips/365)

# Summarise and Calculate Comparison
am_prop_sum_ped <- am_prop_matrix_ped %>% 
  colSums() %>% 
  melt() %>% 
  summarise(sum(value))

am_origin_sum_ped <- am_origin_ped %>% 
  ungroup() %>% 
  summarise(sum(o_trips))

am_cd_caserate_ratio <- am_prop_sum_ped/am_origin_sum_ped

# Calculate Difference between simulated matrix and base HBAM matrix
am_comp_matrix_ped <- left_join(am_csd_matrix_ped, am_hbam_matrix_ped, by = c('destination' = 'treso_zone', 'csduid' = 'csd'), suffix = c('.csd', '.hbam')) %>% 
  replace_na(list(trips.hbam = 0)) %>% 
  mutate(diff = abs(trips.csd - trips.hbam),
         perc.diff = ((trips.csd - trips.hbam)/trips.hbam)*100)
```

```{r}
am.treso.csd_ad <- am_origin_ad %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))

am.treso.csd_ad %>% 
  group_by(csduid) %>% 
  filter(csduid == 3521005) %>% 
  summarise(n = sum(o_trips)) %>% 
  arrange(desc(n))

am.treso.csd_ped <- am_origin_ped %>% 
  left_join(select(treso_zone_system, treso_id, csduid, csdname), by = c('treso_zone' = 'treso_id'))

am.treso.csd_ped %>% 
  group_by(csduid) %>% 
  filter(csduid == 3521005) %>% 
  summarise(n = sum(o_trips)) %>% 
  arrange(desc(n))


```


---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
source('helpers.r')
```


## Import Input Data
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
  
```{r, include= FALSE, results='hide'}
# Defining hospital parameters for care-types and age bands
caretypes = c("at", "cr", "gr", "mh", "am")
agecluster = c('ad', 'ped', 'sr')
agegroup_ref <- tibble(agecluster = c('ad', 'ad', 'ad', 'ped', 'sr', 'sr'),
                       agegroup = as.character(c(2, 3, 4, 1, 5, 6))) %>% 
  arrange(agegroup)

# CIHI Bed Data
CIHIhospitalbeds <- read_csv('input/moh/cap.CIHI_Hospital_Beds.csv')

# Daily Bed Census bed counts
num_beds_siteid <- readRDS('cache/moh/num_beds.rds')

# Historical HBAM Master (w/ Asset data)
HBAMhistorical_master <- readRDS('cache/moh/HBAMhistorical_master.rds')

# Projected HBAM Master (w/ Asset data)
HBAMprojected_master <- readRDS('cache/moh/HBAMprojected_master.rds')

# Hospital Asset Data
hospitallocations <- readRDS('cache/moh/hospitallocations.rds')

# Speciality Hospital Identifier
speciality_hospitals <- read.csv("input/moh/specialty_hospital_list.csv")

# TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_projarg = treso_shp@proj4string@projargs

treso_population_moh <- readRDS('input/moh/treso_population_moh.rds')

treso_zone_system <- read_csv('input/treso/treso_zone_system.csv')

treso_centroids <- read_csv('cache/treso/treso_centroids.csv')

treso_travel_time <- readRDS("cache/treso/treso_travel_time_2016.rds")

ALC_idcrosswalk <- readRDS('cache/moh/ALC_crosswalk.rds')

# ALC Siteids have multiple hospital IDs associated w/ them referring to different case-types and names in some instances; distinct codes are extracted for SiteID-LHIN connection
ALC_idcrosswalk_slim <- ALC_idcrosswalk %>% 
  group_by(ALCsite_id) %>% 
  distinct(lhin, ALCsite_id)

# ALC raw data includes agegroup == 9 which is the totalling flag
# ALC data for 2017 only includes LHINs 1-3 and 10-14; ALC data for 2012 also partial
# MADD = most appropriate discharge destination
ALC_madd_raw <- readRDS('cache/moh/ALC_madd_raw.rds') %>% 
  filter(madd == 'LTC', year != 2011, year!= 2012, year != 2017)

# Importing LTC data
ltc_homes <- readRDS('cache/moh/ltc_homes.rds')
ltc_turnover_raw <- read_csv('input/moh/longtermcare_beds_turnover.csv')
```

## Link Hospital Site IDs to TRESO Zones
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Identify and quantify unmatched TRESO zones/Site IDs, if any
  
```{r, include=FALSE}
# Convert treso population to long format
treso_population_moh_agecluster <- treso_population_moh %>% 
  left_join(agegroup_ref, by = c('age.group' = 'agegroup')) %>% 
  # Use 2017 population for CSD/agecluster combinations with cases observed in 2016 but with population = 0 in 2016 treso data
  mutate(population.2016 = ifelse(population.2016 == 0, population.2017, population.2016))

saveRDS(treso_population_moh_agecluster, "cache/moh/treso_population_moh_agecluster.rds")

# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- hospitallocations %>%
  ungroup() %>%
  select(name,
         id,
         pcode,
         lat,
         long) %>%
  distinct()

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            hosp_name = hospital_xy@data$name,
            id = hospital_xy@data$id) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             hosp_name, 
             id) %>% 
      rename(treso_zone = Treso_ID) %>% 
      left_join(treso_zone_system, by = c('treso_zone' = 'treso_id'))

saveRDS(hospital_overlay, file = 'cache/moh/hospital_overlay.rds')

rm(hospital_xy, hospital_spdf)

#Update Master HBAM list to Include TRESO Zones and corresponding CSD
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, 
                                      select(hospital_overlay, treso_zone, id, hosp_csduid = csduid, csdname, cdname), 
                                      by = c('id')) %>% 
  left_join(agegroup_ref, by = 'agegroup') %>% 
  # Duplicate rows appearing in HBAM - take max by group to deduplicate
  group_by(year, id, caretype, agegroup, orig_csd) %>% 
  mutate(maxCases = max(cases)) %>% 
  select(-cases) %>% 
  distinct() %>% 
  rename(cases = maxCases) %>% 
  ungroup()

HBAMprojected_master_tz <- left_join(HBAMprojected_master, 
                                     select(hospital_overlay, treso_zone, id), 
                                     by = c('id')) %>%
  left_join(agegroup_ref, by = c('agegroup')) %>% 
  # Duplicate rows appearing in HBAM - take max by group to deduplicate
  replace_na(list(beddays = 0)) %>% 
  group_by(year, id, caretype, agegroup) %>% 
  mutate(maxCases = max(cases),
         maxBeddays = max(beddays)) %>% 
  select(-cases, -beddays, -facilityid) %>% 
  distinct() %>% 
  rename(cases = maxCases, beddays = maxBeddays) %>% 
  ungroup()

# Cleaning hospital locations and adding CSD and TRESO zones
hospitallocations_tz <- hospitallocations %>% 
  left_join(select(hospital_overlay, treso_zone, csduid, csdname, mof_region, id), by = c('id')) %>% 
  distinct(id, name, lhin, treso_zone, csduid, csdname, mof_region, pcode, lat, long, address, city)

saveRDS(hospitallocations_tz, "cache/moh/hospitallocations_tz.rds")
saveRDS(HBAMprojected_master_tz, "cache/moh/HBAMprojected_master_tz.rds")
saveRDS(HBAMhistorical_master_tz, "cache/moh/HBAMhistorical_master_tz.rds")

rm(HBAMhistorical_master, HBAMprojected_master)

```

## Consolidated Hospital Lookup
  - Reorganize HBAM historical to show unique hospital locations w/ metadata needed for visualization tool
  - Create in wide format w/ sub-naming for care-type and age-cluster 

```{r}
hospital_lookup <- HBAMhistorical_master_tz %>%
  filter(id != -9999) %>%
  group_by(year, id, agecluster, caretype) %>% 
  summarise(cases = sum(cases)) %>% 
  mutate(cases.at.ad = ifelse(caretype %in% 'AT' & agecluster %in% 'ad', cases, 0),
         cases.at.ped = ifelse(caretype %in% 'AT' & agecluster %in% 'ped', cases, 0),
         cases.at.sr = ifelse(caretype %in% 'AT' & agecluster %in% 'sr', cases, 0),
         cases.cr.ad = ifelse(caretype %in% 'CR' & agecluster %in% 'ad', cases, 0),
         cases.cr.ped = ifelse(caretype %in% 'CR' & agecluster %in% 'ped', cases, 0),
         cases.cr.sr = ifelse(caretype %in% 'CR' & agecluster %in% 'sr', cases, 0),
         cases.gr.ad = ifelse(caretype %in% 'GR' & agecluster %in% 'ad', cases, 0),
         cases.gr.ped = ifelse(caretype %in% 'GR' & agecluster %in% 'ped', cases, 0),
         cases.gr.sr = ifelse(caretype %in% 'GR' & agecluster %in% 'sr', cases, 0),
         cases.mh.ad = ifelse(caretype %in% 'MH' & agecluster %in% 'ad', cases, 0),
         cases.mh.ped = ifelse(caretype %in% 'MH' & agecluster %in% 'ped', cases, 0),
         cases.mh.sr = ifelse(caretype %in% 'MH' & agecluster %in% 'sr', cases, 0),
         cases.am.ad = ifelse(caretype %in% 'AM' & agecluster %in% 'ad', cases, 0),
         cases.am.ped = ifelse(caretype %in% 'AM' & agecluster %in% 'ped', cases, 0),
         cases.am.sr = ifelse(caretype %in% 'AM' & agecluster %in% 'sr', cases, 0)) %>% 
  group_by(year, id) %>% 
  summarise_at(vars(cases.at.ad:cases.am.sr), sum) %>%
  left_join(hospitallocations_tz, by = c('id')) %>% 
  ungroup()

# Import bed summaries from Daily Bed Census (DBC); this can be imported above

# Cleaning up number of beds
num_beds <- num_beds_siteid %>% 
  left_join(select(hospitallocations, datasetID1.siteid, id), by = c('siteid' = 'datasetID1.siteid')) %>% 
  left_join(select(hospitallocations, datasetID2.siteid, id), by = c('siteid' = 'datasetID2.siteid')) %>% 
  left_join(select(hospitallocations, datasetID3.siteid, id), by = c('siteid' = 'datasetID3.siteid')) %>% 
  left_join(select(hospitallocations, datasetID4.siteid, id), by = c('siteid' = 'datasetID4.siteid')) %>% 
  left_join(select(hospitallocations, datasetID5.siteid, id), by = c('siteid' = 'datasetID5.siteid')) %>% 
  left_join(select(hospitallocations, datasetID6.siteid, id), by = c('siteid' = 'datasetID6.siteid')) %>% 
  ungroup() %>% 
  mutate(id = pmax(replace_na(id.x, 0), replace_na(id.x.x, 0), replace_na(id.x.x.x,0), replace_na(id.y, 0), replace_na(id.y.y, 0), replace_na(id.y.y.y, 0))) %>% 
  select(-id.x, -id.x.x, -id.x.x.x, -id.y, -id.y.y, -id.y.y.y) %>% 
  group_by(year, id, type) %>% 
  # Make sure there are not duplicate siteids being using for a given id
  mutate(staffedbeds = sum(staffedbeds)) %>%
  distinct(year, id, type, staffedbeds) %>%
  rename(caretype = type) %>% 
  mutate(count = n()) %>%
  ungroup() %>% 
  # Calculate the sum of beds by hospital by year
  group_by(year, id) %>% 
  mutate(total.hosp.beds = sum(staffedbeds)) %>% 
  ungroup()

saveRDS(num_beds, "cache/moh/num_beds_processed.rds")

# Assessing the daily bed count from 
dbc_beds <- num_beds %>% 
  select(-count, -year) %>% 
  spread(key = caretype, value = staffedbeds) %>% 
  rename(at.beds.2017 = AT,
         cr.beds.2017 = CR,
         gr.beds.2017 = GR,
         mh.beds.2017 = MH) %>% 
  mutate(at.beds.2017 = replace_na(at.beds.2017, 0),
         cr.beds.2017 = replace_na(cr.beds.2017, 0),
         gr.beds.2017 = replace_na(gr.beds.2017, 0),
         mh.beds.2017 = replace_na(mh.beds.2017, 0)) %>% 
  mutate(dbc.total.beds.2017 = sum(c(at.beds.2017, cr.beds.2017, gr.beds.2017, mh.beds.2017)))

#Final Master List only including DBC because of incomplete CIHI Data
hospital_lookup_master <- hospital_lookup %>% 
  left_join(dbc_beds, by = 'id') %>% 
  filter(id != -9999)
  #select(id, year, name, pcode, lhin:city, cases_at_ad:dbc_total_beds_2018)

saveRDS(hospital_lookup_master, file = 'cache/moh/hospital_lookup_master.rds')

rm(hospital_lookup, dbc_beds)
```

## ALC
- Summarize existing (historical) ALC demand for LTC: actual ALC + LTC demand (assumed to equal LTC capacity)
- Calculate average demand for LTC based on population size (i.e., rate of ALC days per person)
- Use forecasted ALC rates to apply to future population in a given scenario year
- Allow the user to 'build' additional LTC beds and test the impact on ALC
- Distribute forecasted ALC days to CSDs and CDs
- ALC forecasts to later be joined to CRM forecast for hospital demand

### ALC Crosswalk
```{r}
hospital_lookup_master <- readRDS('cache/moh/hospital_lookup_master.rds')

# LINK ALC SITES WITH MASTER LIST AND CSD DATA
hospital_lookup_ALC <- hospital_lookup_master %>% 
  ungroup() %>% 
  select(id, pcode, csduid, csdname, name) %>% 
  distinct() %>% 
  right_join(select(ALC_idcrosswalk, id, ALCsite_id, name), by = 'id') %>% 
  distinct()

saveRDS(hospital_lookup_ALC, "cache/moh/hospital_lookup_ALC.rds")

```

### Estimating Suppression: Aggregate Level
```{r}
ALC_madd_prov_total <- ALC_madd_raw %>% 
  filter(number == 15, agegroup == 9) %>% 
  rename('prov.days.tot' = 'alcdays',
         'prov.los.avg' = 'avg.los')

# This query is a double-check to make sure LHIN totals sum to provincial total
ALC_lhin_vol <-  ALC_madd_raw %>% 
  filter(agegroup == 9, number < 15) %>% 
  rename('lhin.num' = 'number',
         'lhin.days' = 'alcdays',
         'lhin.los.avg' = 'avg.los') %>% 
  left_join(select(ALC_madd_prov_total, year, prov.days.tot, prov.los.avg), by = 'year') %>% 
  group_by(year) %>% 
  mutate(lhin.days.tot = sum(as.numeric(lhin.days)),
         lhin.missing.days = as.numeric(prov.days.tot) - lhin.days.tot,
         lhin.residual.avg = lhin.missing.days/sum(patients)) %>% 
  group_by(year, lhin.num) %>% 
  mutate(remaining.days = lhin.residual.avg * patients,
         adj.lhin.days.tot = ifelse(lhin.days == 'LV' | lhin.days == 'NS', remaining.days, as.numeric(lhin.days))) %>% 
  select(year, lhin.num, agegroup, patients, adj.lhin.days.tot)

# This step cleans up most-appropriate discharge data for later use; filtered at an AGGREGATED level
# Accurate only for years 2012-2016 because 2011 and 2017 are missing LHIN data (see note above)
ALC_madd_clean_ag <- ALC_madd_raw %>% 
  filter(madd == 'LTC', number > 999, agegroup == 9) %>% 
  rename(hosp.alc.days = alcdays,
         hosp.avg.los = avg.los) %>% 
  left_join(select(ALC_idcrosswalk_slim, lhin, ALCsite_id), by = c('siteid' = 'ALCsite_id')) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot, agegroup), by = c('year', 'lhin' = 'lhin.num', 'agegroup')) %>% 
  filter(!is.na(lhin)) %>% 
  select(year, siteid, lhin, lhin.days.tot = adj.lhin.days.tot, madd, agegroup, patients, hosp.avg.los, hosp.alc.days)

# This step fills in missing patient days for hospitals where the number of days are suppressed based on low patient counts, but does so for all age groups combined (i.e., agegroup == 9)
ALC_hosp_vol_ag <- ALC_madd_clean_ag %>% 
  group_by(year, lhin) %>% 
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0),
         hosp.days.tot = sum(as.numeric(hosp.alc.days)),
         lhinhosp.missing.days = lhin.days.tot - hosp.days.tot,
         hosp.missing.patients = ifelse(hosp.alc.days == 0, patients, 0),
         lhin.missing.patients = ifelse(hosp.alc.days == 0, sum(hosp.missing.patients), 0),
         hosp.residual.avg = ifelse(is.finite(lhinhosp.missing.days/lhin.missing.patients),  lhinhosp.missing.days/lhin.missing.patients, 0)) %>%
  group_by(year, siteid) %>% 
  mutate(remaining.days = hosp.residual.avg * patients,
         adj.hosp.days.tot = ifelse(hosp.avg.los == 'LV', remaining.days, as.numeric(hosp.alc.days))) %>% 
  # Find remaining missing hospital days - i.e., difference between sum of hospital values and LHIN totals which can't be assigned to hospitals with suppressed values (i.e., no hospitals in LHIN with suppressed values, yet days are missing)
  # These values are distributed across hospitals within the LHIN proportionally based on share of days within the LHIN
  group_by(year, lhin) %>% 
  mutate(adj.lhinhosp.days.tot = sum(adj.hosp.days.tot)) %>% 
  mutate(adj.hosp.days.tot = (adj.hosp.days.tot / adj.lhinhosp.days.tot) * lhin.days.tot) %>% 
  select(year, lhin, siteid, agegroup, patients, adj.hosp.days.tot) %>% 
  ungroup()

```

### Calculating LHIN/Provincial Agegroup Averages
```{r}
# This step cleans up most-appropriate discharge data for later use; filtered at a DISAGGREGATED level
ALC_madd_clean_disag <- ALC_madd_raw %>% 
  # Filter for LTC; 4-digit hospital siteids; all age groups except 'total'; all years with complete data
  filter(madd == 'LTC', number > 999, agegroup != 9) %>% 
  rename(hosp.alc.days = alcdays,
         hosp.avg.los = avg.los) %>%
  left_join(select(ALC_idcrosswalk_slim, lhin, ALCsite_id), by = c('siteid' = 'ALCsite_id')) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot), by = c('year', 'lhin' = 'lhin.num')) %>% 
  filter(!is.na(lhin))

# Calculate number of ALC days per patient for different age groups, at the LHIN level, to fill in suppression gaps
alc_avg_ages.ex2 <- ALC_madd_clean_disag %>%
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0)) %>% 
  group_by(lhin, agegroup, year) %>% 
  mutate(lhin.agegroup.patients = sum(patients), lhin.agegroup.days = sum(as.numeric(hosp.alc.days))) %>% 
  mutate(lhin.agegroup.los = lhin.agegroup.days / lhin.agegroup.patients) %>% 
  ungroup() %>%
  distinct(year, lhin, agegroup, lhin.agegroup.patients, lhin.agegroup.days, lhin.agegroup.los)
  # No total days available for some agegroups (due to suppression resulting from low volumes at the LHIN level) - therefore use average at the provincial level --> see next step

# Determine average length of stay at the provincial level to fill in gaps where data suppressed at the LHIN level
alc_avg_agegroup2 <- ALC_madd_raw %>% 
  filter(number == 15) %>% 
  rename('lhin.num' = 'number',
         'lhin.days' = 'alcdays',
         'lhin.los.avg' = 'avg.los') %>%
  group_by(agegroup, year) %>% 
  mutate(prov.agegroup2.patients = sum(patients), prov.agegroup2.days = sum(as.numeric(lhin.days))) %>% 
  mutate(prov.agegroup2.los = prov.agegroup2.days / prov.agegroup2.patients) %>% 
  ungroup() %>% 
  distinct(year, agegroup, prov.agegroup2.patients, prov.agegroup2.days, prov.agegroup2.los)

# Combine length of stay estimates for agegroups
alc_avg_ages <- alc_avg_ages.ex2 %>% 
  left_join(alc_avg_agegroup2, by = c('agegroup', 'year')) %>% 
  mutate(agegroup.los = ifelse(lhin.agegroup.los == 0, prov.agegroup2.los, lhin.agegroup.los)) %>% 
  select(-prov.agegroup2.patients, -prov.agegroup2.days)

rm(alc_avg_agegroup2, alc_avg_ages.ex2)

```

### Estimating Suppression: Disaggregate Level (Age Groups)
```{r}
# ALC estimations w/ disaggregated age-groups
ALC_hosp_vol_disag <- ALC_madd_clean_disag %>%
  left_join(select(ALC_hosp_vol_ag, year, siteid, hosp.days.tot.agg = adj.hosp.days.tot), by = c('year', 'siteid')) %>%
  left_join(select(alc_avg_ages, year, lhin, agegroup, agegroup.los), by = c('year', 'lhin', 'agegroup')) %>% 
  filter(!is.na(lhin)) %>%
  group_by(year, siteid) %>% 
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0),
         hosp.days.tot = sum(as.numeric(hosp.alc.days)),
         hosp.missing.days = round(hosp.days.tot.agg - hosp.days.tot, 0),
         hosp.missing.patients = ifelse(hosp.alc.days == 0, patients, 0)) %>% 
         #hosp.residual.avg = ifelse(is.finite(hosp.missing.days/sum(hosp.missing.patients)), hosp.missing.days/sum(hosp.missing.patients), 0)) %>%
  # This assumes patients of all agegroups have equal length-of-stay; introduce weighting factor to account for differing lengths of stay, and scale back to known missing number of ALC days
  mutate(unscaled.missing.days = round(hosp.missing.patients * agegroup.los, 0)) %>% 
  mutate(sum.unscaled = sum(unscaled.missing.days)) %>% 
  mutate(scaled.missing.days = ifelse(sum.unscaled == 0, 0, unscaled.missing.days / sum.unscaled * hosp.missing.days)) %>%
  group_by(year, siteid, agegroup) %>% 
  mutate(adj.hosp.days.tot = ifelse(hosp.avg.los == 'LV', scaled.missing.days, as.numeric(hosp.alc.days))) %>%
  select(year, lhin, siteid, agegroup, patients, adj.hosp.days.tot) %>% 
  mutate(agecluster = ifelse(agegroup == 1, 'ped', 
                             ifelse(agegroup %in% 2:4, 'ad',
                                    ifelse(agegroup %in% 5:6, 'sr')))) %>% 
  ungroup()
  # This code checks for number of hospitals when incorporated into ALC_hosp_vol - can be removed if ALC values sum correctly
  # group_by(siteid) %>%
  # filter(year == 2016) %>%
  # mutate(siteCount = n())

saveRDS(ALC_hosp_vol_disag, file = 'cache/moh/ALC_hospitals_disaggregated.rds')
  
# ALC estimation methodology comparison at the provincial-level
# This query is a double-check to make sure calculations valid --> not used for production tables below
ALC_summary <- ALC_hosp_vol_disag %>% 
  group_by(year) %>% 
  summarise(hosp.days.tot.dis = sum(adj.hosp.days.tot)) %>% 
  left_join(select(ALC_hosp_vol_ag, year, siteid, adj.hosp.days.tot), by = 'year') %>%
  group_by(year) %>% 
  mutate(hosp.days.tot.agg = sum(adj.hosp.days.tot)) %>%
  distinct(year, hosp.days.tot.dis, hosp.days.tot.agg) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot), by = 'year') %>% 
  group_by(year) %>% 
  mutate(lhin.days.tot = sum(adj.lhin.days.tot)) %>% 
  distinct(year, hosp.days.tot.dis, hosp.days.tot.agg, lhin.days.tot) %>%
  left_join(select(ALC_madd_prov_total, year, prov.days.tot), by = 'year')
```


## Case-Rate Model (CRM)

- Alternative model to HBAM
- Uses HBAM 2016 average length of stay; subtracts days associated with ALC in 2016; calculates average length of stay excluding ALC days
- Calculates a case rate per population for 2016
- Projects case rate forward based on population for future year
- Applies ALC-free length of stay to future number of cases
- Adds projected ALC values for year of interest to non-ALC demand

### Average Length of Stay

```{r}
# Calculate average length of stay based on projected HBAM values for 2016. 2016 is the only year for which we have historical case data and projected length of stay, since HBAM historical does not inculde length of stay.
HBAMprojected_alos <- HBAMprojected_master_tz %>%
  filter(year == 2016) %>%
  filter(caretype != 'AM') %>% # Filter out AM (Emerg) care since there is no length of stay associated with Emerg cases
  select(year, id, agecluster, caretype, cases, beddays) %>% 
  group_by(year, id, caretype, agecluster) %>% 
  summarise(hosp.caretype.agecluster.cases = sum(cases),
            hosp.caretype.agecluster.days = sum(beddays)) %>% 
  group_by(year, id, agecluster) %>% 
  mutate(hosp.caretype.agecluster.days.percent = hosp.caretype.agecluster.days / sum(hosp.caretype.agecluster.days)) %>% 
  ungroup()

ALC_hosp_vol <- ALC_hosp_vol_disag %>% 
  left_join(hospital_lookup_ALC, by = c('siteid' = 'ALCsite_id')) %>%
  filter(!is.na(csduid)) %>% # Double-check in case any ALC sites don't match to Hospital PAI or master list
  group_by(year, id, agecluster) %>% 
  mutate(hosp.alc.patients = sum(patients),
            hosp.alc.days = sum(adj.hosp.days.tot),
            avg.los = hosp.alc.days / hosp.alc.patients) %>%
  group_by(year, csduid) %>% 
  mutate(hosp.alc.mrkt = hosp.alc.days / sum(hosp.alc.days)) %>% #MARKET-SHARE OF HOSPITAL ALC DAYS TO CSD TOTAL DAYS
  ungroup() %>% 
  distinct(year, id, name = name.x, csduid, csdname, agecluster, hosp.alc.patients, hosp.alc.days, avg.los, hosp.alc.mrkt)

# Remove 2016 ALC from 2016 average length of stay in order to estimate actual length of stay without ALC
# In the raw dataset of ALC Most Appropriate Discharge Destination, most of the 'caretypes' associated with the data (i.e., the site IDs) are for 'AM' care, i.e., Emergency, presumably because many of those patients are admitted to hospital as an emergency case. (Out of 176 distinct siteid values in the ALC MADD raw data, 146 relate to 'AM' caretype siteids, with the remaining 30 siteids being for all other caretypes combined). This is not an accurate representation of the impact ALC has on caretypes given that reducing ALC would serve to free up wards - i.e., non-Emergency caretypes - but likely not reduce (or less significantly reduce) Emergency demand. As a proxy, ALC bed-days per hospital are divided across the four inpatient caretypes based on their relative bed-day weights as a percentage of total bed-days at a given hospital. 
HBAMprojected_alc <- HBAMprojected_alos %>% 
  # left_join(ALC_hosp_caretype, by = c('year', 'id', 'agecluster', 'caretype')) %>% 
  # mutate(hosp.caretype.days = replace_na(hosp.caretype.days, 0),
  #        hosp.caretype.agecluster.days.percent = replace_na(hosp.caretype.agecluster.days.percent, 0))
  left_join(select(ALC_hosp_vol, year, id, agecluster, hosp.alc.days), by = c('year', 'id', 'agecluster')) %>%
  filter(agecluster != 'ped') %>%  # Since no pediatric patients are counted as ALC
  mutate(hosp.alc.days = replace_na(hosp.alc.days, 0)) %>%
  # Assign hospital agecluster ALC days to different caretypes based on percentages previously established
  mutate(hosp.alc.days.agecluster.caretype = hosp.alc.days * hosp.caretype.agecluster.days.percent,
         net.hosp.days = hosp.caretype.agecluster.days - hosp.alc.days.agecluster.caretype) %>% 
  # 13 of 805 entries in the table above have negative bed-days after removing estimated ALC by hospital; for any hospital/caretype which loses more than 50% of its bed-days by removing ALC, assume bed-days are reduced only to 50% of original total (i.e., assume ALC accounts for a max of 50% of total bed-days). Attempts were made to redistribute remaining ALC days to other caretypes within the hospital, but generally if one caretype had excessive ALC noted at a hospital, all caretypes at a hospital had excessive ALC. It may be possible to shift ALC days from one agecluster to another, but this would violate estimated ALC days by agecluster from the ALC MADD data. For now, any ALC which reduces hospital demand below 50% is 'ignored'. This means approximately 46,000 bed-days from the ALC MADD dataset are being 'ignored' / lost.
  mutate(adj.net.hosp.days = pmax(net.hosp.days, 0.5 * hosp.caretype.agecluster.days),
         other.caretype.alc.days = adj.net.hosp.days - net.hosp.days)
  
# This query attempts to redistribute the 'ignored' ALC data described above, but as described above, if one caretype had excessive ALC noted at a hospital, generally all other caretypes at a hospital also had excessive ALC. It may be possible to shift ALC days from one agecluster to another, but this would violate estimated ALC days by agecluster from the ALC MADD data.
# HBAMprojected_alc_redist <- HBAMprojected_alc %>%   
#   # group_by(year, id, agecluster) %>% 
#   mutate(caretype.days.remaining = sum(other.caretype.alc.days)) %>% 
#    # Filter out all caretype-ageclusters with demand already reduced by 50% due to removing ALC. Remaining ALC days to be redistributed amongst remaining caretype-ageclusters
#   filter(adj.net.hosp.days == net.hosp.days) %>% 
#   mutate(caretype.days.remaining.factor = ifelse(caretype.days.remaining > 0, adj.net.hosp.days / caretype.days.remaining, 0),
#          caretype.days.remaining.percent = ifelse(sum(caretype.days.remaining.factor) > 0, caretype.days.remaining.factor / sum(caretype.days.remaining.factor), 0),
#          caretype.extra.alc.days = caretype.days.remaining.percent * caretype.days.remaining)

# Calculate average level of service adjusted for ALC (necessary to join to bring pediatric bed-days back into the model)
HBAMprojected_alos_adj <- HBAMprojected_alos %>% 
  left_join(select(HBAMprojected_alc, year, id, agecluster, caretype, adj.net.hosp.days), by = c('year', 'id', 'caretype', 'agecluster')) %>% 
  # Use adj.net.hosp.days for adult and senior populations but use pre-ALC calculation for pediatrics (since no ALC)
  mutate(adj.net.hosp.days = ifelse(is.na(adj.net.hosp.days), hosp.caretype.agecluster.days, adj.net.hosp.days)) %>%
  mutate(adj.caretype.agecluster.los = adj.net.hosp.days / hosp.caretype.agecluster.cases) %>% 
  select(id, agecluster, caretype, adj.net.hosp.days, adj.caretype.agecluster.los)

saveRDS(HBAMprojected_alos_adj, file = 'cache/moh/HBAMprojected_alos_adj.rds')

```

## Shiny Inputs

```{r}
treso_population_moh <- readRDS("input/moh/treso_population_moh.rds")
treso_zone_system <- read_csv("input/treso/treso_zone_system.csv")
treso_centroids <- read_csv('cache/treso/treso_centroids.csv')
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
hospital_lookup_ALC <- readRDS("cache/moh/hospital_lookup_ALC.rds")
ALC_hosp_vol_disag <- readRDS("cache/moh/ALC_hospitals_disaggregated.rds")
ltc_homes <- readRDS("cache/moh/ltc_homes.rds")
treso_population_moh_agecluster <- readRDS("cache/moh/treso_population_moh_agecluster.rds")
treso_travel_time <- readRDS("cache/treso/treso_travel_time_2016.rds")
HBAMhistorical_master_tz <- readRDS("cache/moh/HBAMhistorical_master_tz.rds")

ltc_turnover_raw <- read_csv('input/moh/longtermcare_beds_turnover.csv')
hospitallocations_tz <- readRDS("cache/moh/hospitallocations_tz.rds")
ALC_hosp_vol_disag <- readRDS("cache/moh/ALC_hospitals_disaggregated.rds")

HBAMprojected_alos_adj <- readRDS("cache/moh/HBAMprojected_alos_adj.rds")
hospital_lookup_master <- readRDS("cache/moh/hospital_lookup_master.rds")

num_beds <- readRDS("cache/moh/num_beds_processed.rds")
speciality_hospitals <- read.csv("input/moh/specialty_hospital_list.csv")


# Read in user-set forecast year
SCENARIO_YEAR <- 2025

# Read in user-set target utilization factor by subsector. each care type has it's own target
UTILIZATION_TARGETS <- tibble(caretype = c('AT', 'MH', 'CR', 'GR', 'AM'), target = c(0.94, 0.92, 0.96, 0.95, 0.9))

# Read in user-set threshold re: minimum number of beds for when to build a new hospital in a CSD with no existing hospital
USER_MIN_BEDS <- 30

# New hospital minimum applies to each caretype individually or all caretypes cumulatively? I.e., if minimum new hospital threshold is 25 beds, and if a CSD needs 15 AT beds, 5 MH beds, and 10 GR beds (therefore sum of 30 beds), should the hospital be built because there is demand for 30 beds? Or hospital should not be built because no individual caretype exceeds minimum of 25 beds required?
MIN_BEDS_TOGGLE <- 1 # 1 = Cumulatively, 0 = Individually

# Read in user-set number of one-way trips per hospital case
USER_TRIPS_PER_CASE <- 2

# Total demand days in 2016 = 6,919,802; total beds in 2017 (assumed same for 2016) = 33,198; 33,198 beds * 365 days/year = 12,117,270 bed-days of capacity per year. However, if we assume hospitals were 96% full in 2016, the proper annualization factor for available days per bed = (6,919,802 / 0.96) / 12,117,270 * 365 = 217 days of capacity per hospital bed per year.
HOSP_OP_DAYS <- 365 # Assume each hospital bed can be used for this many days per year

USER_SELECT <- "HBAM" # TODO: Replace with value from user from visualization tool

CARETYPE_LIST = c('AT', 'AM', 'GR', 'CR', 'MH') # TODO: Replace with value from user from visualization tool

AGE_CLUSTER_LIST = c('ad', 'ped', 'sr') # TODO: Replace with value from user from visualization tool

DECISION_MAKING <- TRUE # TODO: Replace with value from user from visualization tool. #if FALSE, no new hospital beds are built on it's own

# Number of beds added by CSD
USER_NEW_LTC_CAP_CSD <- tibble(csduid = c(3506008, 3519049), added.ltc.cap = c(5000, 7000))

# Read in user-set factor for how many people will stay in their CSD vs. leave the CSD on a per-bed basis if a new hospital is built in a CSD which previously had no hospitals
STAY_IN_CSD_FACTOR <- 1000/1 # ratio of staying in CSD or leaving when new hospital is built

CURRENCY_YEAR <- 2018 # Units of costs; set to 2018 since cost function from EDU assumed to be set in 2018$
LTC_OP_DAYS <- 365
USER_INPUT_COST_PER_BED <- 1
USER_INPUT_BASE_HOSP_COST <- 5
USER_INPUT_INFLATION <- 0.02
USER_INPUT_CURRENT_YEAR = 2019 # Current year used to calculate construction timespan

```

## Base Scenario (2016)
### ALC Base Scenario
```{r}
ALC_prov_rate <- base_scenario_alc_calculation(hospital_lookup_ALC, ALC_hosp_vol_disag, ltc_homes, 
                                               treso_population_moh_agecluster, LTC_OP_DAYS)
```

### CRM Base Scenario
  - Calculate the market share of cases for each hospital w.r.t population at TRESO-level from HBAM for the given year/caretype/age cluster (named segment from now on)
  - Apply the case rates to the population at TRESO zones (Caserate Demand) [origin vector]
  - Create linkage to HBAM Projected and calculate scale factor (HBAM/CRM); scale cases based on factor to get Hosp-TZ cases

```{r}
treso_origin_cases <- base_scenario_crm_calculation(HBAMhistorical_master_tz, treso_population_moh_agecluster)
```


## Forecasting

### HBAM Scenario
```{r}
# Results if user chooses HBAM forecast
if (SCENARIO_YEAR > 2016 & USER_SELECT == "HBAM") {
  HBAM_control <- HBAMprojected_master_tz %>%
    mutate(los = replace_na(los, 0),
           beddays = replace_na(beddays, 0),
           beds.needed = beddays / HOSP_OP_DAYS) %>%
    filter(year == SCENARIO_YEAR) %>%
    rename(demand.days.total = beddays) %>% 
    group_by(id, caretype, agecluster) %>%
    summarise_at(vars(cases:beds.needed), sum, na.rm=TRUE) %>%
    group_by(id) %>% 
    mutate(sum.cases = sum(cases),
           sum.demand.days.total = sum(demand.days.total),
           sum.beds.needed = sum(beds.needed)) %>%
    ungroup() %>% 
    # Pivot table from long to wide for agecluster for demand columns (cases, demand-days)
    pivot_wider(names_from = c(caretype, agecluster), values_from = c(cases, demand.days.total, beds.needed), 
                values_fill = c(cases = 0, demand.days.total = 0, beds.needed = 0))
  
  # Convert num_beds to be in wide form (i.e., one row per asset)
  num_beds_wide <- num_beds %>%
    rename(beds.existing = staffedbeds) %>% 
    mutate(caretype.beds = paste0('beds.existing.', caretype)) %>%
    select(-year, -caretype, -count) %>% 
    pivot_wider(names_from = c(caretype.beds), values_from = c(beds.existing), values_fill = c(beds.existing = 0)) %>% 
    rename(total.hosp.beds.existing = total.hosp.beds)
  
  hosp_results <- HBAM_control %>% 
    left_join(num_beds_wide, by = c('id'))
}
```


### ALC Forecast Scenario

```{r}
result <- forecast_scenario_alc_calculation(treso_population_moh, ltc_turnover_raw, USER_NEW_LTC_CAP_CSD, hospitallocations_tz, 
                                            ALC_hosp_vol_disag, ALC_prov_rate, hospital_lookup_ALC, ltc_homes, LTC_OP_DAYS,
                                            SCENARIO_YEAR)
ALC_proj_cd_agecluster <- result[[1]]
ALC_proj_cd <- result[[2]]
```

### Case-Rate Model Forecast Scenario
  - Calculate total expected cases, bed-days (using ALOS) and beds-needed (bed-days/cases) for a selected forecast year
  
```{r}
result <- forecast_scenario_crm_calculation(treso_population_moh_agecluster, treso_origin_cases, hospital_lookup_master, 
                                            HBAMprojected_alos_adj, crm_treso, ALC_proj_cd_agecluster, ALC_proj_cd, 
                                            CARETYPE_LIST, AGE_CLUSTER_LIST, HOSP_OP_DAYS, SCENARIO_YEAR)
crm_alc <- result[[1]]
crm_orig <- result[[2]]
```


## Decision-Making
### Compare demand for beds/bed-days by CSD to existing bed counts to determine gap

```{r}
if (DECISION_MAKING) {
  result <- moh_decision_making(num_beds, hospitallocations_tz, crm_alc, crm_orig, UTILIZATION_TARGETS)
  
  demand_capacity_difference <- result[[1]]
  overburden_csd_hosp_new <- result[[2]]
  saveRDS(demand_capacity_difference, "cache/moh/demand_capacity_difference.rds")
  saveRDS(overburden_csd_hosp_new, "cache/moh/overburden_csd_hosp_new.rds")
}  
```

### Add hospitals
```{r}
# TODO: Replace this with list of new hospitals provided by user through visualization tool
new_hospital_user <- tibble(
  id = c(88888, 88888, 88888, 88888, 88888, 99999, 99999, 99999, 99999, 99999),
  hospital.lat = c(43.90032, 43.90032, 43.90032, 43.90032, 43.90032, 43.95, 43.95, 43.95, 43.95, 43.95),
  hospital.long = c(-78.85863, -78.85863, -78.85863, -78.85863, -78.85863, -78.79, -78.79, -78.79, -78.79, -78.79),
  name = c('New Hospital 1', 'New Hospital 1', 'New Hospital 1', 'New Hospital 1', 'New Hospital 1', 'New Hospital 2', 
           'New Hospital 2', 'New Hospital 2', 'New Hospital 2', 'New Hospital 2'),
  caretype = c("AT", "CR", "GR", "MH", "AM", "AT", "CR", "GR", "MH", "AM"),
  # Set number of beds per caretype; for Emerg (AM), 0 = no emerg, -1 = emerg to be built
  beds = c(200, 0, 125, 50, -1, 250, 150, 0, 75, 0),
  # agecluster = c("all","all","all","all","all", "all","all","all","all","all"), #all ages or just "ped"
  specialityfactor = c(0, 0, 0, 0, 0, 1, 1, 1, 1, 1) # 1 if hospital is speciality hospital, 0 if not
  ) %>%
  group_by(id) %>%
  mutate(total.hosp.beds = sum(beds[caretype != 'AM'])) %>%
  ungroup()

# Incorporate new hospitals added by redistributing demand from other hospitals and csds
# Add hospitals based on decision-making calculations
if (DECISION_MAKING) {  
  new_hospital <- moh_new_hospitals(overburden_csd_hosp_new, treso_zone_system, treso_population_moh_agecluster, treso_centroids,
                                    new_hospital_user, MIN_BEDS_TOGGLE, USER_MIN_BEDS, SCENARIO_YEAR)
} else {
  new_hospital <- new_hospital_user
}
  
```

## Redistribute demand to new hospitals

There are two components of demand that require redistribution:
1. Demand leaving a CSD for other CSDs
2. Demand within a CSD that went to an existing hospital

```{r}

if (nrow(new_hospital) != 0) {
  crm_orig_revised <- redistribute_demand_leaving_for_new_hospitals(new_hospital, speciality_hospitals, num_beds, crm_orig,
                                                                     treso_shp, treso_zone_system, treso_population_moh_agecluster, 
                                                                     AGE_CLUSTER_LIST, STAY_IN_CSD_FACTOR, SCENARIO_YEAR)
  saveRDS(crm_orig_revised, "cache/moh/crm_orig_revised.rds")
  
  crm_hosp_agecluster_all <- redistribute_demand_within_for_new_hospitals(new_hospital, speciality_hospitals, num_beds, 
                                                                         crm_alc, crm_orig_revised)
  saveRDS(crm_hosp_agecluster_all, "cache/moh/crm_hosp_agecluster_all.rds")
}

```

## Output Results
### Demand Outputs
```{r}
result <- format_demand_output(treso_shp, treso_zone_system, treso_population_moh_agecluster, treso_travel_time,
                               hospitallocations_tz, new_hospital=new_hospital, crm_hosp_agecluster_all,
                               UTILIZATION_TARGETS, USER_TRIPS_PER_CASE, SCENARIO_YEAR)
crm_demand <- result[[1]]
crm_demand_travel <- result[[2]]

saveRDS(crm_demand_travel, "cache/moh/crm_demand_travel.rds")
saveRDS(crm_demand, "cache/moh/crm_demand.rds")

```

### Hospital asset outputs
```{r}
hospital_wide_final <- format_hospital_asset_output(num_beds, crm_demand, crm_demand_travel)

# Calculate Cost
cost_new_hospital <- distinct(filter(hospital_wide_final, id > 999), id, beds.forecasted) %>% 
  mutate(cost_2018 = round(beds.forecasted * USER_INPUT_COST_PER_BED * 1000000 + USER_INPUT_BASE_HOSP_COST * 1000000, 0))
hospital_wide_final <- hospital_wide_final %>% 
  left_join(select(cost_new_hospital, id, cost_2018), by="id")

# Key output
saveRDS(hospital_wide_final, "cache/moh/hospital_wide_final.rds")
```

## Cost Annualization 
- Inflate cost for facility construction based on construction year; calculate total cost over time period of interest
```{r}

# Inflate cost for facility construction based on construction year; calculate total cost over time period of interest
annualized_inflated_cost <- construction_cost(USER_INPUT_INFLATION, SCENARIO_YEAR, CURRENCY_YEAR,
                                              USER_INPUT_CURRENT_YEAR, cost_new_hospital)


```

  ## Extra Code: Queries Tested but Not Kept
```{r}

################## Previous code for calculating ALC rates at the TRESO level

# ALC TRESO-level rates for forecasting future ALC
# ADD TRESO-LEVEL DISAGGREGATIONS BY FIRST JOINING IN CORRESPONDING CSD-TRESO LIST AND THEN TAKING THE PROPORTION OF TRESO POPULATION TO TOTAL CSD POPULATION
# ALC_treso <- ALC_csd_vol %>% 
#   # Use a full join in case there are CSDs with no hospitals or LTC facilities. In theory there should be no CSDs with hospitals or LTC facilities that have no population, in which case this functions as a right_join, but use full_join as double-check.
#   full_join(select(treso_population_long, treso_zone, csduid, age_cluster, treso.population.agecluster, year), by = c('year','csduid', 'agecluster' = 'age_cluster')) %>%
#   distinct() %>% 
#   group_by(year, csduid, agecluster) %>%
#   mutate(csd.age.pop = sum(treso.population.agecluster),
#          treso.csd.pop.perc = treso.population.agecluster / csd.age.pop,
#          treso.csd.dem.patients = csd.demand.patients.total * treso.csd.pop.perc,
#          treso.csd.dem.patients = replace_na(treso.csd.dem.patients, 0),
#          treso.csd.dem.days = csd.demand.days.total * treso.csd.pop.perc) %>% 
#   ungroup()

################# Previous code to calculate length of stay

#Join TRESO origin calculations to HBAM projected by calculating the ALOS for each CT-Age-cluster segment and apply to CRM projected number of cases to convert from cases to beddays

#Average LOS for patient admittance on provincial level (HQO)
# hqo_edlos <- data.frame('year' = c(2018, 2018, 2018, 2018, 2019,2019,2019,2019,2019,2019,2019,2019,2019), 
#                         'month' = c(09:12, 01:09), 
#                         'edlos' = c(16.3,16.8,17, 16.3, 18.3, 16.7, 16.8, 16.2, 16.1, 16.3, 15.6, 15.5, 17.1))
# avg_edlos_2018 <- mean(hqo_edlos$edlos)
# #EDLOS to admittance according to provincial average from CIHI
# avg_edlos_2015 <- 9.8 
# avg_edlos_2016 <- 10.5
# avg_edlos_2017 <- 11.0
# #Averaged out 3 data points to get rough average of ED-LOS (to admittance since that is when they are transferred to other CT); however, rate needs to reflect % of ED patients that do not get admitted, which might be the majority and that would decrease overall ALOS
# avg_edlos <- mean(c(avg_edlos_2015, avg_edlos_2016, avg_edlos_2017))

################## Calculate scale factor between HBAM and CRM in order to produce CRM

# crm_hosp_tbl_join <- left_join(crm_hosp_tbl, HBAM_control, by = c("id", "caretype", "age_cluster")) %>% 
#   mutate(scale.factor = cases/hosp.treso.cases) %>% 
#   select(id, caretype, age_cluster, scale.factor)

################# CRM Hospital Beds Summary Table

# hospital_beds_summary <- crm_treso_tbl_calc %>%
#   group_by(id, caretype, age_cluster) %>% 
#   summarise(bedsneeded = sum(bedsneeded)) %>% 
#   ungroup() %>% 
#   mutate(caretype = tolower(caretype)) %>% 
#   unite(segment, caretype:age_cluster) %>% 
#   spread(segment, bedsneeded) %>% 
#   mutate_at(vars(-id), ~replace_na(., 0)) %>% 
#   mutate(simulated.beds = select(., -id) %>% rowSums())

################ CRM Model - Previous code to report results of CRM model

# hospital_master_id <- readRDS("output/moh/hospital_lookup_master.rds") %>% 
#   ungroup() %>% 
#   mutate(beds = dbc_total_beds_2018,
#          cases = select(., contains("cases")) %>% rowSums(),
#          utilization = NA) %>% 
#   filter(year == 2016) # %>% 
#   # left_join(hospital_beds_summary, by="id")
# 
# # Calculated the calculated CT segment's utilization
# hospital_capacity_summary <- hospital_master_id %>% 
#   select(id, at_beds_2018:mh_beds_2018) %>% 
#   gather(key = caretype, value = beds.ct.2018, -id) %>%
#   mutate(caretype = substring(caretype, 1, 2)) %>% 
#   filter(caretype %in% tolower(CARETYPE_LIST))
# 
# # Calculate average for caretypes that matter
# hospital_utilization_summary <- crm_treso_tbl_calc %>% 
#   group_by(id, caretype) %>% 
#   summarise(bedsneeded = sum(bedsneeded)) %>% 
#   ungroup() %>% 
#   mutate(caretype = tolower(caretype)) %>% 
#   left_join(hospital_capacity_summary, by = c("id", "caretype")) %>% 
#   group_by(id) %>% 
#   summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
#   mutate(utilization = bedsneeded / beds.ct.2018) %>% 
#   select(id, beds.ct.2018, bedsneeded, utilization)
# 
# hospital_master_id <- hospital_master_id %>% 
#   select(-utilization) %>% 
#   left_join(hospital_utilization_summary, by = "id")

# for (caretype in CARETYPE_LIST) {
#   if (caretype != "AM") {
#     caretype = tolower(caretype)
#     hospital_master_id <- hospital_master_id %>% 
#         # Sum the caretypes across age clusters
#       mutate(!!(paste0("simulated.beds.", caretype)) := select(., get(paste0(caretype, "_ad")):get(paste0(caretype, "_sr"))) %>% rowSums()) %>% 
#       # Calculate caretype specific utilization
#       mutate(!!(paste0("utilization.", caretype)) := get(paste0("simulated.beds.", caretype)) / get(paste0(caretype, "_beds_2018"))) 
#     }
# }

# hospital_od <- crm_treso_tbl_calc %>% 
#   group_by(id, orig.treso.zone) %>% 
#   summarise(value = round(sum(cases), 0),
#             name = first(hospitalname)) %>% 
#   rename(orig = orig.treso.zone, dest = id)

# test <- crm_treso_tbl_calc %>% 
#   filter(id == 80, caretype != "AM") %>% 
#   select(hospitalname, id, caretype, age_cluster, 
#          orig.treso.zone, treso.caserate.agecluster,
#          population.2026, hosp.treso.cases, hosp.treso.beddays,
#          hosp.treso.bedsneeded, scale.factor, cases, beddays,
#          bedsneeded)





#   # Establish list of speciality hospitals. Join treso travel time between orig. zone and hospital location zone to identify speciality hospitals by cases*TT for TT over 3hrs > 10% of all cases*TT
#   spec_marker <- crm_treso %>%   
#   left_join(treso_travel_time, by = c("orig.treso.zone"="orig", "hosp.treso.zone" ="dest")) 
#   
# spec_marker_2 <- spec_marker %>% 
#   rename(travel.time = value) %>% 
#   mutate(cases.by.tt = hosp.treso.cases * travel.time) %>% 
#   mutate(long = if_else(travel.time >= 180, 1 , 0)) %>% 
#   group_by(id, hospitalname, long) %>% 
#   mutate(hosp.long.travel.total = sum(cases.by.tt)) %>% 
#   ungroup() %>% 
#   mutate(hosp.total.travel = sum(cases.by.tt)) %>% 
#   mutate(long.to.total.ratio = hosp.long.travel.total/hosp.total.travel) %>% 
#   mutate(speciality = if_else(long.to.total.ratio>=0.,1,0)) %>% 
#   select(id, hospitalname, speciality) %>% 
#   group_by(id, hospitalname) %>% 
#   unique()

############################# Old method of distributing cases, demand days to new hospitals

  # # Revise existing number of hospital beds to be flagged as 'speciality' hospitals or not
  # num_beds_revised <- num_beds %>% 
  #   select(id, caretype, beds = staffedbeds) %>% 
  #   # Join in speciality hospital flag for existing hospitals
  #   left_join(select(speciality_hospitals, id, specialityfactor), by = c('id'))
  # 
  # # Create list of existing and new hospitals with bed counts by caretype
  # num_beds_all <- new_hospital_overlay %>% 
  #   select(-agecluster, -hospitalname, -hosp.cd) %>% 
  #   distinct() %>% 
  #   bind_rows(., num_beds_revised) %>% 
  #   mutate(new.hospital = replace_na(new.hospital, 0)) %>% 
  #   left_join(select(hospitallocations_tz, id, treso_zone, csduid), by = c('id')) %>%
  #   mutate(hosp.csd = ifelse(is.na(hosp.csd), csduid, hosp.csd),
  #          treso_zone.x = ifelse(is.na(treso_zone.x), treso_zone.y, treso_zone.x)) %>% 
  #   rename(treso.zone = treso_zone.x) %>% 
  #   select(-csduid, -treso_zone.y) %>% 
  #   mutate(hosp.cd = substr(hosp.csd, 1, 4))
  # 
  # # Calculate share of CSD-caretype beds each hospital has, ignoring existing speciality hospitals
  # csd_caretype_beds <- num_beds_all %>% 
  #   filter(new.hospital == 1 | specialityfactor == 0) %>% 
  #   # Calculate the total number of beds by CSD and percentage belonging to each hospital
  #   group_by(hosp.csd, caretype) %>% 
  #   mutate(csd.caretype.beds = sum(beds)) %>% 
  #   # Calculate percent of CSD-caretype beds belonging to each hospital
  #   mutate(hosp.caretype.beds.percent = beds / csd.caretype.beds,
  #          hosp.caretype.beds.percent = replace_na(hosp.caretype.beds.percent, 0)) %>% 
  #   # Calculate percent of 'CSD-caretype beds' equivalent for Emergency (AM) cases --> Though Emerg does not have beds in the daily bed census the way other caretypes do, AM cases will need to be redistributed to new hospitals on the basis of some measure of size. Estimate this percentage by taking a weighted average of the percentage of beds from other caretypes
  #   group_by(id) %>% 
  #   mutate(hosp.caretype.beds.percent = ifelse(caretype == 'AM', crossprod(hosp.caretype.beds.percent, beds) / sum(beds), hosp.caretype.beds.percent)) %>% 
  #   ungroup()
  # 
  # ## Prepare the origin demand vector for new hospitals for selected year, based on existing non-speciality hospitals
  # crm_new_hosp_prep <- csd_caretype_beds %>% 
  #   left_join(crm_hosp_agecluster, by = c('id', 'caretype')) %>% 
  #   left_join(select(new_hospital_overlay, id, caretype, agecluster), by = c('id', 'caretype')) %>% 
  #   mutate(agecluster = ifelse(is.na(agecluster.x), agecluster.y, agecluster.x)) %>% 
  #   select(-agecluster.x, -agecluster.y) %>% 
  #   mutate(cases = replace_na(cases, 0),
  #          demand.days.total = replace_na(demand.days.total, 0),
  #          demand.days.ALC = replace_na(demand.days.ALC, 0),
  #          demand.days.nonALC = replace_na(demand.days.nonALC, 0),
  #          beds.needed = replace_na(beds.needed, 0),
  #          new.hospital = replace_na(new.hospital, 0),
  #          beds = replace_na(beds, 0)) %>% 
  #   # Sum cases, bed-days, etc. by CSD
  #   group_by(hosp.csd, caretype, agecluster) %>% 
  #   mutate(cases.csd.caretype.age = sum(cases),
  #          demand.days.total.csd.caretype.age = sum(demand.days.total),
  #          demand.days.ALC.csd.caretype.age = sum(demand.days.ALC),
  #          demand.days.nonALC.csd.caretype.age = sum(demand.days.nonALC)) %>% 
  #   ungroup()
  # 
  # # Redistribute cases, demand days amongst new hospitals, based on total CSD demand
  # crm_new_hosp <- crm_new_hosp_prep %>%
  #   filter(new.hospital == 1) %>% 
  #   mutate(cases = hosp.caretype.beds.percent * cases.csd.caretype.age,
  #          demand.days.total = hosp.caretype.beds.percent * demand.days.total.csd.caretype.age,
  #          demand.days.ALC = hosp.caretype.beds.percent * demand.days.ALC.csd.caretype.age,
  #          demand.days.nonALC = hosp.caretype.beds.percent * demand.days.nonALC.csd.caretype.age) %>% 
  #   # Calcualte sum of cases, demand days by CSD for new hospitals - this will be removed from totals in the next dataframe
  #   group_by(hosp.csd, caretype, agecluster) %>% 
  #   mutate(cases.new.csd.careage = sum(cases),
  #          demand.days.total.new.csd.careage = sum(demand.days.total),
  #          demand.days.ALC.new.csd.careage = sum(demand.days.ALC),
  #          demand.days.nonALC.new.csd.careage = sum(demand.days.nonALC)) %>%
  #   ungroup()
  # 
  # # Determine cases, demand days remaining at existing hospitals, based on total CSD demand and demand at new hospitals.
  # 
  # # Demand must be calculated as the difference between total and new hospitals since not all ageclusters were observed in base year historical data, even in places where those ageclusters COULD have been observed. In other words, if a new hospital represents 10% of total beds in a CSD for Caretype A, it is expected that this new hospital will get 10% of pediatric cases, 10% of adult cases, and 10% of senior cases for Caretype A in that CSD. However, if an existing hospital in the same CSD served 20% of pediatric cases and 20% of senior cases in Caretype A in the base year data, but served 0% of adult cases in Caretype A in the CSD, applying the same distributive logic used for new hospitals will assign 20% of adult cases to this existing hospital. To avoid this, subtract cases assigned to new hospitals from the total number of cases, and then assign remainder to existing hospitals based on historically observed proportion of caretype by agecluster by CSD.
  # 
  # crm_existing_hosp <- crm_new_hosp_prep %>% 
  #   # Remove new hospitals from this dataframe
  #   filter(new.hospital == 0) %>% 
  #   # Join in cases, demand days from new hospitals summed to the CSD level
  #   left_join(select(crm_new_hosp, hosp.csd, caretype, agecluster, cases.new.csd.careage, demand.days.total.new.csd.careage, demand.days.ALC.new.csd.careage, demand.days.nonALC.new.csd.careage), by = c('hosp.csd', 'caretype', 'agecluster')) %>% 
  #   # Replace N/A values for CSDs with no new hospitals
  #   mutate(cases.new.csd.careage = replace_na(cases.new.csd.careage, 0), 
  #          demand.days.total.new.csd.careage = replace_na(demand.days.total.new.csd.careage, 0),
  #          demand.days.ALC.new.csd.careage = replace_na(demand.days.ALC.new.csd.careage, 0),
  #          demand.days.nonALC.new.csd.careage = replace_na(demand.days.nonALC.new.csd.careage, 0)) %>% 
  #   # Calculate percentage of cases, demand days, etc. by existing hospital
  #   group_by(hosp.csd, caretype, agecluster) %>% 
  #   mutate(cases.percent.hosp = cases / sum(cases),
  #          demand.days.total.percent.hosp = demand.days.total / sum(demand.days.total),
  #          demand.days.ALC.percent.hosp = demand.days.ALC / sum(demand.days.ALC),
  #          demand.days.nonALC.percent.hosp = demand.days.nonALC / sum(demand.days.nonALC)) %>% 
  #   # Fix NA values due to divide-by-zero errors
  #   mutate(cases.percent.hosp = replace_na(cases.percent.hosp, 0),
  #          demand.days.total.percent.hosp = replace_na(demand.days.total.percent.hosp, 0),
  #          demand.days.ALC.percent.hosp = replace_na(demand.days.ALC.percent.hosp, 0),
  #          demand.days.nonALC.percent.hosp = replace_na(demand.days.nonALC.percent.hosp, 0)) %>% 
  #   # Calculate cases, demand days remaining at existing hospitals after distributing to new hospitals
  #   mutate(cases.remaining = cases.percent.hosp * (sum(cases) - cases.new.csd.careage),
  #          demand.days.total.remaining = demand.days.total.percent.hosp * (sum(demand.days.total) - demand.days.total.new.csd.careage),
  #          demand.days.ALC.remaining = demand.days.ALC.percent.hosp * (sum(demand.days.ALC) - demand.days.ALC.new.csd.careage),
  #          demand.days.nonALC.remaining = demand.days.nonALC.percent.hosp * (sum(demand.days.nonALC) - demand.days.nonALC.new.csd.careage)) %>% 
  #   ungroup() %>% 
  #   select(id, treso.zone, hosp.csd, hosp.cd, caretype, agecluster, specialityfactor, new.hospital, beds, cases = cases.remaining, demand.days.total = demand.days.total.remaining, demand.days.ALC = demand.days.ALC.remaining, demand.days.nonALC = demand.days.nonALC.remaining)


############################# Outdated means of adding beds to existing hospitals where 'new beds' are required

    # Add beds to largest existing hospital in the CSD if one (or more) exist; otherwise, build new hospital in CSD
    # left_join(select(hospitallocations_tz, id, csduid, hosp.treso = treso_zone, lat, long), by = c('orig.csd' = 'csduid')) %>%
    # left_join(select(num_beds, id, caretype, beds = staffedbeds), by = c('id', 'caretype')) %>% 
    # arrange(desc(beds)) %>% 
    # group_by(orig.csd, caretype) %>% 
    # mutate(size.rank = 1:n()) %>% 
    # ungroup() %>% 
    # filter(size.rank == 1) %>% 
    # select(-size.rank) %>% 

############################# Determine distribution of demand at hospitals by CSD, TRESO zone

# Calculate total number of cases/demand-days at hospitals based on redistribution between hospitals within each CSD
# crm_hosp_agecluster_all <- crm_hosp_agecluster_redist %>%
#   # Identify existing hospitals which are speciality hospitals
#   left_join(select(speciality_hospitals, id, specialityfactor), by = c('id')) %>%
#   mutate(new.hospital = 0) %>% 
#   # Join in bed counts for existing hospitals
#   left_join(select(num_beds, id, beds = staffedbeds, caretype), by = c('id', 'caretype')) %>% 
#   # Bind in new hospital data
#   bind_rows(., select(new_hospital_overlay, id, caretype, agecluster, beds, specialityfactor, new.hospital, hosp.csd)) %>% 
#   mutate(cases = replace_na(cases, 0),
#          demand.days.total = replace_na(demand.days.total, 0),
#          demand.days.ALC = replace_na(demand.days.ALC, 0),
#          demand.days.nonALC = replace_na(demand.days.nonALC, 0),
#          beds.needed = replace_na(beds.needed, 0),
#          new.hospital = replace_na(new.hospital, 0),
#          beds = replace_na(beds, 0)) %>% 
#   # Remove existing hospitals which are speciality hospitals from redistribution
#   filter(new.hospital == 1 | specialityfactor == 0) %>%
#   # Calculate percentage of beds by hospital by caretype by agecluster
#   group_by(hosp.csd, caretype, agecluster) %>%
#   mutate(beds.percent = beds / sum(beds)) %>% 
#   mutate(beds.percent = replace_na(beds.percent, 0)) %>% 
#   # Sum cases, bed-days, etc. by CSD
#   mutate(cases.csd.caretype.age = sum(cases),
#          demand.days.total.csd.caretype.age = sum(demand.days.total),
#          demand.days.ALC.csd.caretype.age = sum(demand.days.ALC),
#          demand.days.nonALC.csd.caretype.age = sum(demand.days.nonALC)) %>% 
#   mutate(cases.revised = beds.percent * cases.csd.caretype.age,
#          demand.days.total.revised = beds.percent * demand.days.total.csd.caretype.age,
#          demand.days.ALC.revised = beds.percent * demand.days.ALC.csd.caretype.age,
#          demand.days.nonALC.revised = beds.percent * demand.days.nonALC.csd.caretype.age) %>% 
#   ungroup()

############################# Overburden and number of beds to build for hospitals

 #Determine how many patients from each CSD/CD go to hospitals in other CSDs/CDs which are overburdened, then determine if it makes sense to build more hospital beds in each origin CSD/CD
  # overburden <- demand_capacity_crm_patterns %>% 
  #   select(id, caretype, hosp.beds.to.build) %>% 
  #   filter(hosp.beds.to.build > 0) %>% 
  #   left_join(select(crm_orig, orig.csd, id, caretype, agecluster, cases:beds.needed), by = c('id', 'caretype')) %>% 
  #   # Sum cases, demand-days across ageclusters to find total demand by orig.csd, caretype
  #   mutate(sumCases = sum(cases)) %>% 
  #   group_by(orig.csd, caretype) %>% 
  #   mutate(cases = sum(cases), demand.days.total = sum(demand.days.total), demand.days.nonALC = sum(demand.days.nonALC), 
  #          demand.days.ALC = sum(demand.days.ALC), beds.needed = sum(beds.needed)) %>% 
  #   select(-agecluster, -id, -hosp.beds.to.build) %>%
  #   ungroup() %>% 
  #   distinct()
  
  # # Determine number of beds to be built by CSD which can justify construction of beds (i.e., exceeding minimum build number)
  # csd_build <- overburden %>% 
  #   # Remove all origin CSD / caretype combinations which do not have enough demand to justify construction of additional beds in the CSD
  #   filter(beds.needed >= min_beds) %>% 
  #   # Start by determining where new facilities should go - i.e., prioritize CSDs with no hospital (by caretype) on the assumption that these will have relatively high travel times
  #   left_join(csd_beds_existing, by = c('orig.csd' = 'hosp.csd')) %>% 
  #   replace_na(list(beds.existing = 0))
  # 
  # # Determine number of beds needed but not built across CSDs going to overburdened hospitals
  # csd_no_build <- overburden %>% 
  #   filter(beds.needed < min_beds)

############################################# Calculate ALC by hospital by caretype for 2016 for use in length-of-stay calculations

# Commented out since this mostly yields ALC demand identified as 'AM' caretype, or Emergency, which is not meaningful or actionable data.
# ALC_hosp_caretype <- ALC_hosp_vol_disag %>% 
#   ungroup() %>% 
#   filter(year == 2016) %>% 
#   distinct(year, siteid, agecluster, adj.hosp.days.tot) %>% 
#   #left_join(distinct(HBAMhistorical_master_tz, year, id, siteid, caretype), by = c('year', 'siteid', 'id')) %>% 
#   left_join(select(hospitallocations, datasetID1.siteid, id, caretype), by = c('siteid' = 'datasetID1.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID2.siteid, id, caretype), by = c('siteid' = 'datasetID2.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID3.siteid, id, caretype), by = c('siteid' = 'datasetID3.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID4.siteid, id, caretype), by = c('siteid' = 'datasetID4.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID5.siteid, id, caretype), by = c('siteid' = 'datasetID5.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID6.siteid, id, caretype), by = c('siteid' = 'datasetID6.siteid')) %>% 
#   ungroup() %>% 
#   mutate(id = pmax(replace_na(id.x, 0), replace_na(id.x.x, 0), replace_na(id.x.x.x,0), replace_na(id.y, 0), replace_na(id.y.y, 0), replace_na(id.y.y.y, 0))) %>% 
#   mutate(caretype = pmax(replace_na(caretype.x, 0), replace_na(caretype.x.x, 0), replace_na(caretype.x.x.x,0), replace_na(caretype.y, 0), replace_na(caretype.y.y, 0), replace_na(caretype.y.y.y, 0))) %>%
#   # Take distinct rows from dataframe above since individual siteid codes may have been joined on multiple times to match the datasetID values
#   distinct(year, id, siteid, agecluster, caretype, adj.hosp.days.tot) %>% 
#   group_by(year, id, agecluster, caretype) %>% 
#   summarise(hosp.caretype.days = sum(adj.hosp.days.tot)) %>% 
#   # Calculate percent of ALC days by caretype/agecluster for each hospital id
#   group_by(year, id) %>% 
#   mutate(hosp.caretype.agecluster.days.percent = hosp.caretype.days / sum(hosp.caretype.days)) %>% 
#   ungroup()

```













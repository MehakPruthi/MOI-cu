---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
# source('helpers.r')
```

## Import Relevant Files
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
  
```{r, include= FALSE, results='hide'}
#Defining hospital parameters for care-types and age bands
caretypes = c("at", "cr", "gr", "mh", "am")
age_cluster = c('ad', 'ped', 'sr')
agegroup_ref <- tibble(age_cluster = c('ad', 'ad', 'ad', 'ped', 'sr', 'sr'),
                          agegroup = as.factor(c(2,3,4,1,5,6))) %>% 
  arrange(agegroup)

#CIHI Bed Data
CIHIhospitalbeds <- read_csv('input/moh/cap.CIHI_Hospital_Beds.csv')

#Daily Bed Census bed counts
numbeds <- readRDS('cache/moh/num_beds.rds')

# Historical HBAM Master (w/ Asset data)
HBAMhistorical_master <- readRDS('cache/moh/HBAMhistorical_master.rds')

# Projected HBAM Master (w/ Asset data)
HBAMprojected_master <- readRDS('cache/moh/HBAMprojected_master.rds')

#Hospital Asset Data
hospitallocations <- readRDS('cache/moh/hospitallocations.rds')

#TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")

treso_population_moh <- readRDS('input/moh/treso_population_moh.rds')

treso_population_long <- gather(treso_population_moh, 'year', 'population', population.2011:population.2041, -age_group, -age_cluster) %>% 
  separate(year, into = c('pop', 'year'), sep = "n.") %>% 
  mutate(year = as.numeric(year)) %>% 
  select(-pop) %>% 
  group_by(year, treso_zone, age_cluster) %>% 
  mutate(treso.population.agecluster = sum(population))

num_beds <- numbeds %>% 
  left_join(select(hospitallocations, datasetID1.siteid, id), by = c('siteid' = 'datasetID1.siteid')) %>% 
  left_join(select(hospitallocations, datasetID2.siteid, id), by = c('siteid' = 'datasetID2.siteid')) %>% 
  left_join(select(hospitallocations, datasetID3.siteid, id), by = c('siteid' = 'datasetID3.siteid')) %>% 
  left_join(select(hospitallocations, datasetID4.siteid, id), by = c('siteid' = 'datasetID4.siteid')) %>% 
  left_join(select(hospitallocations, datasetID5.siteid, id), by = c('siteid' = 'datasetID5.siteid')) %>% 
  left_join(select(hospitallocations, datasetID6.siteid, id), by = c('siteid' = 'datasetID6.siteid')) %>% 
  ungroup() %>% 
  mutate(id = pmax(replace_na(id.x, 0), replace_na(id.x.x, 0), replace_na(id.x.x.x,0), replace_na(id.y, 0), replace_na(id.y.y, 0), replace_na(id.y.y.y, 0))) %>% 
  select(-id.x, -id.x.x, -id.x.x.x, -id.y, -id.y.y, -id.y.y.y)

treso_zone_system <- read_csv('input/treso/treso_zone_system.csv')
```

## Link Hospital Site IDs to TRESO Zones:
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Identify and quantify unmatched TRESO zones/Site IDs, if any
  
```{r, include=FALSE}
# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- hospitallocations %>%
  ungroup() %>%
  select(name,
         id,
         facilityid,
         pcode,
         lat,
         long) %>%
  distinct()

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            hosp_name = hospital_xy@data$name,
            id = hospital_xy@data$id) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             hosp_name, 
             id) %>% 
      rename(treso_zone = Treso_ID) %>% 
      left_join(treso_zone_system, by = c('treso_zone' = 'treso_id'))

saveRDS(hospital_overlay, file = 'cache/moh/hospital_overlay.rds')

rm(treso_shp, hospital_xy, hospital_spdf)

#Update Master HBAM list to Include TRESO Zones
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, 
                                      select(hospital_overlay, treso_zone, id, hosp_csduid = csduid, csdname, cdname), 
                                      by = c('id')) %>% 
  left_join(agegroup_ref, by = 'agegroup') %>% 
  # Duplicate rows appearing in HBAM - take max by group to limit to deduplicate
  group_by(year, id, caretype, agegroup, orig_csd) %>% 
  mutate(maxCases = max(cases)) %>% 
  select(-cases) %>% 
  distinct() %>% 
  rename(cases = maxCases)

HBAMprojected_master_tz <- left_join(HBAMprojected_master, 
                                     select(hospital_overlay, treso_zone, id), 
                                     by = c('id')) %>%
  left_join(agegroup_ref, by = c('agegroup'))

saveRDS(HBAMprojected_master_tz, "output/moh/HBAMprojected_master_tz.rds")

rm(HBAMhistorical_master, HBAMprojected_master)

```

## Consolidated Hospital Lookup
  - Reorganize HBAM historical to show unique hospital locations w/ metadata needed for visualization tool
  - Create in wide format w/ sub-naming for care-type and age-cluster 

```{r}
#Use combine HBAM-TRESO object as basis
hospital_lookup_latlong <- HBAMhistorical_master_tz %>% 
  group_by(id) %>% 
  summarise(csduid = first(hosp_csduid),
            csdname = first(csdname),
            lat = first(lat),
            long = first(long),
            treso_zone = first(treso_zone))

hospital_lookup <- HBAMhistorical_master_tz %>% 
  group_by(year, id, name, pcode, age_cluster, caretype) %>% 
  summarise(cases = sum(cases)) %>% 
  mutate(cases_at_ad = ifelse(caretype %in% 'AT' & age_cluster %in% 'ad', cases, 0),
         cases_at_ped = ifelse(caretype %in% 'AT' & age_cluster %in% 'ped', cases, 0),
         cases_at_sr = ifelse(caretype %in% 'AT' & age_cluster %in% 'sr', cases, 0),
         cases_cr_ad = ifelse(caretype %in% 'CR' & age_cluster %in% 'ad', cases, 0),
         cases_cr_ped = ifelse(caretype %in% 'CR' & age_cluster %in% 'ped', cases, 0),
         cases_cr_sr = ifelse(caretype %in% 'CR' & age_cluster %in% 'sr', cases, 0),
         cases_gr_ad = ifelse(caretype %in% 'GR' & age_cluster %in% 'ad', cases, 0),
         cases_gr_ped = ifelse(caretype %in% 'GR' & age_cluster %in% 'ped', cases, 0),
         cases_gr_sr = ifelse(caretype %in% 'GR' & age_cluster %in% 'sr', cases, 0),
         cases_mh_ad = ifelse(caretype %in% 'MH' & age_cluster %in% 'ad', cases, 0),
         cases_mh_ped = ifelse(caretype %in% 'MH' & age_cluster %in% 'ped', cases, 0),
         cases_mh_sr = ifelse(caretype %in% 'MH' & age_cluster %in% 'sr', cases, 0),
         cases_am_ad = ifelse(caretype %in% 'AM' & age_cluster %in% 'ad', cases, 0),
         cases_am_ped = ifelse(caretype %in% 'AM' & age_cluster %in% 'ped', cases, 0),
         cases_am_sr = ifelse(caretype %in% 'AM' & age_cluster %in% 'sr', cases, 0)) %>% 
  group_by(year, id, name, pcode) %>% 
  summarise_at(vars(cases_at_ad:cases_am_sr), sum) %>%
  left_join(hospital_lookup_latlong, by = c('name', 'pcode'))
  #group_by(pcode) %>% 
  #mutate(id = group_indices()) %>% 
  #ungroup()

#Import bed summaries from Daily Bed Census (DBC); this can be imported above
num_beds_spread <- num_beds %>%
  spread(year, maxstaffedbeds) %>% 
  rename('dbc_beds_2017' = '2017',
         'dbc_beds_2018' = '2018',
         'caretype' = 'type') %>% 
  left_join(select(hospitallocations, id, caretype, name, pcode), by = c('id', 'caretype'))

#Spread DBC 2017 and 2018 data
dbc_beds_2017 <- num_beds_spread %>% 
  select(-dbc_beds_2018) %>% 
  spread(caretype, dbc_beds_2017) %>% 
  rename(at_beds_2017 = AT,
         cr_beds_2017 = CR,
         gr_beds_2017 = GR,
         mh_beds_2017 = MH) %>% 
  mutate(dbc_total_beds_2017 = sum(c(at_beds_2017, cr_beds_2017, gr_beds_2017, mh_beds_2017), na.rm = TRUE))

dbc_beds_2018 <- num_beds_spread %>% 
  select(-dbc_beds_2017) %>% 
  spread(caretype, dbc_beds_2018) %>% 
  rename(at_beds_2018 = AT,
         cr_beds_2018 = CR,
         gr_beds_2018 = GR,
         mh_beds_2018 = MH) %>% 
  mutate(dbc_total_beds_2018 = sum(c(at_beds_2018, cr_beds_2018, gr_beds_2018, mh_beds_2018), na.rm = TRUE))

#Combine DBC bed data into wide table format by Postal Code
dbc_beds <- full_join(dbc_beds_2017, dbc_beds_2018, by = c('name', 'pcode', 'siteid')) %>%
  group_by(pcode) %>% 
  summarise_at(vars(at_beds_2017:dbc_total_beds_2018), sum, na.rm = TRUE)

#Import CIHI Bed data and structure to wide table format by Postal Code
CIHIhospitalbeds_spread <- CIHIhospitalbeds %>% 
  select(year = Year,
         name = 'Hospital Name',
         hosp_type = 'Type of Hospital',
         cihi_total = Total) %>%  
  mutate(name = toupper(name)) %>% 
  right_join(select(hospital_lookup, year, name, pcode), by = c('name', 'year')) %>% 
  spread(year, cihi_total) %>% 
  rename('cihi_beds_2012' = '2012',
         'cihi_beds_2013' = '2013',
         'cihi_beds_2014' = '2014',
         'cihi_beds_2015' = '2015',
         'cihi_beds_2016' = '2016',)

#Compiled Bed Data between CIHI and DBC
hosp_beds_comp <- left_join(dbc_beds, CIHIhospitalbeds_spread, by = 'pcode') %>% 
  select(pcode, hosp_type, cihi_beds_2012:cihi_beds_2016, at_beds_2017:dbc_total_beds_2018)

#Final Master List only including DBC because of incomplete CIHI Data
hospital_lookup_master <- left_join(hospital_lookup, dbc_beds, by = 'pcode') %>% 
  select(id, year, name, pcode, csduid:treso_zone, cases_at_ad:dbc_total_beds_2018)

hospital_lookup_latlong_id <- hospital_lookup_latlong %>% 
  left_join(select(hospital_lookup_master, pcode, id), by = 'pcode') %>% 
  distinct()

saveRDS(hospital_lookup_master, file = 'output/moh/hospital_lookup_master.rds')

rm(hospital_lookup, num_beds_spread, num_beds, dbc_beds, dbc_beds_2017, dbc_beds_2018, CIHIhospitalbeds_spread, CIHIhospitalbeds, hosp_beds_comp)
```

##ALOS Calculation

```{r}
#JOin TRESO origin calculations to HBAM projected by calculating the ALOS for each CT-Age-cluster segment and apply to CRM projected number of cases to convert from cases to beddays

#Average LOS for patient admittance on provincial level (HQO)
hqo_edlos <- data.frame('year' = c(2018, 2018, 2018, 2018, 2019,2019,2019,2019,2019,2019,2019,2019,2019), 
                        'month' = c(09:12, 01:09), 
                        'edlos' = c(16.3,16.8,17, 16.3, 18.3, 16.7, 16.8, 16.2, 16.1, 16.3, 15.6, 15.5, 17.1))
avg_edlos_2018 <- mean(hqo_edlos$edlos)
#EDLOS to admittance according to provincial average from CIHI
avg_edlos_2015 <- 9.8 
avg_edlos_2016 <- 10.5
avg_edlos_2017 <- 11.0
#Averaged out 3 data points to get rough average of ED-LOS (to admittance since that is when they are transferred to other CT); however, rate needs to reflect % of ED patients that do not get admitted, which might be the majority and that would decrease overall ALOS
avg_edlos <- mean(c(avg_edlos_2015, avg_edlos_2016, avg_edlos_2017))

HBAMprojected_alos <- HBAMprojected_master_tz %>% 
  select(year, siteid, lhin, age_cluster, caretype, cases, los) %>% 
  group_by(caretype, age_cluster) %>% 
  summarise(totalcases = sum(cases),
            total.los = sum(los, na.rm = TRUE)) %>% 
  mutate(alos = total.los/totalcases) %>% 
  select(caretype, age_cluster, alos)

saveRDS(HBAMprojected_alos, file = 'cache/moh/HBAMprojected_alos.rds')
```

##Base Scenario Calculation: CRM Rates
  - Calculate the market share of cases for each hospital w.r.t population at TRESO-level from HBAM for the given year/caretype/age cluster (named segment from now on)
  - Apply the case rates to the population at TRESO zones (Caserate Demand) [origin vector]
  - Create linkage to HBAM Projected and calculate scale factor (HBAM/CRM); scale cases based on factor to get Hosp-TZ cases

```{r}
# Calculate total cases by hospital, and the percentage of cases belonging to each CSD for each hospital siteid
HBAMhistorical_origcsd_cases <- HBAMhistorical_master_tz %>% 
  group_by(year, siteid, agegroup, caretype) %>% 
  mutate(totalcases = sum(cases),
         csd.mrkt = cases/totalcases) %>% 
  select(year, 
         siteid, 
         hospitalname,
         hosp.treso.zone = treso_zone,
         caretype, 
         agegroup, 
         age_cluster, 
         orig_csd, 
         csd.hosp.cases = cases, 
         hosp.cases = totalcases, 
         csd.mrkt)

# Join historical HBAM cases by CSD/hospital pair to TRESO information to get TRESO populations
# Then calculate case rates for TRESO zones at the CSD-Hospital pair, segmented by caretype, year, and HBAM agegroup; also segmented seprately by caretype, year, and age_cluster (which lumps some age groups together into 'ped', 'adult', 'senior')
treso_origin_cases <- left_join(HBAMhistorical_origcsd_cases, treso_population_long, by = c('year', 'orig_csd' = 'csduid', 'agegroup' = 'age_group', 'age_cluster')) %>% 
  rename('orig.treso.zone' = 'treso_zone',
         'orig.treso.pop' = 'population') %>%
  # Group to enable analysis by age_cluster or by agegroup
  group_by(year, orig.treso.zone, age_cluster, orig_csd, caretype, siteid) %>% 
  mutate(orig.treso.pop.agecluster = sum(orig.treso.pop),
         hosp.cases.agecluster = sum(hosp.cases),
         csd.hosp.cases.agecluster = sum(csd.hosp.cases),
         csd.mrkt.agecluster = ifelse(hosp.cases.agecluster > 0, csd.hosp.cases.agecluster / hosp.cases.agecluster, 0)) %>%
  # Calculate metrics with segment grouped by agegroup, caretype
  group_by(year, agegroup, orig_csd, caretype, siteid) %>%
  mutate(csd.pop = sum(orig.treso.pop),
         treso.pop.perc = ifelse(csd.pop > 0, orig.treso.pop/csd.pop, 0.0),
         csd.caserate = ifelse(csd.pop > 0, csd.mrkt * hosp.cases / csd.pop, 0.0),
         treso.hosp.cases = csd.mrkt * treso.pop.perc * hosp.cases, 
         treso.caserate = ifelse(orig.treso.pop > 0, treso.hosp.cases / orig.treso.pop, csd.caserate)) %>% 
  # Calculate metrics with segment grouped by age_cluster, caretype
  group_by(year, age_cluster, orig_csd, caretype, siteid) %>%
  mutate(csd.pop.agecluster = sum(orig.treso.pop.agecluster, na.rm = TRUE),
         treso.pop.perc.agecluster = ifelse(csd.pop.agecluster > 0, orig.treso.pop.agecluster/csd.pop.agecluster, 0.0),
         csd.caserate.agecluster = ifelse(csd.pop.agecluster > 0, csd.mrkt.agecluster * hosp.cases.agecluster / csd.pop.agecluster, 0.0), 
         treso.hosp.cases.agecluster = csd.mrkt.agecluster * treso.pop.perc.agecluster * hosp.cases.agecluster, 
         treso.caserate.agecluster = ifelse(orig.treso.pop.agecluster > 0, treso.hosp.cases.agecluster / orig.treso.pop.agecluster, csd.caserate.agecluster)) %>%
  ungroup() %>%
  drop_na(orig.treso.zone) %>% 
  filter(year == 2016) %>% #select most recent historical year
  select(siteid,
         hospitalname,
         hosp.treso.zone,
         caretype,
         age_cluster,
         orig_csd,
         orig.treso.zone,
         treso.caserate.agecluster)

saveRDS(treso_origin_cases, file = 'cache/moh/treso_origin_cases.rds')

rm(treso_origin_cases)
```

##Forecast Scenario Calculation: CRM Demand Volumes
  - Calculate total expected cases, bed-days (using ALOS) and beds-needed (bed-days/cases) for a selected forecast year
  
```{r}
##Projection Parameters
PROJ_YEAR <- 2026
OP_DAYS <- 365
USER_SELECT <- "CRM"

hospital_master_id <- readRDS('output/moh/hospital_lookup_master.rds') %>% 
  select(id, pcode) %>% 
  distinct()

HBAMprojected_alos <- readRDS('cache/moh/HBAMprojected_alos.rds')

treso_population_moh_agecluster <- treso_population_moh %>% 
  select(-age_group) %>% 
  group_by(treso_zone, age_cluster) %>% 
  summarise_all(sum) %>% 
  ungroup()

#CRM Output table calculates the number of cases, bed-days and beds-needed (bed-days/operating-days) for each hospital-treso pair and then summarizes it to each hospital, calculating the totals for each unique hospital-segment for the given projection year
crm_treso_tbl <- readRDS('cache/moh/treso_origin_cases.rds') %>% 
  filter(!is.na(orig.treso.zone), !is.na(treso.caserate.agecluster)) %>% # Can remove after fixes
  left_join(select(hospitallocations,siteid, pcode), by = 'siteid') %>% 
  left_join(select(hospital_master_id, id, pcode), by = 'pcode') %>%
  select(-siteid) %>% 
  distinct() %>% 
  left_join(treso_population_moh_agecluster, by = c("orig.treso.zone" = "treso_zone", "age_cluster")) %>% 
  left_join(HBAMprojected_alos, by = c("age_cluster", "caretype")) %>%
  saveRDS("output/moh/crm_treso_tbl.rds")

crm_treso_tbl <- readRDS("output/moh/crm_treso_tbl.rds") %>% 
  # Calculate the number of cases, beddays, bedsneeded depending on the input year
  mutate(hosp.treso.cases = treso.caserate.agecluster * get(paste0("population.", PROJ_YEAR)),
         hosp.treso.beddays = hosp.treso.cases * alos,
         hosp.treso.bedsneeded = hosp.treso.beddays / OP_DAYS)

crm_hosp_tbl <- crm_treso_tbl %>% 
  group_by(id, caretype, age_cluster) %>% 
  summarise_at(vars(hosp.treso.cases:hosp.treso.bedsneeded), sum) %>% 
  ungroup()

if (PROJ_YEAR <= 2016) {
  HBAM_control <- readRDS("output/moh/hospital_lookup_master.rds") %>% 
    filter(year == PROJ_YEAR) %>% 
    gather(key = "segment", value = "cases", cases_at_ad:cases_am_sr) %>% 
    separate(segment, c(NA, "caretype", "age_cluster")) %>% 
    mutate(caretype = toupper(caretype)) %>% 
    group_by(id, caretype, age_cluster) %>% 
    summarise(cases = sum(cases)) %>% 
    ungroup()
} else {
  HBAM_control <- HBAMprojected_master_tz %>% 
    filter(year == PROJ_YEAR) %>% 
    left_join(select(hospital_master_id, id, pcode), by = "pcode") %>% 
    group_by(id, caretype, age_cluster) %>% 
    summarise_at(vars(cases:beddays), sum, na.rm=TRUE)
}

# Calculate scale factor between HBAM and CRM 
crm_hosp_tbl_join <- left_join(crm_hosp_tbl, HBAM_control, by = c("id", "caretype", "age_cluster")) %>% 
  mutate(scale.factor = cases/hosp.treso.cases) %>% 
  select(id, caretype, age_cluster, scale.factor)

# Depending on the user selected option
if (USER_SELECT == "HBAM") {
  crm_treso_tbl_calc <- left_join(crm_treso_tbl, crm_hosp_tbl_join, by = c("id", "caretype", "age_cluster")) %>% 
    mutate(cases = hosp.treso.cases * scale.factor,
                   beddays = cases * alos,
                   bedsneeded = beddays / OP_DAYS)
} else if (USER_SELECT == "CRM") {
  crm_treso_tbl_calc <- crm_treso_tbl %>% 
    mutate(cases = hosp.treso.cases,
           beddays = cases * alos,
           bedsneeded = beddays / OP_DAYS)
}

hospital_beds_summary <- crm_treso_tbl_calc %>%
  group_by(id, caretype, age_cluster) %>% 
  summarise(bedsneeded = sum(bedsneeded)) %>% 
  ungroup() %>% 
  mutate(caretype = tolower(caretype)) %>% 
  unite(segment, caretype:age_cluster) %>% 
  spread(segment, bedsneeded) %>% 
  mutate_at(vars(-id), ~replace_na(., 0)) %>% 
  mutate(simulated.beds = select(., -id) %>% rowSums())

hospital_master_id <- readRDS("output/moh/hospital_lookup_master.rds") %>% 
  mutate(beds = dbc_total_beds_2018,
         cases = select(., contains("cases")) %>% rowSums(),
         utilization = 0.1) %>% 
  filter(year == 2016) %>% 
  left_join(hospital_beds_summary, by="id") %>% 
  mutate(utilization = simulated.beds / beds)

hospital_od <- crm_treso_tbl_calc %>% 
  group_by(id, orig.treso.zone) %>% 
  summarise(value = round(sum(cases), 0),
            name = first(hospitalname)) %>% 
  rename(orig = orig.treso.zone, dest = id)

print(select(hospital_master_id, id, beds, simulated.beds, utilization))
```

NOT-SO-LOW HANGING FRUIT FOR PAUL:

4. SUMMARIZE ALC HOSPITAL DATA TO AGE CLUSTERS
5. FORECAST ALC(LTC) USING LTC CAPACITY DATA AND ALC VOLUME DATA: COMBINE LTC CAPACITY AND ALC BED DAYS, GET RATE TO CSD-75+ POPULATION AND FORECAST USING TRESO POPULATION, REDISTRIBUTE TO INDIVIDUAL HOSPITALS BY MARKET-SHARE OF ALC DAYS

##ALC

###ALC Crosswalk
```{r}
ALC_idcrosswalk <- readRDS('cache/moh/ALC_crosswalk.rds') %>% 
  select(-name) %>% 
  left_join(hospitallocations, by = c('siteid', 'facilityid', 'lhin', 'type' = 'caretype')) %>% 
  drop_na(pcode) #Drop NA pcodes from Hospital Locations dataset, to be changed when dataset is updated

#ALC Siteids have multiple hospital IDs associated w/ them referring to different case-types and names in some instances; distinct codes are extracted for SiteID-LHIN connection
ALC_idcrosswalk_slim <- ALC_idcrosswalk %>% 
  group_by(ALCsite_id) %>% 
  distinct(lhin, ALCsite_id)

#Importing LTC data
ltc_homes <- read_csv('input/moh/20190628_LTC Homes Query.csv') %>% 
  select(sector = Sector,
         city = 'Homes City',
         postal.code = 'Homes Postal Code',
         beds = 'Total Beds')

pccf <- read.csv('input/edu/PCCF_ONT_2018.csv', stringsAsFactors = FALSE, fileEncoding = "UTF-8-BOM") 

# Join postal code centroids to student's postal code data
pccfSlim <- pccf %>%
  filter(SLI == 1) %>%
  select(postal.code = PostalCode,
         csduid = CSDuid,
         csdname = CSDname,
         lat = LAT,
         long = LONG,
         retirement.date = Ret_Date) %>%
  group_by(postal.code) %>%
  filter(retirement.date == max(retirement.date))

# Create a list of postal codes with SLI == 1 but different lat/long
pccfSlim[duplicated(pccfSlim$postal.code) | duplicated(pccfSlim$postal.code, fromLast = TRUE), ] %>%
  arrange(postal.code) %>%
  group_by(postal.code, lat, long, retirement.date) %>%
  summarise(n = n()) %>%
  filter(n == 1)

# Fill in CSD information
ltc_homes_csd <- ltc_homes %>% 
  mutate(pcode.clean = gsub("\\s+", "", postal.code)) %>%
  left_join(select(pccfSlim, ltc.lat = lat, ltc.long = long, postal.code, csduid, csdname), by = c('pcode.clean' = 'postal.code')) %>%
  select(-pcode.clean, -ltc.lat, -ltc.long) %>% 
  group_by(csduid, csdname) %>% 
  summarise(csd.ltc.beds = sum(beds)) %>% 
  mutate(ltc.bed.days = csd.ltc.beds * OP_DAYS,
         csdname = toupper(csdname))

saveRDS(ltc_homes_csd, file = 'cache/moh/ltc_homes_csd.rds')

ALC_idcrosswalk_csd <- ALC_idcrosswalk %>%
  mutate(pcode.clean = gsub("\\s+", "", pcode)) %>%
  left_join(select(pccfSlim, alc.lat = lat, alc.long = long, postal.code, csduid, csdname), by = c('pcode.clean' = 'postal.code')) %>%
  select(-pcode.clean, -alc.lat, -alc.long) %>% 
  select(lhin, name, alcname, caretype = type, pcode, siteid, ALCsite_id, csduid, csdname)

ALC_idcrosswalk_link <- ALC_idcrosswalk_csd %>%
  select(ALCsite_id, name, csduid, csdname) %>% 
  distinct()
  
saveRDS(ALC_idcrosswalk_csd, file = 'cache/moh/ALC_idcrosswalk_csd.rds')

```


###Estimating Suppression
```{r}
#ALC raw data includes agegroup == 9 which is the totalling flag
#ALC data for 2017 only includes LHINs 1-3 and 10-14
ALC_madd_raw <- readRDS('cache/moh/ALC_madd_raw.rds') %>% 
  filter(madd == 'LTC', year == 2016)

ALC_madd_prov_total <- ALC_madd_raw %>% 
  filter(number == 15, agegroup == 9) %>% 
  rename('prov.days.tot' = 'alcdays',
         'prov.los.avg' = 'avg.los')

####TODO: ASSIGN DF'S TO MADD_RAW INSTEAD OF DIRECT CACHE LINK

ALC_lhin_vol <-  ALC_madd_raw %>% 
  filter(madd == 'LTC', agegroup == 9, year == 2016, number < 15) %>% 
  rename('lhin.num' = 'number',
         'lhin.days' = 'alcdays',
         'lhin.los.avg' = 'avg.los') %>% 
  left_join(select(ALC_madd_prov_total, year, prov.days.tot, prov.los.avg), by = 'year') %>% 
  group_by(year) %>% 
  mutate(lhin.days.tot = sum(as.numeric(lhin.days)),
         lhin.missing.days = as.numeric(prov.days.tot) - lhin.days.tot,
         lhin.residual.avg = lhin.missing.days/sum(patients)) %>% 
  group_by(year, lhin.num) %>% 
  mutate(remaining.days = lhin.residual.avg * patients,
         adj.lhin.days.tot = ifelse(lhin.days == 'LV' | lhin.days == 'NS', remaining.days, as.numeric(lhin.days))) %>% 
  select(year, lhin.num, agegroup, patients, adj.lhin.days.tot)

#ALC estimations at higher age-group aggregation
#estimations at agegroup == 9; accurate only for years 2011-2016 because 2017 is missing LHIN data (see note above)
ALC_hosp_vol <- ALC_madd_raw %>% 
  filter(madd == 'LTC', number > 999, agegroup == 9, year == 2016) %>% 
  rename(hosp.alc.days = alcdays,
         hosp.avg.los = avg.los) %>% 
  left_join(select(ALC_idcrosswalk_slim, lhin, ALCsite_id), by = c('siteid' = 'ALCsite_id')) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot, agegroup), by = c('year', 'lhin' = 'lhin.num', 'agegroup')) %>% 
  filter(!is.na(lhin)) %>% 
  select(year, siteid, lhin, lhin.days.tot = adj.lhin.days.tot, madd, agegroup, patients, hosp.avg.los, hosp.alc.days) %>% 
  group_by(year, lhin) %>% 
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV', 0),
         hosp.days.tot = sum(as.numeric(hosp.alc.days)),
         hosp.missing.days = lhin.days.tot - hosp.days.tot,
         lhin.missing.patients = ifelse(hosp.alc.days == 0, patients, 0),
         hosp.residual.avg = ifelse(is.finite(hosp.missing.days/lhin.missing.patients), hosp.missing.days/lhin.missing.patients, 0)) %>%
  group_by(year, siteid) %>% 
  mutate(remaining.days = hosp.residual.avg * patients,
         adj.hosp.days.tot = ifelse(hosp.avg.los == 'LV', remaining.days, as.numeric(hosp.alc.days))) %>% 
  select(year, lhin, siteid, agegroup, patients, adj.hosp.days.tot)

#ALC estimations w/ disaggregated age-groups
ALC_hosp_vol_disag <- ALC_madd_raw %>% 
  filter(madd == 'LTC', number > 999, agegroup != 9, year == 2016) %>% 
  rename(hosp.alc.days = alcdays,
         hosp.avg.los = avg.los) %>% 
  left_join(select(ALC_hosp_vol, year, lhin, siteid, hosp.days.tot.agg = adj.hosp.days.tot), by = c('year', 'siteid')) %>%
  filter(!is.na(lhin)) %>%
  group_by(year, siteid) %>% 
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0),
         hosp.days.tot = sum(as.numeric(hosp.alc.days)),
         hosp.missing.days = hosp.days.tot.agg - hosp.days.tot,
         hosp.missing.patients = ifelse(hosp.alc.days == 0, patients, 0),
         hosp.residual.avg = ifelse(is.finite(hosp.missing.days/sum(hosp.missing.patients)), hosp.missing.days/sum(hosp.missing.patients), 0)) %>% 
  group_by(year, siteid, agegroup) %>% 
  mutate(remaining.days = hosp.residual.avg * patients,
         adj.hosp.days.tot = ifelse(hosp.avg.los == 'LV', remaining.days, as.numeric(hosp.alc.days))) %>%
  select(year, lhin, siteid, agegroup, patients, adj.hosp.days.tot) %>% 
  mutate(agecluster = ifelse(agegroup == 1, 'ped', 
                             ifelse(agegroup %in% 2:4, 'ad',
                                    ifelse(agegroup %in% 5:6, 'sr'))))

saveRDS(ALC_hosp_vol_disag, file = 'cache/moh/ALC_hospitals_disaggregated.rds')
  
#ALC estimation methodology comparison at the provincial-level
ALC_summary <- ALC_hosp_vol_disag %>% 
  group_by(year) %>% 
  summarise(hosp.days.tot.dis = sum(adj.hosp.days.tot)) %>% 
  left_join(select(ALC_hosp_vol, year, siteid, adj.hosp.days.tot), by = 'year') %>%
  group_by(year) %>% 
  mutate(hosp.days.tot.agg = sum(adj.hosp.days.tot)) %>%
  distinct(year, hosp.days.tot.dis, hosp.days.tot.agg) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot), by = 'year') %>% 
  group_by(year) %>% 
  mutate(lhin.days.tot = sum(adj.lhin.days.tot)) %>% 
  distinct(year, hosp.days.tot.dis, hosp.days.tot.agg, lhin.days.tot) %>%
  left_join(select(ALC_madd_prov_total, year, prov.days.tot), by = 'year')
#totals for 2017 are far lower than the provincial because of the missing LHIN data

```

### Base-Year Calculations
```{r}
#ALC VOLUMES FOR INDIVIDUAL HOSPITALS BY AGE CLUSTER
ALC_hosp_vol <- ALC_hosp_vol_disag %>% 
  left_join(ALC_idcrosswalk_link, by = c('siteid' = 'ALCsite_id')) %>%
  filter(!is.na(csduid)) %>% 
  group_by(year, csduid, csdname,siteid, name, agecluster) %>% 
  summarise(hosp.alc.patients = sum(patients),
            hosp.alc.days = sum(adj.hosp.days.tot),
            avg.los = hosp.alc.days / hosp.alc.patients) %>%
  group_by(year, csduid) %>% 
  mutate(hosp.alc.mrkt = hosp.alc.days / sum(hosp.alc.days)) %>% 
  ungroup()

#CALCULATE ALC DEMAND AT THE CSD LEVEL COMPRISING OF THE SUM OF ALC BEDS/BEDDAYS FOR EACH AGECLUSTER; JOINING LTC CAPACITY DATA FROM LTC-HOMES DATASET
ALC_csd_vol <- ALC_hosp_vol %>%
  group_by(year, csduid, csdname, agecluster) %>% 
  summarise_at(vars(hosp.alc.patients:hosp.alc.days), sum) %>% 
  ungroup() %>% 
  mutate(csdname = toupper(csdname)) %>% 
  left_join(ltc_homes_csd, by = c('csduid', 'csdname')) %>% 
  mutate(csd.ltc.patients = replace_na(csd.ltc.beds, 0),
         ltc.bed.days = replace_na(ltc.bed.days, 0),
         csd.demand.days = ltc.bed.days + hosp.alc.days,
         csd.demand.patients = csd.ltc.beds + hosp.alc.patients)

#ADD TRESO-LEVEL DISAGGREGATIONS BY FIRST JOINING IN CORRESPONDING CSD-TRESO LIST AND THEN TAKING THE PROPORTION OF TRESO POPULATION TO TOTAL CSD POPULATION
ALC_treso <- ALC_csd_vol %>% 
  left_join(select(treso_population_long, treso_zone, csduid, age_cluster, treso.population.agecluster, year), by = c('year','csduid', 'agecluster' = 'age_cluster')) %>%
  distinct() %>% 
  group_by(year, csduid, agecluster) %>%
  select(-hosp.alc.patients, -hosp.alc.days) %>% 
  mutate(csd.pop = sum(treso.population.agecluster),
         treso.csd.pop.perc = treso.population.agecluster / csd.pop,
         treso.csd.dem.patients = csd.demand.patients * treso.csd.pop.perc,
         treso.csd.dem.days = csd.demand.days * treso.csd.pop.perc)  #SHOULD ADD WEIGHT TO SR POPULATION BASED ON A CALCULATED PARAMETER SUCH AS SR/AD POPULATION OR SR/AD CASES
  
pop.65plus  <-  treso_population_long %>% 
  select(year, treso_zone, age_cluster, pop.65plus = treso.population.agecluster) %>% 
  filter(year == 2016, age_cluster == 'sr') %>% 
  distinct()

#ALC rates can be calculated and joined in during forecasting operations as a rate or as a parameter
ALC_rates <- ALC_treso %>% 
  left_join(pop.65plus, by = c('year', 'treso_zone')) %>% 
  select(-age_cluster) %>% 
  group_by(year, treso_zone, agecluster) %>% 
  mutate(treso.alc.rate = treso.csd.dem.patients / pop.65plus) %>% 
  group_by(year, csduid, agecluster) %>% 
  mutate(csd.alc.rate = csd.demand.patients / sum(pop.65plus)) %>% 
  ungroup() %>% 
  select(csduid, csdname, agecluster, treso_zone, treso.alc.rate, csd.alc.rate)
```

###Forecasting-Year Calculation
```{r}
#RECALL PROJ_YEAR AND OP_DAYS FROM ABOVE
PROJ_YEAR_ALC <- PROJ_YEAR
PROJ_ALC_RATE <- .103 #RATE CAN BE EXTRACTED FROM ALC_RATE ABOVE OR MANUALLY INPUT BY USER

#LTC CAPACITY PARAMETERS
CSDUID_ADDED_CAP = 3510101 #THIS INPUT IS FOR THE CSDUID
ADDED_CAP = 0 #IN BEDS
LTC_OCC_RATE = 1
LTC_TURNOVER = .35

#LTC CAPACITY INCLUDES ADDITIONAL CAPACITY FOR CSD AS DEFINED BY USER
ltc_proj_homes <- ltc_homes_csd %>% 
  group_by(csduid, csdname) %>% 
  mutate(csd.added.beds = ifelse(csduid %in% CSDUID_ADDED_CAP, csd.ltc.patients + ADDED_CAP, 0),
         total.ltc.patients = csd.ltc.beds + csd.added.beds,
         ltc.bed.days = total.ltc.patients * LTC_OCC_RATE * OP_DAYS) %>% 
  ungroup() %>% 
  mutate(csdname = toupper(csdname))

#ALC IS CALCULATED AS A RATE OF GROWTH RELATIVE TO THE 65+ POPULATION; FUTURE ADDITIONS COULD ALLOW WEIGHTED SCALING BY AGEGROUP OR INTEGRATE THE ALC-RATES CALCULATED ABOVE
ALC_proj_csd <- treso_population_moh %>%
  filter(age_cluster == 'sr') %>% 
  group_by(treso_zone, csduid) %>% 
  summarise_at(vars(paste0("population.", PROJ_YEAR_ALC)), sum) %>% 
  mutate(ltc.treso.demand.patients = PROJ_ALC_RATE * get(paste0("population.", PROJ_YEAR_ALC))) %>% 
  group_by(csduid) %>% 
  mutate(ltc.csd.demand.patients = sum(ltc.treso.demand.patients) * (1 - LTC_TURNOVER)) %>% #DIFFERENTIATION BY AGE-CLUSTER WAS HINDERING UNIFYING THE TOTAL NUMBER OF LTC BEDS
  left_join(select(ltc_homes_csd, csduid, csd.ltc.beds, ltc.bed.days), by = 'csduid') %>% 
  mutate(csd.ltc.beds = replace_na(csd.ltc.beds, 0), #REPLACE CSD'S W/ ZERO LTC CAPACITY
         ltc.bed.days = replace_na(ltc.bed.days, 0),
         csd.residual.alc.patients = ifelse(ltc.csd.demand.patients - csd.ltc.beds > 0, ltc.csd.demand.patients - csd.ltc.beds, 0)) %>% 
  select(csduid, ltc.csd.demand.patients:csd.residual.alc.patients) %>% 
  distinct()

#ALC PROJECTION TO HOPSITALS FROM CSD TOTALS USING MARKETSHARE
ALC_proj_hosp <- ALC_hosp_vol %>%
  mutate(year = PROJ_YEAR_ALC) %>% 
  select(-agecluster, -hosp.alc.patients, -hosp.alc.days, avg.los) %>% 
  left_join(select(ALC_proj_csd, csduid, csd.residual.alc.patients), by = c('csduid')) %>% 
  group_by(siteid) %>% 
  mutate(proj.alc.patients = csd.residual.alc.patients * hosp.alc.mrkt,
         proj.alc.beddays = proj.alc.patients * avg.los)
  

```

















---
title: "Hospitals"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
source('helpers.r')
```

## Import Input Data
  - HBAM caretypes have been grouped to match asset inventory datasets (care types "AM")
  
```{r, include= FALSE, results='hide'}
#Defining hospital parameters for care-types and age bands
caretypes = c("at", "cr", "gr", "mh", "am")
agecluster = c('ad', 'ped', 'sr')
agegroup_ref <- tibble(agecluster = c('ad', 'ad', 'ad', 'ped', 'sr', 'sr'),
                          agegroup = as.character(c(2, 3, 4, 1, 5, 6))) %>% 
  arrange(agegroup)

#CIHI Bed Data
CIHIhospitalbeds <- read_csv('input/moh/cap.CIHI_Hospital_Beds.csv')

#Daily Bed Census bed counts
num_beds_siteid <- readRDS('cache/moh/num_beds.rds')

# Historical HBAM Master (w/ Asset data)
HBAMhistorical_master <- readRDS('cache/moh/HBAMhistorical_master.rds')

# Projected HBAM Master (w/ Asset data)
HBAMprojected_master <- readRDS('cache/moh/HBAMprojected_master.rds')

#Hospital Asset Data
hospitallocations <- readRDS('cache/moh/hospitallocations.rds')

#Speciality Hospital Identifier
speciality_hospitals <- read.csv("input/moh/specialty_hospital_list.csv")

#TRESO Population data and Spatial Data
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")

treso_population_moh <- readRDS('input/moh/treso_population_moh.rds')

treso_zone_system <- read_csv('input/treso/treso_zone_system.csv')

treso_centroids <- read_csv('input/treso/treso_centroids.csv')

travel_time_skim <- readRDS("output/treso/treso_travel_time.rds")

ALC_idcrosswalk <- readRDS('cache/moh/ALC_crosswalk.rds')
  # drop_na(pcode) #Drop NA pcodes from Hospital Locations dataset, to be changed when dataset is updated

#ALC Siteids have multiple hospital IDs associated w/ them referring to different case-types and names in some instances; distinct codes are extracted for SiteID-LHIN connection
ALC_idcrosswalk_slim <- ALC_idcrosswalk %>% 
  group_by(ALCsite_id) %>% 
  distinct(lhin, ALCsite_id)

#Importing LTC data
ltc_homes <- readRDS('cache/moh/ltc_homes.rds')
ltc_turnover_raw <- read_csv('input/moh/longtermcare_beds_turnover.csv')

# Read in user-set forecast year
scenario.year <- 2025 # TODO: Replace with user-defined input from visualization tool

# Read in user-set factor for how many people will stay in their CSD vs. leave the CSD on a per-bed basis if a new hospital is built in a CSD which previously had no hospitals
STAY_IN_CSD_FACTOR <- 1000

# Read in user-set target utilization factor by subsector
utilization_targets <- tibble(caretype = c('AT', 'MH', 'CR', 'GR', 'AM'), target = c(0.94, 0.92, 0.96, 0.95, 0.9))

# Read in user-set threshold re: minimum number of beds for when to build a new hospital in a CSD with no existing hospital
min_beds <- 30

# New hospital minimum applies to each caretype individually or all caretypes cumulatively? I.e., if minimum new hospital threshold is 25 beds, and if a CSD needs 15 AT beds, 5 MH beds, and 10 GR beds (therefore sum of 30 beds), should the hospital be built because there is demand for 30 beds? Or hospital should not be built because no individual caretype exceeds minimum of 25 beds required?
min_beds_toggle <- 1 # 1 = Cumulatively, 0 = Individually

# Read in user-set number of one-way trips per hospital case
trips_per_case <- 1

# Total demand days in 2016 = 6,919,802; total beds in 2017 (assumed same for 2016) = 33,198; 33,198 beds * 365 days/year = 12,117,270 bed-days of capacity per year. However, if we assume hospitals were 96% full in 2016, the proper annualization factor for available days per bed = (6,919,802 / 0.96) / 12,117,270 * 365 = 217 days of capacity per hospital bed per year.
hosp.op.days <- 365 # Assume each hospital bed can be used for this many days per year

USER_SELECT <- "CRM" # TODO: Replace with value from user from visualization tool

CARETYPE_LIST = c('AT', 'AM', 'GR', 'CR', 'MH') # TODO: Replace with value from user from visualization tool

AGE_CLUSTER_LIST = c('ad', 'ped', 'sr') # TODO: Replace with value from user from visualization tool

decision_making <- TRUE # TODO: Replace with value from user from visualization tool

ltc.op.days = 365 # Set operating days at LTC facilities; set based on observed ALC in 2016 vs. theoretical 

# Number of beds added by CSD
new_ltc_cap_csd <- tibble(csduid = c(3506008, 3519049), added.ltc.cap = c(5000, 7000)) # TODO: Replace with user-defined input from visualization tool

# Read in cost function parameters from model user: cost per bed plus a base startup cost applied to all hospitals regardless of size
user_input_cost_per_bed <- 1000000 # TODO: Replace this hard-coded value with user-input value from visualization
user_input_base_hosp_cost <- 50000000 # TODO: Replace this hard-coded value with user-input value from visualization

```

## Link Hospital Site IDs to TRESO Zones
  - Convert hospital asset data to SpatialPointDataFrame
  - Convert lat/long to TRESO LCC specification
  - Match hospital to corresponding TRESO zone
  - Identify and quantify unmatched TRESO zones/Site IDs, if any
  
```{r, include=FALSE}
# Convert treso population to long format
treso_population_moh_agecluster <- treso_population_moh %>% 
  left_join(agegroup_ref, by = c('age.group' = 'agegroup')) %>% 
  # Use 2017 population for CSD/agecluster combinations with cases observed in 2016 but with population = 0 in 2016 treso data
  mutate(population.2016 = ifelse(population.2016 == 0, population.2017, population.2016))

treso_population_long <- gather(treso_population_moh_agecluster, 'year', 'population', population.2041:population.2040, -age.group, -agecluster) %>% 
  separate(year, into = c('pop', 'year'), sep = "n.") %>% 
  mutate(year = as.numeric(year)) %>%
  select(-pop) %>% 
  group_by(year, treso_zone, agecluster) %>% 
  mutate(treso.population.agecluster = sum(population))

# Convert the hospital dataframe into SpatialPointsDataframe (SPDF)
hospital_spdf <- hospitallocations %>%
  ungroup() %>%
  select(name,
         id,
         pcode,
         lat,
         long) %>%
  distinct()

coordinates(hospital_spdf) <- c('long', 'lat')
  
# Project the hospital points from lat/long to TRESO's LCC specification
proj4string(hospital_spdf) <- CRS('+proj=longlat +datum=WGS84')

treso_projarg = treso_shp@proj4string@projargs
  
hospital_xy <- spTransform(hospital_spdf, CRS(treso_projarg))

hospital_overlay <- over(hospital_xy, treso_shp, returnList = FALSE) %>%
      cbind(pcode = hospital_xy@data$pcode,
            hosp_name = hospital_xy@data$name,
            id = hospital_xy@data$id) %>%
      as_tibble() %>%
      select(Treso_ID,
             pcode, 
             hosp_name, 
             id) %>% 
      rename(treso_zone = Treso_ID) %>% 
      left_join(treso_zone_system, by = c('treso_zone' = 'treso_id'))

saveRDS(hospital_overlay, file = 'cache/moh/hospital_overlay.rds')

rm(hospital_xy, hospital_spdf)

#Update Master HBAM list to Include TRESO Zones and corresponding CSD
HBAMhistorical_master_tz <- left_join(HBAMhistorical_master, 
                                      select(hospital_overlay, treso_zone, id, hosp_csduid = csduid, csdname, cdname), 
                                      by = c('id')) %>% 
  left_join(agegroup_ref, by = 'agegroup') %>% 
  # Duplicate rows appearing in HBAM - take max by group to limit to deduplicate
  group_by(year, id, caretype, agegroup, orig_csd) %>% 
  mutate(maxCases = max(cases)) %>% 
  select(-cases) %>% 
  distinct() %>% 
  rename(cases = maxCases) %>% 
  ungroup()

HBAMprojected_master_tz <- left_join(HBAMprojected_master, 
                                     select(hospital_overlay, treso_zone, id), 
                                     by = c('id')) %>%
  left_join(agegroup_ref, by = c('agegroup'))

# Cleaning hospital locations and adding CSD and TRESO zones
hospitallocations_tz <- hospitallocations %>% 
  left_join(select(hospital_overlay, treso_zone, csduid, csdname, mof_region, id), by = c('id')) %>% 
  distinct(id, name, lhin, treso_zone, csduid, csdname, mof_region, pcode, lat, long, address, city)

saveRDS(HBAMprojected_master_tz, "output/moh/HBAMprojected_master_tz.rds")

rm(HBAMhistorical_master, HBAMprojected_master)

```

## Consolidated Hospital Lookup
  - Reorganize HBAM historical to show unique hospital locations w/ metadata needed for visualization tool
  - Create in wide format w/ sub-naming for care-type and age-cluster 

```{r}
hospital_lookup <- HBAMhistorical_master_tz %>%
  filter(id != -9999) %>%
  group_by(year, id, agecluster, caretype) %>% 
  summarise(cases = sum(cases)) %>% 
  mutate(cases.at.ad = ifelse(caretype %in% 'AT' & agecluster %in% 'ad', cases, 0),
         cases.at.ped = ifelse(caretype %in% 'AT' & agecluster %in% 'ped', cases, 0),
         cases.at.sr = ifelse(caretype %in% 'AT' & agecluster %in% 'sr', cases, 0),
         cases.cr.ad = ifelse(caretype %in% 'CR' & agecluster %in% 'ad', cases, 0),
         cases.cr.ped = ifelse(caretype %in% 'CR' & agecluster %in% 'ped', cases, 0),
         cases.cr.sr = ifelse(caretype %in% 'CR' & agecluster %in% 'sr', cases, 0),
         cases.gr.ad = ifelse(caretype %in% 'GR' & agecluster %in% 'ad', cases, 0),
         cases.gr.ped = ifelse(caretype %in% 'GR' & agecluster %in% 'ped', cases, 0),
         cases.gr.sr = ifelse(caretype %in% 'GR' & agecluster %in% 'sr', cases, 0),
         cases.mh.ad = ifelse(caretype %in% 'MH' & agecluster %in% 'ad', cases, 0),
         cases.mh.ped = ifelse(caretype %in% 'MH' & agecluster %in% 'ped', cases, 0),
         cases.mh.sr = ifelse(caretype %in% 'MH' & agecluster %in% 'sr', cases, 0),
         cases.am.ad = ifelse(caretype %in% 'AM' & agecluster %in% 'ad', cases, 0),
         cases.am.ped = ifelse(caretype %in% 'AM' & agecluster %in% 'ped', cases, 0),
         cases.am.sr = ifelse(caretype %in% 'AM' & agecluster %in% 'sr', cases, 0)) %>% 
  group_by(year, id) %>% 
  summarise_at(vars(cases.at.ad:cases.am.sr), sum) %>%
  left_join(hospitallocations_tz, by = c('id')) %>% 
  ungroup()

# Import bed summaries from Daily Bed Census (DBC); this can be imported above

# Cleaning up number of beds
num_beds <- num_beds_siteid %>% 
  left_join(select(hospitallocations, datasetID1.siteid, id), by = c('siteid' = 'datasetID1.siteid')) %>% 
  left_join(select(hospitallocations, datasetID2.siteid, id), by = c('siteid' = 'datasetID2.siteid')) %>% 
  left_join(select(hospitallocations, datasetID3.siteid, id), by = c('siteid' = 'datasetID3.siteid')) %>% 
  left_join(select(hospitallocations, datasetID4.siteid, id), by = c('siteid' = 'datasetID4.siteid')) %>% 
  left_join(select(hospitallocations, datasetID5.siteid, id), by = c('siteid' = 'datasetID5.siteid')) %>% 
  left_join(select(hospitallocations, datasetID6.siteid, id), by = c('siteid' = 'datasetID6.siteid')) %>% 
  ungroup() %>% 
  mutate(id = pmax(replace_na(id.x, 0), replace_na(id.x.x, 0), replace_na(id.x.x.x,0), replace_na(id.y, 0), replace_na(id.y.y, 0), replace_na(id.y.y.y, 0))) %>% 
  select(-id.x, -id.x.x, -id.x.x.x, -id.y, -id.y.y, -id.y.y.y) %>% 
  group_by(year, id, type) %>% 
  # Make sure there are not duplicate siteids being using for a given id
  mutate(staffedbeds = sum(staffedbeds)) %>%
  distinct(year, id, type, staffedbeds) %>%
  rename(caretype = type) %>% 
  mutate(count = n()) %>%
  ungroup() %>% 
  # Calculate the sum of beds by hospital by year
  group_by(year, id) %>% 
  mutate(total.hosp.beds = sum(staffedbeds)) %>% 
  ungroup()

# Assessing the daily bed count from 
dbc_beds <- num_beds %>% 
  select(-count, -year) %>% 
  spread(key = caretype, value = staffedbeds) %>% 
  rename(at.beds.2017 = AT,
         cr.beds.2017 = CR,
         gr.beds.2017 = GR,
         mh.beds.2017 = MH) %>% 
  mutate(at.beds.2017 = replace_na(at.beds.2017, 0),
         cr.beds.2017 = replace_na(cr.beds.2017, 0),
         gr.beds.2017 = replace_na(gr.beds.2017, 0),
         mh.beds.2017 = replace_na(mh.beds.2017, 0)) %>% 
  mutate(dbc.total.beds.2017 = sum(c(at.beds.2017, cr.beds.2017, gr.beds.2017, mh.beds.2017)))

#Final Master List only including DBC because of incomplete CIHI Data
hospital_lookup_master <- hospital_lookup %>% 
  left_join(dbc_beds, by = 'id') %>% 
  filter(id != -9999)
  #select(id, year, name, pcode, lhin:city, cases_at_ad:dbc_total_beds_2018)

saveRDS(hospital_lookup_master, file = 'output/moh/hospital_lookup_master.rds')

rm(hospital_lookup, dbc_beds)
```

## ALC
- Summarize existing (historical) ALC demand for LTC: actual ALC + LTC demand (assumed to equal LTC capacity)
- Calculate average demand for LTC based on population size (i.e., rate of ALC days per person)
- Use forecasted ALC rates to apply to future population in a given scenario year
- Allow the user to 'build' additional LTC beds and test the impact on ALC
- Distribute forecasted ALC days to CSDs and CDs
- ALC forecasts to later be joined to CRM forecast for hospital demand

### ALC Crosswalk
```{r}
# SUMMARIZE BED INFO BY CSD
# This assumes that LTC facilities are full, ie., all beds are taken, i.e., capacity (patients) = demand
ltc_homes_csd <- ltc_homes %>% 
  group_by(csduid, csdname) %>% 
  summarise(csd.ltc.patients = sum(beds)) %>% 
  mutate(ltc.bed.days.cap = csd.ltc.patients * ltc.op.days,
         csdname = toupper(csdname)) %>% 
  ungroup()

saveRDS(ltc_homes_csd, file = 'cache/moh/ltc_homes_csd.rds')

hospital_lookup_master <- readRDS('output/moh/hospital_lookup_master.rds')

# LINK ALC SITES WITH MASTER LIST AND CSD DATA
hospital_lookup_ALC <- hospital_lookup_master %>% 
  ungroup() %>% 
  select(id, pcode, csduid, csdname, name) %>% 
  distinct() %>% 
  right_join(select(ALC_idcrosswalk, id, ALCsite_id, name), by = 'id') %>% 
  distinct()

```

### Estimating Suppression: Aggregate Level
```{r}
#ALC raw data includes agegroup == 9 which is the totalling flag
#ALC data for 2017 only includes LHINs 1-3 and 10-14; ALC data for 2012 also partial
# MADD = most appropriate discharge destination
ALC_madd_raw <- readRDS('cache/moh/ALC_madd_raw.rds') %>% 
  filter(madd == 'LTC', year != 2011, year!= 2012, year != 2017)

ALC_madd_prov_total <- ALC_madd_raw %>% 
  filter(number == 15, agegroup == 9) %>% 
  rename('prov.days.tot' = 'alcdays',
         'prov.los.avg' = 'avg.los')

# This query is a double-check to make sure LHIN totals sum to provincial total
ALC_lhin_vol <-  ALC_madd_raw %>% 
  filter(agegroup == 9, number < 15) %>% 
  rename('lhin.num' = 'number',
         'lhin.days' = 'alcdays',
         'lhin.los.avg' = 'avg.los') %>% 
  left_join(select(ALC_madd_prov_total, year, prov.days.tot, prov.los.avg), by = 'year') %>% 
  group_by(year) %>% 
  mutate(lhin.days.tot = sum(as.numeric(lhin.days)),
         lhin.missing.days = as.numeric(prov.days.tot) - lhin.days.tot,
         lhin.residual.avg = lhin.missing.days/sum(patients)) %>% 
  group_by(year, lhin.num) %>% 
  mutate(remaining.days = lhin.residual.avg * patients,
         adj.lhin.days.tot = ifelse(lhin.days == 'LV' | lhin.days == 'NS', remaining.days, as.numeric(lhin.days))) %>% 
  select(year, lhin.num, agegroup, patients, adj.lhin.days.tot)

# This step cleans up most-appropriate discharge data for later use; filtered at an AGGREGATED level
# Accurate only for years 2012-2016 because 2011 and 2017 are missing LHIN data (see note above)
ALC_madd_clean_ag <- ALC_madd_raw %>% 
  filter(madd == 'LTC', number > 999, agegroup == 9) %>% 
  rename(hosp.alc.days = alcdays,
         hosp.avg.los = avg.los) %>% 
  left_join(select(ALC_idcrosswalk_slim, lhin, ALCsite_id), by = c('siteid' = 'ALCsite_id')) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot, agegroup), by = c('year', 'lhin' = 'lhin.num', 'agegroup')) %>% 
  filter(!is.na(lhin)) %>% 
  select(year, siteid, lhin, lhin.days.tot = adj.lhin.days.tot, madd, agegroup, patients, hosp.avg.los, hosp.alc.days)

# This step fills in missing patient days for hospitals where the number of days are suppressed based on low patient counts, but does so for all age groups combined (i.e., agegroup == 9)
ALC_hosp_vol_ag <- ALC_madd_clean_ag %>% 
  group_by(year, lhin) %>% 
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0),
         hosp.days.tot = sum(as.numeric(hosp.alc.days)),
         lhinhosp.missing.days = lhin.days.tot - hosp.days.tot,
         hosp.missing.patients = ifelse(hosp.alc.days == 0, patients, 0),
         lhin.missing.patients = ifelse(hosp.alc.days == 0, sum(hosp.missing.patients), 0),
         hosp.residual.avg = ifelse(is.finite(lhinhosp.missing.days/lhin.missing.patients),  lhinhosp.missing.days/lhin.missing.patients, 0)) %>%
  group_by(year, siteid) %>% 
  mutate(remaining.days = hosp.residual.avg * patients,
         adj.hosp.days.tot = ifelse(hosp.avg.los == 'LV', remaining.days, as.numeric(hosp.alc.days))) %>% 
  # Find remaining missing hospital days - i.e., difference between sum of hospital values and LHIN totals which can't be assigned to hospitals with suppressed values (i.e., no hospitals in LHIN with suppressed values, yet days are missing)
  # These values are distributed across hospitals within the LHIN proportionally based on share of days within the LHIN
  group_by(year, lhin) %>% 
  mutate(adj.lhinhosp.days.tot = sum(adj.hosp.days.tot)) %>% 
  mutate(adj.hosp.days.tot = (adj.hosp.days.tot / adj.lhinhosp.days.tot) * lhin.days.tot) %>% 
  select(year, lhin, siteid, agegroup, patients, adj.hosp.days.tot) %>% 
  ungroup()

```

### Calculating LHIN/Provincial Agegroup Averages
```{r}
# This step cleans up most-appropriate discharge data for later use; filtered at a DISAGGREGATED level
ALC_madd_clean_disag <- ALC_madd_raw %>% 
  # Filter for LTC; 4-digit hospital siteids; all age groups except 'total'; all years with complete data
  filter(madd == 'LTC', number > 999, agegroup != 9) %>% 
  rename(hosp.alc.days = alcdays,
         hosp.avg.los = avg.los) %>%
  left_join(select(ALC_idcrosswalk_slim, lhin, ALCsite_id), by = c('siteid' = 'ALCsite_id')) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot), by = c('year', 'lhin' = 'lhin.num')) %>% 
  filter(!is.na(lhin))

# Calculate number of ALC days per patient for different age groups, at the LHIN level, to fill in suppression gaps
alc_avg_ages.ex2 <- ALC_madd_clean_disag %>%
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0)) %>% 
  group_by(lhin, agegroup, year) %>% 
  mutate(lhin.agegroup.patients = sum(patients), lhin.agegroup.days = sum(as.numeric(hosp.alc.days))) %>% 
  mutate(lhin.agegroup.los = lhin.agegroup.days / lhin.agegroup.patients) %>% 
  ungroup() %>%
  distinct(year, lhin, agegroup, lhin.agegroup.patients, lhin.agegroup.days, lhin.agegroup.los)
  # No total days available for some agegroups (due to suppression resulting from low volumes at the LHIN level) - therefore use average at the provincial level --> see next step

# Determine average length of stay at the provincial level to fill in gaps where data suppressed at the LHIN level
alc_avg_agegroup2 <- ALC_madd_raw %>% 
  filter(number == 15) %>% 
  rename('lhin.num' = 'number',
         'lhin.days' = 'alcdays',
         'lhin.los.avg' = 'avg.los') %>%
  group_by(agegroup, year) %>% 
  mutate(prov.agegroup2.patients = sum(patients), prov.agegroup2.days = sum(as.numeric(lhin.days))) %>% 
  mutate(prov.agegroup2.los = prov.agegroup2.days / prov.agegroup2.patients) %>% 
  ungroup() %>% 
  distinct(year, agegroup, prov.agegroup2.patients, prov.agegroup2.days, prov.agegroup2.los)

# Combine length of stay estimates for agegroups
alc_avg_ages <- alc_avg_ages.ex2 %>% 
  left_join(alc_avg_agegroup2, by = c('agegroup', 'year')) %>% 
  mutate(agegroup.los = ifelse(lhin.agegroup.los == 0, prov.agegroup2.los, lhin.agegroup.los)) %>% 
  select(-prov.agegroup2.patients, -prov.agegroup2.days)

rm(alc_avg_agegroup2, alc_avg_ages.ex2)

```

### Estimating Suppression: Disaggregate Level (Age Groups)
```{r}
# ALC estimations w/ disaggregated age-groups
ALC_hosp_vol_disag <- ALC_madd_clean_disag %>%
  left_join(select(ALC_hosp_vol_ag, year, siteid, hosp.days.tot.agg = adj.hosp.days.tot), by = c('year', 'siteid')) %>%
  left_join(select(alc_avg_ages, year, lhin, agegroup, agegroup.los), by = c('year', 'lhin', 'agegroup')) %>% 
  filter(!is.na(lhin)) %>%
  group_by(year, siteid) %>% 
  mutate(hosp.alc.days = replace(hosp.alc.days, hosp.alc.days == 'LV' | hosp.alc.days == 'NS', 0),
         hosp.days.tot = sum(as.numeric(hosp.alc.days)),
         hosp.missing.days = round(hosp.days.tot.agg - hosp.days.tot, 0),
         hosp.missing.patients = ifelse(hosp.alc.days == 0, patients, 0)) %>% 
         #hosp.residual.avg = ifelse(is.finite(hosp.missing.days/sum(hosp.missing.patients)), hosp.missing.days/sum(hosp.missing.patients), 0)) %>%
  # This assumes patients of all agegroups have equal length-of-stay; introduce weighting factor to account for differing lengths of stay, and scale back to known missing number of ALC days
  mutate(unscaled.missing.days = round(hosp.missing.patients * agegroup.los, 0)) %>% 
  mutate(sum.unscaled = sum(unscaled.missing.days)) %>% 
  mutate(scaled.missing.days = ifelse(sum.unscaled == 0, 0, unscaled.missing.days / sum.unscaled * hosp.missing.days)) %>%
  group_by(year, siteid, agegroup) %>% 
  mutate(adj.hosp.days.tot = ifelse(hosp.avg.los == 'LV', scaled.missing.days, as.numeric(hosp.alc.days))) %>%
  select(year, lhin, siteid, agegroup, patients, adj.hosp.days.tot) %>% 
  mutate(agecluster = ifelse(agegroup == 1, 'ped', 
                             ifelse(agegroup %in% 2:4, 'ad',
                                    ifelse(agegroup %in% 5:6, 'sr')))) %>% 
  ungroup()
  # This code checks for number of hospitals when incorporated into ALC_hosp_vol - can be removed if ALC values sum correctly
  # group_by(siteid) %>%
  # filter(year == 2016) %>%
  # mutate(siteCount = n())

saveRDS(ALC_hosp_vol_disag, file = 'cache/moh/ALC_hospitals_disaggregated.rds')
  
# ALC estimation methodology comparison at the provincial-level
# This query is a double-check to make sure calculations valid --> not used for production tables below
ALC_summary <- ALC_hosp_vol_disag %>% 
  group_by(year) %>% 
  summarise(hosp.days.tot.dis = sum(adj.hosp.days.tot)) %>% 
  left_join(select(ALC_hosp_vol_ag, year, siteid, adj.hosp.days.tot), by = 'year') %>%
  group_by(year) %>% 
  mutate(hosp.days.tot.agg = sum(adj.hosp.days.tot)) %>%
  distinct(year, hosp.days.tot.dis, hosp.days.tot.agg) %>% 
  left_join(select(ALC_lhin_vol, year, lhin.num, adj.lhin.days.tot), by = 'year') %>% 
  group_by(year) %>% 
  mutate(lhin.days.tot = sum(adj.lhin.days.tot)) %>% 
  distinct(year, hosp.days.tot.dis, hosp.days.tot.agg, lhin.days.tot) %>%
  left_join(select(ALC_madd_prov_total, year, prov.days.tot), by = 'year')
```


### Base-Year (2016)
```{r}
# Calculate ALC days by hospital by caretype for 2016; this will be used in average length of stay calculations to distribute ALC based on caretype
ALC_hosp_vol <- ALC_hosp_vol_disag %>% 
  left_join(hospital_lookup_ALC, by = c('siteid' = 'ALCsite_id')) %>%
  filter(!is.na(csduid)) %>% # Double-check in case any ALC sites don't match to Hospital PAI or master list
  group_by(year, id, agecluster) %>% 
  mutate(hosp.alc.patients = sum(patients),
            hosp.alc.days = sum(adj.hosp.days.tot),
            avg.los = hosp.alc.days / hosp.alc.patients) %>%
  group_by(year, csduid) %>% 
  mutate(hosp.alc.mrkt = hosp.alc.days / sum(hosp.alc.days)) %>% #MARKET-SHARE OF HOSPITAL ALC DAYS TO CSD TOTAL DAYS
  ungroup() %>% 
  distinct(year, id, name = name.x, csduid, csdname, agecluster, hosp.alc.patients, hosp.alc.days, avg.los, hosp.alc.mrkt)

saveRDS(ALC_hosp_vol, file = 'cache/moh/ALC_hospital_volumes.rds')

# Calculate the percentage of ALC days used by agecluster == adult vs. agecluster == senior; JOINING LTC CAPACITY DATA FROM LTC-HOMES DATASET
ALC_csd_vol_join <- ALC_hosp_vol %>%
  group_by(year, csduid, agecluster, csdname) %>% 
  summarise_at(vars(hosp.alc.patients:hosp.alc.days), sum) %>%
  rename(csd.alc.patients = hosp.alc.patients,
         csd.alc.days = hosp.alc.days) %>%
  group_by(year, csduid) %>% 
  mutate(csd.alc.days.sum.ages = sum(csd.alc.days), csd.alc.patients.sum.ages = sum(csd.alc.patients)) %>% 
  mutate(csd.alc.days.percent.ages = csd.alc.days / csd.alc.days.sum.ages, csd.alc.patients.percent.ages = csd.alc.patients / csd.alc.patients.sum.ages) %>% 
  mutate(csdname = toupper(csdname)) %>% 
  # Full join to ltc_homes_csd since there may be CSDs with hospitals but no LTC facilities, and vice versa
  full_join(ltc_homes_csd, by = c('csduid')) %>%
  # Split existing LTC patients along hospital observed proportions in terms of ageclusters, then sum total by CSD
  mutate(csd.ltc.patients = replace_na(csd.ltc.patients, 0),
         ltc.bed.days.cap = replace_na(ltc.bed.days.cap, 0),
         csd.alc.days = replace_na(csd.alc.days, 0), # Replace NA values for CSDs w/ LTC facilities but no hospital ALC days
         csd.alc.patients = replace_na(csd.alc.patients, 0), # Replace NAs for CSDs w/ LTC but no hospital ALC patients
         csd.alc.days.percent.ages = replace_na(csd.alc.days.percent.ages, 0), # Replace NA values for CSDs w/ no hospital ALC
         csd.alc.patients.percent.ages = replace_na(csd.alc.patients.percent.ages, 0)) %>% # Replace NAs for CSDs w/ no hosp. ALC
  ungroup() %>% 
  filter(is.na(csduid) == FALSE) %>%
  mutate(csdname = ifelse(is.na(csdname.x), csdname.y, csdname.x)) %>% 
  select(-csdname.x, -csdname.y)

# Calculate average % breakdown for agecluster = senior vs. agecluster = adult for CSDs where there ARE hospitals with ALC patients
ALC_LTC_age_breakdown <- ALC_csd_vol_join %>%
  filter(is.na(agecluster) == FALSE) %>% 
  group_by(year, agecluster) %>%  
  mutate(sum.alc.days = sum(csd.alc.days), sum.alc.patients = sum(csd.alc.patients)) %>% 
  group_by(year) %>% 
  mutate(prov.alc.days.percent = sum.alc.days / sum(csd.alc.days), 
         prov.alc.patients.percent = sum.alc.patients / sum(csd.alc.patients)) %>% 
  select(year, agecluster, prov.alc.days.percent, prov.alc.patients.percent) %>% 
  distinct()

  # CSDs with LTC capacity but not hospital ALC capacity do not have an inherent split into age clusters; simulate this split by creating a dataframe with CSDs, LTC capacity, and ageclusters for use in next query
ALC_LTC_csd_ageclusters <- ALC_csd_vol_join %>% 
  filter(is.na(agecluster))

agelist <- c('ad', 'sr')
yearlist <- c(2013, 2014, 2015, 2016) # List of historical years during which LTC beds in CSDs with no hospital ALC 

ALC_LTC_csd_age_cross <- crossing(ALC_LTC_csd_ageclusters, agelist, yearlist) %>% 
  select(csduid, agecluster = agelist, year = yearlist)
  
  # Clean up ALC_csd_vol_join and calculate ALC demand at the CSD level by summing ALC beds/bed-days plus LTC beds/bed-days for each age cluster
ALC_csd_vol <- ALC_csd_vol_join %>% 
  left_join(ALC_LTC_csd_age_cross, by = c('csduid')) %>% 
  mutate(agecluster.x = ifelse(is.na(agecluster.x), agecluster.y, agecluster.x)) %>%
  rename(agecluster = agecluster.x) %>% 
  select(-agecluster.y) %>% 
  mutate(year.x = ifelse(is.na(year.x), year.y, year.x)) %>%
  rename(year = year.x) %>% 
  select(-year.y) %>% 
  # Join in average % breakdown for agecluster = senior vs. agecluster = adult for use in CSDs where there are no hospitals with ALC patients and therefore cannot calculate a CSD-specific breakdown
  left_join(ALC_LTC_age_breakdown, by = c('year', 'agecluster')) %>% 
  # Calculate total ALC demand (ALC days observed plus LTC days)
  group_by(year, csduid) %>% 
  mutate(csd.alc.days.percent.ages = ifelse(csd.alc.days.percent.ages > 0, csd.alc.days.percent.ages, prov.alc.days.percent),
         csd.alc.patients.percent.ages = ifelse(csd.alc.patients.percent.ages > 0, csd.alc.patients.percent.ages, prov.alc.patients.percent)) %>% 
  mutate(csd.demand.days.ages = round(ltc.bed.days.cap * csd.alc.days.percent.ages + csd.alc.days, 0),
         csd.demand.patients.ages = round(csd.ltc.patients * csd.alc.patients.percent.ages + csd.alc.patients, 0),
         csd.demand.days.total = sum(csd.demand.days.ages),
         csd.demand.patients.total = sum(csd.demand.patients.ages)) %>% 
  ungroup() 

# CSD/CD rates not particularly meaningful given the huge variation from one CSD/CD to the next; use provincial average values, disaggregated by agecluster, for ALC rates per population.
ALC_csd_rates <- treso_population_long %>%
  filter(agecluster != 'ped', year > 2012, year < 2017) %>% 
  mutate(cduid = substr(csduid, 1, 4)) %>% 
  group_by(year, cduid, csduid, agecluster) %>% 
  summarise(csd.population.ages = sum(population)) %>% 
  left_join(select(ALC_csd_vol, year, csduid, agecluster, csd.demand.patients.ages, csd.demand.days.ages), by = c('year', "csduid", 'agecluster')) %>% 
  mutate(csd.demand.patients.ages = replace_na(csd.demand.patients.ages, 0),
         csd.demand.days.ages = replace_na(csd.demand.days.ages, 0),
         csd.alc.rate.ages = csd.demand.days.ages / csd.population.ages) %>% 
  group_by(year, cduid, agecluster) %>% 
  mutate(cd.demand.days.ages = sum(csd.demand.days.ages),
         cd.alc.rate.ages = cd.demand.days.ages / sum(csd.population.ages)) %>% 
  ungroup()

# Calculate provincial rates averaging across all CDs, all years, since huge variability observed in terms of ALC days per population by CSD/CD. E.g., for adults, some CDs have as little as 0.01 ALC days per person, whereas some have 2.6 days per person. For seniors, some CDs have as little as 0.5 days per person, whereas others have as many as 56 days per person (when ignoring CDs with no facilities and therefore a rate of 0). Clearly, because hospitals and ALC facilities are not evenly distributed throughout all CDs, 'demand' by CD swings wildly based on availability (i.e., capacity), with out-of-CD users certainly skewing the ALC rates when compared to a CD's population. 
ALC_prov_rate <- ALC_csd_rates %>% 
  filter(year %in% (2016:2016)) %>% # Adjust this filter to choose specific years to include in base rate calculations
  group_by(agecluster) %>%  # Not grouped by 'year' so populations in calculations below appear high, but provincial ALC rate calculations are accurate, they simply represent an average of historical years
  summarise(total.pop.ages = sum(csd.population.ages),
            total.dem.days.ages = sum(csd.demand.days.ages)) %>% 
  mutate(prov.alc.rate.ages = total.dem.days.ages / total.pop.ages)
  
```

## Case-Rate Model (CRM)

- Alternative model to HBAM
- Uses HBAM 2016 average length of stay; subtracts days associated with ALC in 2016; calculates average length of stay excluding ALC days
- Calculates a case rate per population for 2016
- Projects case rate forward based on population for future year
- Applies ALC-free length of stay to future number of cases
- Adds projected ALC values for year of interest to non-ALC demand

### Average Length of Stay

```{r}
# Calculate average length of stay based on projected HBAM values for 2016. 2016 is the only year for which we have historical case data and projected length of stay, since HBAM historical does not inculde length of stay.
HBAMprojected_alos <- HBAMprojected_master_tz %>%
  ungroup() %>% 
  filter(year == 2016) %>%
  filter(caretype != 'AM') %>% # Filter out AM (Emerg) care since there is no length of stay associated with Emerg cases
  select(year, id, agecluster, caretype, cases, los) %>% 
  group_by(year, id, caretype, agecluster) %>% 
  summarise(hosp.caretype.agecluster.cases = sum(cases),
            hosp.caretype.agecluster.days = sum(los, na.rm = TRUE)) %>% 
  group_by(year, id, agecluster) %>% 
  mutate(hosp.caretype.agecluster.days.percent = hosp.caretype.agecluster.days / sum(hosp.caretype.agecluster.days)) %>% 
  ungroup()

# Remove 2016 ALC from 2016 average length of stay in order to estimate actual length of stay without ALC
# In the raw dataset of ALC Most Appropriate Discharge Destination, most of the 'caretypes' associated with the data (i.e., the site IDs) are for 'AM' care, i.e., Emergency, presumably because many of those patients are admitted to hospital as an emergency case. (Out of 176 distinct siteid values in the ALC MADD raw data, 146 relate to 'AM' caretype siteids, with the remaining 30 siteids being for all other caretypes combined). This is not an accurate representation of the impact ALC has on caretypes given that reducing ALC would serve to free up wards - i.e., non-Emergency caretypes - but likely not reduce (or less significantly reduce) Emergency demand. As a proxy, ALC bed-days per hospital are divided across the four inpatient caretypes based on their relative bed-day weights as a percentage of total bed-days at a given hospital. 
HBAMprojected_alc <- HBAMprojected_alos %>% 
  # left_join(ALC_hosp_caretype, by = c('year', 'id', 'agecluster', 'caretype')) %>% 
  # mutate(hosp.caretype.days = replace_na(hosp.caretype.days, 0),
  #        hosp.caretype.agecluster.days.percent = replace_na(hosp.caretype.agecluster.days.percent, 0))
  left_join(select(ALC_hosp_vol, year, id, agecluster, hosp.alc.days), by = c('year', 'id', 'agecluster')) %>%
  filter(agecluster != 'ped') %>%  # Since no pediatric patients are counted as ALC
  mutate(hosp.alc.days = replace_na(hosp.alc.days, 0)) %>%
  # Assign hospital agecluster ALC days to different caretypes based on percentages previously established
  mutate(hosp.alc.days.agecluster.caretype = hosp.alc.days * hosp.caretype.agecluster.days.percent,
         net.hosp.days = hosp.caretype.agecluster.days - hosp.alc.days.agecluster.caretype) %>% 
  # 13 of 805 entries in the table above have negative bed-days after removing estimated ALC by hospital; for any hospital/caretype which loses more than 50% of its bed-days by removing ALC, assume bed-days are reduced only to 50% of original total (i.e., assume ALC accounts for a max of 50% of total bed-days). Attempts were made to redistribute remaining ALC days to other caretypes within the hospital, but generally if one caretype had excessive ALC noted at a hospital, all caretypes at a hospital had excessive ALC. It may be possible to shift ALC days from one agecluster to another, but this would violate estimated ALC days by agecluster from the ALC MADD data. For now, any ALC which reduces hospital demand below 50% is 'ignored'. This means approximately 46,000 bed-days from the ALC MADD dataset are being 'ignored' / lost.
  mutate(adj.net.hosp.days = pmax(net.hosp.days, 0.5 * hosp.caretype.agecluster.days),
         other.caretype.alc.days = adj.net.hosp.days - net.hosp.days)
  
# This query attempts to redistribute the 'ignored' ALC data described above, but as described above, if one caretype had excessive ALC noted at a hospital, generally all other caretypes at a hospital also had excessive ALC. It may be possible to shift ALC days from one agecluster to another, but this would violate estimated ALC days by agecluster from the ALC MADD data.
# HBAMprojected_alc_redist <- HBAMprojected_alc %>%   
#   # group_by(year, id, agecluster) %>% 
#   mutate(caretype.days.remaining = sum(other.caretype.alc.days)) %>% 
#    # Filter out all caretype-ageclusters with demand already reduced by 50% due to removing ALC. Remaining ALC days to be redistributed amongst remaining caretype-ageclusters
#   filter(adj.net.hosp.days == net.hosp.days) %>% 
#   mutate(caretype.days.remaining.factor = ifelse(caretype.days.remaining > 0, adj.net.hosp.days / caretype.days.remaining, 0),
#          caretype.days.remaining.percent = ifelse(sum(caretype.days.remaining.factor) > 0, caretype.days.remaining.factor / sum(caretype.days.remaining.factor), 0),
#          caretype.extra.alc.days = caretype.days.remaining.percent * caretype.days.remaining)

# Calculate average level of service adjusted for ALC (necessary to join to bring pediatric bed-days back into the model)
HBAMprojected_alos_adj <- HBAMprojected_alos %>% 
  left_join(select(HBAMprojected_alc, year, id, agecluster, caretype, adj.net.hosp.days), by = c('year', 'id', 'caretype', 'agecluster')) %>% 
  # Use adj.net.hosp.days for adult and senior populations but use pre-ALC calculation for pediatrics (since no ALC)
  mutate(adj.net.hosp.days = ifelse(is.na(adj.net.hosp.days), hosp.caretype.agecluster.days, adj.net.hosp.days)) %>%
  mutate(adj.caretype.agecluster.los = adj.net.hosp.days / hosp.caretype.agecluster.cases) %>% 
  select(id, agecluster, caretype, adj.net.hosp.days, adj.caretype.agecluster.los)

saveRDS(HBAMprojected_alos_adj, file = 'cache/moh/HBAMprojected_alos_adj.rds')

```

### Base Scenario (2016)
  - Calculate the market share of cases for each hospital w.r.t population at TRESO-level from HBAM for the given year/caretype/age cluster (named segment from now on)
  - Apply the case rates to the population at TRESO zones (Caserate Demand) [origin vector]
  - Create linkage to HBAM Projected and calculate scale factor (HBAM/CRM); scale cases based on factor to get Hosp-TZ cases

```{r}
# Calculate total cases by hospital, and the percentage of cases belonging to each CSD for each hospital siteid
HBAMhistorical_origcsd_cases <- HBAMhistorical_master_tz %>%
  group_by(year, id, agecluster, caretype, orig_csd, treso_zone, caretype, hosp_csduid) %>%
  summarise(hosp.csd.agecluster.caretype.cases = sum(cases)) %>%
  ungroup() %>% 
  group_by(year, id, agecluster, caretype) %>% 
  mutate(hosp.agecluster.caretype.cases = sum(hosp.csd.agecluster.caretype.cases),
         csd.agecluster.caretype.mrkt = hosp.csd.agecluster.caretype.cases / hosp.agecluster.caretype.cases) %>%
  rename(hosp.treso.zone = treso_zone) %>% 
  ungroup()

# Join historical HBAM cases by CSD/hospital pair to TRESO information to get TRESO populations
# Then calculate case rates for TRESO zones at the CSD-Hospital pair, segmented by caretype, year, and agecluster
treso_origin_cases <- HBAMhistorical_origcsd_cases %>% 
  filter(year == 2016) %>% # select most recent historical year
  left_join(distinct(treso_population_long, treso_zone, agecluster, csduid, year, treso.population.agecluster), by = c('year', 'orig_csd' = 'csduid', 'agecluster')) %>% 
  rename(orig.treso.zone = treso_zone,
         orig.treso.pop.agecluster = treso.population.agecluster) %>%
  # A few CSDs don't exist in TRESO, but small case volumes (~2,700 rows out of 2.64M, or 73,000 cases out of 8.6M) so removed for simplicity
  drop_na(orig.treso.zone) %>% 
  # Divide market share from CSDs into TRESO zones
  group_by(id, caretype, agecluster, orig_csd) %>% 
  mutate(orig.csd.pop.agecluster = sum(orig.treso.pop.agecluster)) %>% 
  mutate(treso.caserate = hosp.csd.agecluster.caretype.cases / orig.csd.pop.agecluster) %>% 
  # Check to see how many cases remain after dropping N/A TRESO zones
  mutate(testCases = treso.caserate * orig.treso.pop.agecluster) %>% 
  mutate(hosp.CSD.age.care.cases = sum(testCases)) %>% 
  ungroup() %>% 
  # Select key fields to bring forwards
  select(id,
         hosp.treso.zone,
         hosp_csduid,
         caretype,
         agecluster,
         orig_csd,
         orig.treso.zone,
         treso.caserate)

saveRDS(treso_origin_cases, file = 'cache/moh/treso_origin_cases.rds')

# rm(treso_origin_cases) # Use this if wanting to free up RAM and read in treso_origin_cases later
```


## Forecasting
### ALC Forecast Scenario
```{r}
# Converts annual turnover into length of stay (days) WITHIN a given calendar year --> this does not imply the average length of stay overall is less than a year. However, WITHIN a given year, the length of stay tops out at 365 days.
ltc_los_per_year = ltc_turnover_raw %>% 
  mutate(avg.annual.los = 1 / (1 + system.turnover.2018) * ltc.op.days) %>% 
  left_join(distinct(hospitallocations_tz, lhin, csduid), by = c('lhin')) %>% 
  # This function fails for Toronto's CSD (3520005) which is associated with several LHINs; assume associated with LHIN 7 for purposes of length of stay evaluation
  mutate(csd.lhin.concat = paste(lhin, csduid, sep = '_')) %>% 
  filter(csd.lhin.concat != '5_3520005', csd.lhin.concat != '6_3520005', csd.lhin.concat != '8_3520005', csd.lhin.concat != '9_3520005', csd.lhin.concat != '10_3520005') %>% 
  select(-csd.lhin.concat)

# This query pulls actual historical ALC days for 2016
ALC_proj_hosp_2016 <- ALC_hosp_vol %>% 
  group_by(year, id, name, agecluster, csduid, csdname) %>% 
  filter(year == 2016) %>% 
  summarise_at(vars(hosp.alc.patients:hosp.alc.days), sum) %>% 
  ungroup() %>% 
  mutate(total.LTCalc.days = sum(hosp.alc.days))
  
# Calculate capacity of LTC by CSD, including any additional beds added by visualization tool user
ltc_proj_homes <- ltc_homes %>% 
  group_by(csduid) %>%
  mutate(existing.csd.beds = sum(beds)) %>% 
  left_join(select(new_ltc_cap_csd, csduid, added.ltc.cap), by = c('csduid')) %>% 
  mutate(added.ltc.cap = replace_na(added.ltc.cap, 0)) %>% 
  mutate(total.csd.beds = existing.csd.beds + added.ltc.cap,
         ltc.bed.days.cap = total.csd.beds * ltc.op.days) %>% 
  ungroup() %>% 
  mutate(csdname = toupper(csdname)) %>%
  mutate(sumBeds = sum(beds))

# Calculate population by TRESO zone / CSD for projection year
proj_pop_control <- treso_population_moh %>%
  filter(age.group != 1) %>% # Filter out ages 0-17 as this age group is not represented in ALC data
  mutate(agecluster = ifelse(age.group < 5, 'ad', 'sr')) %>% 
  group_by(treso_zone, agecluster, csduid) %>%
  summarise_at(vars(paste0("population.", scenario.year)), sum)
   
# Calculate ALC demand as a function of population growth, join to capacity; because of the join to capacity, agecluster is phased out (since capacity is not broken down by agecluster)
ALC_proj_csd <- proj_pop_control %>%
  left_join(select(ALC_prov_rate, agecluster, prov.alc.rate.ages), by = c('agecluster')) %>% 
  mutate(ltc.treso.demand.days = prov.alc.rate.ages * get(paste0("population.", scenario.year))) %>% 
  group_by(csduid) %>%
  mutate(ltc.csd.demand.days = sum(ltc.treso.demand.days)) %>%
  # Join to capacity data
  left_join(distinct(ltc_proj_homes, csduid, total.csd.beds, ltc.bed.days.cap), by = 'csduid') %>% 
  # Join to length-of-stay data
  left_join(select(ltc_los_per_year, avg.annual.los, csduid), by = c('csduid')) %>%
  group_by(csduid) %>% 
  mutate(total.csd.beds = replace_na(total.csd.beds, 0), 
         ltc.bed.days.cap = replace_na(ltc.bed.days.cap, 0),
         csd.residual.alc.days = ltc.csd.demand.days - ltc.bed.days.cap,
         csd.patients.demand = ltc.csd.demand.days / avg.annual.los,
         csd.patients.cap = ltc.bed.days.cap / avg.annual.los,
         csd.residual.patients = csd.patients.demand - csd.patients.cap) %>%
  mutate(cduid = substr(csduid, 1, 4)) %>% 
  ungroup() %>% 
  distinct(cduid, csduid, total.csd.beds, ltc.bed.days.cap, avg.annual.los, csd.patients.demand, csd.patients.cap, ltc.csd.demand.days, csd.residual.alc.days, csd.residual.patients) %>%
# Use the code below to sum to the CD level if desired
  # group_by(cduid) %>% 
  # mutate(total.cd.beds = sum(total.csd.beds), ltc.bed.days.cap.cd = sum(ltc.bed.days.cap), cd.patients.demand = sum(csd.patients.demand), cd.patients.cap = sum(csd.patients.cap), ltc.cd.demand.days = sum(ltc.csd.demand.days)) %>% 
  # mutate(cd.residual.patients = cd.patients.demand - cd.patients.cap,  
  #        cd.residual.alc.days = ltc.cd.demand.days - ltc.bed.days.cap.cd) %>% 
  # distinct(total.cd.beds, ltc.bed.days.cap.cd, cd.patients.demand, cd.patients.cap, ltc.cd.demand.days, cd.residual.patients, cd.residual.alc.days) %>% 
  # ungroup() %>%
  # Set CD Length of Stay to be equal to CSD length of stay since length of stay is calculated at the LHIN level. This is used so that CDs/CSDs with no LTC capacity can have patient demand estimated as a function of their bed-days demand
  group_by(cduid) %>%
  mutate(avg.annual.los = replace_na(avg.annual.los, 0)) %>% 
  mutate(avg.annual.los = max(avg.annual.los)) %>% 
  mutate(csd.patients.cap = replace_na(csd.patients.cap, 0),
         csd.patients.demand = replace_na(csd.patients.demand, 0)) %>%
  mutate(csd.patients.cap = ifelse(csd.patients.cap == 0, ltc.bed.days.cap / avg.annual.los, csd.patients.cap),
         csd.patients.demand = ifelse(csd.patients.demand == 0, ltc.csd.demand.days / avg.annual.los, csd.patients.demand),
         csd.residual.patients = ifelse(is.na(csd.residual.patients), csd.patients.demand - csd.patients.cap, csd.residual.patients)) %>% 
  ungroup() %>% 
    mutate(prov.demand.days = sum(ltc.csd.demand.days), prov.cap.days = sum(ltc.bed.days.cap), 
           prov.residual.days = sum(csd.residual.alc.days))

# Roll up ALC_proj_csd to the CD level since 'residual' ALC demand is hard to reconcile with capacity at the CSD level
ALC_proj_cd <- ALC_proj_csd %>% 
  group_by(cduid) %>% 
  summarise(ltc.cd.demand.days = sum(ltc.csd.demand.days), 
         ltc.cd.bed.days.cap = sum(ltc.bed.days.cap), 
         cd.patients.demand = sum(csd.patients.demand),
         cd.patients.cap = sum(csd.patients.cap),
         cd.residual.alc.days = sum(csd.residual.alc.days),
         cd.residual.patients = sum(csd.residual.patients),
         prov.demand.days = first(prov.demand.days),
         prov.cap.days = first(prov.cap.days),
         prov.residual.days = first(prov.residual.days)) %>%
  # Calculate 'adjusted' residual ALC by CD if any excess LTC capacity is shared with other CDs
  #mutate(cd.extra.ltc.days = ifelse(cd.residual.alc.days < 0, -cd.residual.alc.days, 0)) %>% 
  ungroup() %>%
  mutate(sum.cd.extra.ltc.days = sum(cd.residual.alc.days[cd.residual.alc.days < 0]),
         sum.cd.shortfall.ltc.days = sum(cd.residual.alc.days[cd.residual.alc.days >= 0]),
         percent.cd.shortfall.ltc.days = ifelse(cd.residual.alc.days >= 0, cd.residual.alc.days / sum.cd.shortfall.ltc.days, 0),
         borrowed.cd.ltc.days = percent.cd.shortfall.ltc.days * sum.cd.extra.ltc.days * -1,
         adj.cd.residual.alc.days = ifelse(cd.residual.alc.days < 0, 0, pmax(cd.residual.alc.days - borrowed.cd.ltc.days,0)),
         sumBorrowed = sum(borrowed.cd.ltc.days), sumResidual = sum(adj.cd.residual.alc.days))

# Similar to ALC_proj_cd but maintains agecluster disaggregation - used to reduce demand days in scenario forecast years
ALC_proj_cd_agecluster <- proj_pop_control %>%
  left_join(select(ALC_prov_rate, agecluster, prov.alc.rate.ages), by = c('agecluster')) %>% 
  mutate(ltc.treso.demand.days = prov.alc.rate.ages * get(paste0("population.", scenario.year))) %>%
  mutate(cduid = substr(csduid, 1, 4)) %>% 
  group_by(cduid, agecluster) %>%
  mutate(ltc.cd.demand.days = sum(ltc.treso.demand.days)) %>% 
  # Determine what percentage of csd ltc demand days are applied to each age cluster
  select(agecluster, cduid, ltc.cd.demand.days) %>%
  distinct() %>% 
  group_by(cduid) %>% 
  mutate(ltc.cd.demand.days.agepercent = ltc.cd.demand.days / sum(ltc.cd.demand.days)) %>% 
  ungroup() %>% 
  select(-ltc.cd.demand.days)

```

### Case-Rate Model Forecast Scenario
  - Calculate total expected cases, bed-days (using ALOS) and beds-needed (bed-days/cases) for a selected forecast year
```{r}
##Projection Parameters
# PROJ_YEAR <- 2016 # Use scenario.year from ALC data
# HBAMprojected_alos_adj <- readRDS('cache/moh/HBAMprojected_alos_adj.rds') # If reading in cached file instead of keeping in RAM

# Calculate TRESO populations at the agecluster level instead of agegroup
colname <- noquote(paste0('population.', scenario.year))
treso_population_moh_agecluster_scenario <- treso_population_moh_agecluster %>% 
  select(-age.group) %>% 
  group_by(treso_zone, agecluster, csduid) %>% 
  summarise_all(sum) %>% 
  select(csduid, treso_zone, agecluster, !!as.symbol(colname)) %>% 
  rename(scen.proj.pop.treso = !!as.symbol(colname)) %>% 
  ungroup()

# CRM Output table calculates the number of cases, bed-days and beds-needed (bed-days/operating-days) for each hospital-treso pair and then summarizes it to each hospital, calculating the totals for each unique hospital-segment for the given projection year
# treso_origin_cases <- readRDS('cache/moh/treso_origin_cases.rds') # Use this query if reading in from stored data instead of keeping in RAM
crm_treso <- treso_origin_cases %>%
  left_join(treso_population_moh_agecluster_scenario, by = c("orig.treso.zone" = "treso_zone", "agecluster")) %>%
  select(-csduid) %>% 
  left_join(select(HBAMprojected_alos_adj, id, agecluster, caretype, adj.caretype.agecluster.los), by = c('id', "agecluster", "caretype")) %>% 
  # Filter caretypes/ageclusters down to those selected by the user
  filter(caretype %in% CARETYPE_LIST, agecluster %in% AGE_CLUSTER_LIST) %>% 
  # Calculate the number of cases, beddays, bedsneeded depending on the input year
  mutate(hosp.treso.cases = treso.caserate * scen.proj.pop.treso,
         hosp.treso.beddays = hosp.treso.cases * adj.caretype.agecluster.los,
         hosp.treso.bedsneeded = hosp.treso.beddays / hosp.op.days) %>%
  # Assign 0 bed days and 0 beds needed for Emergency (AM)
  mutate(adj.caretype.agecluster.los = replace_na(adj.caretype.agecluster.los, 0),
         hosp.treso.beddays = replace_na(hosp.treso.beddays, 0),
         hosp.treso.bedsneeded = replace_na(hosp.treso.bedsneeded,0)) %>% 
  # Remove any TRESO/hospital pairs which do not historically have cases
  filter(treso.caserate > 0)
  
#saveRDS(crm_treso, file = "output/moh/crm_treso.rds")

# Calculate breakdown by caretype for hospitals for use in next step (since ALC affects 'unknown' caretypes)
crm_treso_caretypes <- crm_treso %>%
  group_by(id, agecluster, caretype) %>%
  summarise(hosp.treso.caretype.beddays = sum(hosp.treso.beddays),
            hosp.treso.caretype.cases = sum(hosp.treso.cases)) %>%
  group_by(id, agecluster) %>% 
  mutate(hosp.treso.caretype.beddays.percent = hosp.treso.caretype.beddays / sum(hosp.treso.caretype.beddays),
         hosp.treso.caretype.cases.percent = hosp.treso.caretype.cases / sum(hosp.treso.caretype.cases)) %>% 
  mutate(hosp.treso.caretype.beddays.percent = replace_na(hosp.treso.caretype.beddays.percent, 0),
         hosp.treso.caretype.cases.percent = replace_na(hosp.treso.caretype.cases.percent, 0)) %>% 
  select(id, agecluster, caretype, hosp.treso.caretype.beddays.percent, hosp.treso.caretype.cases.percent)

# Calculate CRM at the CD level for scenario year in order to add ALC days to forecasted hospital non-ALC demand
# Start by collecting demand data at the hospital to treso-origin level
crm_alc <- select(hospital_lookup_master, year, id, hosp.csd = csduid) %>%
  filter(year == 2016) %>%
  select(-year) %>% 
  group_by(id) %>% 
  mutate(hosp.cd = substr(hosp.csd, 1, 4)) %>%
  left_join(select(crm_treso, id, agecluster, caretype, orig_csd, orig.treso.zone, hosp.treso.cases, hosp.treso.beddays, hosp.treso.bedsneeded), by = c('id')) %>% 
  mutate(hosp.cd = substr(hosp.csd, 1, 4)) %>%
  group_by(id, agecluster) %>%
  ungroup() %>%
  # Join in ALC by CD, and then join in agecluster data
  left_join(select(ALC_proj_cd, cduid, adj.cd.residual.alc.days), by = c('hosp.cd' = 'cduid')) %>%
  left_join(ALC_proj_cd_agecluster, by = c('agecluster', 'hosp.cd' = 'cduid')) %>%
  mutate(ltc.cd.demand.days.agepercent = replace_na(ltc.cd.demand.days.agepercent, 0)) %>% 
  mutate(cd.alc.days.agecluster = adj.cd.residual.alc.days * ltc.cd.demand.days.agepercent) %>% 
  group_by(hosp.cd, agecluster) %>% 
  mutate(hosp.treso.beddays.percent = hosp.treso.beddays / sum(hosp.treso.beddays),
         hosp.treso.beddays.percent = replace_na(hosp.treso.beddays.percent, 0),
         hosp.treso.beddays.alc = hosp.treso.beddays.percent * cd.alc.days.agecluster) %>%
  ungroup() %>% 
  select(id, hosp.csd, hosp.cd, agecluster, caretype, orig.csd = orig_csd, orig.treso.zone, hosp.treso.cases, 
         hosp.treso.beddays, hosp.treso.beddays.alc) %>% 
  mutate(hosp.treso.days.total = hosp.treso.beddays + hosp.treso.beddays.alc,
         hosp.treso.bedsneeded = hosp.treso.days.total / hosp.op.days) %>%
  # Finalize demand totals by caretype, agecluster, treso zone, hospital
  mutate(demand.days.total = hosp.treso.days.total,
         cases = hosp.treso.cases,
         demand.days.nonALC = hosp.treso.beddays,
         demand.days.ALC = hosp.treso.beddays.alc,
         beds.needed = demand.days.total/hosp.op.days) %>% 
  select(id, hosp.csd, hosp.cd, caretype, agecluster, orig.csd, orig.treso.zone, cases, demand.days.total, demand.days.nonALC, demand.days.ALC, beds.needed)

# Calculate number of cases, demand days, and beds needed by hospital, caretype, and agecluster
crm_hosp_agecluster <- crm_alc %>%
  group_by(id, agecluster, caretype) %>%
  summarise_at(vars(cases:beds.needed), sum) %>%
  ungroup()

# Calculate number of cases, demand days, and beds needed by CSD, caretype, and agecluster
crm_csd_agecluster <- crm_alc %>%
  group_by(orig.csd, agecluster, caretype) %>%
  summarise_at(vars(cases:beds.needed), sum) %>%
  ungroup()

# Calculate number of cases, demand days, and beds needed by hospital and caretype
crm_hosp <- crm_alc %>% 
  group_by(id, caretype) %>%
  summarise_at(vars(cases:beds.needed), sum) %>%
  ungroup()

# Calculate number of cases, demand days, and beds needed by origin CSD, caretype
crm_orig <- crm_alc %>% 
  group_by(orig.csd, id, hosp.csd, caretype, agecluster) %>%
  summarise_at(vars(cases:beds.needed), sum) %>%
  ungroup()
```


## Decision-Making
### Compare demand for beds/bed-days by CSD to existing bed counts to determine gap

```{r}
if (decision_making) {  
  # Determine total existing bed count by CSD by caretype
  csd_beds_existing <- num_beds %>% 
    left_join(select(hospitallocations_tz, id, hosp.csd = csduid), by = ('id')) %>% 
    rename(beds.existing = staffedbeds) %>% 
    mutate(hosp.cd = substr(hosp.csd, 1, 4)) %>%
    # Analyse by CSD and CD
    group_by(hosp.cd, hosp.csd, caretype) %>%
    summarise(csd.beds.existing = sum(beds.existing)) %>%
    ungroup()
  
  # Determine total existing bed count by CD by caretype
  cd_beds_existing <- csd_beds_existing %>%   
    group_by(hosp.cd, caretype) %>% 
    summarise(cd.beds.existing = sum(csd.beds.existing)) %>% 
    ungroup()
  
  # Join demand to capacity data and assess demand and capacity by CSD and CD
  demand_capacity_difference <- crm_csd_agecluster %>% 
    mutate(orig.cd = substr(orig.csd, 1, 4)) %>%
    left_join(csd_beds_existing, by = c('orig.csd' = 'hosp.csd', 'caretype')) %>% 
    left_join(cd_beds_existing, by = c('orig.cd' = 'hosp.cd', 'caretype')) %>% 
    replace_na(list(csd.beds.existing = 0, cd.beds.existing = 0)) %>%
    # Join in utilization targets provided by user
    left_join(utilization_targets, by = c('caretype')) %>% 
    # Calculate total beds needed across all ageclusters
    group_by(orig.csd, caretype) %>% 
    mutate(csd.beds.needed = sum(beds.needed),
           adjusted.csd.beds.needed = round(csd.beds.needed / target, 0),
           csd.beds.to.build = adjusted.csd.beds.needed - csd.beds.existing) %>% 
    group_by(orig.cd, caretype) %>% 
    mutate(cd.beds.needed = sum(beds.needed),
           adjusted.cd.beds.needed = round(cd.beds.needed / target, 0),
           cd.beds.to.build = adjusted.cd.beds.needed - cd.beds.existing) %>%
    ungroup()
}  
```

### Test number of beds required by CSD/CD if maintaining existing travel patterns
```{r}
if (decision_making) {  
  
  # Test number of beds required by CSD/CD if maintaining existing travel patterns
  demand_capacity_crm_patterns <- crm_orig %>% 
    mutate(hosp.cd = substr(hosp.csd, 1, 4)) %>%
    left_join(select(num_beds, caretype, id, beds.existing = staffedbeds), by = c('id', 'caretype')) %>% 
    replace_na(list(beds.existing = 0)) %>% 
    # Calculate the number of beds needed by caretype by hospital
    group_by(hosp.cd, hosp.csd, id, caretype, beds.existing) %>% 
    # mutate(hosp.beds.needed = sum(beds.needed)) %>% 
    summarise(hosp.beds.needed = sum(beds.needed)) %>% 
    ungroup() %>% 
    left_join(utilization_targets, by = c('caretype')) %>% 
    mutate(adjusted.hosp.beds.needed = round(hosp.beds.needed / target, 0),
           hosp.beds.to.build = adjusted.hosp.beds.needed - beds.existing)
  
  overburden_csd_hosp <- demand_capacity_crm_patterns %>% 
    select(id, caretype, hosp.beds.to.build) %>% 
    filter(hosp.beds.to.build > 0) %>% 
    left_join(select(crm_orig, orig.csd, id, hosp.csd, caretype, agecluster, cases:beds.needed), by = c('id', 'caretype')) %>% 
    # Sum cases, demand-days across ageclusters to find total demand by orig.csd, caretype
    mutate(sumCases = sum(cases)) %>% 
    group_by(orig.csd, id, caretype) %>% 
    mutate(cases = sum(cases), demand.days.total = sum(demand.days.total), demand.days.nonALC = sum(demand.days.nonALC), 
           demand.days.ALC = sum(demand.days.ALC), beds.needed = sum(beds.needed)) %>% 
    select(-agecluster) %>%
    ungroup() %>% 
    distinct() %>% 
    mutate(tot.cases = sum(cases)) %>% 
    # filter(orig.csd != hosp.csd) %>% 
    group_by(orig.csd, caretype) %>% 
    # Caclulate sum of beds.needed by origin CSD 
    mutate(csd.caretype.beds.needed = sum(beds.needed)) %>% 
    ungroup()
    
  overburden_csd_hosp_new <- overburden_csd_hosp %>% 
    anti_join(select(hospitallocations_tz, csduid), by = c('orig.csd' = 'csduid'))
    
}  
```

### Add hospitals
```{r}

# Incorporate new hospitals added by redistributing demand from other hospitals and csds

# Initialize new_hospital dataframe
new_hospital <- tibble(id = integer(), hospital.lat = double(), hospital.long = double(), name = character(), caretype = character(), 
                       beds = integer(), specialityfactor = integer(), total.hosp.beds = integer())

# TODO: Replace this with list of new hospitals provided by user through visualization tool
# This tibble represents hospitals added manually by the visualization tool user
new_hospital_user <- tibble(
  id = c(88888, 88888, 88888, 88888, 88888, 99999, 99999, 99999, 99999, 99999),
  hospital.lat = c(43.90032, 43.90032, 43.90032, 43.90032, 43.90032, 43.95, 43.95, 43.95, 43.95, 43.95),
  hospital.long = c(-78.85863, -78.85863, -78.85863, -78.85863, -78.85863, -78.79, -78.79, -78.79, -78.79, -78.79),
  name = c('New Hospital 1', 'New Hospital 1', 'New Hospital 1', 'New Hospital 1', 'New Hospital 1', 'New Hospital 2', 'New Hospital 2', 'New Hospital 2', 'New Hospital 2', 'New Hospital 2'),
  caretype = c("AT", "CR", "GR", "MH", "AM", "AT", "CR", "GR", "MH", "AM"),
  # Set number of beds per caretype; for Emerg (AM), 0 = no emerg, -1 = emerg to be built
  beds = c(200, 0, 125, 50, -1, 250, 150, 0, 75, 0),
  # agecluster = c("all","all","all","all","all", "all","all","all","all","all"), #all ages or just "ped"
  specialityfactor = c(0, 0, 0, 0, 0, 1, 1, 1, 1, 1) # 1 if hospital is speciality hospital, 0 if not
) %>%
group_by(id) %>%
mutate(total.hosp.beds = sum(beds[caretype != 'AM'])) %>%
ungroup()

# Add hospitals based on decision-making calculations
if (decision_making) {  
  new_hospital_dm <- overburden_csd_hosp_new %>% 
    distinct(orig.csd, caretype, csd.caretype.beds.needed) %>%
    mutate(csd.caretype.beds.needed = ceiling(csd.caretype.beds.needed)) %>%
    # Calculate sum of beds needed by CSD
    group_by(orig.csd) %>% 
    mutate(csd.beds.needed = sum(csd.caretype.beds.needed)) %>% 
    ungroup() %>% 
    # Limit new hospital beds to be built only if minimum size threshold is crossed
    mutate(beds.threshold = pmax(min_beds_toggle * csd.beds.needed, csd.caretype.beds.needed)) %>% 
    filter(beds.threshold >= min_beds) %>% 
    rename(beds.to.build = csd.caretype.beds.needed) %>% 
    mutate(specialityfactor = 0) %>% 
    # # Assign ID number to new hospitals; assume max of 1 new hospital per cSD
    mutate(row = group_indices(., orig.csd),
           id = 1111 * row) %>% 
    select(-row) %>%
    # Determine most populous TRESO zone in CSD
    left_join(select(treso_zone_system, csduid, treso_id), by = c('orig.csd' = 'csduid')) %>% 
    left_join(select(treso_population_moh_agecluster_scenario, treso_zone, agecluster, scen.proj.pop.treso), by = c('treso_id' = 'treso_zone')) %>% 
    rename(pop.treso = scen.proj.pop.treso) %>% 
    group_by(treso_id) %>% 
    mutate(pop.treso.all.ages = sum(pop.treso)) %>% 
    select(-agecluster, -pop.treso) %>% 
    distinct() 
  
  # Check to see if any new hospitals are required
  if (nrow(new_hospital_dm) > 0) {
    # Build new hospital(s) in most populous TRESO zone of CSDs needing a new hospital
    new_hospital_dm_treso <- new_hospital_dm %>% 
      arrange(desc(pop.treso.all.ages)) %>% 
      group_by(orig.csd, caretype) %>% 
      mutate(row = 1:n()) %>% 
      filter(row == 1) %>% 
      select(-row) %>% 
      ungroup() %>% 
      # Join in treso centroid to get lat/long for new hospitals
      left_join(select(treso_centroids, treso_id, lat, long), by = c('treso_id')) %>% 
      # Generate hospital name based on ID
      mutate(name = paste0('Hospital ', id)) %>% 
      # Rename and remove fields to match inputs for redistribution
      rename(beds = beds.to.build, total.hosp.beds = csd.beds.needed, hospital.lat = lat, hospital.long = long) %>% 
      select(id, hospital.lat, hospital.long, name, caretype, beds, specialityfactor, total.hosp.beds) 
  
    # Add in row for Emergency cases (AM) with 0 beds for each new hospital
    new_hospital <- new_hospital_dm_treso %>% 
      # Start by creating list of new hospitals and adding a column for 'AM' caretype
      distinct(id) %>% 
      # Set number of beds for Emerg (AM): 0 = no emerg, -1 = emerg to be built
      mutate(caretype = 'AM', beds = -1) %>%
      # Fill in blanks for AM caretype based on other caretypes
      bind_rows(., new_hospital_dm_treso) %>% 
      arrange(id, caretype) %>% 
      group_by(id) %>% 
      mutate(hospital.lat = last(hospital.lat), hospital.long = last(hospital.long), name = last(name), specialityfactor = 0, 
             total.hosp.beds = last(total.hosp.beds)) %>% 
      ungroup()
  }
}

# Combine user-set new hospitals plus decision-making new hospitals (if running decision-making)
new_hospital <- bind_rows(new_hospital, new_hospital_user)
  
```


```{r}  
# TODO: Replace this with list of new hospitals provided by user through visualization tool - NEW HOSPITALS SHOULD HAVE AGECLUSTERS SPECIFIED
  new_hospital <- crossing(new_hospital, AGE_CLUSTER_LIST) %>% 
    rename(agecluster = AGE_CLUSTER_LIST)

  # Overlay with TRESO Shapefile to get the TRESO/CSD Information for new hospitals
  new_hospital_xy <- create_hospital_xy(new_hospital) 
  
  new_hospital_overlay <- create_overlay(new_hospital_xy, treso_shp, type = "hospital") %>% 
    left_join(treso_zone_system, by = c("treso.id.pos" = "treso_id")) %>%
    distinct() %>% 
    left_join(new_hospital, by = "id") %>% 
    mutate_if(is.factor, as.character) %>% 
    select(-lat, -long, -csdname, -area, -mof_region, -hospital.lat, -hospital.long, -cdname) %>% 
    rename(treso_zone = treso.id.pos, hosp.csd = csduid, hospitalname = name, hosp.cd = cduid) %>% 
    mutate(id = as.numeric(id), hosp.cd=as.character(hosp.cd)) %>% 
    mutate(new.hospital = 1)
  
  # Identify the TRESO zones within the CSD of each new hospital, and join in populations
  new_hospital_CSD_treso <- distinct(new_hospital_overlay, id, hosp.csd) %>% 
    left_join(select(treso_zone_system, csduid, treso_id), by = c('hosp.csd' = 'csduid')) %>% 
    left_join(select(treso_population_moh_agecluster_scenario, treso_zone, agecluster, scen.proj.pop.treso), by = c('treso_id' = 'treso_zone')) %>% 
    rename(pop.treso = scen.proj.pop.treso, csduid = hosp.csd) %>% 
    # Determine percentage of population by agecluster by treso zone per CSD
    group_by(csduid, agecluster) %>% 
    mutate(pop.percent = pop.treso / sum(pop.treso)) %>% 
    ungroup()
  
```


## Redistribute demand leaving a CSD for other CSDs based on new hospitals
```{r}
# For CSDs with existing hospitals: redistribute based on weight, eg:
  # Existing hospitals in CSD A = 1,000 beds; other CSDs attracting cases from CSD A = 10,000 beds;
  # New hospital in CSD A = 100 beds
  # Total cases = 5,000 at existing hospitals in CSD A, 5,000 at hospitals outside CSD A
  # Cases per bed = 5,000 / 1,000 at existing hosp. CSD A = 5 cases/bed; 5,000/10,000 = 0.5 cases/bed outside CSD A
  # Assume new beds in CSD A = 5 cases/bed as per existing
  # New cases per bed = 1,100 beds x 5 cases = 5,500 cases CSD A; 5,000 cases non-CSD-A; total cases should = 10,000
  # Therefore: (1,100 x 5) * (10,000 / (1,110 * 5 + 10,000 * 0.5)) = 5,238 in CSD A
  # Therefore: 10,000 - 5,238 = 4,762 cases leaving CSD A for other CSDs
  # Now redistribute cases in CSD A based on new hospital
  # Then redistribute cases at hospitals outside CSD A (coming from CSD A) based on the above

# Determine the number of cases/demand-days staying within CSDs vs. the number with origin CSD != hospital CSD, and then produce a rate at which patients choose to stay or leave their origin CSD based on the number of beds per hospital
crm_staying <- crm_orig %>% 
  # Filter CRM outputs to CSDs with new hospitals being built
  filter(orig.csd %in% distinct(new_hospital_overlay, hosp.csd)[[1]]) %>% 
  # Identify existing hospitals which are speciality hospitals, and join in TRESO/CSD info
  left_join(select(speciality_hospitals, id, specialityfactor), by = c('id')) %>% 
  #left_join(select(hospitallocations_tz, id, hosp.csd = csduid), by = c('id')) %>% 
  mutate(new.hospital = 0) %>% 
  # Join in bed counts for existing hospitals
  left_join(select(num_beds, id, beds = staffedbeds, caretype), by = c('id', 'caretype')) %>%
  # Assign a representative number of beds to AM (Emergency) caretype to weight distribution of AM cases in later steps
  group_by(id) %>% 
  mutate(beds = replace_na(beds, 0), 
         beds = ifelse(beds == 0, sum(beds), beds)) %>% 
  # Calculate number of beds in CSDs with new hospitals, vs. number of beds in other CSDs which attracted at least some number of  residents from the CSD with new hospitals
  group_by(orig.csd, caretype, agecluster) %>% 
  mutate(beds = replace_na(beds, 0),
         beds.in = sum(beds[hosp.csd == orig.csd]),
         beds.out = sum(beds) - beds.in) %>% 
  # Calculate number of cases, demand days in CSDs with new hospitals vs. other CSDs
  mutate(cases.in = sum(cases[hosp.csd == orig.csd]),
         cases.out = sum(cases) - cases.in,
         demand.days.total.in = sum(demand.days.total[hosp.csd == orig.csd]),
         demand.days.total.out = sum(demand.days.total) - demand.days.total.in,
         demand.days.nonALC.in = sum(demand.days.nonALC[hosp.csd == orig.csd]),
         demand.days.nonALC.out = sum(demand.days.nonALC) - demand.days.nonALC.in,
         demand.days.ALC.in = sum(demand.days.ALC[hosp.csd == orig.csd]),
         demand.days.ALC.out = sum(demand.days.ALC) - demand.days.ALC.in) %>%
  # Tested shorter code but not working so stuck with long form instead: mutate_at(vars(cases:demand.days.ALC), .funs = list(inin = ~sum(vars(cases:demand.days.ALC)[hosp.csd == orig.csd])))
  # Calculate rates of cases/days per bed in and bed out of CSDs with new hospitals
  mutate(cases.per.bed.in = cases.in / beds.in,
         cases.per.bed.out = cases.out / beds.out,
         demand.days.total.per.bed.in = demand.days.total.in / beds.in,
         demand.days.total.per.bed.out = demand.days.total.out / beds.out,
         demand.days.nonALC.per.bed.in = demand.days.nonALC.in / beds.in,
         demand.days.nonALC.per.bed.out = demand.days.nonALC.out / beds.out,
         demand.days.ALC.per.bed.in = demand.days.ALC.in / beds.in,
         demand.days.ALC.per.bed.out = demand.days.ALC.out / beds.out) %>% 
  # Fix N/A values if there are no existing hospitals in CSDs with a new hospital being added
    replace_na(list(cases.per.bed.in = 0, cases.per.bed.out = 0, demand.days.total.per.bed.in = 0, demand.days.total.per.bed.out = 0,
                    demand.days.nonALC.per.bed.in = 0, demand.days.nonALC.per.bed.out = 0, demand.days.ALC.per.bed.in = 0, 
                    demand.days.ALC.per.bed.out = 0)) %>% 
  # Calculate total cases, demand-days by origin CSD, caretype
  mutate(orig.cases = sum(cases),
         orig.demand.days.total = sum(demand.days.total),
         orig.demand.days.nonALC = sum(demand.days.nonALC),
         orig.demand.days.ALC = sum(demand.days.ALC)) %>% 
  ungroup()

# Apply rates to new hospitals
new_hospital_rates <- new_hospital_overlay %>% 
  select(-hospitalname, -treso_zone, -hosp.cd) %>% 
  distinct() %>% 
  left_join(distinct(crm_staying, orig.csd, caretype, agecluster, cases.per.bed.in, demand.days.total.per.bed.in, 
                     demand.days.nonALC.per.bed.in, demand.days.ALC.per.bed.in, cases.per.bed.out, demand.days.total.per.bed.out, 
                     demand.days.nonALC.per.bed.out, demand.days.ALC.per.bed.out, orig.cases, orig.demand.days.total, 
                     orig.demand.days.nonALC, orig.demand.days.ALC), by = c('hosp.csd' = 'orig.csd', 'caretype', 'agecluster')) %>% 
  # Solve any N/A values based on lack of historical demand
  mutate(cases.per.bed.in = replace_na(cases.per.bed.in, 0),
         demand.days.total.per.bed.in = replace_na(demand.days.total.per.bed.in, 0),
         demand.days.nonALC.per.bed.in = replace_na(demand.days.nonALC.per.bed.in, 0),
         demand.days.ALC.per.bed.in = replace_na(demand.days.ALC.per.bed.in, 0),
         cases.per.bed.out = replace_na(cases.per.bed.out, 0),
         demand.days.total.per.bed.out = replace_na(demand.days.total.per.bed.out, 0),
         demand.days.nonALC.per.bed.out = replace_na(demand.days.nonALC.per.bed.out, 0), 
         demand.days.ALC.per.bed.out = replace_na(demand.days.ALC.per.bed.out, 0),
         orig.cases = replace_na(orig.cases, 0),
         orig.demand.days.total = replace_na(orig.demand.days.total, 0),
         orig.demand.days.nonALC = replace_na(orig.demand.days.nonALC, 0),
         orig.demand.days.ALC = replace_na(orig.demand.days.ALC, 0)) %>% 
  # For caretypes with no existing beds in the CSD, assume likelihood of staying in CSD is a function of likelihood of going to external CSDs
  mutate(cases.per.bed.in = ifelse(cases.per.bed.in == 0, STAY_IN_CSD_FACTOR * cases.per.bed.out, cases.per.bed.in),
         demand.days.total.per.bed.in = ifelse(demand.days.total.per.bed.in == 0, STAY_IN_CSD_FACTOR * demand.days.total.per.bed.out, demand.days.total.per.bed.in),
         demand.days.nonALC.per.bed.in = ifelse(demand.days.nonALC.per.bed.in == 0, STAY_IN_CSD_FACTOR * demand.days.nonALC.per.bed.out, demand.days.nonALC.per.bed.in),
         demand.days.ALC.per.bed.in = ifelse(demand.days.ALC.per.bed.in == 0, STAY_IN_CSD_FACTOR * demand.days.ALC.per.bed.out, demand.days.ALC.per.bed.in)) %>%
  select(-cases.per.bed.out, -demand.days.total.per.bed.out, -demand.days.nonALC.per.bed.out, -demand.days.ALC.per.bed.out) %>% 
  # Assign a representative number of beds to AM (Emergency) caretype to weight distribution of AM cases in later steps
  group_by(id) %>% 
  mutate(beds = ifelse(beds == -1 & caretype == 'AM', sum(beds), beds)) %>% 
  ungroup() %>% 
  # Estimate share of cases/demand-days going to new hospitals
  mutate(cases = cases.per.bed.in * beds,
         demand.days.total = demand.days.total.per.bed.in * beds,
         demand.days.nonALC = demand.days.nonALC.per.bed.in * beds,
         demand.days.ALC = demand.days.ALC.per.bed.in * beds)
  
# Bind in new hospitals to estimate how many people will be converted to stay in the CSD
crm_staying_new <- crm_staying %>% 
  # Bind in new hospital data
  bind_rows(., new_hospital_rates) %>% 
  mutate(orig.csd = ifelse(is.na(orig.csd), hosp.csd, orig.csd)) %>% 
  group_by(orig.csd, caretype, agecluster) %>% 
  # Determine market share per hospital
  mutate(orig.cases.percent = cases / sum(cases),
         orig.demand.days.total.percent = demand.days.total / sum(demand.days.total),
         orig.demand.days.nonALC.percent = demand.days.nonALC / sum(demand.days.nonALC),
         orig.demand.days.ALC.percent = demand.days.ALC / sum(demand.days.ALC)) %>% 
  ungroup() %>%
  # Fix N/A values for groupings with no cases/demand
  mutate(orig.cases.percent = replace_na(orig.cases.percent, 0),
         orig.demand.days.total.percent = replace_na(orig.demand.days.total.percent, 0),
         orig.demand.days.nonALC.percent = replace_na(orig.demand.days.nonALC.percent, 0),
         orig.demand.days.ALC.percent = replace_na(orig.demand.days.ALC.percent, 0)) %>% 
  # Calculate revised number of cases based on percentages above
  mutate(cases.revised = orig.cases.percent * orig.cases,
         demand.days.total.revised = orig.demand.days.total.percent * orig.demand.days.total,
         demand.days.nonALC.revised = orig.demand.days.nonALC.percent * orig.demand.days.nonALC,
         demand.days.ALC.revised = orig.demand.days.ALC.percent * orig.demand.days.ALC)

# Summarise results of redistribution of cases/demand-days from other CSDs to CSDs with new hospitals, and divide into TRESO zones  
crm_orig_revised <- crm_staying_new %>% 
  select(orig.csd, id, hosp.csd, caretype, agecluster, specialityfactor, new.hospital, beds, cases.revised, demand.days.total.revised, 
         demand.days.nonALC.revised, demand.days.ALC.revised) %>% 
  # Replace N/A values for AM cases (since no demand-days for AM, aka Emergency)
  mutate(demand.days.total.revised = replace_na(demand.days.total.revised, 0), 
         demand.days.nonALC.revised = replace_na(demand.days.nonALC.revised, 0), 
         demand.days.ALC.revised = replace_na(demand.days.ALC.revised, 0)) %>% 
  # Divide demand from CSDs down to individual TRESO zones
  left_join(select(new_hospital_CSD_treso, csduid, agecluster, pop.percent, treso_id), by = c('orig.csd' = 'csduid', 'agecluster')) %>% 
  mutate(cases.revised = cases.revised * pop.percent,
         demand.days.total.revised = demand.days.total.revised * pop.percent,
         demand.days.nonALC.revised = demand.days.nonALC.revised * pop.percent,
         demand.days.ALC.revised = demand.days.ALC.revised * pop.percent) %>% 
  rename(orig.treso.zone = treso_id)
  
```

## Redistribute demand from existing hospitals to new hospital within CSDs
- Build list of all existing and new hospitals, caretypes, ageclusters, and distribute some of existing cases and demand days from existing hospitals to new hospitals built in the same CSD  
```{r}  

# Revise cases and demand-days in crm_alc based on redistribution from other CSDs due to new hospitals
crm_alc_redist <- crm_alc %>% 
  full_join(select(crm_orig_revised, orig.csd, orig.treso.zone, hosp.csd, id, caretype, agecluster, cases.revised, 
                   demand.days.total.revised, demand.days.nonALC.revised, demand.days.ALC.revised), 
            by = c('orig.treso.zone', 'id', 'orig.csd', 'hosp.csd', 'caretype', 'agecluster')) %>% 
  # Reuse existing cases, demand-days where cases.revised and demand.days.revised are empty (i.e., no changes)
  mutate(cases.revised = ifelse(is.na(cases.revised), cases, cases.revised),
         demand.days.total.revised = ifelse(is.na(demand.days.total.revised), demand.days.total, demand.days.total.revised),
         demand.days.nonALC.revised = ifelse(is.na(demand.days.nonALC.revised), demand.days.nonALC, demand.days.nonALC.revised),
         demand.days.ALC.revised = ifelse(is.na(demand.days.ALC.revised), demand.days.ALC, demand.days.ALC.revised)) %>% 
  select(id, hosp.csd, orig.csd, orig.treso.zone, agecluster, caretype, cases.revised, demand.days.total.revised, 
         demand.days.nonALC.revised, demand.days.ALC.revised) %>% 
  rename(cases = cases.revised, demand.days.total = demand.days.total.revised, demand.days.nonALC = demand.days.nonALC.revised, 
         demand.days.ALC = demand.days.ALC.revised)

# Summarise revised crm_alc data based on redistributions within CSDs with new hospitals
crm_hosp_agecluster_redist <- crm_alc_redist %>%
  group_by(id, orig.csd, hosp.csd, agecluster, caretype) %>%
  summarise_at(vars(cases:demand.days.ALC), sum) %>%
  ungroup()

crm_hosp_agecluster_all <- crm_hosp_agecluster_redist %>%
  # Identify existing hospitals which are speciality hospitals
  left_join(select(speciality_hospitals, id, specialityfactor), by = c('id')) %>%
  mutate(new.hospital = 0) %>% 
  # Join in bed counts for existing hospitals
  left_join(select(num_beds, id, beds = staffedbeds, caretype), by = c('id', 'caretype')) %>%
  # Join in total bed counts for existing hospitals
  left_join(distinct(num_beds, id, total.hosp.beds), by = c('id')) %>% 
  # Address existing hospitals with missing bed counts by estimating beds based on cases relative to other hospitals in CSD
  mutate(beds = ifelse(caretype == 'AM' & id < 999, -1, beds)) %>% 
  # Join in bed counts and speciality hospital flag for new hospitals
  left_join(distinct(new_hospital, id, caretype, beds, specialityfactor), by = c('id', 'caretype')) %>% 
  # Join in total bed counts for new hospitals
  left_join(distinct(new_hospital, id, total.hosp.beds), by = c('id')) %>% 
  rename(specialityfactor = specialityfactor.x, beds = beds.x, total.hosp.beds = total.hosp.beds.x) %>% 
  mutate(specialityfactor = ifelse(is.na(specialityfactor), specialityfactor.y, specialityfactor),
         beds = ifelse(is.na(beds), beds.y, beds),
         beds = replace_na(beds, 0),
         total.hosp.beds = ifelse(is.na(total.hosp.beds), total.hosp.beds.y, total.hosp.beds),
         total.hosp.beds = replace_na(total.hosp.beds, 0)) %>% 
  select(-specialityfactor.y, -beds.y, -total.hosp.beds.y) %>%
  # Flag new hospitals as new
  mutate(new.hospital = replace_na(new.hospital, 1)) %>% 
  # Estimate total.hosp.beds for hospitals with no bed data provided, in order to set weighting for AM (emerg) beds
  group_by(id) %>% 
  mutate(AM.cases.no.bed.data = sum(cases[caretype == 'AM' & id < 999])) %>% 
  group_by(hosp.csd) %>% 
  mutate(AM.cases.bed.data = sum(cases[caretype == 'AM' & id < 999]) - AM.cases.no.bed.data,
         AM.cases.weight = ifelse(AM.cases.bed.data == 0, 1, AM.cases.no.bed.data / AM.cases.bed.data),
         AM.cases.weight = replace_na(AM.cases.weight, 0),
         sum.tot.beds = sum(total.hosp.beds[id < 999]),
         total.hosp.beds = ifelse(total.hosp.beds == 0, AM.cases.weight * sum(total.hosp.beds[id < 999]), total.hosp.beds),
         total.hosp.beds = ifelse(total.hosp.beds == 0, 100, total.hosp.beds)) %>% 
  ungroup() %>% 
  # Set relative size of each Emergency department relative to Emergency Dept's at other hospitals by using sum of inpatient beds (i.e., total hospital beds) as a proxy. Note that this is only used as a weighting factor relative to other Emergency Dept's, so it is the relative size that counts, not the total number of beds
  group_by(id) %>% 
  mutate(beds = ifelse(beds == -1, total.hosp.beds, beds)) %>% 
  # Adjust number of beds for existing hospitals where cases/demand was nonzero in historical years but where the bedcount = 0
  mutate(beds = ifelse(beds == 0 & id < 300, 1, beds)) %>% 
  ungroup() %>% 
  # Remove existing hospitals which are speciality hospitals from redistribution
  # filter(new.hospital == 1 | specialityfactor == 0) %>%
  # Calculate percentage of beds by hospital by caretype by agecluster
  group_by(orig.csd, hosp.csd, caretype, agecluster) %>%
  mutate(beds.percent = beds / sum(beds)) %>% 
  mutate(beds.percent = replace_na(beds.percent, 0)) %>% 
  # Sum cases, bed-days, etc. by CSD
  mutate(cases.csd.caretype.age = sum(cases),
         demand.days.total.csd.caretype.age = sum(demand.days.total),
         demand.days.ALC.csd.caretype.age = sum(demand.days.ALC),
         demand.days.nonALC.csd.caretype.age = sum(demand.days.nonALC)) %>% 
  mutate(cases.revised = beds.percent * cases.csd.caretype.age,
         demand.days.total.revised = beds.percent * demand.days.total.csd.caretype.age,
         demand.days.ALC.revised = beds.percent * demand.days.ALC.csd.caretype.age,
         demand.days.nonALC.revised = beds.percent * demand.days.nonALC.csd.caretype.age) %>% 
  ungroup()

```

## Output Results
- Simplify results for presenting in final output
### Demand outputs
```{r}
# Simplify demand outputs
crm_demand <- crm_hosp_agecluster_all %>% 
  select(-cases, -demand.days.total, -demand.days.nonALC, -demand.days.ALC) %>% 
  rename(cases = cases.revised, demand.days.total = demand.days.total.revised, demand.days.nonALC = demand.days.nonALC.revised,
         demand.days.ALC = demand.days.ALC.revised) %>% 
  # Join in TRESO population data to distribute cases from CSDs to TRESO zones
  left_join(select(treso_zone_system, csduid, treso_id), by = c('orig.csd' = 'csduid')) %>% 
  left_join(select(treso_population_moh_agecluster_scenario, treso_zone, agecluster, scen.proj.pop.treso), by = c('treso_id' = 'treso_zone', 'agecluster')) %>% 
  rename(pop.treso = scen.proj.pop.treso, orig.treso = treso_id) %>% 
  # Determine percentage of population by agecluster by treso zone per CSD
  replace_na(list(pop.treso = 0)) %>% 
  group_by(orig.csd, id, caretype, agecluster) %>% 
  mutate(pop.percent = pop.treso / sum(pop.treso)) %>% 
  ungroup() %>%
  replace_na(list(pop.percent = 0)) %>% 
  # Distribute Origin CSD cases/demand-days into TRESO zones
  mutate(cases = cases * pop.percent, demand.days.total = demand.days.total * pop.percent, 
         demand.days.nonALC = demand.days.nonALC * pop.percent, demand.days.ALC = demand.days.ALC * pop.percent) %>% 
  mutate(hosp.cd = substr(hosp.csd, 1, 4)) %>%
  select(id, hosp.cd, hosp.csd, specialityfactor, new.hospital, orig.csd, orig.treso, caretype, agecluster, pop.treso, cases, 
         demand.days.total, demand.days.nonALC, demand.days.ALC) %>% 
  # Join in utilization targets
  left_join(utilization_targets, by = c('caretype')) %>% 
  # Calculate beds needed by hospital, caretype
  group_by(id, caretype) %>% 
  mutate(beds.needed = ceiling(sum(demand.days.total) / hosp.op.days / target)) %>% 
  ungroup()

# Add travel times and distances to demand
crm_demand_travel <- crm_demand %>% 
  # Join in treso.zone info for existing hospitals
  left_join(select(hospitallocations_tz, id, hosp.treso = treso_zone), by = c('id')) %>%
  # Join in treso.zone info for new hospitals
  left_join(distinct(new_hospital_overlay, id, treso_zone), by = c('id')) %>% 
  # Merge hosp.treso column (containing treso zones for existing hospitals) with treso_id column (containing treso zones for new hospitals)
  replace_na(list(hosp.treso = 0, treso_zone = 0)) %>% 
  mutate(hosp.treso = pmax(hosp.treso, treso_zone)) %>% 
  select(-treso_zone) %>% 
  # Join in travel times for treso zone to treso zone travel
  left_join(travel_time_skim, by = c('orig.treso' = 'treso.id.por', 'hosp.treso' = 'treso.id.pos')) %>%
  rename(trip.time = value) %>%
  # Calculate travel time by origin treso zone to hospital treso zone
  mutate(cases.travel.time = cases * trip.time * trips_per_case) %>%
  # Find total and average travel time by CSD origin
  group_by(orig.csd, caretype) %>%
  mutate(orig.csd.caretype.travel.time.total = sum(cases.travel.time),
         orig.csd.caretype.travel.time.avg = orig.csd.caretype.travel.time.total / sum(cases) / trips_per_case) %>%
  ungroup() %>% 
  # Calculate total and average travel times at the hospital level
  group_by(id, caretype) %>% 
  mutate(hosp.caretype.travel.time.total = sum(cases.travel.time),
         hosp.caretype.travel.time.avg = hosp.caretype.travel.time.total / sum(cases) / trips_per_case) %>% 
  ungroup()

# Summarise total and average travel times by hospital by caretype, convert to wide format
hosp_travel_wide <- crm_demand_travel %>% 
  distinct(id, caretype, hosp.caretype.travel.time.total, hosp.caretype.travel.time.avg) %>% 
  # Convert to wide format
  pivot_wider(names_from = c(caretype), values_from = c(hosp.caretype.travel.time.total, hosp.caretype.travel.time.avg), 
              values_fill = c(hosp.caretype.travel.time.total = 0, hosp.caretype.travel.time.avg = 0)) %>% 
  # Fix N/A values for travel times at new hospitals
  replace_na(list(hosp.caretype.travel.time.avg_AM = 0, hosp.caretype.travel.time.avg_AT = 0, hosp.caretype.travel.time.avg_CR = 0, 
                  hosp.caretype.travel.time.avg_GR = 0, hosp.caretype.travel.time.avg_MH = 0))
```

### Hospital asset outputs
```{r}
# Convert num_beds to be in wide form (i.e., one row per asset)
  num_beds_wide <- num_beds %>%
    rename(beds.existing = staffedbeds) %>% 
    mutate(caretype.beds = paste0('beds.existing.', caretype)) %>%
    select(-year, -caretype, -count) %>% 
    pivot_wider(names_from = c(caretype.beds), values_from = c(beds.existing), values_fill = c(beds.existing = 0)) %>% 
    rename(total.hosp.beds.existing = total.hosp.beds)

# Calculate demand and capacity data by asset (i.e., by hospital)
hospital_wide <- crm_demand %>% 
  # Calculate beds needed and demand, summarised at the hospital level
  group_by(id, caretype, agecluster) %>% 
  summarise(beds.needed = first(beds.needed), cases = sum(cases), demand.days.total = sum(demand.days.total), 
            demand.days.nonALC = sum(demand.days.nonALC), demand.days.ALC = sum(demand.days.ALC)) %>% 
  ungroup() %>% 
  select(id, caretype, agecluster, beds.needed, cases, demand.days.total, demand.days.nonALC, demand.days.ALC) %>%
  # Pivot table from long to wide for agecluster for demand columns (cases, demand-days)
  pivot_wider(names_from = c(agecluster), values_from = c(cases, demand.days.total, demand.days.nonALC, demand.days.ALC), 
              values_fill = c(cases = 0, demand.days.total = 0, demand.days.nonALC = 0, demand.days.ALC = 0)) %>% 
  # Pivot table from long to wide for caretype for beds needed and demand columns (cases, demand-days)
  pivot_wider(names_from = c(caretype), 
              values_from = c(beds.needed, cases_ad, cases_ped, cases_sr, demand.days.total_ad, demand.days.total_ped, 
                              demand.days.total_sr, demand.days.nonALC_ad, demand.days.nonALC_ped, demand.days.nonALC_sr, 
                              demand.days.ALC_ad, demand.days.ALC_ped, demand.days.ALC_sr), 
              values_fill = c(beds.needed = 0, cases_ad = 0, cases_ped = 0, cases_sr = 0, demand.days.total_ad = 0, 
                              demand.days.total_ped = 0, demand.days.total_sr = 0, demand.days.nonALC_ad = 0, demand.days.nonALC_ped = 0, 
                              demand.days.nonALC_sr = 0, demand.days.ALC_ad = 0, demand.days.ALC_ped = 0, demand.days.ALC_sr = 0)) %>% 
  # Calculate sum of cases, demand-days as a double-check, and make sure there are exactly 0 beds for AM cases (Emergency)
  mutate(sum.cases = cases_ad_AM + cases_ped_AM + cases_sr_AM + cases_ad_AT + cases_ped_AT + cases_sr_AT + cases_ad_CR + cases_ped_CR + cases_sr_CR + 
                     cases_ad_GR + cases_ped_GR + cases_sr_GR + cases_ad_MH + cases_ped_MH + cases_sr_MH) %>%
  mutate(sum.demand.days = demand.days.total_ad_AM + demand.days.total_ped_AM + demand.days.total_sr_AM + demand.days.total_ad_AT + 
                           demand.days.total_ped_AT + demand.days.total_sr_AT + demand.days.total_ad_CR + demand.days.total_ped_CR + 
                           demand.days.total_sr_CR + demand.days.total_ad_GR + demand.days.total_ped_GR + demand.days.total_sr_GR + 
                           demand.days.total_ad_MH + demand.days.total_ped_MH + demand.days.total_sr_MH) %>% 
  mutate(sum.ALC.days = demand.days.ALC_ad_AM + demand.days.ALC_ped_AM + demand.days.ALC_sr_AM + demand.days.ALC_ad_AT + 
                           demand.days.ALC_ped_AT + demand.days.ALC_sr_AT + demand.days.ALC_ad_CR + demand.days.ALC_ped_CR + 
                           demand.days.ALC_sr_CR + demand.days.ALC_ad_GR + demand.days.ALC_ped_GR + demand.days.ALC_sr_GR + 
                           demand.days.ALC_ad_MH + demand.days.ALC_ped_MH + demand.days.ALC_sr_MH) %>% 
  mutate(beds.needed_AM = 0) %>% 
  mutate(total.hosp.beds.needed = beds.needed_AM + beds.needed_AT + beds.needed_CR + beds.needed_GR + beds.needed_MH) 

# Join in capacity data to hospital_wide
hospital_wide_cap <- hospital_wide %>% 
  # Join in existing capacity (i.e., beds.existing) data
  left_join(num_beds_wide, by = c('id')) %>% 
  replace_na(list(total.hosp.beds.existing = 0, beds.existing.AM = 0, beds.existing.AT = 0, beds.existing.CR = 0, beds.existing.GR = 0, 
                  beds.existing.MH = 0)) %>% 
  # Replace beds.needed columns (by caretype) with the pmax of (beds.needed, beds.existing)
  mutate(beds.forecasted.AT = pmax(beds.needed_AT, beds.existing.AT),
         beds.forecasted.CR = pmax(beds.needed_CR, beds.existing.CR),
         beds.forecasted.GR = pmax(beds.needed_GR, beds.existing.GR),
         beds.forecasted.MH = pmax(beds.needed_MH, beds.existing.MH))

# Calculate utilization by hospital, caretype for forecasted beds, and utilizations using existing beds
hospital_wide_util <- hospital_wide_cap %>% 
  # Utilization calculations use the sum of demand-days rather than beds.needed because beds.needed incorporates user-input utilization targets 
  group_by(id) %>% 
  mutate(utilization.AM = 0,
         utilization.AT = (sum(demand.days.total_ad_AT)+sum(demand.days.total_ped_AT)+sum(demand.days.total_sr_AT)) / beds.forecasted.AT / hosp.op.days,
         utilization.CR = (sum(demand.days.total_ad_CR)+sum(demand.days.total_ped_CR)+sum(demand.days.total_sr_CR)) / beds.forecasted.CR / hosp.op.days,
         utilization.GR = (sum(demand.days.total_ad_GR)+sum(demand.days.total_ped_GR)+sum(demand.days.total_sr_GR)) / beds.forecasted.GR / hosp.op.days,
         utilization.MH = (sum(demand.days.total_ad_MH)+sum(demand.days.total_ped_MH)+sum(demand.days.total_sr_MH)) / beds.forecasted.MH / hosp.op.days,
         utilization.AT.existing = (sum(demand.days.total_ad_AT)+sum(demand.days.total_ped_AT)+sum(demand.days.total_sr_AT)) / beds.existing.AT / hosp.op.days,
         utilization.CR.existing = (sum(demand.days.total_ad_CR)+sum(demand.days.total_ped_CR)+sum(demand.days.total_sr_CR)) / beds.existing.CR / hosp.op.days,
         utilization.GR.existing = (sum(demand.days.total_ad_GR)+sum(demand.days.total_ped_GR)+sum(demand.days.total_sr_GR)) / beds.existing.GR / hosp.op.days,
         utilization.MH.existing = (sum(demand.days.total_ad_MH)+sum(demand.days.total_ped_MH)+sum(demand.days.total_sr_MH)) / beds.existing.MH / hosp.op.days) %>%
  # Replace 'NaN' utilizations (i.e., where there is no demand nor capacity in a given hospital/caretype) and 'inf' utilizations (where there is demand but no existing capacity - this occurs at new hospitals)
  mutate_at(vars(utilization.AT.existing, utilization.CR.existing, utilization.GR.existing, utilization.MH.existing), ~replace(., is.nan(.), 0)) %>% 
  mutate_at(vars(utilization.AT.existing, utilization.CR.existing, utilization.GR.existing, utilization.MH.existing), ~replace(., is.infinite(.), 999)) %>%
  ungroup() %>% 
  replace_na(list(utilization.AT = 0, utilization.CR = 0, utilization.GR = 0, utilization.MH = 0))

# Add in travel times, distances to final hospital_wide table
hosp_wide_final <- hospital_wide_util %>% 
  left_join(hosp_travel_wide, by = c('id'))

```

## New Hospital Cost Function
```{r hospital cost function}
# Read in list of new hospitals
# TODO: Replace this hard-coded tibble with user-input value from visualization
new_hosp_list <- distinct(new_hospital, id, total.hosp.beds)

# Calculate costs
new_hosp_list_complete <- new_hosp_list %>% 
  mutate(cost_2018 = round(total.hosp.beds * user_input_cost_per_bed + user_input_base_hosp_cost, 0))

```

## Cost Annualization 
- Inflate cost for facility construction based on construction year; calculate total cost over time period of interest
```{r}
user_input_inflation <- 0.02 # TODO: Replace this hard-coded value with user-input value from visualization

currency_year = 2018 # Units of costs; set to 2018 since cost function from EDU assumed to be set in 2018$
current_year = 2019 # Current year used to calculate construction timespan; should be parameterized and put up front for user to choose

annualized_inflated_cost <- construction_cost(user_input_inflation, scenario.year, currency_year,
                                              current_year, new_hosp_list_complete)
```


```{r}
 
########################################
# Results if user chooses HBAM forecast
if (scenario.year <= 2016) {
  HBAM_control <- readRDS("output/moh/hospital_lookup_master.rds") %>% 
    filter(year == scenario.year) %>% 
    gather(key = "segment", value = "cases", cases_at_ad:cases_am_sr) %>% 
    separate(segment, c(NA, "caretype", "age_cluster")) %>% 
    mutate(caretype = toupper(caretype)) %>% 
    group_by(id, caretype, age_cluster) %>% 
    summarise(cases = sum(cases)) %>% 
    ungroup()
} else { # HBAM only goes out to 2026
  HBAM_control <- HBAMprojected_master_tz %>%
    mutate(los = replace_na(los, 0),
           beddays = replace_na(beddays, 0),
           beds.needed = beddays / hosp.op.days) %>% 
    filter(year == scenario.year) %>% 
    group_by(id, caretype, age_cluster) %>% 
    summarise_at(vars(cases:beddays), sum, na.rm=TRUE)
}

# Set results to respond to user model choice
if (USER_SELECT == "HBAM") {
  hosp_results <- HBAM_control
} else if (USER_SELECT == "CRM") {
  hosp_results <- crm_hosp_agecluster
}


```


## Extra Code: Queries Tested but Not Kept
```{r}

################## Previous code for calculating ALC rates at the TRESO level

# ALC TRESO-level rates for forecasting future ALC
# ADD TRESO-LEVEL DISAGGREGATIONS BY FIRST JOINING IN CORRESPONDING CSD-TRESO LIST AND THEN TAKING THE PROPORTION OF TRESO POPULATION TO TOTAL CSD POPULATION
# ALC_treso <- ALC_csd_vol %>% 
#   # Use a full join in case there are CSDs with no hospitals or LTC facilities. In theory there should be no CSDs with hospitals or LTC facilities that have no population, in which case this functions as a right_join, but use full_join as double-check.
#   full_join(select(treso_population_long, treso_zone, csduid, age_cluster, treso.population.agecluster, year), by = c('year','csduid', 'agecluster' = 'age_cluster')) %>%
#   distinct() %>% 
#   group_by(year, csduid, agecluster) %>%
#   mutate(csd.age.pop = sum(treso.population.agecluster),
#          treso.csd.pop.perc = treso.population.agecluster / csd.age.pop,
#          treso.csd.dem.patients = csd.demand.patients.total * treso.csd.pop.perc,
#          treso.csd.dem.patients = replace_na(treso.csd.dem.patients, 0),
#          treso.csd.dem.days = csd.demand.days.total * treso.csd.pop.perc) %>% 
#   ungroup()

################# Previous code to calculate length of stay

#Join TRESO origin calculations to HBAM projected by calculating the ALOS for each CT-Age-cluster segment and apply to CRM projected number of cases to convert from cases to beddays

#Average LOS for patient admittance on provincial level (HQO)
# hqo_edlos <- data.frame('year' = c(2018, 2018, 2018, 2018, 2019,2019,2019,2019,2019,2019,2019,2019,2019), 
#                         'month' = c(09:12, 01:09), 
#                         'edlos' = c(16.3,16.8,17, 16.3, 18.3, 16.7, 16.8, 16.2, 16.1, 16.3, 15.6, 15.5, 17.1))
# avg_edlos_2018 <- mean(hqo_edlos$edlos)
# #EDLOS to admittance according to provincial average from CIHI
# avg_edlos_2015 <- 9.8 
# avg_edlos_2016 <- 10.5
# avg_edlos_2017 <- 11.0
# #Averaged out 3 data points to get rough average of ED-LOS (to admittance since that is when they are transferred to other CT); however, rate needs to reflect % of ED patients that do not get admitted, which might be the majority and that would decrease overall ALOS
# avg_edlos <- mean(c(avg_edlos_2015, avg_edlos_2016, avg_edlos_2017))

################## Calculate scale factor between HBAM and CRM in order to produce CRM

# crm_hosp_tbl_join <- left_join(crm_hosp_tbl, HBAM_control, by = c("id", "caretype", "age_cluster")) %>% 
#   mutate(scale.factor = cases/hosp.treso.cases) %>% 
#   select(id, caretype, age_cluster, scale.factor)

################# CRM Hospital Beds Summary Table

# hospital_beds_summary <- crm_treso_tbl_calc %>%
#   group_by(id, caretype, age_cluster) %>% 
#   summarise(bedsneeded = sum(bedsneeded)) %>% 
#   ungroup() %>% 
#   mutate(caretype = tolower(caretype)) %>% 
#   unite(segment, caretype:age_cluster) %>% 
#   spread(segment, bedsneeded) %>% 
#   mutate_at(vars(-id), ~replace_na(., 0)) %>% 
#   mutate(simulated.beds = select(., -id) %>% rowSums())

################ CRM Model - Previous code to report results of CRM model

# hospital_master_id <- readRDS("output/moh/hospital_lookup_master.rds") %>% 
#   ungroup() %>% 
#   mutate(beds = dbc_total_beds_2018,
#          cases = select(., contains("cases")) %>% rowSums(),
#          utilization = NA) %>% 
#   filter(year == 2016) # %>% 
#   # left_join(hospital_beds_summary, by="id")
# 
# # Calculated the calculated CT segment's utilization
# hospital_capacity_summary <- hospital_master_id %>% 
#   select(id, at_beds_2018:mh_beds_2018) %>% 
#   gather(key = caretype, value = beds.ct.2018, -id) %>%
#   mutate(caretype = substring(caretype, 1, 2)) %>% 
#   filter(caretype %in% tolower(CARETYPE_LIST))
# 
# # Calculate average for caretypes that matter
# hospital_utilization_summary <- crm_treso_tbl_calc %>% 
#   group_by(id, caretype) %>% 
#   summarise(bedsneeded = sum(bedsneeded)) %>% 
#   ungroup() %>% 
#   mutate(caretype = tolower(caretype)) %>% 
#   left_join(hospital_capacity_summary, by = c("id", "caretype")) %>% 
#   group_by(id) %>% 
#   summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
#   mutate(utilization = bedsneeded / beds.ct.2018) %>% 
#   select(id, beds.ct.2018, bedsneeded, utilization)
# 
# hospital_master_id <- hospital_master_id %>% 
#   select(-utilization) %>% 
#   left_join(hospital_utilization_summary, by = "id")

# for (caretype in CARETYPE_LIST) {
#   if (caretype != "AM") {
#     caretype = tolower(caretype)
#     hospital_master_id <- hospital_master_id %>% 
#         # Sum the caretypes across age clusters
#       mutate(!!(paste0("simulated.beds.", caretype)) := select(., get(paste0(caretype, "_ad")):get(paste0(caretype, "_sr"))) %>% rowSums()) %>% 
#       # Calculate caretype specific utilization
#       mutate(!!(paste0("utilization.", caretype)) := get(paste0("simulated.beds.", caretype)) / get(paste0(caretype, "_beds_2018"))) 
#     }
# }

# hospital_od <- crm_treso_tbl_calc %>% 
#   group_by(id, orig.treso.zone) %>% 
#   summarise(value = round(sum(cases), 0),
#             name = first(hospitalname)) %>% 
#   rename(orig = orig.treso.zone, dest = id)

# test <- crm_treso_tbl_calc %>% 
#   filter(id == 80, caretype != "AM") %>% 
#   select(hospitalname, id, caretype, age_cluster, 
#          orig.treso.zone, treso.caserate.agecluster,
#          population.2026, hosp.treso.cases, hosp.treso.beddays,
#          hosp.treso.bedsneeded, scale.factor, cases, beddays,
#          bedsneeded)





#   # Establish list of speciality hospitals. Join treso travel time between orig. zone and hospital location zone to identify speciality hospitals by cases*TT for TT over 3hrs > 10% of all cases*TT
#   spec_marker <- crm_treso %>%   
#   left_join(travel_time_skim, by = c("orig.treso.zone"="orig", "hosp.treso.zone" ="dest")) 
#   
# spec_marker_2 <- spec_marker %>% 
#   rename(travel.time = value) %>% 
#   mutate(cases.by.tt = hosp.treso.cases * travel.time) %>% 
#   mutate(long = if_else(travel.time >= 180, 1 , 0)) %>% 
#   group_by(id, hospitalname, long) %>% 
#   mutate(hosp.long.travel.total = sum(cases.by.tt)) %>% 
#   ungroup() %>% 
#   mutate(hosp.total.travel = sum(cases.by.tt)) %>% 
#   mutate(long.to.total.ratio = hosp.long.travel.total/hosp.total.travel) %>% 
#   mutate(speciality = if_else(long.to.total.ratio>=0.,1,0)) %>% 
#   select(id, hospitalname, speciality) %>% 
#   group_by(id, hospitalname) %>% 
#   unique()

############################# Old method of distributing cases, demand days to new hospitals

  # # Revise existing number of hospital beds to be flagged as 'speciality' hospitals or not
  # num_beds_revised <- num_beds %>% 
  #   select(id, caretype, beds = staffedbeds) %>% 
  #   # Join in speciality hospital flag for existing hospitals
  #   left_join(select(speciality_hospitals, id, specialityfactor), by = c('id'))
  # 
  # # Create list of existing and new hospitals with bed counts by caretype
  # num_beds_all <- new_hospital_overlay %>% 
  #   select(-agecluster, -hospitalname, -hosp.cd) %>% 
  #   distinct() %>% 
  #   bind_rows(., num_beds_revised) %>% 
  #   mutate(new.hospital = replace_na(new.hospital, 0)) %>% 
  #   left_join(select(hospitallocations_tz, id, treso_zone, csduid), by = c('id')) %>%
  #   mutate(hosp.csd = ifelse(is.na(hosp.csd), csduid, hosp.csd),
  #          treso_zone.x = ifelse(is.na(treso_zone.x), treso_zone.y, treso_zone.x)) %>% 
  #   rename(treso.zone = treso_zone.x) %>% 
  #   select(-csduid, -treso_zone.y) %>% 
  #   mutate(hosp.cd = substr(hosp.csd, 1, 4))
  # 
  # # Calculate share of CSD-caretype beds each hospital has, ignoring existing speciality hospitals
  # csd_caretype_beds <- num_beds_all %>% 
  #   filter(new.hospital == 1 | specialityfactor == 0) %>% 
  #   # Calculate the total number of beds by CSD and percentage belonging to each hospital
  #   group_by(hosp.csd, caretype) %>% 
  #   mutate(csd.caretype.beds = sum(beds)) %>% 
  #   # Calculate percent of CSD-caretype beds belonging to each hospital
  #   mutate(hosp.caretype.beds.percent = beds / csd.caretype.beds,
  #          hosp.caretype.beds.percent = replace_na(hosp.caretype.beds.percent, 0)) %>% 
  #   # Calculate percent of 'CSD-caretype beds' equivalent for Emergency (AM) cases --> Though Emerg does not have beds in the daily bed census the way other caretypes do, AM cases will need to be redistributed to new hospitals on the basis of some measure of size. Estimate this percentage by taking a weighted average of the percentage of beds from other caretypes
  #   group_by(id) %>% 
  #   mutate(hosp.caretype.beds.percent = ifelse(caretype == 'AM', crossprod(hosp.caretype.beds.percent, beds) / sum(beds), hosp.caretype.beds.percent)) %>% 
  #   ungroup()
  # 
  # ## Prepare the origin demand vector for new hospitals for selected year, based on existing non-speciality hospitals
  # crm_new_hosp_prep <- csd_caretype_beds %>% 
  #   left_join(crm_hosp_agecluster, by = c('id', 'caretype')) %>% 
  #   left_join(select(new_hospital_overlay, id, caretype, agecluster), by = c('id', 'caretype')) %>% 
  #   mutate(agecluster = ifelse(is.na(agecluster.x), agecluster.y, agecluster.x)) %>% 
  #   select(-agecluster.x, -agecluster.y) %>% 
  #   mutate(cases = replace_na(cases, 0),
  #          demand.days.total = replace_na(demand.days.total, 0),
  #          demand.days.ALC = replace_na(demand.days.ALC, 0),
  #          demand.days.nonALC = replace_na(demand.days.nonALC, 0),
  #          beds.needed = replace_na(beds.needed, 0),
  #          new.hospital = replace_na(new.hospital, 0),
  #          beds = replace_na(beds, 0)) %>% 
  #   # Sum cases, bed-days, etc. by CSD
  #   group_by(hosp.csd, caretype, agecluster) %>% 
  #   mutate(cases.csd.caretype.age = sum(cases),
  #          demand.days.total.csd.caretype.age = sum(demand.days.total),
  #          demand.days.ALC.csd.caretype.age = sum(demand.days.ALC),
  #          demand.days.nonALC.csd.caretype.age = sum(demand.days.nonALC)) %>% 
  #   ungroup()
  # 
  # # Redistribute cases, demand days amongst new hospitals, based on total CSD demand
  # crm_new_hosp <- crm_new_hosp_prep %>%
  #   filter(new.hospital == 1) %>% 
  #   mutate(cases = hosp.caretype.beds.percent * cases.csd.caretype.age,
  #          demand.days.total = hosp.caretype.beds.percent * demand.days.total.csd.caretype.age,
  #          demand.days.ALC = hosp.caretype.beds.percent * demand.days.ALC.csd.caretype.age,
  #          demand.days.nonALC = hosp.caretype.beds.percent * demand.days.nonALC.csd.caretype.age) %>% 
  #   # Calcualte sum of cases, demand days by CSD for new hospitals - this will be removed from totals in the next dataframe
  #   group_by(hosp.csd, caretype, agecluster) %>% 
  #   mutate(cases.new.csd.careage = sum(cases),
  #          demand.days.total.new.csd.careage = sum(demand.days.total),
  #          demand.days.ALC.new.csd.careage = sum(demand.days.ALC),
  #          demand.days.nonALC.new.csd.careage = sum(demand.days.nonALC)) %>%
  #   ungroup()
  # 
  # # Determine cases, demand days remaining at existing hospitals, based on total CSD demand and demand at new hospitals.
  # 
  # # Demand must be calculated as the difference between total and new hospitals since not all ageclusters were observed in base year historical data, even in places where those ageclusters COULD have been observed. In other words, if a new hospital represents 10% of total beds in a CSD for Caretype A, it is expected that this new hospital will get 10% of pediatric cases, 10% of adult cases, and 10% of senior cases for Caretype A in that CSD. However, if an existing hospital in the same CSD served 20% of pediatric cases and 20% of senior cases in Caretype A in the base year data, but served 0% of adult cases in Caretype A in the CSD, applying the same distributive logic used for new hospitals will assign 20% of adult cases to this existing hospital. To avoid this, subtract cases assigned to new hospitals from the total number of cases, and then assign remainder to existing hospitals based on historically observed proportion of caretype by agecluster by CSD.
  # 
  # crm_existing_hosp <- crm_new_hosp_prep %>% 
  #   # Remove new hospitals from this dataframe
  #   filter(new.hospital == 0) %>% 
  #   # Join in cases, demand days from new hospitals summed to the CSD level
  #   left_join(select(crm_new_hosp, hosp.csd, caretype, agecluster, cases.new.csd.careage, demand.days.total.new.csd.careage, demand.days.ALC.new.csd.careage, demand.days.nonALC.new.csd.careage), by = c('hosp.csd', 'caretype', 'agecluster')) %>% 
  #   # Replace N/A values for CSDs with no new hospitals
  #   mutate(cases.new.csd.careage = replace_na(cases.new.csd.careage, 0), 
  #          demand.days.total.new.csd.careage = replace_na(demand.days.total.new.csd.careage, 0),
  #          demand.days.ALC.new.csd.careage = replace_na(demand.days.ALC.new.csd.careage, 0),
  #          demand.days.nonALC.new.csd.careage = replace_na(demand.days.nonALC.new.csd.careage, 0)) %>% 
  #   # Calculate percentage of cases, demand days, etc. by existing hospital
  #   group_by(hosp.csd, caretype, agecluster) %>% 
  #   mutate(cases.percent.hosp = cases / sum(cases),
  #          demand.days.total.percent.hosp = demand.days.total / sum(demand.days.total),
  #          demand.days.ALC.percent.hosp = demand.days.ALC / sum(demand.days.ALC),
  #          demand.days.nonALC.percent.hosp = demand.days.nonALC / sum(demand.days.nonALC)) %>% 
  #   # Fix NA values due to divide-by-zero errors
  #   mutate(cases.percent.hosp = replace_na(cases.percent.hosp, 0),
  #          demand.days.total.percent.hosp = replace_na(demand.days.total.percent.hosp, 0),
  #          demand.days.ALC.percent.hosp = replace_na(demand.days.ALC.percent.hosp, 0),
  #          demand.days.nonALC.percent.hosp = replace_na(demand.days.nonALC.percent.hosp, 0)) %>% 
  #   # Calculate cases, demand days remaining at existing hospitals after distributing to new hospitals
  #   mutate(cases.remaining = cases.percent.hosp * (sum(cases) - cases.new.csd.careage),
  #          demand.days.total.remaining = demand.days.total.percent.hosp * (sum(demand.days.total) - demand.days.total.new.csd.careage),
  #          demand.days.ALC.remaining = demand.days.ALC.percent.hosp * (sum(demand.days.ALC) - demand.days.ALC.new.csd.careage),
  #          demand.days.nonALC.remaining = demand.days.nonALC.percent.hosp * (sum(demand.days.nonALC) - demand.days.nonALC.new.csd.careage)) %>% 
  #   ungroup() %>% 
  #   select(id, treso.zone, hosp.csd, hosp.cd, caretype, agecluster, specialityfactor, new.hospital, beds, cases = cases.remaining, demand.days.total = demand.days.total.remaining, demand.days.ALC = demand.days.ALC.remaining, demand.days.nonALC = demand.days.nonALC.remaining)


############################# Outdated means of adding beds to existing hospitals where 'new beds' are required

    # Add beds to largest existing hospital in the CSD if one (or more) exist; otherwise, build new hospital in CSD
    # left_join(select(hospitallocations_tz, id, csduid, hosp.treso = treso_zone, lat, long), by = c('orig.csd' = 'csduid')) %>%
    # left_join(select(num_beds, id, caretype, beds = staffedbeds), by = c('id', 'caretype')) %>% 
    # arrange(desc(beds)) %>% 
    # group_by(orig.csd, caretype) %>% 
    # mutate(size.rank = 1:n()) %>% 
    # ungroup() %>% 
    # filter(size.rank == 1) %>% 
    # select(-size.rank) %>% 

############################# Determine distribution of demand at hospitals by CSD, TRESO zone

# Calculate total number of cases/demand-days at hospitals based on redistribution between hospitals within each CSD
# crm_hosp_agecluster_all <- crm_hosp_agecluster_redist %>%
#   # Identify existing hospitals which are speciality hospitals
#   left_join(select(speciality_hospitals, id, specialityfactor), by = c('id')) %>%
#   mutate(new.hospital = 0) %>% 
#   # Join in bed counts for existing hospitals
#   left_join(select(num_beds, id, beds = staffedbeds, caretype), by = c('id', 'caretype')) %>% 
#   # Bind in new hospital data
#   bind_rows(., select(new_hospital_overlay, id, caretype, agecluster, beds, specialityfactor, new.hospital, hosp.csd)) %>% 
#   mutate(cases = replace_na(cases, 0),
#          demand.days.total = replace_na(demand.days.total, 0),
#          demand.days.ALC = replace_na(demand.days.ALC, 0),
#          demand.days.nonALC = replace_na(demand.days.nonALC, 0),
#          beds.needed = replace_na(beds.needed, 0),
#          new.hospital = replace_na(new.hospital, 0),
#          beds = replace_na(beds, 0)) %>% 
#   # Remove existing hospitals which are speciality hospitals from redistribution
#   filter(new.hospital == 1 | specialityfactor == 0) %>%
#   # Calculate percentage of beds by hospital by caretype by agecluster
#   group_by(hosp.csd, caretype, agecluster) %>%
#   mutate(beds.percent = beds / sum(beds)) %>% 
#   mutate(beds.percent = replace_na(beds.percent, 0)) %>% 
#   # Sum cases, bed-days, etc. by CSD
#   mutate(cases.csd.caretype.age = sum(cases),
#          demand.days.total.csd.caretype.age = sum(demand.days.total),
#          demand.days.ALC.csd.caretype.age = sum(demand.days.ALC),
#          demand.days.nonALC.csd.caretype.age = sum(demand.days.nonALC)) %>% 
#   mutate(cases.revised = beds.percent * cases.csd.caretype.age,
#          demand.days.total.revised = beds.percent * demand.days.total.csd.caretype.age,
#          demand.days.ALC.revised = beds.percent * demand.days.ALC.csd.caretype.age,
#          demand.days.nonALC.revised = beds.percent * demand.days.nonALC.csd.caretype.age) %>% 
#   ungroup()

############################# Overburden and number of beds to build for hospitals

 #Determine how many patients from each CSD/CD go to hospitals in other CSDs/CDs which are overburdened, then determine if it makes sense to build more hospital beds in each origin CSD/CD
  # overburden <- demand_capacity_crm_patterns %>% 
  #   select(id, caretype, hosp.beds.to.build) %>% 
  #   filter(hosp.beds.to.build > 0) %>% 
  #   left_join(select(crm_orig, orig.csd, id, caretype, agecluster, cases:beds.needed), by = c('id', 'caretype')) %>% 
  #   # Sum cases, demand-days across ageclusters to find total demand by orig.csd, caretype
  #   mutate(sumCases = sum(cases)) %>% 
  #   group_by(orig.csd, caretype) %>% 
  #   mutate(cases = sum(cases), demand.days.total = sum(demand.days.total), demand.days.nonALC = sum(demand.days.nonALC), 
  #          demand.days.ALC = sum(demand.days.ALC), beds.needed = sum(beds.needed)) %>% 
  #   select(-agecluster, -id, -hosp.beds.to.build) %>%
  #   ungroup() %>% 
  #   distinct()
  
  # # Determine number of beds to be built by CSD which can justify construction of beds (i.e., exceeding minimum build number)
  # csd_build <- overburden %>% 
  #   # Remove all origin CSD / caretype combinations which do not have enough demand to justify construction of additional beds in the CSD
  #   filter(beds.needed >= min_beds) %>% 
  #   # Start by determining where new facilities should go - i.e., prioritize CSDs with no hospital (by caretype) on the assumption that these will have relatively high travel times
  #   left_join(csd_beds_existing, by = c('orig.csd' = 'hosp.csd')) %>% 
  #   replace_na(list(beds.existing = 0))
  # 
  # # Determine number of beds needed but not built across CSDs going to overburdened hospitals
  # csd_no_build <- overburden %>% 
  #   filter(beds.needed < min_beds)

############################################# Calculate ALC by hospital by caretype for 2016 for use in length-of-stay calculations

# Commented out since this mostly yields ALC demand identified as 'AM' caretype, or Emergency, which is not meaningful or actionable data.
# ALC_hosp_caretype <- ALC_hosp_vol_disag %>% 
#   ungroup() %>% 
#   filter(year == 2016) %>% 
#   distinct(year, siteid, agecluster, adj.hosp.days.tot) %>% 
#   #left_join(distinct(HBAMhistorical_master_tz, year, id, siteid, caretype), by = c('year', 'siteid', 'id')) %>% 
#   left_join(select(hospitallocations, datasetID1.siteid, id, caretype), by = c('siteid' = 'datasetID1.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID2.siteid, id, caretype), by = c('siteid' = 'datasetID2.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID3.siteid, id, caretype), by = c('siteid' = 'datasetID3.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID4.siteid, id, caretype), by = c('siteid' = 'datasetID4.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID5.siteid, id, caretype), by = c('siteid' = 'datasetID5.siteid')) %>% 
#   left_join(select(hospitallocations, datasetID6.siteid, id, caretype), by = c('siteid' = 'datasetID6.siteid')) %>% 
#   ungroup() %>% 
#   mutate(id = pmax(replace_na(id.x, 0), replace_na(id.x.x, 0), replace_na(id.x.x.x,0), replace_na(id.y, 0), replace_na(id.y.y, 0), replace_na(id.y.y.y, 0))) %>% 
#   mutate(caretype = pmax(replace_na(caretype.x, 0), replace_na(caretype.x.x, 0), replace_na(caretype.x.x.x,0), replace_na(caretype.y, 0), replace_na(caretype.y.y, 0), replace_na(caretype.y.y.y, 0))) %>%
#   # Take distinct rows from dataframe above since individual siteid codes may have been joined on multiple times to match the datasetID values
#   distinct(year, id, siteid, agecluster, caretype, adj.hosp.days.tot) %>% 
#   group_by(year, id, agecluster, caretype) %>% 
#   summarise(hosp.caretype.days = sum(adj.hosp.days.tot)) %>% 
#   # Calculate percent of ALC days by caretype/agecluster for each hospital id
#   group_by(year, id) %>% 
#   mutate(hosp.caretype.agecluster.days.percent = hosp.caretype.days / sum(hosp.caretype.days)) %>% 
#   ungroup()

```













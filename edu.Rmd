---
title: "Education"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
source("helpers.R")
```

## TODO List

- Utilization vs travel time
- Recalculate the closest school theory by using travel time


## Import relavent files
```{r Import files, include=FALSE}
# TRESO 
treso_shp <- readOGR(dsn = "input", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("cache/treso_tb.rds")

# TRESO time skim
travel_time_skim_square <- read_csv("input/mf224.csv.gz")

travel_time_skim <- travel_time_skim_square %>%
  melt(id = c("p/q/[val]")) %>%
  rename(orig = "p/q/[val]", dest = variable) %>%
  mutate(orig = as.numeric(orig), dest = as.numeric(levels(dest))[dest])

# Definition files
school_board_def <- read_csv("input/school_board_types.csv")
treso_zone_def <- read.csv("input/treso_zone_system.csv", stringsAsFactors = FALSE)

# Student travel data
student_travel_90 <- readRDS("cache/student_travel_0.9.rds")
student_travel_80 <- readRDS("cache/student_travel_0.8.rds")
student_travel_70 <- readRDS("cache/student_travel_0.7.rds")
student_travel_60 <- readRDS("cache/student_travel_0.6.rds")
student_travel_50 <- readRDS("cache/student_travel_0.5.rds")

# School related data
school_sfis_2017 <- readRDS("cache/school_sfis_2017.rds") %>%
  rename(year = year.x)

# EQAO only has school number which corresponds to BSID
eqao_2017 <- readRDS("cache/eqao_standardized_2017.rds") %>%
  mutate(School.Number = as.character(School.Number)) %>%
  mutate(School.Number = gsub("^0+", "", School.Number)) %>%
  mutate(School.Number = as.integer(School.Number)) %>%
  drop_na(School.Number) %>% # 3 NA schools with not value
  left_join(select(school_sfis_2017, bsid, sfis), by = c("School.Number" = "bsid"))
print(paste0('There are ', length(filter(eqao_2017, is.na(sfis))$sfis), ' schools with unmatching SFIS IDs.'))
eqao_2017 <- drop_na(eqao_2017, sfis)

```

## Summary of School Utilization

- Plot a chart showing the average utilization per DSB and board type.

```{r school utilization}
g <- school_sfis_2017 %>%
  left_join(school_board_def, by = c('dsb.index'='dsb')) %>%
  group_by(dsb.index, panel) %>%
  summarise(
    utilization.total = mean(utilization.total),
    board_type_name = first(board_type_name)
  ) %>%
  ggplot(aes(x = dsb.index, y = utilization.total, fill = board_type_name)) +
  geom_col(position = 'dodge') +
  labs(x = 'DSB', y = 'Average Utilization', fill = 'Board Type') +
  theme_minimal()

g <- ggplotly(g)
g
```


## Find Closest School for each Student

- Get the coordinates for schools and students
- Get the projection from the TRESO shapefile
- Transform the coordinates to use the same projection system as TRESO shapefile

```{r plotting shapefiles, echo = FALSE}
student_xy <- create_student_xy(student_travel_90)
school_xy <- create_school_xy(student_travel_90)

# Convert the SpatialDataframe to normal Dataframe for ggplot()
treso_shp_df <- fortify(treso_shp) %>%
  rename(
    x = long,
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

student_xy_df <- data.frame(student_xy) %>%
  rename(
    x = long,
    y = lat
  )

ggplot() +
  geom_polygon(data = treso_shp_df, mapping = aes(x = x, y = y, group = group),
               fill = 'grey40', color = 'grey90', alpha = 1, size = 0.1) +
  geom_point(data = student_xy_df, mapping = aes(x = x, y = y), color = "red", alpha = 0.1, size = 0.01) +
  geom_point(data = school_xy_df, mapping = aes(x = x, y = y), color = "blue", alpha = 0.1, size = 0.01, shape = 2) +
  labs(x = "", y = "", title = "Students and schools in Ontario") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# ggsave(treso_plot, file = "output/treso_with_points.png", width = 10, height = 10)

# Clean up the global environments
rm(school_xy_df, treso_shp_df, student_xy_df)
```

## Spatial Gymnastics

- Loop and do the following for all catchment distance available
- Using `over()` to determine the treso zone number for each student/school point
- Using `gbuffer()` to determine the treso zones that catchment distance touches for each school
- Setting up the multi-core to do `foreach()` loop is worth it once you are doing more than 100 fields
  - 100 fields: 29s compared to 19s
  - 1000 fields: 252s compared to 116s
- Combine the the datalist of buffered TRESO zones with the tibble containing socio-economic data
- Combine with the historical ADE and utilization data by school

```{r spatial gymnastics, eval = FALSE}
percentile_dist = c('90')
#percentile_dist = c('90', '80', '70', '60', '50')

for (dist in percentile_dist) {
  
  # Loop through the different catchment areas by retriving the proper variable.
  student_travel <- get(paste0("student_travel_",dist))
  
  # Spatial transformation to XY
  student_xy <- create_student_xy(student_travel)
  school_xy <- create_school_xy(student_travel)
  
  # Create the overlays to get the TRESO zone each XY coordinate falls on
  student_overlay <- create_overlay(student_xy, treso_shp, "student")
  saveRDS(student_overlay, paste0("output/student_overlay_", dist, ".rds"))
  school_overlay <- create_overlay(school_xy, treso_shp, "school")
  
  # Join the POR and POS together for distance matrix
  observed_por_pos <- left_join(student_overlay, school_overlay, by = c("school.name", "sfis")) %>%
    saveRDS(paste0("output/observed_por_pos_", dist, ".rds"))
  
  # Save the zones in each school's catchment area
  buffered_df <- buffer_zones(school_xy, treso_shp)
  saveRDS(buffered_df, paste0("output/school_catchment_treso_zones_", dist, ".rds"))
  
  # Combine the school's buffered TRESO zones with socio-economic info and group_by school name
  school_tb <- summarize_buffered_zones(buffered_df, treso_tb, school_sfis_2017, school_board_def, treso_zone_def) %>%
    saveRDS(paste0("output/school_tb_", dist, ".rds"))
}
```

- Test that `gBuffer()` is returning intended results.

```{r test buffer, eval = FALSE, echo = FALSE}
# Select a specific buffer
school_of_interest <- "Holy Trinity CSS"
student_travel <- get("student_travel_90")
student_xy <- create_student_xy(student_travel)
school_xy <- create_school_xy(student_travel)
buffered_points <- gBuffer(school_xy, width = school_xy@data$catchment.dist * 1000, byid = TRUE)
buffer <- buffered_points[buffered_points@data$school.name == school_of_interest, ]

# Get all TRESO zones that touches the buffer with over(), gIntersect() could be another solution
treso_overlay <- over(treso_shp, buffer, returnList = FALSE) %>%
  cbind(treso.id = treso_shp@data$Treso_ID,
        households = treso_shp@data$TotHH,
        persons = treso_shp@data$TotPers) %>%
  as.tibble() %>%
  select(school.name, sfis, dsb.index, catchment.dist, treso.id, households, persons) %>%
  drop_na()

# Select the TRESO zones of interest
treso_zones_interest <- treso_shp[is.element(treso_shp@data$Treso_ID, treso_overlay$treso.id), ] %>%
  fortify() %>%
  rename(
    x = long, 
    y = lat
  )

interst_zones <- treso_overlay

# Convert buffer into df
buffer_df <- fortify(buffer) %>%
  rename(
    x = long, 
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

# Plot the school, buffer and the selected TRESO zones
ggplot() +
  geom_polygon(data = treso_zones_interest, mapping = aes(x = x, y = y, group = group), 
               fill = 'grey40', color = 'grey90', alpha = 1, size = 0.1) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = 'red', color = 'red', alpha = 0.5) +
  geom_point(data = filter(school_xy_df, school.name == school_of_interest), mapping = aes(x = x, y = y), 
               fill = "blue", alpha = 0.5, size = 10) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# Clean up global environment variables
rm(school_of_interest, buffer, treso_overlay, treso_zones_interest, buffer_df, school_xy_df)
```

```{r, echo=FALSE, eval=FALSE}
as_tibble(interst_zones) %>%
  left_join(select(treso_tb, treso_zone, mean_income, mean_age), by = c('treso.id' = 'treso_zone')) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c('dsb.index' = 'dsb')) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c('treso.id' = 'treso_id')) %>%
  replace(is.na(.), 0) %>%
  group_by(sfis) %>%
  summarise(
    mean.income = mean(mean_income),
    mean.age = mean(mean_age),
    dsb.index = first(dsb.index),
    school.name = first(school.name),
    catchment.dist = first(catchment.dist),
    board.type.name = first(board_type_name),
    area = names(which.max(table(area))),
    mof.region = names(which.max(table(mof_region)))
  )
```

## Closest School Theory

- From `student_travel_90`, obtain the travel distance to create a buffer for each student
- Build a buffer with the travel distance and capture any school within that buffer
- Make sure the school is from `school_sfis`
- Calculate the distance to all the schools within its travel distance buffer
  - if no school exist then this student is travelling to closest (labelled 1)
  - if there are schools within this buffer, then the label a value equal in rank (2 - n)

```{r calculate closest school, eval = FALSE, echo = FALSE}
student_xy_90 <- student_travel_90 %>%
  select(sfis, bsid, school.name, school.lat, school.long, dsb.index, panel, enrolment, student.postal.code, student.lat, student.long,
         dist) %>%
  create_student_xy()
school_xy <- create_school_xy(student_travel_90)

student_buffered <- gBuffer(student_xy_90, width = (student_xy_90@data$euclidean.dist * 1000 + 25), byid = TRUE)

  # Start multi-core clustering for performance
  cores = parallel::detectCores()
  cl <- parallel::makeCluster(cores[1] - 1)
  registerDoParallel(cl)
  
  # Progress bar
  registerDoSNOW(cl)
  pb <- txtProgressBar(max = nrow(student_buffered@data), style = 3)
  progress <- function(n) setTxtProgressBar(pb, n)
  opts <- list(progress = progress)
  
  tic('testing sp::over')
  # foreach() loop to find the TRESO zones touching the school buffers
  datalist <- list()
  datalist <- foreach(i = 1:nrow(student_buffered@data), .combine = rbind,
                  .options.snow = opts, .packages=c('sp', 'tidyverse', 'rgeos')) %dopar% {
  # datalist <- foreach(i = 1:10, .combine = rbind, 
  #                 .options.snow = opts, .packages=c('sp', 'tidyverse', 'rgeos')) %dopar% {
    # Select the buffer
    buffer <- student_buffered[student_buffered@data$id == i, ]
    
    #Get all schools that touches the buffer with over()
    school_overlay <- over(school_xy, buffer, returnList = FALSE) %>%
        cbind(overlay.school.name = school_xy@data$school.name,
              overlay.dsb.index = school_xy@data$dsb.index,
              overlay.sfis = school_xy@data$sfis,
              overlay.panel = school_xy@data$panel,
              overlay.coords = school_xy@coords) %>%
        as.tibble() %>%
        drop_na()
    
    # Save each tibble in a list of tibbles
    datalist[[i]] <- school_overlay
  }
  toc()
  close(pb)
  stopCluster(cl)
  
  # Write the datalist to csv
  saveRDS(datalist, 'output/closest_school.rds')
  rm(student_xy_90, student_buffered, datalist)
```


``` {r test closest school, echo = FALSE, eval = FALSE}
TESTID = 200
# Convert buffer into df
buffer_df <- fortify(student_buffered[student_buffered@data$id == TESTID, ]) %>%
  rename(
    x = long, 
    y = lat
  )

student_interest_df <- student_xy_90[is.element(student_xy_90@data$id, TESTID), ] %>%
  data.frame() %>%
  rename(
    x = long,
    y = lat
  )

# Select the schools of interest that exist in the 
school_interest_df <- school_xy[is.element(school_xy@data$sfis, filter(datalist, id == TESTID)$overlay.sfis), ] %>%
  data.frame() %>%
  rename(
    x = long, 
    y = lat
  )

ggplot() +
  geom_point(data = filter(student_interest_df, id == TESTID), mapping = aes(x = x, y = y), 
               color = 'blue', fill = "blue", alpha = 1, size = 3) +
  geom_point(data = school_interest_df, mapping = aes(x = x, y = y), 
               color = 'green', fill = "green", alpha = 1, size = 3) +
  geom_text(data = school_interest_df, aes(x = x, y = y, label = school.name), size = 2) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = 'red', color = 'red', alpha = 0.01) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

rm(buffer_df, student_interest_df, school_interest_df)

```

```{r closest school results, fig.height = 12, fig.width = 10, echo = FALSE}
closest_school <- readRDS('output/closest_school_full.rds') %>%
  left_join(select(school_board_def, dsb, board_type, board_type_name), by = c('dsb.index' = 'dsb')) %>%
  rename(
    board.type = board_type,
    board.type.name = board_type_name
         ) %>%
  left_join(select(school_board_def, dsb, board_type, board_type_name), by = c('overlay.dsb.index' = 'dsb')) %>%
  rename(
    overlay.board.type = board_type,
    overlay.board.type.name = board_type_name
         ) %>%
  filter(panel == as.character(overlay.panel), board.type == overlay.board.type)

closest_school_summary <- closest_school %>%
  group_by(id) %>%
  summarise(
    euclidean.dist = first(euclidean.dist),
    school.name = first(school.name),
    sfis = first(sfis),
    dsb.index = first(dsb.index),
    panel = first(panel),
    enrolment = first(enrolment),
    student.postal.code = first(student.postal.code),
    board.type = first(board.type),
    board.type.name = first(board.type.name),
    num.closer.schools = n()
    )

closest_school_subtotal <- closest_school_summary %>%
  group_by(board.type.name, panel) %>%
  summarise(
    total.students = sum(enrolment)
  )

closest_school_summary %>%
  mutate(num.closer.schools.cuts = cut(num.closer.schools, c(0, 1, 2, 3, 4, Inf), labels = c('1', '2', '3', '4', '5+'))) %>%
  group_by(num.closer.schools.cuts, board.type.name, panel) %>%
  summarise(
    num.students = sum(enrolment)
  ) %>%
  left_join(closest_school_subtotal, by = c('board.type.name', 'panel')) %>%
  mutate(percentage = num.students/total.students) %>%
  mutate(percentage.lable = ifelse(percentage > 0.10, as.character(percent(percentage)), '')) %>%
  saveRDS('output/closest_school_summary.rds')

g <- readRDS('output/closest_school_summary.rds') %>%
  ggplot(aes(x = '', y = percentage, fill = num.closer.schools.cuts)) +
  geom_bar(width = 1, stat = 'identity', position = 'dodge') +
  facet_grid(rows = vars(board.type.name), cols = vars(panel), scales = 'free_y') +
  theme_minimal() + 
  theme(axis.text.x = element_blank()) +
  labs(x = '', y = '', fill = 'Schools within travel distance') +
  ggsave('output/closest_school_summary.png')

ggplotly(g)
```

## Travel Time TLFD plots {.tabset .tabset-fade}

```{r prepare travel time skim, echo = FALSE}
student_overlay_90 <- readRDS("output/student_overlay_90.rds")
student_overlay_80 <- readRDS("output/student_overlay_80.rds")
student_overlay_70 <- readRDS("output/student_overlay_70.rds")
student_overlay_60 <- readRDS("output/student_overlay_60.rds")
student_overlay_50 <- readRDS("output/student_overlay_50.rds")
```

### 90th Percentile plots
```{r tlfd plots for 90th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  # Get the travel time skims
  left_join(travel_time_skim, by=c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  rename(travel.time = value) %>%
  # Get the school board type names
  left_join(select(school_board_def, dsb, board_type_name), by = c('dsb.index' = 'dsb')) %>%
  # Get the MOF regions
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c('treso.id.por' = 'treso_id')) %>%
  # Get the panel information
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  # expand the rows based on enrollment number
  uncount(enrolment)

summary(student_tlfd_90$travel.time)

student_tlfd_90 <- student_tlfd_90 %>%
  # the large zones TRESO zones in the north have unproportional travel time vs travel distance
  # between the student and school
  mutate(euclidean.travel.time = euclidean.dist / 30 * 60) %>%
  mutate(compare.travel.time = travel.time - euclidean.travel.time) %>%
  mutate(travel.time = ifelse(compare.travel.time > 30, euclidean.travel.time, travel.time)) %>%
  # remove intra-zonal trips
  filter(travel.time > 0)

summary(student_tlfd_90$travel.time)

plot_travel_time_tlfd(student_tlfd_90)
```

### 80th Percentile plots
```{r tlfd plots for 80th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_80 <- student_travel_80 %>% 
  select(dsb.index, dist, enrolment, panel, student.postal.code) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c('dsb.index' = 'dsb')) %>%
  left_join(select(student_overlay_80, student.postal.code, treso.id.por), by = "student.postal.code") %>%
  rename(treso.id = treso.id.por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c('treso.id' = 'treso_id')) %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(enrolment)

plot_straight_line_tlfd(student_tlfd_80)
```

### 70th Percentile plots
```{r tlfd plots for 70th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_70 <- student_travel_70 %>% 
  select(dsb.index, dist, enrolment, panel, student.postal.code) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c('dsb.index' = 'dsb')) %>%
  left_join(select(student_overlay_70, student.postal.code, treso.id.por), by = "student.postal.code") %>%
  rename(treso.id = treso.id.por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c('treso.id' = 'treso_id')) %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(enrolment)

plot_straight_line_tlfd(student_tlfd_70)
```

### 50th Percentile plots
```{r tlfd plots for 50th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_50 <- student_travel_50 %>% 
  select(dsb.index, dist, enrolment, panel, student.postal.code) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c('dsb.index' = 'dsb')) %>%
  left_join(select(student_overlay_50, student.postal.code, treso.id.por), by = "student.postal.code") %>%
  rename(treso.id = treso.id.por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c('treso.id' = 'treso_id')) %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(enrolment)


plot_straight_line_tlfd(student_tlfd_50)
```

## Explore Linear Regressions

- Segment the schools by board (at least)
- Build linear regression 
- Explore other segmentations

```{r data exploration}
# Choose the catchment area to explore
school_tb <- readRDS("output/school_tb_90.rds") %>%
  mutate(shape.area_sum = shape.area_sum / 1e6) %>%
  mutate(n_pop_density = n_pop_sum / shape.area_sum) %>%
  mutate(n_sec_pop_density = n_sec_pop_sum / shape.area_sum) %>%
  mutate(n_ele_pop_density = n_ele_pop_sum / shape.area_sum)

# Join with EQAO Scores
school_tb <- left_join(school_tb, select(eqao_2017, sfis, eqao), by = "sfis")

summary(school_tb$ade)
filter(school_tb, is.na(eqao))

g1 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x=ade)) +
  geom_histogram(bins = 50) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = 'free') +
  theme_minimal() +
  labs(x = 'ADE', y = 'Count')

g2 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = catchment.dist, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = 'free') +
  theme_minimal() +
  labs(x = 'Catchment Distance', y = 'ADE')

g3 <- ggplot(filter(school_tb, panel == "Secondary", mof.region == "GTA"), aes(x = n_sec_pop_density, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = 'free') +
  theme_minimal() +
  labs(x = 'Secondary Population Density', y = 'ADE')

g4 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = attend_school_sum, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = 'free') +
  theme_minimal() +
  labs(x = 'Attend School', y = 'ADE')

g5 <- ggplot(filter(school_tb, panel == "Secondary", mof.region == "East"), aes(x = eqao, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = 'free') +
  theme_minimal() +
  labs(x = 'EQAO', y = 'ADE')

ggplotly(g1)
ggplotly(g2)
ggplotly(g3)
ggplotly(g4)
ggplotly(g5)

bufilter(school_tb, mof.region == '0')

```

```{r linear regression, eval = FALSE, echo = FALSE}

# Choose the catchment area to explore
school_tb <- readRDS("output/school_tb_80.rds")

# Join with EQAO Scores
school_tb <- left_join(school_tb, select(eqao_2017, sfis, eqao), by = "sfis")

# Filter the school database down
school_tb_filtered <- filter(school_tb, panel == "Elementary", board.type.name == "English Public", eqao != 0, utilization < 1.5)

# Display schools that has captured a large area and their 2011 ADE
school_tb_filtered %>%
  arrange(desc(utilization)) %>%
  select(school.name.x, utilization, ade)

# Build linear regression dataset with various transformed x, y variables
linreg <- school_tb_filtered %>%
  select(ade, utilization, eqao, starts_with("n_"), starts_with("occu_"), starts_with("deg_"), attend_school_sum, shape.area_sum, mean.income, mean.age) %>%
  mutate(shape.area_sum = shape.area_sum / 1e6) %>%  
  mutate(n_sec_pop_density = n_sec_pop_sum / shape.area_sum) %>%
  mutate(n_ele_pop_density = n_ele_pop_sum / shape.area_sum) %>%
  mutate(n_two_adult_two_child_density = n_two_adult_two_child_sum / shape.area_sum) %>%
  mutate(n_two_adult_one_child_density = n_two_adult_one_child_sum / shape.area_sum) %>%
  mutate_all(
    funs(ln = log1p(.), sqrt = sqrt(.), sq = .^2)
  ) %>%
  mutate(dummy_large_pop = ifelse(n_pop_sum >= 10e+4, 1, 0)) %>%
  bind_cols(select(school_tb_filtered, sfis, school.name.x))

linreg %>%
  select(ade, school.name.x, sfis) %>%
  filter(ade < 100)

# Exploring the data relationships
ggplot(linreg, aes(y = utilization, x = attend_school_sum)) +
  geom_point(alpha = 0.5, color = "#F8766D")

# Fully segment the data
linreg_small <- linreg %>%
  filter(n_sec_pop_density_sqrt < 5)
linreg_large <- linreg %>%
  filter(n_sec_pop_density_sqrt >= 5)

# Build models
mod.small <- lm(utilization ~  eqao, data = linreg_small)
summary(mod.small)
#plot(mod.small)
mod.large <- lm(utilization ~ eqao, data = linreg_large)
summary(mod.large)
#plot(mod.large)
mod <- lm(utilization ~ eqao + n_ele_pop_density, data = linreg)
summary(mod)
plot(mod)
# mod.base <- lm(ade_2011 ~ n_sec_pop_sum_sqrt, data = linreg)
# mod.expand <- lm(ade_2011 ~ n_sec_pop_sum_sqrt + n_ele_pop_sum_sqrt, data = linreg)
# anova(mod.base, mod.expand)
# 
# summary(mod.base)
# summary(mod.expand)
# plot(mod.expand)
```

## Explore Facility Choice - Sampling Procedure

- Implement sampling procedure
  - Create sampling proportions at CSD level for each board type
  - For each TRESO zone, distribute the population of students by board type of CSD
  - Then distribute the students to schools using a composite weight
    - The composite weight comprises the closest school (or second closest, so on) probability, EQAO, and observed TLFD friction
  - Compare the TLFD against observation
  
- There are two version, one is contrained by capacity and another that doesn't have capacity constrains
  
```{r sampling baord type, echo=FALSE, fig.width=10, fig.height=8}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

# Calculate the board type sample for each CSD
board_type_sample <- observed_por_pos_90 %>%
  group_by(csduid, csdname, board_type_name, panel) %>%
  summarise(enrolment.total = sum(enrolment), mof_region = first(mof_region)) %>%
  group_by(csduid, csdname, panel) %>%
  mutate(sample = enrolment.total / sum(enrolment.total))

g1 <- board_type_sample %>%
  mutate(csduid.prefix = str_trunc(csduid, 4, side='right', ellipsis = "")) %>%
  group_by(csduid.prefix, board_type_name, panel) %>%
  summarise(sample = mean(sample), mof_region = first(mof_region)) %>%
  ggplot(aes(x = csduid.prefix, y = sample, fill = board_type_name)) +
  geom_col(position="stack") +
  facet_grid(cols = vars(panel), rows = vars(mof_region), scales = 'free_y') +
  theme_minimal() +
  labs(title = "Average Board Type Sample at CD Level", x = "CD", y = "Porportions", fill = "Board Type")

g1

elementary_board_type_sample_spread <- board_type_sample %>%
  filter(panel == "Elementary") %>%
  spread(key = board_type_name, value = sample) %>%
  replace_na(list(`English Catholic` = 0, `French Catholic` = 0, `English Public` = 0, `French Public` = 0)) %>%
  group_by(csduid, csdname) %>%
  summarise(
    panel = first(panel),
    enrolment.total = sum(enrolment.total),
    `English Catholic` = sum(`English Catholic`, na.rm = TRUE),
    `English Public` = sum(`English Public`, na.rm = TRUE),
    `French Catholic` = sum(`French Catholic`, na.rm = TRUE),
    `French Public` = sum(`French Public`, na.rm = TRUE)
  ) %>%
  mutate(sample.total = sum(`English Catholic`, `English Public`, `French Catholic`, `French Public`))

secondary_board_type_sample_spread <- board_type_sample %>%
  filter(panel == "Secondary") %>%
  spread(key = board_type_name, value = sample) %>%
  replace_na(list(`English Catholic` = 0, `French Catholic` = 0, `English Public` = 0, `French Public` = 0)) %>%
  group_by(csduid, csdname) %>%
  summarise(
    panel = first(panel),
    enrolment.total = sum(enrolment.total),
    `English Catholic` = sum(`English Catholic`, na.rm = TRUE),
    `English Public` = sum(`English Public`, na.rm = TRUE),
    `French Catholic` = sum(`French Catholic`, na.rm = TRUE),
    `French Public` = sum(`French Public`, na.rm = TRUE)
  ) %>%
  mutate(sample.total = sum(`English Catholic`, `English Public`, `French Catholic`, `French Public`))

board_type_sample_spread <- rbind(elementary_board_type_sample_spread, secondary_board_type_sample_spread)

# Get the student data over TRESO zones
treso_level_sampling <- observed_por_pos_90 %>%
  select(treso.id.por, enrolment, panel, csduid) %>%
  left_join(select(board_type_sample_spread, -enrolment.total, -sample.total), by = c("panel", "csduid")) %>%
  group_by(treso.id.por, panel) %>%
  summarise(
    csduid = first(csduid),
    csdname = first(csdname),
    enrolment = sum(enrolment),
    `English Catholic` = mean(`English Catholic`),
    `English Public` = mean(`English Public`),
    `French Catholic` = mean(`French Catholic`),
    `French Public` = mean(`French Public`)
  ) %>%
  # Create probability list for sample
  unite(prob, `English Catholic`, `English Public`, `French Catholic`, `French Public`, sep = ",") %>%
  rowwise() %>%
  mutate(prob = list(as.double(unlist(strsplit(prob, ","))))) %>%
  # Sample the different board types 
  mutate(sample.result = list(sample(c("EC", "EP", "FC", "FP"), size = enrolment, replace = TRUE, prob = prob))) %>%
  mutate(`English Catholic` = sum(sample.result == "EC"),
         `English Public` = sum(sample.result == "EP"),
         `French Catholic` = sum(sample.result == "FC"),
         `French Public` = sum(sample.result == "FP"))

treso_level_sampling_elementary_ep <- filter(treso_level_sampling, panel == "Elementary") %>%
  select(treso.id.por, panel, csduid, csdname, `English Public`)
```

```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}


```




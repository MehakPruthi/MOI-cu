---
title: "edu"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(rgeos)
library(rgdal)
library(sp)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
source("helpers.R")
```


## Import relavent files
```{r Import files, include=FALSE}
# TRESO 
treso_shp <- readOGR(dsn = "input", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("output/treso_tb.rds")

# Definition files
school_board_def <- read_csv("input/school_board_types.csv")
treso_zone_def <- read_csv("input/treso_zone_system.csv")

# Student travel data
student_travel_90 <- readRDS("output/student_travel_0.9.rds")
student_travel_80 <- readRDS("output/student_travel_0.8.rds")
student_travel_70 <- readRDS("output/student_travel_0.7.rds")
student_travel_50 <- readRDS("output/student_travel_0.5.rds")
student_travel_10 <- readRDS("output/student_travel_0.1.rds")

# School's historical ADE
school_ade <- read_csv("input/school_historical_ade.csv")
```

## Data cleaning

- Get the coordinates for schools and students
- Get the projection from the TRESO shapefile
- Transform the coordinates to use the same projection system as TRESO shapefile
- *TODO* get rid of Quebec zones

```{r cleaning and selecting data}
student_xy_90 <- create_student_xy(student_travel_90)
school_xy_90 <- create_school_xy(student_travel_90)
```

- Plot TRESO zones, with school and student 

```{r plotting shapefiles, echo = FALSE}

# Convert the SpatialDataframe to normal Dataframe for ggplot()
treso_shp_df <- fortify(treso_shp) %>%
  rename(
    x = long,
    y = lat
  )

school_xy_df <- data.frame(school_xy_90) %>%
  rename(
    x = long,
    y = lat
  )

student_xy_df <- data.frame(student_xy_90) %>%
  rename(
    x = long,
    y = lat
  )

ggplot() +
  geom_polygon(data = treso_shp_df, mapping = aes(x = x, y = y, group = group), 
               fill = 'grey40', color = 'grey90', alpha = 1, size = 0.1) +
  geom_point(data = student_xy_df, mapping = aes(x = x, y = y), color = "red", alpha = 0.1, size = 0.01) +
  geom_point(data = school_xy_df, mapping = aes(x = x, y = y), color = "blue", alpha = 0.1, size = 0.01, shape = 2) +
  labs(x = "", y = "", title = "Students and schools in Ontario") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# ggsave(treso_plot, file = "output/treso_with_points.png", width = 10, height = 10)

# Clean up the global environments
rm(school_xy_df, treso_shp_df, student_xy_df)
```

## Spatial Gymnastics

- Loop and do the following for all catchment distance available
- Using `over()` to determine the treso zone number for each student/school point
- Using `gbuffer()` to determine the treso zones that catchment distance touches for each school
- Setting up the multi-core to do `foreach()` loop is worth it once you are doing more than 100 fields
  - 100 fields: 29s compared to 19s
  - 1000 fields: 252s compared to 116s
- Combine the the datalist of buffered TRESO zones with the tibble containing socio-economic data
- Combine with the historical ADE and utilization data by school

```{r spatial gymnastics, eval = TRUE, echo = FALSE}
#catchment_dist = c('90', '80', '70', '50')
catchment_dist = c('80')
for (dist in catchment_dist) {
  # Loop through the different catchment areas by retriving the
  # proper variable.
  student_travel <- get(paste0("student_travel_",dist))
  
  # Spatial transformation to XY
  student_xy <- create_student_xy(student_travel)
  school_xy <- create_school_xy(student_travel)
  
  # Create the overlays to get the TRESO zone each XY coordinate falls on
  student_overlay <- create_overlay(student_xy, treso_shp, "student")
  saveRDS(student_overlay, paste0("output/student_overlay_", dist, ".rds"))
  school_overlay <- create_overlay(school_xy, treso_shp, "school")
  
  # Join the POR and POS together for distance matrix
  observed_por_pos <- left_join(student_overlay, school_overlay, by = "school_name") %>%
    saveRDS(paste0("output/observed_por_pos_", dist, ".rds"))
  
  # Save the zones in each school's catchment area
  buffered_df <- buffer_zones(school_xy, treso_shp)
  saveRDS(buffered_df, paste0("output/school_catchment_treso_zones_", dist, ".rds"))
  
  # Combine the school's buffered TRESO zones with socio-economic info and group_by school name
  school_tb <- summarize_buffered_zones(buffered_df, treso_tb, school_ade, school_board_def, treso_zone_def) %>%
    saveRDS(paste0("output/school_tb_", dist, ".rds"))
}
```

- Test that `gBuffer()` is returning intended results.

```{r test buffer, eval = FALSE, echo = FALSE}
# Select a specific buffer
school_of_interest <- "Crolancia Public School"
buffered_points <- gBuffer(school_xy, width = school_xy@data$catchment_dist * 1000, byid = TRUE)
buffer <- buffered_points[buffered_points@data$school_name == school_of_interest, ]

# Get all TRESO zones that touches the buffer with over(), gIntersect() could be another solution
treso_overlay <- over(treso_shp, buffer, returnList = FALSE) %>%
  cbind(treso_id = treso_shp@data$Treso_ID,
        households = treso_shp@data$TotHH,
        persons = treso_shp@data$TotPers) %>%
  as.tibble() %>%
  select(school_name, sfis, dsb, catchment_dist, treso_id, households, persons) %>%
  drop_na()

# Select the TRESO zones of interest
treso_zones_interest <- treso_shp[is.element(treso_shp@data$Treso_ID, treso_overlay$treso_id), ] %>%
  fortify() %>%
  rename(
    x = long, 
    y = lat
  )

interst_zones <- treso_overlay

# Convert buffer into df
buffer_df <- fortify(buffer) %>%
  rename(
    x = long, 
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

# Plot the school, buffer and the selected TRESO zones
ggplot() +
  geom_polygon(data = treso_zones_interest, mapping = aes(x = x, y = y, group = group), 
               fill = 'grey40', color = 'grey90', alpha = 1, size = 0.1) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = 'red', color = 'red', alpha = 0.5) +
  geom_point(data = filter(school_xy_df, school_name == school_of_interest), mapping = aes(x = x, y = y), 
               fill = "blue", alpha = 0.5, size = 10) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# Clean up global environment variables
rm(school_of_interest, buffer, treso_overlay, treso_zones_interest, buffer_df, school_xy_df)
```

## Straight Line TLFD plots {.tabset .tabset-fade}

- Convert this to use the TRESO distance once we obtain the skims. (*need to obtain*)
- Using `uncount()` to convert the enrollment number to individual entries in the tibble

```{r read in the student overlay RDS, echo = FALSE}
# Create overlays for the 90th catchment distance
student_overlay_90 <- readRDS("output/student_overlay_90.rds")
student_overlay_80 <- readRDS("output/student_overlay_80.rds")
student_overlay_70 <- readRDS("output/student_overlay_70.rds")
student_overlay_50 <- readRDS("output/student_overlay_50.rds")
```

### 90th Percentile plots
```{r tlfd plots for 90th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_90 <- student_travel_90 %>% 
  select(DSB_Index, dist, Enrolment, Panel, student_postal_id) %>%
  rename(dsb = DSB_Index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = "dsb") %>%
  left_join(select(student_overlay_90, student_postal_id, treso_id_por), by = "student_postal_id") %>%
  rename(treso_id = treso_id_por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = "treso_id") %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(Enrolment)

plot_straight_line_tlfd(student_tlfd_90)
```

### 80th Percentile plots
```{r tlfd plots for 80th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_80 <- student_travel_80 %>% 
  select(DSB_Index, dist, Enrolment, Panel, student_postal_id) %>%
  rename(dsb = DSB_Index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = "dsb") %>%
  left_join(select(student_overlay_80, student_postal_id, treso_id_por), by = "student_postal_id") %>%
  rename(treso_id = treso_id_por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = "treso_id") %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(Enrolment)

plot_straight_line_tlfd(student_tlfd_80)
```

### 70th Percentile plots
```{r tlfd plots for 70th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_70 <- student_travel_70 %>% 
  select(DSB_Index, dist, Enrolment, Panel, student_postal_id) %>%
  rename(dsb = DSB_Index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = "dsb") %>%
  left_join(select(student_overlay_70, student_postal_id, treso_id_por), by = "student_postal_id") %>%
  rename(treso_id = treso_id_por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = "treso_id") %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(Enrolment)

plot_straight_line_tlfd(student_tlfd_70)
```

### 50th Percentile plots
```{r tlfd plots for 50th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_50 <- student_travel_50 %>% 
  select(DSB_Index, dist, Enrolment, Panel, student_postal_id) %>%
  rename(dsb = DSB_Index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = "dsb") %>%
  left_join(select(student_overlay_50, student_postal_id, treso_id_por), by = "student_postal_id") %>%
  rename(treso_id = treso_id_por) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = "treso_id") %>%
  # MOF Region of NA are Quebec Zones
  filter(mof_region != "NA") %>%
  # expand the rows based on enrollment number
  uncount(Enrolment)


plot_straight_line_tlfd(student_tlfd_50)
```

## Explore Linear Regressions

- Segment the schools by board (at least)
- Build linear regression 
- Explore other segmentations

- *TODO:* check the 0 matched MOF region

```{r linear regression, eval = FALSE, echo = FALSE}

# Choose the catchment area to explore
school_tb <- readRDS("output/school_tb_80.rds")

# Filter the school database down
school_tb_filtered <- filter(school_tb, ade_2011 > 0, panel == "Secondary", board_type_name == "English Public", 
                             mof_region == "GTA")

# Build linear regression data base with various transformed x, y variables
# Consider standardizing the data here.
linreg <- school_tb_filtered %>%
  select(ade_2011, starts_with("n_"), starts_with("occu_"), starts_with("deg_"), attend_school_sum, mean_income, mean_age) %>%
  mutate_all(
    funs(ln = log1p(.), sqrt = sqrt(.), sq = .^2)
  ) %>%
  mutate(dummy_large_pop = ifelse(n_pop_sum >= 1e+5, 1, 0)) %>%
  cbind(select(school_tb_filtered, sfis, school_name))

# Exploring the data relationships
ggplot(linreg, aes(y = ade_2011, x = n_pop_sum)) +
  geom_point(alpha = 0.5, color = "#F8766D")
  #geom_smooth(method = "lm", se = FALSE)

# Fully segment the data
linreg_small <- linreg %>%
  filter(n_pop_sum < 1e+5)

linreg_large <- linreg %>%
  filter(n_pop_sum >= 1e+5)

# Build models
mod.small <- lm(ade_2011 ~ n_sec_pop_sum_sqrt + n_pt_sum_sqrt + n_two_adult_one_child_sum, data = linreg_small)
summary(mod.small)
plot(mod.small)
mod.large <- lm(ade_2011 ~ n_pop_sum_sqrt + n_pt_sum_sqrt + n_one_adult_twoplus_child_sum +
                  n_zero_adult_sum, data = linreg_large)
summary(mod.large)

mod.partial <- lm(ade_2011 ~ n_sec_pop_sum_sqrt + n_pop_sum_sqrt + n_pt_sum_sqrt + n_one_adult_twoplus_child_sum +
                  n_zero_adult_sum + dummy_large_pop, data = linreg)
summary(mod.partial)
# mod.base <- lm(ade_2011 ~ n_sec_pop_sum_sqrt, data = linreg)
# mod.expand <- lm(ade_2011 ~ n_sec_pop_sum_sqrt + n_ele_pop_sum_sqrt, data = linreg)
# anova(mod.base, mod.expand)
# 
# summary(mod.base)
# summary(mod.expand)
# plot(mod.expand)
```



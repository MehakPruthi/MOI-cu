---
title: "Education"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
source("helpers.R")
```

## TODO List

- General Tasks
  - [] Utilization vs travel time
  - [x] Utilization vs EQAO
  - [] Improve Haversine function to mimic manhattan travel
- Gravity Model
  - [x] Calibrate the TLFD curves using $cfunc = k \times t_{ij}^{\alpha} \times e^{ \beta t_{ij}}$
  - [x] 1D distribute the students based on the calibrated cost function and weighting from OTG
  - [x] Distribute TRESO zones with multiple schools based on OTG of schools
  - [x] Fix bug resulting from applying the `smart_round()` function
  - [x] Validate the distributed patterns
- Closest School Model
  - [x] Validate if the distributed patterns matches the observed closest school patterns
  - [x] Apply closest school theory and validate results in terms of assigned ADE and TLFD

```{r Import files, include=FALSE}
# TRESO 
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("cache/treso_tb.rds")

# TRESO time skim
travel_time_skim_square <- read_csv("input/treso/mf224.csv.gz")

travel_time_skim <- travel_time_skim_square %>%
  melt(id = c("p/q/[val]")) %>%
  rename(orig = "p/q/[val]", dest = variable) %>%
  mutate(orig = as.numeric(orig), dest = as.numeric(levels(dest))[dest])

# Definition files
school_board_def <- read_csv("input/edu/school_board_types.csv")
treso_zone_def <- read.csv("input/treso/treso_zone_system.csv", stringsAsFactors = FALSE)

# Student travel data
student_travel_90 <- readRDS("cache/student_travel_0.9.rds")
student_travel_80 <- readRDS("cache/student_travel_0.8.rds")
student_travel_70 <- readRDS("cache/student_travel_0.7.rds")
student_travel_60 <- readRDS("cache/student_travel_0.6.rds")
student_travel_50 <- readRDS("cache/student_travel_0.5.rds")

# School related data
school_sfis_2017 <- readRDS("cache/school_sfis_2017.rds") %>%
  rename(year = year.x)

# EQAO only has school number which corresponds to BSID
eqao_2017 <- readRDS("cache/eqao_standardized_2017.rds") %>%
  mutate(School.Number = as.character(School.Number)) %>%
  mutate(School.Number = gsub("^0+", "", School.Number)) %>%
  mutate(School.Number = as.integer(School.Number)) %>%
  drop_na(School.Number) %>% # 3 NA schools with not value
  left_join(select(school_sfis_2017, bsid, sfis),
            by = c("School.Number" = "bsid"))
print(paste0("There are ", length(filter(eqao_2017, is.na(sfis))$sfis), " schools with unmatching SFIS IDs."))
eqao_2017 <- drop_na(eqao_2017, sfis)

```

## Summary of Education Dataset

- Plot a chart showing the average utilization per DSB and board type.

```{r school utilization}
g <- school_sfis_2017 %>%
  left_join(school_board_def, by = c("dsb.index" = "dsb")) %>%
  group_by(dsb.index, panel) %>%
  summarise(
    utilization = mean(utilization),
    board_type_name = first(board_type_name)
  ) %>%
  ggplot(aes(x = dsb.index, y = utilization, fill = board_type_name)) +
  geom_col(position = "dodge") +
  labs(x = "DSB", y = "Average Utilization", fill = "Board Type") +
  theme_minimal()

g <- ggplotly(g)
g
```

- Plot a map of the entire dataset with students and schools

```{r plotting shapefiles, echo = FALSE}
student_xy <- create_student_xy(student_travel_90)
school_xy <- create_school_xy(student_travel_90)

# Convert the SpatialDataframe to normal Dataframe for ggplot()
treso_shp_df <- fortify(treso_shp) %>%
  rename(
    x = long,
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

student_xy_df <- data.frame(student_xy) %>%
  rename(
    x = long,
    y = lat
  )

ggplot() +
  geom_polygon(data = treso_shp_df, mapping = aes(x = x, y = y, group = group),
               fill = "grey40", color = "grey90", alpha = 1, size = 0.1) +
  geom_point(data = student_xy_df, mapping = aes(x = x, y = y), color = "red", alpha = 0.1, size = 0.01) +
  geom_point(data = school_xy_df, mapping = aes(x = x, y = y), color = "blue", alpha = 0.1, size = 0.01, shape = 2) +
  labs(x = "", y = "", title = "Students and schools in Ontario") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# ggsave(treso_plot, file = "output/treso_with_points.png", width = 10, height = 10)

# Clean up the global environments
rm(school_xy_df, treso_shp_df, student_xy_df)
```

## Obtain socio-economic data for each school

- Loop and do the following for all catchment distances available
- Using `over()` to determine the treso zone number for each student/school point
- Using `gbuffer()` to determine the treso zones that catchment distance touches for each school
- Setting up the multi-core to do `foreach()` loop is worth it once you are doing more than 100 fields
- Combine the the datalist of buffered TRESO zones with the tibble containing socio-economic data
- Combine with the historical ADE and utilization data by school

```{r spatial gymnastics, eval = FALSE}
percentile_dist <- c("90", "80", "70", "60", "50")

for (dist in percentile_dist) {

  # Loop through the different catchment areas by retriving the proper variable.
  student_travel <- get(paste0("student_travel_", dist))

  # Spatial transformation to XY
  student_xy <- create_student_xy(student_travel)
  school_xy <- create_school_xy(student_travel)

  # Create the overlays to get the TRESO zone each XY coordinate falls on
  student_overlay <- create_overlay(student_xy, treso_shp, "student")
  saveRDS(student_overlay, paste0("output/student_overlay_", dist, ".rds"))
  school_overlay <- create_overlay(school_xy, treso_shp, "school")

  # Join the POR and POS together for distance matrix
  observed_por_pos <- left_join(student_overlay, school_overlay, by = c("school.name", "sfis")) %>%
    saveRDS(paste0("output/observed_por_pos_", dist, ".rds"))

  # Save the zones in each school's catchment area
  buffered_df <- buffer_zones(school_xy, treso_shp)
  saveRDS(buffered_df, paste0("output/school_catchment_treso_zones_", dist, ".rds"))

  # Combine the school's buffered TRESO zones with socio-economic info and group_by school name
  school_tb <- summarize_buffered_zones(buffered_df, treso_tb, school_sfis_2017, school_board_def, treso_zone_def) %>%
    saveRDS(paste0("output/school_tb_", dist, ".rds"))
}
```

- Test that `gBuffer()` is returning intended results.

```{r test buffer, eval = FALSE, echo = FALSE}
# Select a specific buffer
school_of_interest <- "Holy Trinity CSS"
student_travel <- get("student_travel_90")
student_xy <- create_student_xy(student_travel)
school_xy <- create_school_xy(student_travel)
buffered_points <- gBuffer(school_xy, width = school_xy@data$catchment.dist * 1000, byid = TRUE)
buffer <- buffered_points[buffered_points@data$school.name == school_of_interest, ]

# Get all TRESO zones that touches the buffer with over(), gIntersect() could be another solution
treso_overlay <- over(treso_shp, buffer, returnList = FALSE) %>%
  cbind(treso.id = treso_shp@data$Treso_ID,
        households = treso_shp@data$TotHH,
        persons = treso_shp@data$TotPers) %>%
  as_tibble() %>%
  select(school.name, sfis, dsb.index, catchment.dist, treso.id, households, persons) %>%
  drop_na()

# Select the TRESO zones of interest
treso_zones_interest <- treso_shp[is.element(treso_shp@data$Treso_ID, treso_overlay$treso.id), ] %>%
  fortify() %>%
  rename(
    x = long,
    y = lat
  )

interst_zones <- treso_overlay

# Convert buffer into df
buffer_df <- fortify(buffer) %>%
  rename(
    x = long,
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

# Plot the school, buffer and the selected TRESO zones
ggplot() +
  geom_polygon(data = treso_zones_interest, mapping = aes(x = x, y = y, group = group),
               fill = "grey40", color = "grey90", alpha = 1, size = 0.1) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = "red", color = "red", alpha = 0.5) +
  geom_point(data = filter(school_xy_df, school.name == school_of_interest), mapping = aes(x = x, y = y),
               fill = "blue", alpha = 0.5, size = 10) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# Clean up global environment variables
rm(school_of_interest, buffer, treso_overlay, treso_zones_interest, buffer_df, school_xy_df)
```

## Closest School Theory

- From `student_travel_90`, obtain the travel distance to create a buffer for each student
- Build a buffer with the travel distance and capture any school within that buffer
- Make sure the school is from `school_sfis`
- Calculate the distance to all the schools within its travel distance buffer
  - if no school exist then this student is travelling to closest (1)
  - if there are schools within this buffer, then the label a value equal in rank (>=2)

```{r calculate closest school, eval = FALSE, echo = FALSE}
student_xy_90 <- student_travel_90 %>%
  select(sfis, bsid, school.name, school.lat, school.long, dsb.index, panel, 
         enrolment, student.postal.code, student.lat, student.long, dist) %>%
  create_student_xy()
school_xy <- create_school_xy(student_travel_90)

student_buffered <- gBuffer(student_xy_90, width = (student_xy_90@data$euclidean.dist * 1000 + 25), byid = TRUE)

  # Start multi-core clustering for performance
  cores <- parallel::detectCores()
  cl <- parallel::makeCluster(cores[1] - 1)
  registerDoParallel(cl)
  
  # Progress bar
  registerDoSNOW(cl)
  pb <- txtProgressBar(max = nrow(student_buffered@data), style = 3)
  progress <- function(n) setTxtProgressBar(pb, n)
  opts <- list(progress = progress)
  
  tic("using sp::over")
  # foreach() loop to find the TRESO zones touching the school buffers
  datalist <- list()
  datalist <- foreach(i = 1:nrow(student_buffered@data), .combine = rbind,
                  .options.snow = opts, .packages=c("sp", "tidyverse", "rgeos")) %dopar% {
    # Select the buffer
    buffer <- student_buffered[student_buffered@data$id == i, ]
    
    #Get all schools that touches the buffer with over()
    school_overlay <- over(school_xy, buffer, returnList = FALSE) %>%
        cbind(overlay.school.name = school_xy@data$school.name,
              overlay.dsb.index = school_xy@data$dsb.index,
              overlay.sfis = school_xy@data$sfis,
              overlay.panel = school_xy@data$panel,
              overlay.coords = school_xy@coords) %>%
        as_tibble() %>%
        drop_na()
    
    # Save each tibble in a list of tibbles
    datalist[[i]] <- school_overlay
  }
  toc()
  close(pb)
  stopCluster(cl)
  
  # Write the datalist to csv
  saveRDS(datalist, "output/closest_school_full.rds")
  rm(student_xy_90, student_buffered, datalist)
```

``` {r test closest school, echo = FALSE, eval = FALSE}
TESTID <- 523550
datalist <- readRDS("output/closest_school_full.rds")
# Convert buffer into df
buffer_df <- fortify(student_buffered[student_buffered@data$id == TESTID, ]) %>%
  rename(
    x = long, 
    y = lat
  )

student_interest_df <- student_xy_90[is.element(student_xy_90@data$id, TESTID), ] %>%
  data.frame() %>%
  rename(
    x = long,
    y = lat
  )

# Select the schools of interest that exist in the 
school_interest_df <- school_xy[is.element(school_xy@data$sfis, filter(datalist, id == TESTID)$overlay.sfis), ] %>%
  data.frame() %>%
  rename(
    x = long, 
    y = lat
  )

school_user_df <- school_xy[school_xy@data$sfis == 16794, ] %>%
  data.frame() %>%
  rename(
    x = long,
    y = lat
  )

ggplot() +
  geom_point(data = filter(student_interest_df, id == TESTID), mapping = aes(x = x, y = y), 
               color = "blue", fill = "blue", alpha = 1, size = 3) +
  geom_point(data = school_interest_df, mapping = aes(x = x, y = y), 
               color = "green", fill = "green", alpha = 1, size = 3) +
  geom_text(data = school_interest_df, aes(x = x, y = y, label = school.name), size = 2) +
  geom_point(data = school_user_df, mapping = aes(x = x, y = y),
             color = "yellow", fill = "yellow", alpha = 1, size = 5) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = "red", color = "red", alpha = 0.01) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

rm(buffer_df, student_interest_df, school_interest_df)

```

```{r closest school results, echo = FALSE}
por_mof <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, student.postal.code) %>%
  mutate(student.postal.code = as.character(student.postal.code)) %>%
  distinct(student.postal.code, .keep_all=TRUE) %>%
  left_join(select(treso_zone_def, treso_id, csdname, mof_region), by = c("treso.id.por" = "treso_id"))

closest_school <- readRDS("output/closest_school_full.rds") %>%
  left_join(select(school_board_def, dsb, board_type, board_type_name), by = c("dsb.index" = "dsb")) %>%
  rename(board.type = board_type,
         board.type.name = board_type_name) %>%
  left_join(select(school_board_def, dsb, board_type, board_type_name), by = c("overlay.dsb.index" = "dsb")) %>%
  rename(overlay.board.type = board_type,
         overlay.board.type.name = board_type_name) %>% 
  filter(panel == as.character(overlay.panel), board.type == overlay.board.type) %>%
  left_join(por_mof, by = "student.postal.code")

closest_school_summary <- closest_school %>%
  group_by(id) %>%
  summarise(
    euclidean.dist = first(euclidean.dist),
    school.name = first(school.name),
    sfis = first(sfis),
    dsb.index = first(dsb.index),
    panel = first(panel),
    enrolment = first(enrolment),
    student.postal.code = first(student.postal.code),
    board.type = first(board.type),
    board.type.name = first(board.type.name),
    mof_region = first(mof_region),
    csdname = first(csdname),
    num.closer.schools = n()
    )

 closest_school_subtotal <- closest_school_summary %>%
   group_by(board.type.name, panel, mof_region, csdname) %>%
   summarise(
     total.students = sum(enrolment)
   )

 closest_school_summary <- closest_school_summary %>%
   mutate(num.closer.schools.cuts = cut(num.closer.schools, c(0, 1, 2, 3, 4, Inf), labels = c("1", "2", "3", "4", "5+"))) %>%
   group_by(num.closer.schools.cuts, board.type.name, panel, mof_region, csdname) %>%
   summarise(
     num.students = sum(enrolment)
   ) %>%
   left_join(closest_school_subtotal, by = c("board.type.name", "panel", "mof_region", "csdname")) %>%
   mutate(percentage = num.students / total.students) %>%
   mutate(percentage.lable = ifelse(percentage > 0.10, as.character(percent(percentage)), "")) %>%
   saveRDS("output/closest_school_summary.rds")

rm(closest_school, closest_school_summary)
```


```{r plot closest school results, fig.height = 12, fig.width = 10, echo=FALSE}
g_subtotal <- readRDS("output/closest_school_summary.rds") %>%
  drop_na(mof_region) %>%
  group_by(board.type.name, panel, mof_region) %>%
    summarise(
      total.students = sum(num.students)
    )

g <- readRDS("output/closest_school_summary.rds") %>%
  drop_na(mof_region) %>%
  group_by(num.closer.schools.cuts, board.type.name, panel, mof_region) %>%
    summarise(
      num.students = sum(num.students)
    ) %>%
  left_join(g_subtotal, by = c("board.type.name", "panel", "mof_region")) %>%
  mutate(percentage = num.students / total.students) %>%
  mutate(segmentation = paste0(panel, "_", board.type.name, "_", mof_region)) %>%
  ggplot(aes(x = "", y = percentage, fill = num.closer.schools.cuts)) +
  geom_bar(width = 1, stat = "identity", position = "dodge") +
  facet_wrap(vars(segmentation), scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  labs(x = "", y = "", fill = "Schools within travel distance") +
  ggsave("output/closest_school_summary.png", height = 12, width = 10, units = "in")

ggplotly(g)

rm(g, g_subtotal)
```

## Travel Time TLFD plots

The intra-zonal travel times from TRESO is 0, this required some extra work to take care of. 
The assumption is intra-zonal trips which are less than or equal to 2.5 km in length
are performed by walking at an average speed of 5 km/hr. 
Intra-zonal trips more than 2.5 km in length are performed by driving at an average speed of 30 km/hr.
Extremely long inter-zonal travel times (greater than 30 min difference between travel time skim and 
euclidean travel time at 30 km/hr) are set to euclidean travel time.

### 90th Percentile plots

```{r tlfd plots for 90th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  # Get the travel time skims
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  rename(travel.time = value) %>%
  # Get the school board type names
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  # Get the MOF regions
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  # Get the panel information
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  # expand the rows based on enrollment number
  uncount(enrolment)

summary(student_tlfd_90$travel.time)

student_tlfd_90 <- student_tlfd_90 %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(travel.time = ifelse(travel.time == 0,
                              euclidean.travel.time,
                              travel.time)) %>%
  mutate(compare.travel.time = travel.time - euclidean.travel.time) %>%
  mutate(travel.time = ifelse(compare.travel.time > 30,
                              euclidean.travel.time,
                              travel.time))

summary(student_tlfd_90$travel.time)

ggsave(file = "output/tlfd_90th_percentile.png", plot_travel_time_tlfd(student_tlfd_90), height = 28, width = 10)
g <- plot_travel_time_tlfd(student_tlfd_90)
plot(g)
```

## Exploration of demand modelling methods {.tabset .tabset-fade}

### Linear Regressions

- Segment the schools by board (at least)
- Build linear regression 
- Explore other segmentations

```{r data exploration, echo=FALSE}
school_tb <- readRDS("output/school_tb_90.rds") %>%
  mutate(shape.area_sum = shape.area_sum / 1e6) %>%
  mutate(n_pop_density = n_pop_sum / shape.area_sum) %>%
  mutate(n_sec_pop_density = n_sec_pop_sum / shape.area_sum) %>%
  mutate(n_ele_pop_density = n_ele_pop_sum / shape.area_sum)

summary(school_tb$ade)

g1 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = ade)) +
  geom_histogram(bins = 50) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "ADE", y = "Count")

g2 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = catchment.dist, y = ade, label = school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "Catchment Distance", y = "ADE")

g3 <- ggplot(filter(school_tb, panel == "Secondary", mof.region == "GTA"), aes(x = n_sec_pop_density, y = ade, label = school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "Secondary Population Density", y = "ADE")

g4 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = attend_school_sum, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "Attend School", y = "ADE")


ggplotly(g1)
ggplotly(g2)
ggplotly(g3)
ggplotly(g4)

```

```{r linear regression, eval = FALSE, echo = FALSE}

# Choose the catchment area to explore
school_tb <- readRDS("output/school_tb_80.rds")

# Join with EQAO Scores
school_tb <- left_join(school_tb, select(eqao_2017, sfis, eqao.standardized), by = "sfis")

# Filter the school database down
school_tb_filtered <- filter(school_tb, panel == "Elementary", board.type.name == "English Public", eqao.standardized != 0, utilization < 1.5)

# Display schools that has captured a large area and their 2011 ADE
school_tb_filtered %>%
  arrange(desc(utilization)) %>%
  select(school.name.x, utilization, ade)


student_tlfd_90_dist <- readRDS("output/observed_por_pos_90.rds") %>%
  drop_na(treso.id.por) %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  rename(travel.time = value) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  uncount(enrolment)%>%
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(travel.time = ifelse(travel.time == 0,
                              euclidean.travel.time,
                              travel.time)) %>%
  mutate(compare.travel.time = travel.time - euclidean.travel.time) %>%
  mutate(travel.time = ifelse(compare.travel.time > 30,
                              euclidean.travel.time,
                              travel.time)) %>%
  group_by(sfis) %>%
  summarise(average.travel.time = mean(travel.time)) 

school_tb_filtered <- left_join(school_tb_filtered, student_tlfd_90_dist, by = "sfis")

# Build linear regression dataset with various transformed x, y variables
linreg <- school_tb_filtered %>%
  select(ade, utilization, eqao.standardized, starts_with("n_"), starts_with("occu_"), starts_with("deg_"), attend_school_sum, shape.area_sum, mean.income, mean.age, average.travel.time) %>%
  mutate(shape.area_sum = shape.area_sum / 1e6) %>%
  mutate(n_pop_density = n_pop_sum / shape.area_sum) %>%
  mutate(n_sec_pop_density = n_sec_pop_sum / shape.area_sum) %>%
  mutate(n_ele_pop_density = n_ele_pop_sum / shape.area_sum) %>%
  mutate(n_two_adult_two_child_density = n_two_adult_two_child_sum / shape.area_sum) %>%
  mutate(n_two_adult_one_child_density = n_two_adult_one_child_sum / shape.area_sum) %>%
  mutate_all(
    funs(ln = log1p(.), sqrt = sqrt(.), sq = .^2)
  ) %>%
  mutate(dummy_large_pop = ifelse(n_pop_sum >= 10e+4, 1, 0)) %>%
  bind_cols(select(school_tb_filtered, sfis, school.name.x))


linreg <- linreg %>%
  select(ade, school.name.x, sfis, average.travel.time, utilization, n_pop_density, eqao.standardized) %>%
  filter(ade < 100)

# Exploring the data relationships
ggplot(linreg, aes(y = utilization, x = attend_school_sum)) +
  geom_point(alpha = 0.5, color = "#F8766D")

# Fully segment the data
linreg_small <- linreg %>%
  filter(n_sec_pop_density_sqrt < 5)
linreg_large <- linreg %>%
  filter(n_sec_pop_density_sqrt >= 5)

# Build models
mod.small <- lm(utilization ~  eqao.standardized, data = linreg_small)
summary(mod.small)
#plot(mod.small)
mod.large <- lm(utilization ~ eqao.standardized, data = linreg_large)
summary(mod.large)
#plot(mod.large)
mod <- lm(ade ~ average.travel.time + n_pop_density, data = linreg)
summary(mod)
plot(mod)
  
# mod.base <- lm(ade_2011 ~ n_sec_pop_sum_sqrt, data = linreg)
# mod.expand <- lm(ade_2011 ~ n_sec_pop_sum_sqrt + n_ele_pop_sum_sqrt, data = linreg)
# anova(mod.base, mod.expand)
# 
# summary(mod.base)
# summary(mod.expand)
# plot(mod.expand)
```

### Gravity model

- Implement sampling procedure
  - Create sampling proportions of stduent board type at the CSD level
  - For each TRESO zone, calculate the students of each board type by applying the sampling proportions
- Calibrate cost functions
  - For each board type, calibrate a cost function that matches the observed TLFD
- Distribution
  - 1D distribute the observed POR to POS using the calibrated cost fuction and OTG as weights
  - Then for each POS, if there are multiple schools further distribute to the individual schools based on EQAO
  - Re-check the distribution with observation and the closest school theory
- There are two versions, one is contrained by capacity and another that doesn't have capacity constrains

The board type sampling proportions are calculated at the CSD level and applied at TRESO level.
  
```{r sampling board type, echo=FALSE, fig.width=10, fig.height=8}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

# Calculate the board type sample for each CSD
board_type_sample <- observed_por_pos_90 %>%
  group_by(csduid, csdname, board_type_name, panel) %>%
  summarise(enrolment.total = sum(enrolment), mof_region = first(mof_region)) %>%
  group_by(csduid, csdname, panel) %>%
  mutate(sample = enrolment.total / sum(enrolment.total))

g1 <- board_type_sample %>%
  mutate(csduid.prefix = str_trunc(csduid, 4, side="right", ellipsis = "")) %>%
  group_by(csduid.prefix, board_type_name, panel) %>%
  summarise(sample = mean(sample), mof_region = first(mof_region)) %>%
  ggplot(aes(x = csduid.prefix, y = sample, fill = board_type_name)) +
  geom_col(position="stack") +
  facet_grid(cols = vars(panel), rows = vars(mof_region), scales = "free_y") +
  theme_minimal() +
  labs(title = "Average Board Type Sample at CD Level", x = "CD", y = "Porportions", fill = "Board Type")

ggplotly(g1)

elementary_board_type_sample_spread <- board_type_sample %>%
  filter(panel == "Elementary") %>%
  spread(key = board_type_name, value = sample) %>%
  replace_na(list(`English Catholic` = 0, `French Catholic` = 0, `English Public` = 0, `French Public` = 0)) %>%
  group_by(csduid, csdname) %>%
  summarise(
    panel = first(panel),
    enrolment.total = sum(enrolment.total),
    `English Catholic` = sum(`English Catholic`, na.rm = TRUE),
    `English Public` = sum(`English Public`, na.rm = TRUE),
    `French Catholic` = sum(`French Catholic`, na.rm = TRUE),
    `French Public` = sum(`French Public`, na.rm = TRUE)
  ) %>%
  mutate(sample.total = sum(`English Catholic`, `English Public`, `French Catholic`, `French Public`))

secondary_board_type_sample_spread <- board_type_sample %>%
  filter(panel == "Secondary") %>%
  spread(key = board_type_name, value = sample) %>%
  replace_na(list(`English Catholic` = 0, `French Catholic` = 0, `English Public` = 0, `French Public` = 0)) %>%
  group_by(csduid, csdname) %>%
  summarise(
    panel = first(panel),
    enrolment.total = sum(enrolment.total),
    `English Catholic` = sum(`English Catholic`, na.rm = TRUE),
    `English Public` = sum(`English Public`, na.rm = TRUE),
    `French Catholic` = sum(`French Catholic`, na.rm = TRUE),
    `French Public` = sum(`French Public`, na.rm = TRUE)
  ) %>%
  mutate(sample.total = sum(`English Catholic`, `English Public`, `French Catholic`, `French Public`))

board_type_sample_spread <- rbind(elementary_board_type_sample_spread, secondary_board_type_sample_spread)

# Apply the board sampling probabilities to the students
treso_level_sampling <- observed_por_pos_90 %>%
  select(treso.id.por, enrolment, panel, csduid) %>%
  left_join(select(board_type_sample_spread, -enrolment.total, -sample.total), by = c("panel", "csduid")) %>%
  group_by(treso.id.por, panel) %>%
  summarise(
    csduid = first(csduid),
    csdname = first(csdname),
    enrolment = sum(enrolment),
    `English Catholic` = mean(`English Catholic`),
    `English Public` = mean(`English Public`),
    `French Catholic` = mean(`French Catholic`),
    `French Public` = mean(`French Public`)
  ) %>%
  # Create probability list for sample
  unite(prob, `English Catholic`, `English Public`, `French Catholic`, `French Public`, sep = ",") %>%
  rowwise() %>%
  mutate(prob = list(as.double(unlist(strsplit(prob, ","))))) %>%
  # Sample the different board types 
  mutate(sample.result = list(sample(c("EC", "EP", "FC", "FP"), size=enrolment, replace=TRUE, prob=prob))) %>%
  mutate(`English Catholic` = sum(sample.result == "EC"),
         `English Public` = sum(sample.result == "EP"),
         `French Catholic` = sum(sample.result == "FC"),
         `French Public` = sum(sample.result == "FP"))

treso_level_sampling_elementary_ep <- filter(treso_level_sampling, panel == "Elementary") %>%
  select(treso.id.por, panel, csduid, csdname, `English Public`, `English Catholic`,
         `French Public`, `French Catholic`)

rm(board_type_sample, elementary_board_type_sample_spread, secondary_board_type_sample_spread, board_type_sample_spread)
```

The TLFD estimation has some assumptions made for intra-zonal travel times and extremely large travel times.

The intra-zonal travel times from TRESO is 0, this requires some extra work to take care of. 
The current assumption is intra-zonal trips which are less than or equal to 2.5 km in length
are performed by walking at an average speed of 5 km/hr. 
Intra-zonal trips more than 2.5 km in length are performed by driving at an average speed of 30 km/hr.
Extremely long inter-zonal travel times (greater than 30 min difference between travel time skim and 
euclidean travel time at 30 km/hr) are set to euclidean travel time.

##### Estimate Friction Function Coefficients

- The estimated `alpha` and `beta` values are saved in .csv file in cache

```{r estimate tlfd friction function, echo=FALSE, eval=FALSE, fig.width=10, fig.height=8}

observed_trips <- read_observed_trips("output/observed_por_pos_90.rds", school_board_def,
                                          treso_zone_def, school_sfis_2017, travel_time_skim,
                                          panel_id = "Elementary", board_id = "English Public")

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips$value * observed_trips$enrolment) / sum(observed_trips$enrolment)
print(paste0("For English Public Elementary, the average travel time to be calibrated to is " , tlfd_obs))

# Setup parameters for the cost function iteration
cost <- select(observed_trips, treso.id.por, treso.id.pos, value)
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1

# Iterate through the alpha and beta
iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  # Calculate the simulated trips
  simulated_trips <- calculate_simulated_trips(observed_trips, cost, alpha, beta)

  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips$value * simulated_trips$enrolment) / sum(simulated_trips$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))

  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
  obs_tlfd <- select(observed_trips, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  join_tlfd <- generate_tlfd(observed_trips, simulated_trips, max_value, bin_size) %>%
    spread(flag, enrolment) %>%
    mutate(max.enrol = pmax(obs, model), min.enrol = pmin(obs, model))
  
  # Calculate the coincidence ratio
  minsum = sum(join_tlfd$min.enrol)
  maxsum = sum(join_tlfd$max.enrol)
  cr = minsum/maxsum
  print(paste0("The CR value for this iteration is ", cr))
}

rm(observed_trips, simulated_trips, obs_tlfd, sim_tlfd, join_tlfd, minsum, maxsum, CR, tlfd_sim, tlfd_obs)

```

#### English Public Elementary

Generate the simulated trips using the estimated `alpha` and `beta` values 

```{r simulate english public elementary trips, eval=FALSE, echo=FALSE}

panel_id = "Elementary"
board_id = "English Public"
max_value = 85
bin_size = 1

observed_trips <- read_observed_trips("output/observed_por_pos_90.rds", school_board_def,
                                          treso_zone_def, school_sfis_2017, travel_time_skim,
                                          panel_id = panel_id, board_id = board_id)

cost <- select(observed_trips, treso.id.por, treso.id.pos, value)

tlfd_parameter <- read_csv("cache/tlfd_parameters.csv")
alpha = filter(tlfd_parameter, panel == panel_id, board_type == board_id)$alpha
beta = filter(tlfd_parameter, panel == panel_id, board_type == board_id)$beta

simulated_trips <- calculate_simulated_trips(observed_trips, cost, alpha=alpha, beta=beta)
combined_tlfd <- generate_tlfd(observed_trips, simulated_trips, max_value, bin_size)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("EP/ELEM - alpha: ", alpha, " beta: ", beta))

# Save the simulated trip list
saveRDS(simulated_trips, "cache/simulated_trips_EPE.rds")
```

1D balance the POR using the calibrated cfunc stored in simulated trips

```{r distribute english public elementary POR}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total <- observed_por_pos_90 %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_EPE <- readRDS("cache/simulated_trips_EPE.rds")

prop_matrix_EPE <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_EPE, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_EPE <- matrix_balancing_1d(prop_matrix_EPE, por_full, pos_full, constrained = TRUE)

# Save the balanced POR-POS trip list
trip_list_EPE <- melt(prop_matrix2_EPE)
colnames(trip_list_EPE) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_EPE, "cache/balanced_trip_list_EPE.rds")
```

Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_EPE <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_EPE <- pos_school_EPE %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_EPE <- left_join(pos_school_EPE, pos_school_weight_EPE, by = "treso.id.pos") %>%
  mutate(school.weight.prob = (otg/otg.total)) 

pos_school_weight_3_EPE <- pos_school_weight_2_EPE %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For English Public Elementary, there are ", nrow(filter(pos_school_weight_3_EPE, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_EPE, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_EPE <- readRDS(paste0("cache/trip_list_EPE.RDS")) %>%
  left_join(pos_school_weight_3_EPE, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_EPE <- by(trip_list_EPE$trips, trip_list_EPE[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_EPE <- sapply(results_EPE, I)
colnames(results2_EPE) <- colnames(prop_matrix2_EPE)
rownames(results2_EPE) <- rownames(prop_matrix2_EPE)

df <- results2_EPE %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_EPE <- bind_cols(trip_list_EPE, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_EPE <- future_apply(trip_list2_EPE, 1, sample_by_row)
results_tb_EPE = t(as.data.table(results_EPE))
trip_list_schools_EPE <- cbind(trip_list2_EPE, results_tb_EPE)

saveRDS(trip_list_schools_EPE, "output/trip_list_schools_EPE.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_EPE <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_EPE <- readRDS("output/trip_list_schools_EPE.rds") %>%
  unnest(results_tb_EPE) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_EPE) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_EPE, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) 
  
avg_perc <- mean(simulated_compare_EPE$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for English Public Elementary schools is ", round(avg_perc, 2)))


simulated_compare_EPE.data <- data.frame("y" = simulated_compare_EPE$rounded_perc_diff, "x" = simulated_compare_EPE$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_EPE$mof_region)
ggplot(data=simulated_compare_EPE.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Elementary - English Public", title="Simulated vs. Observed Demand (2017)") #+


```


#### English Public Secondary

```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_EPS <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Secondary", board_type_name == "English Public") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(compare.travel.time > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_EPS <- select(observed_trips_EPS, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_EPS$value * observed_trips_EPS$enrolment) / sum(observed_trips_EPS$enrolment)
print(paste0("For English Public Secondary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_EPS
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
#initbeta <- -0.13
#initalpha <- 0.52
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_EPS <- select(observed_trips_EPS, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_EPS, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_EPS$value * simulated_trips_EPS$enrolment) / sum(simulated_trips_EPS$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_EPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_EPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_EPS, simulated_trips_EPS, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_EPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_EPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_EPS, simulated_trips_EPS, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("EP/Sec - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_EPS, "cache/simulated_trips_EPS.rds")

#Final Alpha/Beta values
#alpha = 0.167584433695443
#beta = -0.190818394593536
```

2D balance the POR and POS demand using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_EPS <- observed_por_pos_90 %>%
  filter(panel == "Secondary", board_type_name == "English Public") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_EPS, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_EPS <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "English Public") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_EPS, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_EPS <- readRDS("cache/simulated_trips_EPS.rds")

prop_matrix_EPS <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_EPS, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()


prop_matrix2_EPS <- matrix_balancing_1d(prop_matrix_EPS, por_full, pos_full, constrained = TRUE)

```

Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_EPS <- melt(prop_matrix2_EPS)
colnames(trip_list_EPS) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_EPS, "cache/trip_list_EPS.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_EPS <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "English Public") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_EPS <- pos_school_EPS %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_EPS <- left_join(pos_school_EPS, pos_school_weight_EPS, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_EPS <- pos_school_weight_2_EPS %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For English Public Secondary, there are ", nrow(filter(pos_school_weight_3_EPS, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_EPS, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_EPS <- readRDS(paste0("cache/trip_list_EPS.RDS")) %>%
  left_join(pos_school_weight_3_EPS, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_EPS <- by(trip_list_EPS$trips, trip_list_EPS[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_EPS <- sapply(results_EPS, I)
colnames(results2_EPS) <- colnames(prop_matrix2_EPS)
rownames(results2_EPS) <- rownames(prop_matrix2_EPS)  

df <- results2_EPS %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_EPS <- bind_cols(trip_list_EPS, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_EPS <- future_apply(trip_list2_EPS, 1, sample_by_row)
results_tb_EPS = t(as.data.table(results_EPS))
trip_list_schools_EPS <- cbind(trip_list2_EPS, results_tb_EPS)

saveRDS(trip_list_schools_EPS, "output/trip_list_schools_EPS.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_EPS <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Secondary", board_type_name == "English Public") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_EPS <- readRDS("output/trip_list_schools_EPS.rds") %>%
  unnest(results_tb_EPS) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_EPS) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_EPS, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) #%>%
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_EPS$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for English Public Secondary schools is ", round(avg_perc, 2)))


simulated_compare_EPS.data <- data.frame("y" = simulated_compare_EPS$rounded_perc_diff, "x" = simulated_compare_EPS$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_EPS$mof_region)
ggplot(data=simulated_compare_EPS.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Secondary - English Public", title="Simulated vs. Observed Demand (2017)") #+
  #geom_point(data = subset(simulated_compare.data, group=="Central"),
             #aes(x=x, y=y),
             #colour = "red")
  #coord_cartesian(ylim=c(-25,50), xlim=c(-10,50))



```


#### English Catholic Elementary


```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_ECE <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Elementary", board_type_name == "English Catholic") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_ECE <- select(observed_trips_ECE, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_ECE$value * observed_trips_ECE$enrolment) / sum(observed_trips_ECE$enrolment)
print(paste0("For English Catholic Elementary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_ECE
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_ECE <- select(observed_trips_ECE, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_ECE, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_ECE$value * simulated_trips_ECE$enrolment) / sum(simulated_trips_ECE$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_ECE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_ECE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_ECE, simulated_trips_ECE, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_ECE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_ECE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_ECE, simulated_trips_ECE, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("EC/Elem - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_ECE, "cache/simulated_trips_ECE.rds")

#Final Alpha/Beta values
#alpha = 0.0659247802248005
#beta = -0.0911852150695799
#Simulated Average Travel Time: 6.06579317261467
#Observed Average Travel Time: 6.33143548297959
```

2D balance the POR and POS demand using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_ECE <- observed_por_pos_90 %>%
  filter(panel == "Elementary", board_type_name == "English Catholic") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_ECE, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_ECE <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "English Catholic") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_ECE, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_ECE <- readRDS("cache/simulated_trips_ECE.rds")

prop_matrix_ECE <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_ECE, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_ECE <- matrix_balancing_1d(prop_matrix_ECE, por_full, pos_full, constrained = TRUE)

```

Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_ECE <- melt(prop_matrix2_ECE)
colnames(trip_list_ECE) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_ECE, "cache/trip_list_ECE.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_ECE <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "English Catholic") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_ECE <- pos_school_ECE %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_ECE <- left_join(pos_school_ECE, pos_school_weight_ECE, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_ECE <- pos_school_weight_2_ECE %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For English Catholic Elementary, there are ", nrow(filter(pos_school_weight_3_ECE, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_ECE, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_ECE <- readRDS(paste0("cache/trip_list_ECE.RDS")) %>%
  left_join(pos_school_weight_3_ECE, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_ECE <- by(trip_list_ECE$trips, trip_list_ECE[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_ECE <- sapply(results_ECE, I)
colnames(results2_ECE) <- colnames(prop_matrix2_ECE)
rownames(results2_ECE) <- rownames(prop_matrix2_ECE)  

df <- results2_ECE %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_ECE <- bind_cols(trip_list_ECE, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_ECE <- future_apply(trip_list2_ECE, 1, sample_by_row)
results_tb_ECE = t(as.data.table(results_ECE))
trip_list_schools_ECE <- cbind(trip_list2_ECE, results_tb_ECE)

saveRDS(trip_list_schools_ECE, "output/trip_list_schools_ECE.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_ECE <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Elementary", board_type_name == "English Catholic") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_ECE <- readRDS("output/trip_list_schools_ECE.rds") %>%
  unnest(results_tb_ECE) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_ECE) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_ECE, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) #%>%
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_ECE$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for English Catholic Elementary schools is ", round(avg_perc, 2)))


simulated_compare_ECE.data <- data.frame("y" = simulated_compare_ECE$rounded_perc_diff, "x" = simulated_compare_ECE$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_ECE$mof_region)
ggplot(data=simulated_compare_ECE.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Elementary - English Catholic", title="Simulated vs. Observed Demand (2017)") #+
  #geom_point(data = subset(simulated_compare.data, group=="Central"),
             #aes(x=x, y=y),
             #colour = "red")
  #coord_cartesian(ylim=c(-25,50), xlim=c(-10,50))

```



#### English Catholic Secondary


```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_ECS <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Secondary", board_type_name == "English Catholic") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_ECS <- select(observed_trips_ECS, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_ECS$value * observed_trips_ECS$enrolment) / sum(observed_trips_ECS$enrolment)
print(paste0("For English Catholic Secondary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_ECS
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_ECS <- select(observed_trips_ECS, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_ECS, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_ECS$value * simulated_trips_ECS$enrolment) / sum(simulated_trips_ECS$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_ECS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_ECS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_ECS, simulated_trips_ECS, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_ECS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_ECS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_ECS, simulated_trips_ECS, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("EC/Sec - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_ECS, "cache/simulated_trips_ECS.rds")

#Final Alpha/Beta values
#alpha = 0.11935534939959
#beta = -0.178892324060272
#Simulated Average Travel Time: 7.45633466174834
#Observed Average Travel Time: 7.33100370241489
```

1D balance the POR and weight by POS using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_ECS <- observed_por_pos_90 %>%
  filter(panel == "Secondary", board_type_name == "English Catholic") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_ECS, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_ECS <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "English Catholic") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_ECS, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()


simulated_trips_ECS <- readRDS("cache/simulated_trips_ECS.rds")

prop_matrix_ECS <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_ECS, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_ECS <- matrix_balancing_1d(prop_matrix_ECS, por_full, pos_full, constrained = TRUE)

```

Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_ECS <- melt(prop_matrix2_ECS)
colnames(trip_list_ECS) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_ECS, "cache/trip_list_ECS.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_ECS <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "English Catholic") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_ECS <- pos_school_ECS %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_ECS <- left_join(pos_school_ECS, pos_school_weight_ECS, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_ECS <- pos_school_weight_2_ECS %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For English Catholic Secondary, there are ", nrow(filter(pos_school_weight_3_ECS, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_ECS, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_ECS <- readRDS(paste0("cache/trip_list_ECS.RDS")) %>%
  left_join(pos_school_weight_3_ECS, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_ECS <- by(trip_list_ECS$trips, trip_list_ECS[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_ECS <- sapply(results_ECS, I)
colnames(results2_ECS) <- colnames(prop_matrix2_ECS)
rownames(results2_ECS) <- rownames(prop_matrix2_ECS)  

df <- results2_ECS %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_ECS <- bind_cols(trip_list_ECS, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_ECS <- future_apply(trip_list2_ECS, 1, sample_by_row)
results_tb_ECS = t(as.data.table(results_ECS))
trip_list_schools_ECS <- cbind(trip_list2_ECS, results_tb_ECS)

saveRDS(trip_list_schools_ECS, "output/trip_list_schools_ECS.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_ECS <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Secondary", board_type_name == "English Catholic") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_ECS <- readRDS("output/trip_list_schools_ECS.rds") %>%
  unnest(results_tb_ECS) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_ECS) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_ECS, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) #%>%
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_ECS$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for English Catholic Secondary schools is ", round(avg_perc, 2)))


simulated_compare_ECS.data <- data.frame("y" = simulated_compare_ECS$rounded_perc_diff, "x" = simulated_compare_ECS$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_ECS$mof_region)
ggplot(data=simulated_compare_ECS.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  #geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Secondary - English Catholic", title="Simulated vs. Observed Demand (2017)") #+
  #geom_point(data = subset(simulated_compare.data, group=="Central"),
             #aes(x=x, y=y),
             #colour = "red")
  #coord_cartesian(ylim=c(-25,50), xlim=c(-10,50))

```



#### French Public Elementary


```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_FPE <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Elementary", board_type_name == "French Public") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_FPE <- select(observed_trips_FPE, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_FPE$value * observed_trips_FPE$enrolment) / sum(observed_trips_FPE$enrolment)
print(paste0("For French Public Elementary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_FPE
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_FPE <- select(observed_trips_FPE, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_FPE, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_FPE$value * simulated_trips_FPE$enrolment) / sum(simulated_trips_FPE$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_FPE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FPE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_FPE, simulated_trips_FPE, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_FPE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FPE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_FPE, simulated_trips_FPE, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("FP/Elem - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_FPE, "cache/simulated_trips_FPE.rds")

#Final Alpha/Beta values
#alpha = 0.160267956628693
#beta = -0.165874573133361
#CR: 0.945281237301516
#Simulated Average Travel Time: 7.89803976295508
#Observed Average Travel Time: 7.8844979227484
```

1D balance the POR and weight by POS using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_FPE <- observed_por_pos_90 %>%
  filter(panel == "Elementary", board_type_name == "French Public") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_FPE, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_FPE <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "French Public") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_FPE, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_FPE <- readRDS("cache/simulated_trips_FPE.rds")

prop_matrix_FPE <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_FPE, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_FPE <- matrix_balancing_1d(prop_matrix_FPE, por_full, pos_full, constrained = TRUE)


```


Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_FPE <- melt(prop_matrix2_FPE)
colnames(trip_list_FPE) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_FPE, "cache/trip_list_FPE.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_FPE <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "French Public") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_FPE <- pos_school_FPE %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_FPE <- left_join(pos_school_FPE, pos_school_weight_FPE, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_FPE <- pos_school_weight_2_FPE %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For French Public Elementary, there are ", nrow(filter(pos_school_weight_3_FPE, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_FPE, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_FPE <- readRDS(paste0("cache/trip_list_FPE.RDS")) %>%
  left_join(pos_school_weight_3_FPE, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_FPE <- by(trip_list_FPE$trips, trip_list_FPE[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_FPE <- sapply(results_FPE, I)
colnames(results2_FPE) <- colnames(prop_matrix2_FPE)
rownames(results2_FPE) <- rownames(prop_matrix2_FPE)  

df <- results2_FPE %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_FPE <- bind_cols(trip_list_FPE, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_FPE <- future_apply(trip_list2_FPE, 1, sample_by_row)
results_tb_FPE = t(as.data.table(results_FPE))
trip_list_schools_FPE <- cbind(trip_list2_FPE, results_tb_FPE)

saveRDS(trip_list_schools_FPE, "output/trip_list_schools_FPE.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_FPE <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Elementary", board_type_name == "French Public") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_FPE <- readRDS("output/trip_list_schools_FPE.rds") %>%
  unnest(results_tb_FPE) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_FPE) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_FPE, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) %>%
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_FPE$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for French Public Elementary schools is ", round(avg_perc, 2)))

```


#### French Public Secondary


```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_FPS <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Secondary", board_type_name == "French Public") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_FPS <- select(observed_trips_FPS, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_FPS$value * observed_trips_FPS$enrolment) / sum(observed_trips_FPS$enrolment)
print(paste0("For French Public Secondary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_FPS
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_FPS <- select(observed_trips_FPS, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_FPS, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_FPS$value * simulated_trips_FPS$enrolment) / sum(simulated_trips_FPS$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_FPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_FPS, simulated_trips_FPS, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_FPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FPS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_FPS, simulated_trips_FPS, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("FP/Sec - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_FPS, "cache/simulated_trips_FPS.rds")

#Final Alpha/Beta values
#alpha = 0.0772272932157199
#beta = -0.0872442231124019
#CR: 894112110823475
#Simulated Average Travel Time: 11.6171674929108
#Observed Average Travel Time: 12.0141642941271
```

1D balance the POR and weight by POS using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_FPS <- observed_por_pos_90 %>%
  filter(panel == "Secondary", board_type_name == "French Public") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_FPS, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_FPS <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "French Public") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_FPS, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_FPS <- readRDS("cache/simulated_trips_FPS.rds")

prop_matrix_FPS <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_FPS, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_FPS <- matrix_balancing_1d(prop_matrix_FPS, por_full, pos_full, constrained = TRUE)


```

Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_FPS <- melt(prop_matrix2_FPS)
colnames(trip_list_FPS) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_FPS, "cache/trip_list_FPS.rds")
```

Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_FPS <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "French Public") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_FPS <- pos_school_FPS %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_FPS <- left_join(pos_school_FPS, pos_school_weight_FPS, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_FPS <- pos_school_weight_2_FPS %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For French Public Secondary, there are ", nrow(filter(pos_school_weight_3_FPS, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_FPS, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_FPS <- readRDS(paste0("cache/trip_list_FPS.RDS")) %>%
  left_join(pos_school_weight_3_FPS, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_FPS <- by(trip_list_FPS$trips, trip_list_FPS[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_FPS <- sapply(results_FPS, I)
colnames(results2_FPS) <- colnames(prop_matrix2_FPS)
rownames(results2_FPS) <- rownames(prop_matrix2_FPS)  

df <- results2_FPS %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_FPS <- bind_cols(trip_list_FPS, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_FPS <- future_apply(trip_list2_FPS, 1, sample_by_row)
results_tb_FPS = t(as.data.table(results_FPS))
trip_list_schools_FPS <- cbind(trip_list2_FPS, results_tb_FPS)

saveRDS(trip_list_schools_FPS, "output/trip_list_schools_FPS.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_FPS <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Secondary", board_type_name == "French Public") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_FPS <- readRDS("output/trip_list_schools_FPS.rds") %>%
  unnest(results_tb_FPS) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_FPS) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_FPS, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis")
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_FPS$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for French Public Secondary schools is ", round(avg_perc, 2)))


simulated_compare_FPS.data <- data.frame("y" = simulated_compare_FPS$rounded_perc_diff, "x" = simulated_compare_FPS$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_FPS$mof_region)
ggplot(data=simulated_compare_FPS.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Secondary - French Public", title="Simulated vs. Observed Demand (2017)") #+
  #geom_point(data = subset(simulated_compare.data, group=="Central"),
             #aes(x=x, y=y),
             #colour = "red")
  #coord_cartesian(ylim=c(-25,50), xlim=c(-10,50))




```



#### French Catholic Secondary


```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_FCS <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Secondary", board_type_name == "French Catholic") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_FCS <- select(observed_trips_FCS, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_FCS$value * observed_trips_FCS$enrolment) / sum(observed_trips_FCS$enrolment)
print(paste0("For French Catholic Secondary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_FCS
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_FCS <- select(observed_trips_FCS, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_FCS, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_FCS$value * simulated_trips_FCS$enrolment) / sum(simulated_trips_FCS$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_FCS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FCS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_FCS, simulated_trips_FCS, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_FCS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FCS, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_FCS, simulated_trips_FCS, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("FP/Sec - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_FCS, "cache/simulated_trips_FCS.rds")

#Final Alpha/Beta values
#alpha = 0.206351395084993
#beta = -0.157466893361841
#CR: 0.942119770994744
#Simulated Average Travel Time: 10.9024428527545
#Observed Average Travel Time: 10.7673474062775
```

1D balance the POR and weight by POS  using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_FCS <- observed_por_pos_90 %>%
  filter(panel == "Secondary", board_type_name == "French Catholic") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_FCS, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_FCS <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "French Catholic") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_FCS, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_FCS <- readRDS("cache/simulated_trips_FCS.rds")

prop_matrix_FCS <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_FCS, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_FCS <- matrix_balancing_1d(prop_matrix_FCS, por_full, pos_full, constrained = TRUE)


```


Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_FCS <- melt(prop_matrix2_FCS)
colnames(trip_list_FCS) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_FCS, "cache/trip_list_FCS.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_FCS <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Secondary", board_type_name == "French Catholic") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_FCS <- pos_school_FCS %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_FCS <- left_join(pos_school_FCS, pos_school_weight_FCS, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_FCS <- pos_school_weight_2_FCS %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For French Catholic Secondary, there are ", nrow(filter(pos_school_weight_3_FCS, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_FCS, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_FCS <- readRDS(paste0("cache/trip_list_FCS.RDS")) %>%
  left_join(pos_school_weight_3_FCS, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_FCS <- by(trip_list_FCS$trips, trip_list_FCS[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_FCS <- sapply(results_FCS, I)
colnames(results2_FCS) <- colnames(prop_matrix2_FCS)
rownames(results2_FCS) <- rownames(prop_matrix2_FCS)  

df <- results2_FCS %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_FCS <- bind_cols(trip_list_FCS, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_FCS <- future_apply(trip_list2_FCS, 1, sample_by_row)
results_tb_FCS = t(as.data.table(results_FCS))
trip_list_schools_FCS <- cbind(trip_list2_FCS, results_tb_FCS)

saveRDS(trip_list_schools_FCS, "output/trip_list_schools_FCS.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_FCS <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Secondary", board_type_name == "French Catholic") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_FCS <- readRDS("output/trip_list_schools_FCS.rds") %>%
  unnest(results_tb_FCS) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_FCS) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_FCS, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) #%>%
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_FCS$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for French Catholic Secondary schools is ", round(avg_perc, 2)))


simulated_compare_FCS.data <- data.frame("y" = simulated_compare_FCS$rounded_perc_diff, "x" = simulated_compare_FCS$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_FCS$mof_region)
ggplot(data=simulated_compare_FCS.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Secondary - French Catholic", title="Simulated vs. Observed Demand (2017)") #+
  #geom_point(data = subset(simulated_compare.data, group=="Central"),
             #aes(x=x, y=y),
             #colour = "red")
  #coord_cartesian(ylim=c(-25,50), xlim=c(-10,50))


```


#### French Catholic Elementary


```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

# Read in the observed trips, and focus on elementary/EP
# Combine with travel time
observed_trips_FCE <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Elementary", board_type_name == "French Catholic") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select_FCE <- select(observed_trips_FCE, treso.id.por, treso.id.pos, value)

# Calculate observed average trip travel time
tlfd_obs <- sum(observed_trips_FCE$value * observed_trips_FCE$enrolment) / sum(observed_trips_FCE$enrolment)
print(paste0("For French Catholic Elementary, the average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select_FCE
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha
max_value = 85
bin_size = 1


iterations <- 20
for (j in 1:iterations) {
  print(j)
  
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips_FCE <- select(observed_trips_FCE, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select_FCE, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate simulated average trip lengths
  tlfd_sim <- sum(simulated_trips_FCE$value * simulated_trips_FCE$enrolment) / sum(simulated_trips_FCE$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  # Calculate CR Ratio
  
 
   
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
  
    
  obs_tlfd <- select(observed_trips_FCE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FCE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  tlfdjoin <- left_join(sim_tlfd, obs_tlfd, by = "bin")%>%
    replace_na(list(enrolment.x = 0, enrolment.y = 0))%>%
    mutate(max.enrol = pmax(enrolment.x,enrolment.y))%>%
    mutate(min.enrol = pmin(enrolment.x,enrolment.y))
  
  minsum = sum(tlfdjoin$min.enrol)
  
  maxsum = sum(tlfdjoin$max.enrol)
  
  CR = minsum/maxsum
  print(paste0("The CR value for this iteration is ", CR))
  
}

generate_tlfd <- function(observed_trips_FCE, simulated_trips_FCE, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips_FCE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips_FCE, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}


combined_tlfd <- generate_tlfd(observed_trips_FCE, simulated_trips_FCE, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("FP/Elem - alpha: ", alpha, " beta: ", beta))

saveRDS(simulated_trips_FCE, "cache/simulated_trips_FCE.rds")

#Final Alpha/Beta values
#alpha = 0.191978971702315
#beta = -0.138258795875567
#CR: 0.909638134325216
#Simulated Average Travel Time: 8.60672638684763
#Observed Average Travel Time: 8.57841737811264
```

2D balance the POR and POS demand using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

por_total_FCE <- observed_por_pos_90 %>%
  filter(panel == "Elementary", board_type_name == "French Catholic") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total_FCE, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total_FCE <- observed_por_pos_90 %>%
  left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "French Catholic") %>%
  distinct(sfis, treso.id.pos, .keep_all = TRUE) %>%
  group_by(treso.id.pos) %>%
  summarise(otg = sum(otg))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total_FCE, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(otg = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

simulated_trips_FCE <- readRDS("cache/simulated_trips_FCE.rds")

prop_matrix_FCE <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips_FCE, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

prop_matrix2_FCE <- matrix_balancing_1d(prop_matrix_FCE, por_full, pos_full, constrained = TRUE)



```


Save the balanced POR-POS trip list

```{r trip list}
# Save the full matrix as a long trip list
trip_list_FCE <- melt(prop_matrix2_FCE)
colnames(trip_list_FCE) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list_FCE, "cache/trip_list_FCE.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school_FCE <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "French Catholic") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(school_sfis_2017, sfis, otg), by = "sfis") %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE))) 

# get treso zone otg totals
pos_school_weight_FCE <- pos_school_FCE %>%
  group_by(treso.id.pos) %>%
  summarise(otg.total = sum(otg)) 

pos_school_weight_2_FCE <- left_join(pos_school_FCE, pos_school_weight_FCE, by = "treso.id.pos") %>%
  #mutate(school.weight = eqao.standardized * (otg/otg.total)) 
  mutate(school.weight.prob = (otg/otg.total)) 

# get treso zone school.weight totals
# pos_school_weight_3 <- pos_school_weight_2 %>%
#   group_by(treso.id.pos) %>%
#   summarise(school.weight.total = sum(school.weight)) 

pos_school_weight_3_FCE <- pos_school_weight_2_FCE %>%
  #left_join(pos_school_weight_3, by = "treso.id.pos") %>%
  #mutate(school.weight.prob = school.weight/school.weight.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, school.weight.prob) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    school.weight.prob.list = paste(school.weight.prob, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(school.weight.prob.list = list(as.numeric(unlist(strsplit(school.weight.prob.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))
  
print(paste0("For French Catholic Elementary, there are ", nrow(filter(pos_school_weight_3_FCE, length(school.weight.prob.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school_weight_3_FCE, length(school.weight.prob.list) != 1)), " TRESO zones with multiple schools."))

trip_list_FCE <- readRDS(paste0("cache/trip_list_FCE.RDS")) %>%
  left_join(pos_school_weight_3_FCE, by = "treso.id.pos")

# Apply bucket rounding to chunks of data by POS
results_FCE <- by(trip_list_FCE$trips, trip_list_FCE[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2_FCE <- sapply(results_FCE, I)
colnames(results2_FCE) <- colnames(prop_matrix2_FCE)
rownames(results2_FCE) <- rownames(prop_matrix2_FCE)  

df <- results2_FCE %>%
  melt()
colnames(df) <- c('treso.id.por', 'treso.id.pos', 'enrolment.rounded')

trip_list2_FCE <- bind_cols(trip_list_FCE, df) %>%
  filter(enrolment.rounded != 0) %>%
  select(-treso.id.por1, -treso.id.pos1)

plan(multiprocess)
results_FCE <- future_apply(trip_list2_FCE, 1, sample_by_row)
results_tb_FCE = t(as.data.table(results_FCE))
trip_list_schools_FCE <- cbind(trip_list2_FCE, results_tb_FCE)

saveRDS(trip_list_schools_FCE, "output/trip_list_schools_FCE.rds")
```

Compare simulated ADE to Observed ADE by school for gravity model and for closest school prob. result

```{r simulated to observed comparison by school for gravity model}
observed_enrol_FCE <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  filter(panel == "Elementary", board_type_name == "French Catholic") %>%
  group_by(sfis)%>%
  summarise (sum.enrolment = sum(enrolment))

simulated_compare_FCE <- readRDS("output/trip_list_schools_FCE.rds") %>%
  unnest(results_tb_FCE) %>%
  mutate(enrol.value = 1) %>%
  rename(sfis = results_tb_FCE) %>%
  group_by(sfis, school.name.list, dsb.index.ist, treso.id.pos) %>%
  summarise(sim.enrol.sum = sum(enrol.value)) %>%
  left_join(select(observed_enrol_FCE, sfis, sum.enrolment), by = "sfis") %>%
  mutate(sim_enrol.diff_to_ade_2017 = sim.enrol.sum - sum.enrolment)%>%
  mutate(perc_ade_diff = ((sim.enrol.sum - sum.enrolment)/sum.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) #%>%
  # left_join(select(school_sfis_2017, otg, sfis), by = "sfis") %>%
  # mutate(ratio_sim = sim.enrol.sum/otg) %>%
  # mutate(ratio_obs = sum.enrolment/otg) %>%
  # filter(ratio_sim >= 1) %>%
  # filter(ratio_obs <1)
  


avg_perc <- mean(simulated_compare_FCE$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for French Catholic Elementary schools is ", round(avg_perc, 2)))


simulated_compare_FCE.data <- data.frame("y" = simulated_compare_FCE$rounded_perc_diff, "x" = simulated_compare_FCE$sim_enrol.diff_to_ade_2017, "mof_region" = simulated_compare_FCE$mof_region)
ggplot(data=simulated_compare_FCE.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Elementary - French Catholic", title="Simulated vs. Observed Demand (2017)") #+
  #geom_point(data = subset(simulated_compare.data, group=="Central"),
             #aes(x=x, y=y),
             #colour = "red")
  #coord_cartesian(ylim=c(-25,50), xlim=c(-10,50))



```


Validate the assigned trips are matching with known closest scool probability

```{r validate gravity model}
# Review paul's code on obtaining closest school probabilities
# Apply it to the newly assgined POR-POS trip list
```

### Closest School Probability Choice

- Using the closest school probability to assign students to schools
- Examine if the resulting assignment aligns closely with observed ADE as well as OTG constraints
- Assumes the school board and panel is predetermined

```{r applying closest school probability, echo=FALSE, eval=FALSE}
closest_school_summary <- readRDS("output/closest_school_summary.rds") %>%
  group_by(board.type.name, panel, mof_region, csdname) %>%
  summarise(closest.school.list = paste(num.closer.schools.cuts, collapse = ","),
            prob.list = paste(percentage, collapse = ","))

observed_students <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, student.postal.code, enrolment, sfis, dsb.index) %>%
  left_join(select(treso_zone_def, treso_id, mof_region, csdname), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  left_join(closest_school_summary, by = c("board_type_name" = "board.type.name",
                                          "panel", "mof_region", "csdname")) %>%
  # FIXME this is a hotfix for prob.list and closest.school.list being NA (empty)
  # The reason for empty list is the 25 meter added buffer was not enough to capture the
  # actual school it went to. And, filtering to the panel and board.index resulted
  # in no schools in the selection. Therefore, it is most likely students in these
  # segmentations are going to the closest school.
  drop_na(mof_region, prob.list) %>%
  rowwise() %>%
  mutate(prob.list = list(as.numeric(unlist(strsplit(prob.list, ","))))) %>%
  mutate(closest.school.list = list(as.character(unlist(strsplit(closest.school.list, ",")))))

f2 <- function(row) {
  x = row["closest.school.list"][[1]]
  size = row["enrolment"][[1]]
  pc = row["student.postal.code"][[1]]
  sfis = row["sfis"][[1]]
  
  print(paste0("Student Postal Code: ", pc, ". SFIS: ", sfis))
  
  if (length(x) == 1) {
    if (x == "5+") {
      x <- 5
    }
    else {
      x <- as.numeric(x)
    }
    
    prob <- c(rep(0, x-1), row["prob.list"][[1]])
  } 
  else {
    prob <- row["prob.list"][[1]]
  }
  
  list(sample(x, size=size, replace=TRUE, prob=prob))
}

plan(multiprocess)
results <- future_apply(observed_students, 1, f2)
results_tb = t(as.data.table(results))
observed_students <- cbind(observed_students, results_tb)

summary <- observed_students %>%
  rowwise() %>%
  mutate(school.1 = sum(results_tb == "1"),
         school.2 = sum(results_tb == "2"),
         school.3 = sum(results_tb == "3"),
         school.4 = sum(results_tb == "4"),
         school.5 = sum(results_tb == "5+"))

saveRDS(summary, "output/closest_school_theory_applied.RDS")  

```


```{r summarize application, echo=FALSE}
student_lat_long <- student_travel_90 %>%
  select(student.postal.code, student.lat, student.long) %>%
  distinct(student.postal.code, .keep_all = TRUE)

student_to_schools <- readRDS("output/closest_school_theory_applied.RDS") %>%
  select(student.postal.code, school.1, school.2, school.3, school.4, school.5, mof_region, panel, board_type_name) %>%
  group_by(student.postal.code, mof_region, panel, board_type_name) %>%
  summarise_all(list(sum)) %>%
  ungroup() %>%
  mutate(student.postal.code = as.character(student.postal.code)) %>%
  left_join(student_lat_long, by = "student.postal.code") %>%
  mutate(id = row_number())

result_school = data.table()
result_student = data.table()
for (i in c("English Catholic", "English Public", "French Catholic", "French Public")) {
  for (j in c("Elementary", "Secondary")) {
    print(paste0(i, j))
    
    student_xy <- student_to_schools %>%
      filter(board_type_name == i, panel == j)
    coordinates(student_xy) <- c("student.long", "student.lat")
    
    school_xy <- student_travel_90 %>%
      left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
      filter(board_type_name == i, panel == j) %>%
      select(sfis, school.name, school.lat, school.long) %>%
      distinct(sfis, .keep_all=TRUE)
    coordinates(school_xy) <- c("school.long", "school.lat")
    
    nn <- get.knnx(coordinates(school_xy), coordinates(student_xy), k = 5)
    nearest_schools <- nn$nn.index %>%
      as_tibble()

    school_df <- as_tibble(school_xy) %>%
      mutate(index.column = row_number())
    student_df <- as_tibble(student_xy)

    nn_schools_sfis <- nearest_schools %>%
      left_join(select(school_df, index.column, sfis), by=c("V1" = "index.column")) %>%
      rename(sfis.1 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V2" = "index.column")) %>%
      rename(sfis.2 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V3" = "index.column")) %>%
      rename(sfis.3 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V4" = "index.column")) %>%
      rename(sfis.4 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V5" = "index.column")) %>%
      rename(sfis.5 = sfis) %>%
      select(sfis.1, sfis.2, sfis.3, sfis.4, sfis.5)
    
    students_assigned <- cbind(student_df, nn_schools_sfis)
    
    student_1 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.1) %>%
      summarise(enrolment = sum(school.1)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.1)
    student_2 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.2) %>%
      summarise(enrolment = sum(school.2)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.2)
    student_3 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.3) %>%
      summarise(enrolment = sum(school.3)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.3)
    student_4 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.4) %>%
      summarise(enrolment = sum(school.4)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.4)
    student_5 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.5) %>%
      summarise(enrolment = sum(school.5)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.5)
    
    school_1 <- students_assigned %>%
      group_by(sfis.1) %>%
      summarise(enrolment = sum(school.1)) %>%
      rename(sfis = sfis.1)
    school_2 <- students_assigned %>%
      group_by(sfis.2) %>%
      summarise(enrolment = sum(school.2)) %>%
      rename(sfis = sfis.2)
    school_3 <- students_assigned %>%
      group_by(sfis.3) %>%
      summarise(enrolment = sum(school.3)) %>%
      rename(sfis = sfis.3)
    school_4 <- students_assigned %>%
      group_by(sfis.4) %>%
      summarise(enrolment = sum(school.4)) %>%
      rename(sfis = sfis.4)
    school_5 <- students_assigned %>%
      group_by(sfis.5) %>%
      summarise(enrolment = sum(school.5)) %>%
      rename(sfis = sfis.5)
    
    student_total <- rbind(student_1, student_2, student_3, student_4, student_5) %>%
      group_by(student.postal.code, student.lat, student.long, sfis) %>%
      summarise(enrolment.assigned = sum(enrolment)) %>%
      ungroup()
    
    school_total <- rbind(school_1, school_2, school_3, school_4, school_5) %>%
      group_by(sfis) %>%
      summarise(enrolment.assigned = sum(enrolment))
    
    result_student <- rbind(result_student, student_total)
    result_school <- rbind(result_school, school_total)

  }
}

result_student <- result_student %>%
  group_by(student.postal.code, student.lat, student.long, sfis) %>%
  summarise(enrolment.assigned = sum(enrolment.assigned))

observed_enrol <- readRDS("output/observed_por_pos_90.rds") %>%
  group_by(sfis)%>%
  summarise (sum.obs.enrolment = sum(enrolment))

join_table <- readRDS("output/observed_por_pos_90.rds") %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis") ) %>%
  select(sfis, school.name, treso.id.pos, dsb.index, board_type_name, panel) %>%
  group_by(sfis) %>%
  left_join(select(observed_enrol, sum.obs.enrolment, sfis), by = "sfis") %>%
  summarise(school.name = first(school.name), treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index), board_type_name = first(board_type_name), panel = first(panel), sum.obs.enrolment = first(sum.obs.enrolment))


result_school2 <- result_school %>%
  group_by(sfis) %>%
  summarise (enrolment.assigned = sum(enrolment.assigned)) %>%
  left_join(join_table, by = "sfis") %>%
  filter(panel =="Elementary", board_type_name == "French Catholic") %>%
  mutate(closest_school_to_observed_enrol = enrolment.assigned - sum.obs.enrolment)%>%
  mutate(perc_ade_diff = ((enrolment.assigned - sum.obs.enrolment)/sum.obs.enrolment)*100) %>%
  mutate(rounded_perc_diff = round(perc_ade_diff, 2)) %>%
  left_join(select(treso_zone_def, treso_id, mof_region), by = c("treso.id.pos" = "treso_id")) 

avg_perc2 <- mean(result_school2$rounded_perc_diff)

print(paste0("The average percent change between simulated and 2017 observed ADE for French Public Secondary schools is ", round(avg_perc2, 2)))

result_school2.data <- data.frame("y" = result_school2$rounded_perc_diff, "x" = result_school2$closest_school_to_observed_enrol, "mof_region" = result_school2$mof_region)
ggplot(data=result_school2.data) +
  
  geom_hline(yintercept = 0, colour="pink", size=1) + 
  geom_vline(xintercept = 0, colour="pink", size=1) +
  #geom_point(aes(x = x, y = y, colour = mof_region), size = 1.5, alpha = 0.15) +
  geom_point(aes(x = x, y = y), size = 1.5, alpha = 0.15) +
  coord_cartesian(xlim=c(-400,400), ylim=c(-100,100)) +
  #facet_wrap(~ mof_region, scale = "fixed") +
  theme(legend.position = "none") + 
  labs(x="Enrollment Difference (Count)", y="Percent Difference (%)", subtitle="Elementary - French Catholic", title="Closest School vs. Observed Demand (2017)")




```

```{r tlfd of closest school probability}

school_overlay <- readRDS("output/observed_por_pos_90.rds") %>%
  distinct(sfis, school.name, treso.id.pos, dsb.index) %>%
  left_join(select(school_sfis_2017, sfis, school.lat, school.long), by = "sfis")

student_overlay <- readRDS("output/observed_por_pos_90.rds") %>%
  distinct(student.postal.code, treso.id.por) %>%
  mutate(student.postal.code = as.character(student.postal.code))

result_student_tlfd <- result_student %>%
  left_join(school_overlay, by="sfis") %>%
  left_join(student_overlay, by="student.postal.code") %>%
  # There are new POR-POS pairs that did not exist before, need to recalculate euclidean_dist
  mutate(euclidean.dist = haverFunction(student.lat, student.long, school.lat, school.long)) %>%
  # Get the travel time skims
  left_join(travel_time_skim, by=c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  rename(travel.time = value) %>%
  # Get the school board type names
  left_join(select(school_board_def, dsb, board_type_name),
            by = c("dsb.index" = "dsb")) %>%
  # Get the MOF regions
  left_join(select(treso_zone_def, treso_id, area, mof_region),
            by = c("treso.id.por" = "treso_id")) %>%
  # Get the panel information
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  # expand the rows based on enrollment number
  uncount(enrolment.assigned)

summary(result_student_tlfd$travel.time)

result_student_tlfd <- result_student_tlfd %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(travel.time = ifelse(travel.time == 0,
                              euclidean.travel.time,
                              travel.time)) %>%
  mutate(compare.travel.time = travel.time - euclidean.travel.time) %>%
  mutate(travel.time = ifelse(compare.travel.time > 30,
                              euclidean.travel.time,
                              travel.time))

summary(result_student_tlfd$travel.time)

ggsave(file = "output/tlfd_closest_school_probability.png",
       plot_travel_time_tlfd(result_student_tlfd), height = 28, width = 10)

```


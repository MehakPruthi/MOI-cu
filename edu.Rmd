---
title: "Education"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(scales)
library(plotly)
library(rgeos)
library(rgdal)
library(sp)
library(doSNOW)
library(foreach)
library(doParallel)
library(tictoc)
library(gridExtra)
library(future.apply)
library(FNN)
source("helpers.R")
```

## TODO List

- General Tasks
  - [] Utilization vs travel time
  - [x] Utilization vs EQAO
  - [] Recalculate the closest school theory by using travel time
  - [] Improve Haversine function to mimic manhattan travel
- Gravity Model
  - [x] Calibrate the TLFD curves using $cfunc = k \times t_{ij}^{\alpha} \times e^{ \beta t_{ij}}$
  - [x] Distribute the students based on the friction
  - [x] Distribute TRESO zones with multiple schools based on EQAO schools
  - [] Validate the distributed patterns
- Closest School Model
  - [x] Validate if the distributed patterns matches the observed closest school patterns
  - [x] Apply closest school theory and validate results in terms of assigned ADE and TLFD
- Salah
  - test commit

```{r Import files, include=FALSE}
# TRESO 
treso_shp <- readOGR(dsn = "input/treso", layer = "TRESO_Zones_SocioData_Gatineau_LCC")
treso_tb <- readRDS("cache/treso_tb.rds")

# TRESO time skim
travel_time_skim_square <- read_csv("input/treso/mf224.csv.gz")

travel_time_skim <- travel_time_skim_square %>%
  melt(id = c("p/q/[val]")) %>%
  rename(orig = "p/q/[val]", dest = variable) %>%
  mutate(orig = as.numeric(orig), dest = as.numeric(levels(dest))[dest])

# Definition files
school_board_def <- read_csv("input/edu/school_board_types.csv")
treso_zone_def <- read.csv("input/treso/treso_zone_system.csv", stringsAsFactors = FALSE)

# Student travel data
student_travel_90 <- readRDS("cache/student_travel_0.9.rds")
student_travel_80 <- readRDS("cache/student_travel_0.8.rds")
student_travel_70 <- readRDS("cache/student_travel_0.7.rds")
student_travel_60 <- readRDS("cache/student_travel_0.6.rds")
student_travel_50 <- readRDS("cache/student_travel_0.5.rds")

# School related data
school_sfis_2017 <- readRDS("cache/school_sfis_2017.rds") %>%
  rename(year = year.x)

# EQAO only has school number which corresponds to BSID
eqao_2017 <- readRDS("cache/eqao_standardized_2017.rds") %>%
  mutate(School.Number = as.character(School.Number)) %>%
  mutate(School.Number = gsub("^0+", "", School.Number)) %>%
  mutate(School.Number = as.integer(School.Number)) %>%
  drop_na(School.Number) %>% # 3 NA schools with not value
  left_join(select(school_sfis_2017, bsid, sfis),
            by = c("School.Number" = "bsid"))
print(paste0("There are ", length(filter(eqao_2017, is.na(sfis))$sfis), " schools with unmatching SFIS IDs."))
eqao_2017 <- drop_na(eqao_2017, sfis)

```

## Summary of Education Dataset

- Plot a chart showing the average utilization per DSB and board type.

```{r school utilization}
g <- school_sfis_2017 %>%
  left_join(school_board_def, by = c("dsb.index" = "dsb")) %>%
  group_by(dsb.index, panel) %>%
  summarise(
    utilization.total = mean(utilization.total),
    board_type_name = first(board_type_name)
  ) %>%
  ggplot(aes(x = dsb.index, y = utilization.total, fill = board_type_name)) +
  geom_col(position = "dodge") +
  labs(x = "DSB", y = "Average Utilization", fill = "Board Type") +
  theme_minimal()

g <- ggplotly(g)
g
```

- Plot a chart of the entire dataset with students and schools

```{r plotting shapefiles, echo = FALSE}
student_xy <- create_student_xy(student_travel_90)
school_xy <- create_school_xy(student_travel_90)

# Convert the SpatialDataframe to normal Dataframe for ggplot()
treso_shp_df <- fortify(treso_shp) %>%
  rename(
    x = long,
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

student_xy_df <- data.frame(student_xy) %>%
  rename(
    x = long,
    y = lat
  )

ggplot() +
  geom_polygon(data = treso_shp_df, mapping = aes(x = x, y = y, group = group),
               fill = "grey40", color = "grey90", alpha = 1, size = 0.1) +
  geom_point(data = student_xy_df, mapping = aes(x = x, y = y), color = "red", alpha = 0.1, size = 0.01) +
  geom_point(data = school_xy_df, mapping = aes(x = x, y = y), color = "blue", alpha = 0.1, size = 0.01, shape = 2) +
  labs(x = "", y = "", title = "Students and schools in Ontario") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# ggsave(treso_plot, file = "output/treso_with_points.png", width = 10, height = 10)

# Clean up the global environments
rm(school_xy_df, treso_shp_df, student_xy_df)
```

## Obtain socio-economic data for each school

- Loop and do the following for all catchment distances available
- Using `over()` to determine the treso zone number for each student/school point
- Using `gbuffer()` to determine the treso zones that catchment distance touches for each school
- Setting up the multi-core to do `foreach()` loop is worth it once you are doing more than 100 fields
- Combine the the datalist of buffered TRESO zones with the tibble containing socio-economic data
- Combine with the historical ADE and utilization data by school

```{r spatial gymnastics, eval = FALSE}
percentile_dist <- c("90", "80", "70", "60", "50")

for (dist in percentile_dist) {

  # Loop through the different catchment areas by retriving the proper variable.
  student_travel <- get(paste0("student_travel_", dist))

  # Spatial transformation to XY
  student_xy <- create_student_xy(student_travel)
  school_xy <- create_school_xy(student_travel)

  # Create the overlays to get the TRESO zone each XY coordinate falls on
  student_overlay <- create_overlay(student_xy, treso_shp, "student")
  saveRDS(student_overlay, paste0("output/student_overlay_", dist, ".rds"))
  school_overlay <- create_overlay(school_xy, treso_shp, "school")

  # Join the POR and POS together for distance matrix
  observed_por_pos <- left_join(student_overlay, school_overlay, by = c("school.name", "sfis")) %>%
    saveRDS(paste0("output/observed_por_pos_", dist, ".rds"))

  # Save the zones in each school's catchment area
  buffered_df <- buffer_zones(school_xy, treso_shp)
  saveRDS(buffered_df, paste0("output/school_catchment_treso_zones_", dist, ".rds"))

  # Combine the school's buffered TRESO zones with socio-economic info and group_by school name
  school_tb <- summarize_buffered_zones(buffered_df, treso_tb, school_sfis_2017, school_board_def, treso_zone_def) %>%
    saveRDS(paste0("output/school_tb_", dist, ".rds"))
}
```

- Test that `gBuffer()` is returning intended results.

```{r test buffer, eval = FALSE, echo = FALSE}
# Select a specific buffer
school_of_interest <- "Holy Trinity CSS"
student_travel <- get("student_travel_90")
student_xy <- create_student_xy(student_travel)
school_xy <- create_school_xy(student_travel)
buffered_points <- gBuffer(school_xy, width = school_xy@data$catchment.dist * 1000, byid = TRUE)
buffer <- buffered_points[buffered_points@data$school.name == school_of_interest, ]

# Get all TRESO zones that touches the buffer with over(), gIntersect() could be another solution
treso_overlay <- over(treso_shp, buffer, returnList = FALSE) %>%
  cbind(treso.id = treso_shp@data$Treso_ID,
        households = treso_shp@data$TotHH,
        persons = treso_shp@data$TotPers) %>%
  as_tibble() %>%
  select(school.name, sfis, dsb.index, catchment.dist, treso.id, households, persons) %>%
  drop_na()

# Select the TRESO zones of interest
treso_zones_interest <- treso_shp[is.element(treso_shp@data$Treso_ID, treso_overlay$treso.id), ] %>%
  fortify() %>%
  rename(
    x = long,
    y = lat
  )

interst_zones <- treso_overlay

# Convert buffer into df
buffer_df <- fortify(buffer) %>%
  rename(
    x = long,
    y = lat
  )

school_xy_df <- data.frame(school_xy) %>%
  rename(
    x = long,
    y = lat
  )

# Plot the school, buffer and the selected TRESO zones
ggplot() +
  geom_polygon(data = treso_zones_interest, mapping = aes(x = x, y = y, group = group),
               fill = "grey40", color = "grey90", alpha = 1, size = 0.1) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = "red", color = "red", alpha = 0.5) +
  geom_point(data = filter(school_xy_df, school.name == school_of_interest), mapping = aes(x = x, y = y),
               fill = "blue", alpha = 0.5, size = 10) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

# Clean up global environment variables
rm(school_of_interest, buffer, treso_overlay, treso_zones_interest, buffer_df, school_xy_df)
```

## Closest School Theory

- From `student_travel_90`, obtain the travel distance to create a buffer for each student
- Build a buffer with the travel distance and capture any school within that buffer
- Make sure the school is from `school_sfis`
- Calculate the distance to all the schools within its travel distance buffer
  - if no school exist then this student is travelling to closest (labelled 1)
  - if there are schools within this buffer, then the label a value equal in rank (2 - n)

```{r calculate closest school, eval = FALSE, echo = FALSE}
student_xy_90 <- student_travel_90 %>%
  select(sfis, bsid, school.name, school.lat, school.long, dsb.index, panel, 
         enrolment, student.postal.code, student.lat, student.long, dist) %>%
  create_student_xy()
school_xy <- create_school_xy(student_travel_90)

student_buffered <- gBuffer(student_xy_90, width = (student_xy_90@data$euclidean.dist * 1000 + 25), byid = TRUE)

  # Start multi-core clustering for performance
  cores <- parallel::detectCores()
  cl <- parallel::makeCluster(cores[1] - 1)
  registerDoParallel(cl)
  
  # Progress bar
  registerDoSNOW(cl)
  pb <- txtProgressBar(max = nrow(student_buffered@data), style = 3)
  progress <- function(n) setTxtProgressBar(pb, n)
  opts <- list(progress = progress)
  
  tic("using sp::over")
  # foreach() loop to find the TRESO zones touching the school buffers
  datalist <- list()
  datalist <- foreach(i = 1:nrow(student_buffered@data), .combine = rbind,
                  .options.snow = opts, .packages=c("sp", "tidyverse", "rgeos")) %dopar% {
  # datalist <- foreach(i = 1:10, .combine = rbind, 
  #                 .options.snow = opts, .packages=c("sp", "tidyverse", "rgeos")) %dopar% {
    # Select the buffer
    buffer <- student_buffered[student_buffered@data$id == i, ]
    
    #Get all schools that touches the buffer with over()
    school_overlay <- over(school_xy, buffer, returnList = FALSE) %>%
        cbind(overlay.school.name = school_xy@data$school.name,
              overlay.dsb.index = school_xy@data$dsb.index,
              overlay.sfis = school_xy@data$sfis,
              overlay.panel = school_xy@data$panel,
              overlay.coords = school_xy@coords) %>%
        as_tibble() %>%
        drop_na()
    
    # Save each tibble in a list of tibbles
    datalist[[i]] <- school_overlay
  }
  toc()
  close(pb)
  stopCluster(cl)
  
  # Write the datalist to csv
  saveRDS(datalist, "output/closest_school_full.rds")
  rm(student_xy_90, student_buffered, datalist)
```

``` {r test closest school, echo = FALSE, eval = FALSE}
TESTID <- 523550
datalist <- readRDS("output/closest_school_full.rds")
# Convert buffer into df
buffer_df <- fortify(student_buffered[student_buffered@data$id == TESTID, ]) %>%
  rename(
    x = long, 
    y = lat
  )

student_interest_df <- student_xy_90[is.element(student_xy_90@data$id, TESTID), ] %>%
  data.frame() %>%
  rename(
    x = long,
    y = lat
  )

# Select the schools of interest that exist in the 
school_interest_df <- school_xy[is.element(school_xy@data$sfis, filter(datalist, id == TESTID)$overlay.sfis), ] %>%
  data.frame() %>%
  rename(
    x = long, 
    y = lat
  )

school_user_df <- school_xy[school_xy@data$sfis == 16794, ] %>%
  data.frame() %>%
  rename(
    x = long,
    y = lat
  )

ggplot() +
  geom_point(data = filter(student_interest_df, id == TESTID), mapping = aes(x = x, y = y), 
               color = "blue", fill = "blue", alpha = 1, size = 3) +
  geom_point(data = school_interest_df, mapping = aes(x = x, y = y), 
               color = "green", fill = "green", alpha = 1, size = 3) +
  geom_text(data = school_interest_df, aes(x = x, y = y, label = school.name), size = 2) +
  geom_point(data = school_user_df, mapping = aes(x = x, y = y),
             color = "yellow", fill = "yellow", alpha = 1, size = 5) +
  geom_polygon(data = buffer_df, mapping = aes(x = x, y = y, group = group),
               fill = "red", color = "red", alpha = 0.01) +
  labs(x = "", y = "", title = "Test Buffer") +
  theme(plot.title = element_text(lineheight = 0.8, face = "bold", vjust = 1)) +
  coord_equal(ratio = 1)

rm(buffer_df, student_interest_df, school_interest_df)

```

```{r closest school results, echo = FALSE}
por_mof <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, student.postal.code) %>%
  mutate(student.postal.code = as.character(student.postal.code)) %>%
  distinct(student.postal.code, .keep_all=TRUE) %>%
  left_join(select(treso_zone_def, treso_id, csdname, mof_region), by = c("treso.id.por" = "treso_id"))

closest_school <- readRDS("output/closest_school_full.rds") %>%
  left_join(select(school_board_def, dsb, board_type, board_type_name), by = c("dsb.index" = "dsb")) %>%
  rename(board.type = board_type,
         board.type.name = board_type_name) %>%
  left_join(select(school_board_def, dsb, board_type, board_type_name), by = c("overlay.dsb.index" = "dsb")) %>%
  rename(overlay.board.type = board_type,
         overlay.board.type.name = board_type_name) %>% 
  filter(panel == as.character(overlay.panel), board.type == overlay.board.type) %>%
  left_join(por_mof, by = "student.postal.code")

closest_school_summary <- closest_school %>%
  group_by(id) %>%
  summarise(
    euclidean.dist = first(euclidean.dist),
    school.name = first(school.name),
    sfis = first(sfis),
    dsb.index = first(dsb.index),
    panel = first(panel),
    enrolment = first(enrolment),
    student.postal.code = first(student.postal.code),
    board.type = first(board.type),
    board.type.name = first(board.type.name),
    mof_region = first(mof_region),
    csdname = first(csdname),
    num.closer.schools = n()
    )

closest_school_subtotal <- closest_school_summary %>%
  group_by(board.type.name, panel, mof_region, csdname) %>%
  summarise(
    total.students = sum(enrolment)
  )

closest_school_summary %>%
  mutate(num.closer.schools.cuts = cut(num.closer.schools, c(0, 1, 2, 3, 4, Inf), labels = c("1", "2", "3", "4", "5+"))) %>%
  group_by(num.closer.schools.cuts, board.type.name, panel, mof_region, csdname) %>%
  summarise(
    num.students = sum(enrolment)
  ) %>%
  left_join(closest_school_subtotal, by = c("board.type.name", "panel", "mof_region", "csdname")) %>%
  mutate(percentage = num.students / total.students) %>%
  mutate(percentage.lable = ifelse(percentage > 0.10, as.character(percent(percentage)), "")) %>%
  saveRDS("output/closest_school_summary.rds")

rm(closest_school, closest_school_summary, school_mof)
```

```{r plot closest school results, fig.height = 12, fig.width = 10, echo=FALSE}
g_subtotal <- readRDS("output/closest_school_summary.rds") %>%
  drop_na(mof_region) %>%
  group_by(board.type.name, panel, mof_region) %>%
    summarise(
      total.students = sum(num.students)
    )

g <- readRDS("output/closest_school_summary.rds") %>%
  drop_na(mof_region) %>%
  group_by(num.closer.schools.cuts, board.type.name, panel, mof_region) %>%
    summarise(
      num.students = sum(num.students)
    ) %>%
  left_join(g_subtotal, by = c("board.type.name", "panel", "mof_region")) %>%
  mutate(percentage = num.students / total.students) %>%
  mutate(segmentation = paste0(panel, "_", board.type.name, "_", mof_region)) %>%
  ggplot(aes(x = "", y = percentage, fill = num.closer.schools.cuts)) +
  geom_bar(width = 1, stat = "identity", position = "dodge") +
  facet_wrap(vars(segmentation), scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  labs(x = "", y = "", fill = "Schools within travel distance") +
  ggsave("output/closest_school_summary.png", height = 12, width = 10, units = "in")

ggplotly(g)

rm(g, g_subtotal)
```

## Travel Time TLFD plots

The intra-zonal travel times from TRESO is 0, this required some extra work to take care of. 
The current assumption is intra-zonal trips which are less than or equal to 2.5 km in length
are performed by walking at an average speed of 5 km/hr. 
Intra-zonal trips more than 2.5 km in length are performed by driving at an average speed of 30 km/hr.
Extremely long inter-zonal travel times (greater than 30 min difference between travel time skim and 
euclidean travel time at 30 km/hr) are set to euclidean travel time.

### 90th Percentile plots

```{r tlfd plots for 90th percentile, fig.width = 10, fig.height = 28, echo = FALSE}
student_tlfd_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  # Get the travel time skims
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  rename(travel.time = value) %>%
  # Get the school board type names
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  # Get the MOF regions
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  # Get the panel information
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  # expand the rows based on enrollment number
  uncount(enrolment)

summary(student_tlfd_90$travel.time)

student_tlfd_90 <- student_tlfd_90 %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(travel.time = ifelse(travel.time == 0,
                              euclidean.travel.time,
                              travel.time)) %>%
  mutate(compare.travel.time = travel.time - euclidean.travel.time) %>%
  mutate(travel.time = ifelse(compare.travel.time > 30,
                              euclidean.travel.time,
                              travel.time))

summary(student_tlfd_90$travel.time)

#ggsave(file = "output/tlfd_90th_percentile.png", plot_travel_time_tlfd(student_tlfd_90), height = 28, width = 10)
g <- plot_travel_time_tlfd(student_tlfd_90)
plot(g)
```

## Exploration of demand modelling methods {.tabset .tabset-fade}

### Linear Regressions

- Segment the schools by board (at least)
- Build linear regression 
- Explore other segmentations

```{r data exploration}
# Choose the catchment area to explore
school_tb <- readRDS("output/school_tb_90.rds") %>%
  mutate(shape.area_sum = shape.area_sum / 1e6) %>%
  mutate(n_pop_density = n_pop_sum / shape.area_sum) %>%
  mutate(n_sec_pop_density = n_sec_pop_sum / shape.area_sum) %>%
  mutate(n_ele_pop_density = n_ele_pop_sum / shape.area_sum)

# Join with EQAO Scores
school_tb <- left_join(school_tb, select(eqao_2017, sfis, eqao.standardized), by = "sfis") %>%
  filter(is.na(eqao.standardized))
summary(school_tb$ade)

g1 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = ade)) +
  geom_histogram(bins = 50) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "ADE", y = "Count")

g2 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = catchment.dist, y = ade, label = school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "Catchment Distance", y = "ADE")

g3 <- ggplot(filter(school_tb, panel == "Secondary", mof.region == "GTA"), aes(x = n_sec_pop_density, y = ade, label = school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "Secondary Population Density", y = "ADE")

g4 <- ggplot(filter(school_tb, panel == "Secondary"), aes(x = attend_school_sum, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "Attend School", y = "ADE")

g5 <- ggplot(filter(school_tb, panel == "Secondary", mof.region == "East"), aes(x = eqao.standardized, y = ade, label=school.name.x)) +
  geom_point(alpha = 0.5) +
  facet_grid(rows = vars(mof.region), cols = vars(board.type.name), scales = "free") +
  theme_minimal() +
  labs(x = "EQAO", y = "ADE")

ggplotly(g1)
ggplotly(g2)
ggplotly(g3)
ggplotly(g4)
ggplotly(g5)

```

```{r linear regression, eval = FALSE, echo = FALSE}

# Choose the catchment area to explore
school_tb <- readRDS("output/school_tb_80.rds")

# Join with EQAO Scores
school_tb <- left_join(school_tb, select(eqao_2017, sfis, eqao), by = "sfis")

# Filter the school database down
school_tb_filtered <- filter(school_tb, panel == "Elementary", board.type.name == "English Public", eqao != 0, utilization < 1.5)

# Display schools that has captured a large area and their 2011 ADE
school_tb_filtered %>%
  arrange(desc(utilization)) %>%
  select(school.name.x, utilization, ade)

# Build linear regression dataset with various transformed x, y variables
linreg <- school_tb_filtered %>%
  select(ade, utilization, eqao, starts_with("n_"), starts_with("occu_"), starts_with("deg_"), attend_school_sum, shape.area_sum, mean.income, mean.age) %>%
  mutate(shape.area_sum = shape.area_sum / 1e6) %>%
  mutate(n_sec_pop_density = n_sec_pop_sum / shape.area_sum) %>%
  mutate(n_ele_pop_density = n_ele_pop_sum / shape.area_sum) %>%
  mutate(n_two_adult_two_child_density = n_two_adult_two_child_sum / shape.area_sum) %>%
  mutate(n_two_adult_one_child_density = n_two_adult_one_child_sum / shape.area_sum) %>%
  mutate_all(
    funs(ln = log1p(.), sqrt = sqrt(.), sq = .^2)
  ) %>%
  mutate(dummy_large_pop = ifelse(n_pop_sum >= 10e+4, 1, 0)) %>%
  bind_cols(select(school_tb_filtered, sfis, school.name.x))

linreg %>%
  select(ade, school.name.x, sfis) %>%
  filter(ade < 100)

# Exploring the data relationships
ggplot(linreg, aes(y = utilization, x = attend_school_sum)) +
  geom_point(alpha = 0.5, color = "#F8766D")

# Fully segment the data
linreg_small <- linreg %>%
  filter(n_sec_pop_density_sqrt < 5)
linreg_large <- linreg %>%
  filter(n_sec_pop_density_sqrt >= 5)

# Build models
mod.small <- lm(utilization ~  eqao, data = linreg_small)
summary(mod.small)
#plot(mod.small)
mod.large <- lm(utilization ~ eqao, data = linreg_large)
summary(mod.large)
#plot(mod.large)
mod <- lm(utilization ~ eqao + n_ele_pop_density, data = linreg)
summary(mod)
plot(mod)
# mod.base <- lm(ade_2011 ~ n_sec_pop_sum_sqrt, data = linreg)
# mod.expand <- lm(ade_2011 ~ n_sec_pop_sum_sqrt + n_ele_pop_sum_sqrt, data = linreg)
# anova(mod.base, mod.expand)
# 
# summary(mod.base)
# summary(mod.expand)
# plot(mod.expand)
```

### Gravity model

- Implement sampling procedure
  - Create sampling proportions at CSD level for each board type
  - For each TRESO zone, distribute the population of students by board type of CSD
  - Then for each board type, distribute the POR to POS using TLFD (This may require a K factor to calibrate)
  - Then for each POS, distribute to the individual schools based on EQAO and OTG
  - Re-check the probability of closest school theory
- There are two versions, one is contrained by capacity and another that doesn't have capacity constrains

The board type sampling procedure is calculated at the CSD level.
  
```{r sampling board type, echo=FALSE, fig.width=10, fig.height=8}
observed_por_pos_90 <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, treso.id.pos, school.name, sfis, enrolment, dsb.index) %>%
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, csduid, csdname, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = c("sfis"))

# Calculate the board type sample for each CSD
board_type_sample <- observed_por_pos_90 %>%
  group_by(csduid, csdname, board_type_name, panel) %>%
  summarise(enrolment.total = sum(enrolment), mof_region = first(mof_region)) %>%
  group_by(csduid, csdname, panel) %>%
  mutate(sample = enrolment.total / sum(enrolment.total))

g1 <- board_type_sample %>%
  mutate(csduid.prefix = str_trunc(csduid, 4, side="right", ellipsis = "")) %>%
  group_by(csduid.prefix, board_type_name, panel) %>%
  summarise(sample = mean(sample), mof_region = first(mof_region)) %>%
  ggplot(aes(x = csduid.prefix, y = sample, fill = board_type_name)) +
  geom_col(position="stack") +
  facet_grid(cols = vars(panel), rows = vars(mof_region), scales = "free_y") +
  theme_minimal() +
  labs(title = "Average Board Type Sample at CD Level", x = "CD", y = "Porportions", fill = "Board Type")

ggplotly(g1)

elementary_board_type_sample_spread <- board_type_sample %>%
  filter(panel == "Elementary") %>%
  spread(key = board_type_name, value = sample) %>%
  replace_na(list(`English Catholic` = 0, `French Catholic` = 0, `English Public` = 0, `French Public` = 0)) %>%
  group_by(csduid, csdname) %>%
  summarise(
    panel = first(panel),
    enrolment.total = sum(enrolment.total),
    `English Catholic` = sum(`English Catholic`, na.rm = TRUE),
    `English Public` = sum(`English Public`, na.rm = TRUE),
    `French Catholic` = sum(`French Catholic`, na.rm = TRUE),
    `French Public` = sum(`French Public`, na.rm = TRUE)
  ) %>%
  mutate(sample.total = sum(`English Catholic`, `English Public`, `French Catholic`, `French Public`))

secondary_board_type_sample_spread <- board_type_sample %>%
  filter(panel == "Secondary") %>%
  spread(key = board_type_name, value = sample) %>%
  replace_na(list(`English Catholic` = 0, `French Catholic` = 0, `English Public` = 0, `French Public` = 0)) %>%
  group_by(csduid, csdname) %>%
  summarise(
    panel = first(panel),
    enrolment.total = sum(enrolment.total),
    `English Catholic` = sum(`English Catholic`, na.rm = TRUE),
    `English Public` = sum(`English Public`, na.rm = TRUE),
    `French Catholic` = sum(`French Catholic`, na.rm = TRUE),
    `French Public` = sum(`French Public`, na.rm = TRUE)
  ) %>%
  mutate(sample.total = sum(`English Catholic`, `English Public`, `French Catholic`, `French Public`))

board_type_sample_spread <- rbind(elementary_board_type_sample_spread, secondary_board_type_sample_spread)

# Get the student data over TRESO zones
treso_level_sampling <- observed_por_pos_90 %>%
  select(treso.id.por, enrolment, panel, csduid) %>%
  left_join(select(board_type_sample_spread, -enrolment.total, -sample.total), by = c("panel", "csduid")) %>%
  group_by(treso.id.por, panel) %>%
  summarise(
    csduid = first(csduid),
    csdname = first(csdname),
    enrolment = sum(enrolment),
    `English Catholic` = mean(`English Catholic`),
    `English Public` = mean(`English Public`),
    `French Catholic` = mean(`French Catholic`),
    `French Public` = mean(`French Public`)
  ) %>%
  # Create probability list for sample
  unite(prob, `English Catholic`, `English Public`, `French Catholic`, `French Public`, sep = ",") %>%
  rowwise() %>%
  mutate(prob = list(as.double(unlist(strsplit(prob, ","))))) %>%
  # Sample the different board types 
  mutate(sample.result = list(sample(c("EC", "EP", "FC", "FP"), size=enrolment, replace=TRUE, prob=prob))) %>%
  mutate(`English Catholic` = sum(sample.result == "EC"),
         `English Public` = sum(sample.result == "EP"),
         `French Catholic` = sum(sample.result == "FC"),
         `French Public` = sum(sample.result == "FP"))

treso_level_sampling_elementary_ep <- filter(treso_level_sampling, panel == "Elementary") %>%
  select(treso.id.por, panel, csduid, csdname, `English Public`, `English Catholic`,
         `French Public`, `French Catholic`)
```

The TLFD estimation includes some assumptions made for intra-zonal travel times and extremely large travel times.

The intra-zonal travel times from TRESO is 0, this requires some extra work to take care of. 
The current assumption is intra-zonal trips which are less than or equal to 2.5 km in length
are performed by walking at an average speed of 5 km/hr. 
Intra-zonal trips more than 2.5 km in length are performed by driving at an average speed of 30 km/hr.
Extremely long inter-zonal travel times (greater than 30 min difference between travel time skim and 
euclidean travel time at 30 km/hr) are set to euclidean travel time.

```{r estimate tlfd friction function, echo=FALSE, fig.width=10, fig.height=8}

generate_tlfd <- function(observed_trips, simulated_trips, max_value=85, bin_size=1) {
  obs_tlfd <- select(observed_trips, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "obs")
  
  sim_tlfd <- select(simulated_trips, treso.id.por, treso.id.pos, enrolment, value) %>%
    mutate(bin = cut(value, seq(0, max_value, bin_size), labels = seq(bin_size, max_value, bin_size))) %>%
    group_by(bin) %>%
    summarise(enrolment = sum(enrolment)) %>%
    transform(., flag = "model")
  
  # Combine into one dataframe and plot TLFD
  combined_tlfd <- rbind(obs_tlfd, sim_tlfd)
  return(combined_tlfd)
}

# Read in the observed trips, and focus on elementary/GTA/Ep
# Combine with travel time
observed_trips <- readRDS("output/observed_por_pos_90.rds") %>%
  # Drop NAs in POR, it didn't overlay on the TRESO shapefile
  drop_na(treso.id.por) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(treso_zone_def, treso_id, area, mof_region), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  left_join(travel_time_skim, by = c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(value = ifelse(value == 0,
                        euclidean.travel.time,
                        value)) %>%
  mutate(compare.travel.time = value - euclidean.travel.time) %>%
  mutate(value = ifelse(value > 30,
                        euclidean.travel.time,
                        value)) %>%
  group_by(treso.id.por, treso.id.pos) %>%
  summarise(value = weighted.mean(value, enrolment),
            euclidean.dist = weighted.mean(euclidean.dist, enrolment),
            enrolment = sum(enrolment))

travel_time_skim_select <- select(observed_trips, treso.id.por, treso.id.pos, value)

# Calculate observed average trip lengths
tlfd_obs <- sum(observed_trips$value * observed_trips$enrolment) / sum(observed_trips$enrolment)
print(paste0("The average travel time to be calibrated to is " , tlfd_obs))
  
cost <- travel_time_skim_select
initbeta <- -1/log(sum(cost$value)) - runif(1)/10
initalpha <- 1/log(sum(cost$value)) + runif(1)/10
beta <- initbeta
alpha <- initalpha

iterations <- 12
for (j in 1:iterations) {
  print(j)
  cfunc <- cost %>%
    mutate(value = value^alpha * exp(beta*value)) %>%
    replace_na(value = 0)
  
  cfunc_rowsums <- cfunc %>%
    group_by(treso.id.por) %>%
    summarise(rowsum = sum(value))
  
  t <- left_join(cfunc, cfunc_rowsums, by = "treso.id.por") %>%
    mutate(prob_scaled = value / rowsum) %>%
    select(treso.id.por, treso.id.pos, prob_scaled)
  
  simulated_trips <- select(observed_trips, treso.id.por, enrolment, value) %>%
    group_by(treso.id.por) %>%
    summarise(enrolment = sum(enrolment)) %>%
    left_join(t, by = "treso.id.por") %>%
    mutate(enrolment = enrolment * prob_scaled) %>%
    left_join(travel_time_skim_select, by = c("treso.id.por", "treso.id.pos"))
  
  # Calculate observed average trip lengths
  tlfd_sim <- sum(simulated_trips$value * simulated_trips$enrolment) / sum(simulated_trips$enrolment)
  print(paste0("The average travel time of simulated is " , tlfd_sim))
  
  if (j %% 2 == 0) {
    alpha <- alpha * (tlfd_sim/tlfd_obs)
    print(paste0("The alpha value in this iteriation of the combined function is ", alpha))
  } else {
    beta <- beta * (tlfd_sim/tlfd_obs)
    print(paste0("The beta value in this iteriation of the combined function is ", beta))
  }
}

combined_tlfd <- generate_tlfd(observed_trips, simulated_trips, 85, 1)

ggplot(data=combined_tlfd, aes(x=bin, y=enrolment, group=flag, color=flag)) +
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle(paste0("EP/ELEM - alpha: ", alpha, " beta: ", beta))

simulated_trips %>%
  saveRDS(paste0("cache/simulated_trips.rds"))
```

2D balance the POR and POS demand using the calibrated cfunc stored in simulated trips

```{r distribute POR and POS}
por_total <- observed_por_pos_90 %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  group_by(treso.id.por) %>%
  summarise(enrolment = sum(enrolment))

por_full <- travel_time_skim %>%
  distinct(orig) %>%
  left_join(por_total, by = c("orig" = "treso.id.por")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

pos_total <- observed_por_pos_90 %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  group_by(treso.id.pos) %>%
  summarise(enrolment = sum(enrolment))

pos_full <- travel_time_skim %>%
  distinct(dest) %>%
  left_join(pos_total, by = c("dest" = "treso.id.pos")) %>%
  replace_na(list(enrolment = 0)) %>%
  column_to_rownames(var = "dest") %>%
  data.matrix()

prop_matrix <- travel_time_skim %>%
  mutate(value = 0.0001) %>%
  left_join(select(simulated_trips, treso.id.por, treso.id.pos, enrolment),
            by = c("orig" = "treso.id.por", "dest" = "treso.id.pos")) %>%
  mutate(value = ifelse(is.na(enrolment), value, enrolment)) %>%
  select(-enrolment) %>%
  spread(key = dest, value=value) %>%
  column_to_rownames(var = "orig") %>%
  data.matrix()

balance <- function(matrix, tot, axis) {
  if (axis == 1) {
      sum <- rowSums(matrix)
  } else if (axis == 2) {
      sum <- colSums(matrix)
  }
  sc <- tot / sum 
  sc[is.nan(sc)] <- 0

  
  # MARGIN = 1 indicates rows, MARGIN = 2 indicates columns
  matrix2 <- sweep(matrix, MARGIN = axis, sc, `*`)
  return(matrix2)
}

calc_error <- function(matrix, a, b) {
  row_sum <- sum(abs(a - rowSums(matrix)))
  col_sum <- sum(abs(b - colSums(matrix)))
  return(row_sum + col_sum)
}

rel_error = 0.001
max_iterations = 1000


matrix_balancing <- function(matrix, a, b, max_iterations = 10000, rel_error = 0.0001) {
  error <- 1.0
  i <- 0
  init_error <- calc_error(matrix, a, b)
  matrix2 <- matrix
  
  while (error > rel_error) {
    if (i > max_iterations) {
      print("Matrix balancing did not converge within iteration limit")
      break
    }
    matrix2 <- balance(matrix2, a, 1)
    matrix2 <- balance(matrix2, b, 2)
    error <- calc_error(matrix2, a, b) / init_error
    i <- i + 1
  }
  return(matrix2)
}

prop_matrix2 <- matrix_balancing(prop_matrix, por_full, pos_full, 1000, 0.001)

```

```{r timing}
sum <- rowSums(prop_matrix)
sc <- por_full / sum
sc <- as.vector(sc)


Rprof(tmp <- tempfile(),interval = 0.001)
t(t(prop_matrix2) * sc) # first option
Rprof()
MyTimerTranspose=summaryRprof(tmp)$sampling.time
unlink(tmp)

Rprof(tmp <- tempfile(),interval = 0.001)
sweep(prop_matrix2, MARGIN = 1, sc, `*`) # sweep option
Rprof()
MyTimerSweep=summaryRprof(tmp)$sampling.time
unlink(tmp)
```

Obtain the balanced POR-POS trip list

```{r trip list}
trip_list <- melt(prop_matrix2) %>%
  filter(value != 0)
colnames(trip_list) <- c('treso.id.por', 'treso.id.pos', 'trips')

saveRDS(trip_list, "cache/trip_list.rds")
```
Distribute each the POS demand to the individual schools

```{r distribute POS demand} 
pos_school <- select(observed_por_pos_90, school.name, sfis, treso.id.pos, dsb.index) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  filter(panel == "Elementary", board_type_name == "English Public") %>%
  group_by(sfis, school.name) %>%
  summarise(treso.id.pos = first(treso.id.pos), dsb.index = first(dsb.index)) %>%
  left_join(select(eqao_2017, eqao.standardized, sfis), by = "sfis") %>%
  mutate(eqao.standardized = replace_na(eqao.standardized, mean(.$eqao.standardized, na.rm=TRUE)))

pos_school_weight <- pos_school %>%
  group_by(treso.id.pos) %>%
  summarise(eqao.total = sum(eqao.standardized))

pos_school <- left_join(pos_school, pos_school_weight, by = "treso.id.pos") %>%
  mutate(eqao.weight = eqao.standardized / eqao.total) %>%
  select(treso.id.pos, sfis, school.name, dsb.index, eqao.weight) %>%
  group_by(treso.id.pos) %>%
  summarise(
    sfis.list = paste(sfis, collapse = ","),
    school.name.list = paste(school.name, collapse = ","),
    dsb.index.ist = paste(dsb.index, collapse = ","),
    eqao.weight.list = paste(eqao.weight, collapse = ",")
  ) %>%
  rowwise() %>%
  mutate(eqao.weight.list = list(as.numeric(unlist(strsplit(eqao.weight.list, ","))))) %>%
  mutate(sfis.list = list(as.numeric(unlist(strsplit(sfis.list, ",")))))

print(paste0("There are ", nrow(filter(pos_school, length(eqao.weight.list) == 1)), " TRESO zones with a single school, and ", nrow(filter(pos_school, length(eqao.weight.list) != 1)), " TRESO zones with multiple schools."))

trip_list <- readRDS(paste0("cache/trip_list.RDS")) %>%
  left_join(pos_school, by = "treso.id.pos")

# TODO there is some error here.
# Apply bucket rounding to chunks of data by POS
results <- by(trip_list$trips, trip_list[c("treso.id.pos")], smart_round, simplify = TRUE)

# Convert the output of by() to a dataframe
results2 <- t(sapply(results, I))
df <- data.frame(t(as.data.frame(results2)))
colnames(df) <- "trips.rounded"
df2 <- unnest(df, trips.rounded)

trip_list2 <- arrange(trip_list, treso.id.pos) %>%
  cbind(df2)

plan(multiprocess)
results <- future_apply(trip_list2, 1, sample_by_row)
results_tb = t(as.data.table(results))
trip_list_schools <- cbind(trip_list2, results_tb)
```

### Closest School Probability Choice

- Using the closest school probability to assign students to schools
- Examine if the resulting assignment aligns closely with observed ADE as well as OTG constraints
- Assumes the school board and panel is predetermined

```{r applying closest school probability, echo=FALSE, eval=FALSE}
closest_school_summary <- readRDS("output/closest_school_summary.rds") %>%
  group_by(board.type.name, panel, mof_region, csdname) %>%
  summarise(closest.school.list = paste(num.closer.schools.cuts, collapse = ","),
            prob.list = paste(percentage, collapse = ","))

observed_students <- readRDS("output/observed_por_pos_90.rds") %>%
  select(treso.id.por, student.postal.code, enrolment, sfis, dsb.index) %>%
  left_join(select(treso_zone_def, treso_id, mof_region, csdname), by = c("treso.id.por" = "treso_id")) %>%
  left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  left_join(closest_school_summary, by = c("board_type_name" = "board.type.name",
                                          "panel", "mof_region", "csdname")) %>%
  # FIXME this is a hotfix for prob.list and closest.school.list being NA (empty)
  # The reason for empty list is the 25 meter added buffer was not enough to capture the
  # actual school it went to. And, filtering to the panel and board.index resulted
  # in no schools in the selection. Therefore, it is most likely students in these
  # segmentations are going to the closest school.
  drop_na(mof_region, prob.list) %>%
  rowwise() %>%
  mutate(prob.list = list(as.numeric(unlist(strsplit(prob.list, ","))))) %>%
  mutate(closest.school.list = list(as.character(unlist(strsplit(closest.school.list, ",")))))

f2 <- function(row) {
  x = row["closest.school.list"][[1]]
  size = row["enrolment"][[1]]
  pc = row["student.postal.code"][[1]]
  sfis = row["sfis"][[1]]
  
  print(paste0("Student Postal Code: ", pc, ". SFIS: ", sfis))
  
  if (length(x) == 1) {
    if (x == "5+") {
      x <- 5
    }
    else {
      x <- as.numeric(x)
    }
    
    prob <- c(rep(0, x-1), row["prob.list"][[1]])
  } 
  else {
    prob <- row["prob.list"][[1]]
  }
  
  list(sample(x, size=size, replace=TRUE, prob=prob))
}

plan(multiprocess)
results <- future_apply(observed_students, 1, f2)
results_tb = t(as.data.table(results))
observed_students <- cbind(observed_students, results_tb)

summary <- observed_students %>%
  rowwise() %>%
  mutate(school.1 = sum(results_tb == "1"),
         school.2 = sum(results_tb == "2"),
         school.3 = sum(results_tb == "3"),
         school.4 = sum(results_tb == "4"),
         school.5 = sum(results_tb == "5+"))

saveRDS(summary, "output/closest_school_theory_applied.RDS")  

```


```{r summarize application, echo=FALSE}
student_lat_long <- student_travel_90 %>%
  select(student.postal.code, student.lat, student.long) %>%
  distinct(student.postal.code, .keep_all = TRUE)

student_to_schools <- readRDS("output/closest_school_theory_applied.RDS") %>%
  select(student.postal.code, school.1, school.2, school.3, school.4, school.5, mof_region, panel, board_type_name) %>%
  group_by(student.postal.code, mof_region, panel, board_type_name) %>%
  summarise_all(list(sum)) %>%
  ungroup() %>%
  mutate(student.postal.code = as.character(student.postal.code)) %>%
  left_join(student_lat_long, by = "student.postal.code") %>%
  mutate(id = row_number())

result_school = data.table()
result_student = data.table()
for (i in c("English Catholic", "English Public", "French Catholic", "French Public")) {
  for (j in c("Elementary", "Secondary")) {
    print(paste0(i, j))
    
    student_xy <- student_to_schools %>%
      filter(board_type_name == i, panel == j)
    coordinates(student_xy) <- c("student.long", "student.lat")
    
    school_xy <- student_travel_90 %>%
      left_join(select(school_board_def, dsb, board_type_name), by = c("dsb.index" = "dsb")) %>%
      filter(board_type_name == i, panel == j) %>%
      select(sfis, school.name, school.lat, school.long) %>%
      distinct(sfis, .keep_all=TRUE)
    coordinates(school_xy) <- c("school.long", "school.lat")
    
    nn <- get.knnx(coordinates(school_xy), coordinates(student_xy), k = 5)
    nearest_schools <- nn$nn.index %>%
      as_tibble()

    school_df <- as_tibble(school_xy) %>%
      mutate(index.column = row_number())
    student_df <- as_tibble(student_xy)

    nn_schools_sfis <- nearest_schools %>%
      left_join(select(school_df, index.column, sfis), by=c("V1" = "index.column")) %>%
      rename(sfis.1 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V2" = "index.column")) %>%
      rename(sfis.2 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V3" = "index.column")) %>%
      rename(sfis.3 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V4" = "index.column")) %>%
      rename(sfis.4 = sfis) %>%
      left_join(select(school_df, index.column, sfis), by=c("V5" = "index.column")) %>%
      rename(sfis.5 = sfis) %>%
      select(sfis.1, sfis.2, sfis.3, sfis.4, sfis.5)
    
    students_assigned <- cbind(student_df, nn_schools_sfis)
    
    student_1 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.1) %>%
      summarise(enrolment = sum(school.1)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.1)
    student_2 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.2) %>%
      summarise(enrolment = sum(school.2)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.2)
    student_3 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.3) %>%
      summarise(enrolment = sum(school.3)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.3)
    student_4 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.4) %>%
      summarise(enrolment = sum(school.4)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.4)
    student_5 <- students_assigned %>%
      group_by(student.postal.code, student.lat, student.long, sfis.5) %>%
      summarise(enrolment = sum(school.5)) %>%
      filter(enrolment > 0) %>%
      ungroup() %>%
      rename(sfis = sfis.5)
    
    school_1 <- students_assigned %>%
      group_by(sfis.1) %>%
      summarise(enrolment = sum(school.1)) %>%
      rename(sfis = sfis.1)
    school_2 <- students_assigned %>%
      group_by(sfis.2) %>%
      summarise(enrolment = sum(school.2)) %>%
      rename(sfis = sfis.2)
    school_3 <- students_assigned %>%
      group_by(sfis.3) %>%
      summarise(enrolment = sum(school.3)) %>%
      rename(sfis = sfis.3)
    school_4 <- students_assigned %>%
      group_by(sfis.4) %>%
      summarise(enrolment = sum(school.4)) %>%
      rename(sfis = sfis.4)
    school_5 <- students_assigned %>%
      group_by(sfis.5) %>%
      summarise(enrolment = sum(school.5)) %>%
      rename(sfis = sfis.5)
    
    student_total <- rbind(student_1, student_2, student_3, student_4, student_5) %>%
      group_by(student.postal.code, student.lat, student.long, sfis) %>%
      summarise(enrolment.assigned = sum(enrolment)) %>%
      ungroup()
    
    school_total <- rbind(school_1, school_2, school_3, school_4, school_5) %>%
      group_by(sfis) %>%
      summarise(enrolment.assigned = sum(enrolment))
    
    result_student <- rbind(result_student, student_total)
    result_school <- rbind(result_school, school_total)

  }
}

result_student <- result_student %>%
  group_by(student.postal.code, student.lat, student.long, sfis) %>%
  summarise(enrolment.assigned = sum(enrolment.assigned))

result_school <- result_school %>%
  group_by(sfis) %>%
  summarise(enrolment.assigned = sum(enrolment.assigned)) %>%
  right_join(school_sfis_2017, by = "sfis") %>%
  select(panel, sfis, school.name, otg, ade, enrolment.assigned) %>%
  mutate(ade.difference = ade - enrolment.assigned)

summary(result_school$ade.difference)
sd(result_school$ade.difference, na.rm = TRUE)
```

```{r tlfd of closest school probability}

school_overlay <- readRDS("output/observed_por_pos_90.rds") %>%
  distinct(sfis, school.name, treso.id.pos, dsb.index) %>%
  left_join(select(school_sfis_2017, sfis, school.lat, school.long), by = "sfis")

student_overlay <- readRDS("output/observed_por_pos_90.rds") %>%
  distinct(student.postal.code, treso.id.por) %>%
  mutate(student.postal.code = as.character(student.postal.code))

result_student_tlfd <- result_student %>%
  left_join(school_overlay, by="sfis") %>%
  left_join(student_overlay, by="student.postal.code") %>%
  # There are new POR-POS pairs that did not exist before, need to recalculate euclidean_dist
  mutate(euclidean.dist = haverFunction(student.lat, student.long, school.lat, school.long)) %>%
  # Get the travel time skims
  left_join(travel_time_skim, by=c("treso.id.por" = "orig", "treso.id.pos" = "dest")) %>%
  rename(travel.time = value) %>%
  # Get the school board type names
  left_join(select(school_board_def, dsb, board_type_name),
            by = c("dsb.index" = "dsb")) %>%
  # Get the MOF regions
  left_join(select(treso_zone_def, treso_id, area, mof_region),
            by = c("treso.id.por" = "treso_id")) %>%
  # Get the panel information
  left_join(select(school_sfis_2017, sfis, panel), by = "sfis") %>%
  # expand the rows based on enrollment number
  uncount(enrolment.assigned)

summary(result_student_tlfd$travel.time)

result_student_tlfd <- result_student_tlfd %>%
  # intra-zonal trip assumptions
  mutate(euclidean.travel.time = ifelse(euclidean.dist <= 2.5,
                                        euclidean.dist / 5 * 60,
                                        euclidean.dist / 30 * 60)) %>%
  mutate(travel.time = ifelse(travel.time == 0,
                              euclidean.travel.time,
                              travel.time)) %>%
  mutate(compare.travel.time = travel.time - euclidean.travel.time) %>%
  mutate(travel.time = ifelse(compare.travel.time > 30,
                              euclidean.travel.time,
                              travel.time))

summary(result_student_tlfd$travel.time)

ggsave(file = "output/tlfd_closest_school_probability.png",
       plot_travel_time_tlfd(result_student_tlfd), height = 28, width = 10)

```

